<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proposal Editor | Drishti Consulting</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #0ea5e9;
            --accent: #8b5cf6;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: var(--dark);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .back-btn {
            color: var(--gray);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        .back-btn:hover { color: var(--light); }
        .proposal-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .proposal-number {
            font-weight: 600;
            color: var(--primary);
        }
        .version-badge {
            background: var(--accent);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-draft { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-sent { background: rgba(14, 165, 233, 0.2); color: var(--secondary); }
        .status-accepted { background: rgba(16, 185, 129, 0.2); color: var(--success); }

        .top-bar-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--light);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.15); }
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
        .btn-success {
            background: var(--success);
            color: white;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: calc(100vh - 60px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--dark);
            border-left: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar-section {
            margin-bottom: 24px;
        }
        .sidebar-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray);
            margin-bottom: 12px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 6px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--light);
            font-size: 13px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Document Area */
        .document-area {
            padding: 40px;
            overflow-y: auto;
            background: linear-gradient(180deg, var(--darker) 0%, #0a0a1a 100%);
        }
        .document {
            max-width: 900px;
            margin: 0 auto;
            background: var(--darker);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 40px;
        }

        /* Document Header */
        .doc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
        }
        .logo-text {
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .logo-subtitle {
            font-size: 11px;
            color: var(--gray);
        }
        .doc-meta {
            text-align: left;
            font-size: 12px;
            color: var(--gray);
        }
        .doc-meta strong {
            color: var(--light);
            display: block;
            font-size: 14px;
        }

        /* Editable Fields */
        .editable {
            background: rgba(99, 102, 241, 0.05);
            border: 1px dashed rgba(99, 102, 241, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            cursor: text;
            transition: all 0.2s;
            min-height: 1.5em;
        }
        .editable:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }
        .editable:focus {
            outline: none;
            background: rgba(99, 102, 241, 0.15);
            border-style: solid;
        }
        .editable-multiline {
            display: block;
            width: 100%;
            min-height: 60px;
            white-space: pre-wrap;
        }

        /* Title Section */
        .title-section {
            text-align: center;
            margin-bottom: 40px;
        }
        .title-section h1 {
            font-size: 32px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .title-section h2 {
            font-size: 18px;
            font-weight: 400;
            color: var(--gray);
        }

        /* Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        .info-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
        }
        .info-card h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--secondary);
            margin-bottom: 10px;
        }
        .info-card p {
            font-size: 16px;
            font-weight: 600;
        }
        .info-card span {
            font-size: 12px;
            color: var(--gray);
        }

        /* Section */
        .section {
            margin-bottom: 30px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--light);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
            display: inline-block;
        }
        .section-content {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 20px;
        }

        /* Line Items Table */
        .items-table {
            width: 100%;
            border-collapse: collapse;
        }
        .items-table th {
            text-align: right;
            padding: 10px;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--secondary);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .items-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            vertical-align: top;
        }
        .items-table .desc-cell { width: 50%; }
        .items-table .hours-cell { width: 15%; text-align: center; }
        .items-table .rate-cell { width: 15%; text-align: center; }
        .items-table .amount-cell { width: 15%; text-align: left; }
        .items-table .actions-cell { width: 5%; }
        .items-table input {
            width: 100%;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: var(--light);
            font-size: 13px;
        }
        .items-table input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .items-table .total-row {
            background: rgba(99, 102, 241, 0.1);
            font-weight: 600;
        }
        .delete-item {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
            opacity: 0.5;
        }
        .delete-item:hover { opacity: 1; }
        .add-item-btn {
            margin-top: 10px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px dashed rgba(99, 102, 241, 0.3);
            color: var(--primary);
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .add-item-btn:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        /* Price Box */
        .price-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin: 20px 0;
        }
        .price-label { font-size: 13px; color: var(--gray); margin-bottom: 6px; }
        .price-value {
            font-size: 32px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .price-vat { font-size: 13px; color: var(--gray); margin-top: 6px; }
        .price-total { font-size: 16px; font-weight: 600; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Payment Terms */
        .payment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }
        .payment-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        .payment-percent { font-size: 24px; font-weight: 700; color: var(--primary); }
        .payment-amount { font-size: 13px; font-weight: 600; margin: 6px 0; }
        .payment-desc { font-size: 11px; color: var(--gray); }

        /* Timeline */
        .timeline {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 0;
            left: 0;
            height: 3px;
            background: rgba(255,255,255,0.1);
        }
        .timeline-item {
            text-align: center;
            position: relative;
            flex: 1;
        }
        .timeline-dot {
            width: 40px;
            height: 40px;
            background: var(--gradient);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            position: relative;
            z-index: 1;
        }
        .timeline-label { font-size: 11px; color: var(--gray); }
        .timeline-desc { font-size: 10px; color: var(--gray); margin-top: 4px; }

        /* Version History */
        .version-history {
            margin-top: 20px;
        }
        .version-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .version-item.current {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .version-num {
            font-weight: 600;
            color: var(--primary);
        }
        .version-date { color: var(--gray); }
        .version-note { flex: 1; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        @media print {
            .top-bar, .sidebar { display: none !important; }
            .main-container { grid-template-columns: 1fr; }
            .document-area { padding: 0; }
            .document { border: none; box-shadow: none; }
            .editable { background: none; border: none; }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <a href="admin.html" class="back-btn">← Back to Admin</a>
            <div class="proposal-info">
                <span class="proposal-number" id="proposalNumberDisplay">DRS-2026-001</span>
                <span class="version-badge" id="versionBadge">v1.0</span>
                <span class="status-badge status-draft" id="statusBadge">draft</span>
            </div>
        </div>
        <div class="top-bar-actions">
            <button class="btn btn-secondary" onclick="createNewVersion()">+ New Version</button>
            <button class="btn btn-secondary" onclick="window.print()">Print / PDF</button>
            <button class="btn btn-primary" onclick="saveProposal()">Save Changes</button>
        </div>
    </div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Proposal Details</div>
                <div class="form-group">
                    <label>Proposal Number</label>
                    <input type="text" id="proposalNumber" value="DRS-2026-001">
                </div>
                <div class="form-group">
                    <label>Version</label>
                    <input type="text" id="proposalVersion" value="1.0" readonly style="background: rgba(99,102,241,0.1);">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="proposalStatus">
                        <option value="draft">Draft</option>
                        <option value="sent">Sent</option>
                        <option value="accepted">Accepted</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="proposalDate">
                    </div>
                    <div class="form-group">
                        <label>Valid (days)</label>
                        <input type="number" id="validDays" value="30">
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Client</div>
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="clientName" placeholder="Client company name">
                </div>
                <div class="form-group">
                    <label>Industry / Sector</label>
                    <input type="text" id="clientSector" placeholder="e.g. Insurance, Tech">
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Pricing</div>
                <div class="form-group">
                    <label>Hourly Rate (NIS)</label>
                    <input type="number" id="hourlyRate" value="375">
                </div>
                <div class="form-group">
                    <label>VAT Rate (%)</label>
                    <input type="number" id="vatRate" value="18">
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Version History</div>
                <div class="version-history" id="versionHistory">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Document Area -->
        <div class="document-area">
            <div class="document">
                <!-- Header -->
                <div class="doc-header">
                    <div class="logo-section">
                        <svg class="logo-icon" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#4a5568" stroke-width="2"/>
                            <circle cx="50" cy="50" r="32" fill="none" stroke="#4a5568" stroke-width="2"/>
                            <circle cx="50" cy="50" r="20" fill="none" stroke="#4a5568" stroke-width="2"/>
                            <circle cx="50" cy="50" r="10" fill="none" stroke="#6366f1" stroke-width="2.5"/>
                            <circle cx="50" cy="50" r="4" fill="#6366f1"/>
                        </svg>
                        <div>
                            <div class="logo-text">Drishti</div>
                            <div class="logo-subtitle">Focused Vision. Precise Execution.</div>
                        </div>
                    </div>
                    <div class="doc-meta">
                        <strong id="docNumber">DRS-2026-001</strong>
                        <span id="docDate">5 January 2026</span><br>
                        <span>Valid: <span id="docValidity">30</span> days</span>
                    </div>
                </div>

                <!-- Title -->
                <div class="title-section">
                    <h1>הצעת מחיר</h1>
                    <h2><span contenteditable="true" class="editable" id="projectTitle">Project Title</span></h2>
                </div>

                <!-- Info Cards -->
                <div class="info-grid">
                    <div class="info-card">
                        <h3>מוגש ל</h3>
                        <p><span contenteditable="true" class="editable" id="docClientName">Client Name</span></p>
                        <span><span contenteditable="true" class="editable" id="docClientSector">Industry</span></span>
                    </div>
                    <div class="info-card">
                        <h3>מגיש ההצעה</h3>
                        <p>ד"ר אבי לובצ'יק</p>
                        <span>Drishti Consulting</span>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="section">
                    <h2 class="section-title">1. תקציר מנהלים</h2>
                    <div class="section-content">
                        <div contenteditable="true" class="editable editable-multiline" id="executiveSummary">Enter executive summary here...</div>
                    </div>
                </div>

                <!-- Scope / Deliverables -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">2. היקף הפרויקט ועלויות</h2>
                    </div>
                    <div class="section-content">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th class="desc-cell">תיאור / Deliverable</th>
                                    <th class="hours-cell">שעות</th>
                                    <th class="rate-cell">תעריף</th>
                                    <th class="amount-cell">סכום</th>
                                    <th class="actions-cell"></th>
                                </tr>
                            </thead>
                            <tbody id="itemsBody">
                                <!-- Populated dynamically -->
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td>סה"כ</td>
                                    <td class="hours-cell" id="totalHours">0</td>
                                    <td></td>
                                    <td class="amount-cell" id="totalAmount">₪0</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        <button class="add-item-btn" onclick="addItem()">+ Add Line Item</button>

                        <div class="price-box">
                            <div class="price-label">עלות הפרויקט</div>
                            <div class="price-value" id="priceValue">₪0</div>
                            <div class="price-vat">+ מע"מ (<span id="vatPercent">18</span>%) <span id="vatAmount">₪0</span></div>
                            <div class="price-total">סה"כ לתשלום: <span id="totalWithVat">₪0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Payment Terms -->
                <div class="section">
                    <h2 class="section-title">3. תנאי תשלום</h2>
                    <div class="section-content">
                        <div class="payment-grid" id="paymentGrid">
                            <!-- Populated dynamically -->
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="font-size: 12px; color: var(--gray);">Payment Notes:</label>
                            <div contenteditable="true" class="editable editable-multiline" id="paymentNotes" style="margin-top: 8px;">Enter payment terms notes...</div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="section">
                    <h2 class="section-title">4. לוחות זמנים</h2>
                    <div class="section-content">
                        <p style="text-align: center; margin-bottom: 15px;">משך הפרויקט המוערך: <span contenteditable="true" class="editable" id="projectDuration">8 שבועות</span></p>
                        <div class="timeline" id="timeline">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Terms -->
                <div class="section">
                    <h2 class="section-title">5. תנאים כלליים</h2>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h4 style="color: var(--success); margin-bottom: 10px; font-size: 13px;">כלול בהצעה</h4>
                                <div contenteditable="true" class="editable editable-multiline" id="included">• Item 1
• Item 2
• Item 3</div>
                            </div>
                            <div>
                                <h4 style="color: var(--gray); margin-bottom: 10px; font-size: 13px;">לא כלול</h4>
                                <div contenteditable="true" class="editable editable-multiline" id="excluded">• Item 1
• Item 2</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IP Ownership Section -->
                <div class="section" id="ipOwnershipSection" style="display: none;">
                    <h2 style="font-size: 18px; margin-bottom: 16px; color: var(--secondary); border-bottom: 2px solid var(--secondary); padding-bottom: 8px;">8. זכויות קניין רוחני (IP)</h2>
                    <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 20px;">
                        <div contenteditable="true" class="editable editable-multiline" id="ipOwnership" style="font-size: 13px; line-height: 2; white-space: pre-line;">1. קוד המקור, הלוגיקה העסקית, והמודלים יישארו בבעלות מלאה של המפתח.

2. הלקוח מקבל רישיון שימוש בלעדי במערכת לצרכיו העסקיים.

3. המפתח שומר לעצמו את הזכות לשימוש חוזר בקוד ובארכיטקטורה.

4. נתוני הלקוח יישארו בבעלות מלאה של הלקוח.</div>
                    </div>
                </div>

                <!-- Footer -->
                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center;">
                    <p style="color: var(--gray); font-size: 12px;">Drishti Consulting | ד"ר אבי לובצ'יק | avi@drishticonsulting.com</p>
                    <p style="color: var(--success); font-size: 12px; margin-top: 8px;">תוקף ההצעה: <span id="footerValidity">30</span> יום</p>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Saved successfully!</div>

    <script>
        // Get proposal ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const proposalId = urlParams.get('id');

        // Load proposals from localStorage
        let proposals = JSON.parse(localStorage.getItem('proposals')) || [];
        let currentProposal = null;

        // Default line items
        let lineItems = [
            { description: 'אפיון מפורט ותכנון', hours: 20, rate: 375 },
            { description: 'פיתוח ובנייה', hours: 80, rate: 375 },
            { description: 'בדיקות והטמעה', hours: 20, rate: 375 }
        ];

        // Default payment terms (percentages)
        let paymentTerms = [
            { percent: 40, description: 'עם חתימת ההסכם' },
            { percent: 40, description: 'באמצע הפרויקט' },
            { percent: 20, description: 'מסירת הפרויקט' }
        ];

        // Default timeline
        let timelineItems = [
            { weeks: '1-2', label: 'שבועות', desc: 'אפיון ותכנון' },
            { weeks: '3-5', label: 'שבועות', desc: 'פיתוח' },
            { weeks: '6-7', label: 'שבועות', desc: 'בדיקות' },
            { weeks: '8', label: 'שבוע', desc: 'הטמעה' }
        ];

        // Version history
        let versions = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date
            document.getElementById('proposalDate').value = new Date().toISOString().split('T')[0];

            if (proposalId) {
                loadProposal(parseInt(proposalId));
            } else {
                // New proposal
                renderItems();
                renderPaymentTerms();
                renderTimeline();
                renderVersionHistory();
            }

            // Sync sidebar with document
            setupSync();
        });

        function loadProposal(id) {
            currentProposal = proposals.find(p => p.id === id);
            if (!currentProposal) {
                alert('Proposal not found');
                return;
            }

            // Load basic info
            document.getElementById('proposalNumber').value = currentProposal.proposalNumber || currentProposal.number || '';
            document.getElementById('proposalNumberDisplay').textContent = currentProposal.proposalNumber || currentProposal.number || '';
            document.getElementById('docNumber').textContent = currentProposal.proposalNumber || currentProposal.number || '';
            document.getElementById('proposalStatus').value = currentProposal.status || 'draft';
            updateStatusBadge(currentProposal.status || 'draft');

            // Client info
            document.getElementById('clientName').value = currentProposal.clientName || '';
            document.getElementById('docClientName').textContent = currentProposal.clientName || '';

            // Project title
            document.getElementById('projectTitle').textContent = currentProposal.projectName || currentProposal.project || '';

            // Load line items if exists
            if (currentProposal.lineItems && currentProposal.lineItems.length > 0) {
                lineItems = currentProposal.lineItems;
            } else if (currentProposal.items && currentProposal.items.length > 0) {
                // Convert old format
                lineItems = currentProposal.items.map(item => ({
                    description: item.description,
                    hours: item.hours || 0,
                    rate: item.amount && item.hours ? Math.round(item.amount / item.hours) : 375
                }));
            }

            // Load other data
            if (currentProposal.executiveSummary) {
                document.getElementById('executiveSummary').textContent = currentProposal.executiveSummary;
            }
            if (currentProposal.paymentNotes) {
                document.getElementById('paymentNotes').textContent = currentProposal.paymentNotes;
            }
            if (currentProposal.included) {
                document.getElementById('included').textContent = currentProposal.included;
            }
            if (currentProposal.excluded) {
                document.getElementById('excluded').textContent = currentProposal.excluded;
            }
            if (currentProposal.ipOwnership) {
                document.getElementById('ipOwnership').textContent = currentProposal.ipOwnership;
                document.getElementById('ipOwnershipSection').style.display = 'block';
            }
            if (currentProposal.projectDuration) {
                document.getElementById('projectDuration').textContent = currentProposal.projectDuration;
            }
            if (currentProposal.paymentTerms) {
                paymentTerms = currentProposal.paymentTerms;
            }
            if (currentProposal.timeline) {
                timelineItems = currentProposal.timeline;
            }
            if (currentProposal.versions) {
                versions = currentProposal.versions;
            }

            // Version
            const version = currentProposal.version || '1.0';
            document.getElementById('proposalVersion').value = version;
            document.getElementById('versionBadge').textContent = 'v' + version;

            // Hourly rate
            if (currentProposal.hourlyRate) {
                document.getElementById('hourlyRate').value = currentProposal.hourlyRate;
            }

            renderItems();
            renderPaymentTerms();
            renderTimeline();
            renderVersionHistory();
        }

        function renderItems() {
            const tbody = document.getElementById('itemsBody');
            const rate = parseInt(document.getElementById('hourlyRate').value) || 375;

            tbody.innerHTML = lineItems.map((item, index) => `
                <tr>
                    <td class="desc-cell">
                        <input type="text" value="${item.description}" onchange="updateItem(${index}, 'description', this.value)">
                    </td>
                    <td class="hours-cell">
                        <input type="number" value="${item.hours}" onchange="updateItem(${index}, 'hours', this.value)" style="text-align: center;">
                    </td>
                    <td class="rate-cell">₪${rate}</td>
                    <td class="amount-cell">₪${(item.hours * rate).toLocaleString()}</td>
                    <td class="actions-cell">
                        <button class="delete-item" onclick="deleteItem(${index})">×</button>
                    </td>
                </tr>
            `).join('');

            calculateTotals();
        }

        function addItem() {
            lineItems.push({ description: 'New item', hours: 10, rate: parseInt(document.getElementById('hourlyRate').value) || 375 });
            renderItems();
        }

        function updateItem(index, field, value) {
            if (field === 'hours') {
                lineItems[index][field] = parseInt(value) || 0;
            } else {
                lineItems[index][field] = value;
            }
            renderItems();
        }

        function deleteItem(index) {
            if (lineItems.length > 1) {
                lineItems.splice(index, 1);
                renderItems();
            }
        }

        function calculateTotals() {
            const rate = parseInt(document.getElementById('hourlyRate').value) || 375;
            const vatRate = parseInt(document.getElementById('vatRate').value) || 18;

            let totalHours = 0;
            let totalAmount = 0;

            lineItems.forEach(item => {
                totalHours += item.hours;
                totalAmount += item.hours * rate;
            });

            const vatAmount = Math.round(totalAmount * vatRate / 100);
            const totalWithVat = totalAmount + vatAmount;

            document.getElementById('totalHours').textContent = totalHours;
            document.getElementById('totalAmount').textContent = '₪' + totalAmount.toLocaleString();
            document.getElementById('priceValue').textContent = '₪' + totalAmount.toLocaleString();
            document.getElementById('vatPercent').textContent = vatRate;
            document.getElementById('vatAmount').textContent = '₪' + vatAmount.toLocaleString();
            document.getElementById('totalWithVat').textContent = '₪' + totalWithVat.toLocaleString();

            // Update payment amounts
            renderPaymentTerms();
        }

        function renderPaymentTerms() {
            const totalAmount = lineItems.reduce((sum, item) => sum + (item.hours * (parseInt(document.getElementById('hourlyRate').value) || 375)), 0);

            document.getElementById('paymentGrid').innerHTML = paymentTerms.map((term, index) => `
                <div class="payment-item">
                    <div class="payment-percent">${term.percent}%</div>
                    <div class="payment-amount">₪${Math.round(totalAmount * term.percent / 100).toLocaleString()} + מע"מ</div>
                    <div class="payment-desc" contenteditable="true" onblur="updatePaymentDesc(${index}, this.textContent)">${term.description}</div>
                </div>
            `).join('');
        }

        function updatePaymentDesc(index, value) {
            paymentTerms[index].description = value;
        }

        function renderTimeline() {
            document.getElementById('timeline').innerHTML = timelineItems.map((item, index) => `
                <div class="timeline-item">
                    <div class="timeline-dot" contenteditable="true" onblur="updateTimeline(${index}, 'weeks', this.textContent)">${item.weeks}</div>
                    <div class="timeline-label">${item.label}</div>
                    <div class="timeline-desc" contenteditable="true" onblur="updateTimeline(${index}, 'desc', this.textContent)">${item.desc}</div>
                </div>
            `).join('');
        }

        function updateTimeline(index, field, value) {
            timelineItems[index][field] = value;
        }

        function renderVersionHistory() {
            const container = document.getElementById('versionHistory');
            const currentVersion = document.getElementById('proposalVersion').value;

            if (versions.length === 0) {
                versions.push({
                    version: currentVersion,
                    date: new Date().toISOString(),
                    note: 'Initial version'
                });
            }

            container.innerHTML = versions.map((v, i) => `
                <div class="version-item ${v.version === currentVersion ? 'current' : ''}">
                    <span class="version-num">v${v.version}</span>
                    <span class="version-date">${new Date(v.date).toLocaleDateString()}</span>
                    <span class="version-note">${v.note}</span>
                </div>
            `).join('');
        }

        function createNewVersion() {
            const currentVersion = document.getElementById('proposalVersion').value;
            const parts = currentVersion.split('.');
            let major = parseInt(parts[0]) || 1;
            let minor = parseInt(parts[1]) || 0;

            const choice = confirm('Create MAJOR version (new proposal)?\n\nOK = Major (v' + (major + 1) + '.0)\nCancel = Minor (v' + major + '.' + (minor + 1) + ')');

            let newVersion;
            if (choice) {
                newVersion = (major + 1) + '.0';
            } else {
                newVersion = major + '.' + (minor + 1);
            }

            const note = prompt('Version note (what changed?):', '');

            versions.push({
                version: newVersion,
                date: new Date().toISOString(),
                note: note || 'Updated'
            });

            document.getElementById('proposalVersion').value = newVersion;
            document.getElementById('versionBadge').textContent = 'v' + newVersion;

            renderVersionHistory();
            saveProposal();
        }

        function setupSync() {
            // Sync client name
            document.getElementById('clientName').addEventListener('input', function() {
                document.getElementById('docClientName').textContent = this.value;
            });

            // Sync proposal number
            document.getElementById('proposalNumber').addEventListener('input', function() {
                document.getElementById('proposalNumberDisplay').textContent = this.value;
                document.getElementById('docNumber').textContent = this.value;
            });

            // Sync validity
            document.getElementById('validDays').addEventListener('input', function() {
                document.getElementById('docValidity').textContent = this.value;
                document.getElementById('footerValidity').textContent = this.value;
            });

            // Sync hourly rate
            document.getElementById('hourlyRate').addEventListener('input', function() {
                renderItems();
            });

            // Sync VAT
            document.getElementById('vatRate').addEventListener('input', function() {
                calculateTotals();
            });

            // Sync status
            document.getElementById('proposalStatus').addEventListener('change', function() {
                updateStatusBadge(this.value);
            });
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('statusBadge');
            badge.textContent = status;
            badge.className = 'status-badge status-' + status;
        }

        function saveProposal() {
            const proposalData = {
                proposalNumber: document.getElementById('proposalNumber').value,
                version: document.getElementById('proposalVersion').value,
                status: document.getElementById('proposalStatus').value,
                clientName: document.getElementById('clientName').value,
                clientSector: document.getElementById('clientSector').value,
                projectName: document.getElementById('projectTitle').textContent,
                hourlyRate: parseInt(document.getElementById('hourlyRate').value) || 375,
                lineItems: lineItems,
                executiveSummary: document.getElementById('executiveSummary').textContent,
                paymentNotes: document.getElementById('paymentNotes').textContent,
                paymentTerms: paymentTerms,
                timeline: timelineItems,
                projectDuration: document.getElementById('projectDuration').textContent,
                included: document.getElementById('included').textContent,
                excluded: document.getElementById('excluded').textContent,
                ipOwnership: document.getElementById('ipOwnership').textContent,
                versions: versions,
                amount: lineItems.reduce((sum, item) => sum + (item.hours * (parseInt(document.getElementById('hourlyRate').value) || 375)), 0),
                hours: lineItems.reduce((sum, item) => sum + item.hours, 0),
                updated: new Date().toISOString()
            };

            if (currentProposal) {
                // Update existing
                const index = proposals.findIndex(p => p.id === currentProposal.id);
                if (index !== -1) {
                    proposals[index] = { ...proposals[index], ...proposalData };
                }
            } else {
                // Create new
                proposalData.id = Date.now();
                proposalData.created = new Date().toISOString();
                proposals.push(proposalData);
                currentProposal = proposalData;

                // Update URL
                window.history.replaceState({}, '', `?id=${proposalData.id}`);
            }

            localStorage.setItem('proposals', JSON.stringify(proposals));
            showToast('Saved successfully!');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
