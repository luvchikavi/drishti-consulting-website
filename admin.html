<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Drishti Consulting</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #0ea5e9;
            --accent: #8b5cf6;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
            font-size: 12px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 13px;
        }

        .form-group {
            margin-bottom: 12px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 10px;
            color: var(--gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--light);
            font-size: 12px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--light);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 10px;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 180px;
            height: 100vh;
            background: rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255,255,255,0.08);
            padding: 16px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .sidebar-logo svg {
            width: 28px;
            height: 28px;
        }

        .sidebar-logo span {
            font-size: 14px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--gray-light);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--light);
        }

        .nav-item.active {
            border-left: 3px solid var(--primary);
        }

        .nav-item svg {
            width: 16px;
            height: 16px;
        }

        .main-content {
            margin-left: 180px;
            padding: 20px;
            min-height: 100vh;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .page-title {
            font-size: 18px;
            font-weight: 700;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px 16px;
        }

        .stat-card h3 {
            font-size: 10px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-card .value {
            font-size: 22px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Table */
        .data-table {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .data-table th {
            background: rgba(99, 102, 241, 0.1);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-light);
            font-weight: 600;
        }

        .data-table tr:hover td {
            background: rgba(255,255,255,0.02);
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-sent {
            background: rgba(14, 165, 233, 0.1);
            color: var(--secondary);
        }

        .action-btns {
            display: flex;
            gap: 6px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--dark);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* Airtable Setup Notice */
        .setup-notice {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .setup-notice h4 {
            color: var(--warning);
            margin-bottom: 8px;
        }

        .setup-notice p {
            color: var(--gray-light);
            font-size: 13px;
        }

        .setup-notice code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            font-weight: 600;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        /* Multiple Contacts */
        .contacts-container {
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .contacts-header label {
            font-size: 12px;
            color: var(--gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-add-contact {
            padding: 6px 12px;
            font-size: 11px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
        }

        .contact-entry {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        .contact-entry:last-child {
            margin-bottom: 0;
        }

        .contact-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .contact-row:last-child {
            margin-bottom: 0;
        }

        .contact-entry input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--light);
            font-size: 13px;
            font-family: inherit;
        }

        .contact-entry input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .contact-entry input::placeholder {
            color: var(--gray);
        }

        .btn-remove-contact {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: var(--danger);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <svg class="login-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="none" stroke="#4a5568" stroke-width="2"/>
                <circle cx="50" cy="50" r="32" fill="none" stroke="#4a5568" stroke-width="2"/>
                <circle cx="50" cy="50" r="20" fill="none" stroke="#4a5568" stroke-width="2"/>
                <circle cx="50" cy="50" r="10" fill="none" stroke="#6366f1" stroke-width="2.5"/>
                <circle cx="50" cy="50" r="4" fill="#6366f1"/>
            </svg>
            <h1 class="login-title">Admin Panel</h1>
            <p class="login-subtitle">Focused Vision. Precise Execution.</p>

            <form id="loginForm">
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <a href="https://drishticonsulting.com" target="_blank" class="sidebar-logo" style="text-decoration: none; color: inherit;">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#4a5568" stroke-width="2"/>
                    <circle cx="50" cy="50" r="32" fill="none" stroke="#4a5568" stroke-width="2"/>
                    <circle cx="50" cy="50" r="20" fill="none" stroke="#4a5568" stroke-width="2"/>
                    <circle cx="50" cy="50" r="10" fill="none" stroke="#6366f1" stroke-width="2.5"/>
                    <circle cx="50" cy="50" r="4" fill="#6366f1"/>
                </svg>
                <span>Drishti</span>
            </a>

            <nav>
                <div class="nav-item active" data-page="clients">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Clients
                </div>
                <div class="nav-item" data-page="proposals">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    Proposals
                </div>
                <div class="nav-item" data-page="projects">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        <line x1="12" y1="11" x2="12" y2="17"/>
                        <line x1="9" y1="14" x2="15" y2="14"/>
                    </svg>
                    Projects
                </div>
                <div class="nav-item" data-page="invoices">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6"/>
                        <path d="M16 13H8"/>
                        <path d="M16 17H8"/>
                        <path d="M10 9H8"/>
                    </svg>
                    Invoices
                </div>
                <div class="nav-item" data-page="expenses">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    Expenses
                </div>
                <div class="nav-item" data-page="analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10"/>
                        <path d="M12 20V4"/>
                        <path d="M6 20v-6"/>
                    </svg>
                    Analytics
                </div>
                <div class="nav-item" data-page="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>

                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 10px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; padding: 0 12px;">Projects</div>
                    <a href="progress.html?p=lhd-001" target="_blank" class="nav-item" style="text-decoration: none; color: inherit;" id="nav-riskcovery">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        Riskcovery (LHD)
                    </a>
                    <a href="https://climetrix.io" target="_blank" class="nav-item" style="text-decoration: none; color: inherit;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                            <path d="M2 17l10 5 10-5"/>
                            <path d="M2 12l10 5 10-5"/>
                        </svg>
                        Climetrix
                    </a>
                    <a href="https://frontendmaterialdashboard.vercel.app" target="_blank" class="nav-item" style="text-decoration: none; color: inherit;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <line x1="3" y1="9" x2="21" y2="9"/>
                            <line x1="9" y1="21" x2="9" y2="9"/>
                        </svg>
                        Nectra
                    </a>
                    <a href="https://luvchik.streamlit.app" target="_blank" class="nav-item" style="text-decoration: none; color: inherit;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                            <polyline points="2 17 12 22 22 17"/>
                            <polyline points="2 12 12 17 22 12"/>
                        </svg>
                        TAG System
                    </a>
                </div>
            </nav>

            <div style="position: absolute; bottom: 24px; left: 24px; right: 24px;">
                <div class="nav-item" onclick="logout()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Clients Page -->
            <div class="page" id="page-clients">
                <div class="page-header">
                    <h1 class="page-title">Clients</h1>
                    <button class="btn btn-primary" onclick="openModal('addClient')">+ Add Client</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Clients</h3>
                        <div class="value" id="totalClients">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Projects</h3>
                        <div class="value" id="activeProjects">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Proposals Sent</h3>
                        <div class="value" id="proposalsSent">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending</h3>
                        <div class="value" id="pendingProposals">0</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                    <div style="position: relative; flex: 1; max-width: 400px;">
                        <input type="text" id="clientSearch" placeholder="Search clients by name, company, email..."
                            style="width: 100%; padding: 12px 16px 12px 44px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px;"
                            oninput="filterClients()">
                        <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--gray);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                    </div>
                    <select id="clientIndustryFilter" onchange="filterClients()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px; min-width: 150px;">
                        <option value="">All Industries</option>
                        <option value="Technology">Technology</option>
                        <option value="Finance">Finance & Insurance</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Retail">Retail</option>
                        <option value="Construction">Construction</option>
                        <option value="Government">Government / Municipal</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Proposals Page -->
            <div class="page hidden" id="page-proposals">
                <div class="page-header">
                    <h1 class="page-title">Proposals</h1>
                    <button class="btn btn-primary" onclick="openModal('newProposal')">+ New Proposal</button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Proposal #</th>
                                <th>Client</th>
                                <th>Project</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="proposalsTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Projects Page -->
            <div class="page hidden" id="page-projects">
                <div class="page-header">
                    <h1 class="page-title">Projects</h1>
                    <button class="btn btn-primary" onclick="openModal('newProject')">+ New Project</button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Active Projects</h3>
                        <div class="value" id="activeProjectsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Projects</h3>
                        <div class="value" id="totalProjectsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>On Track</h3>
                        <div class="value" id="onTrackProjects" style="color: #10b981;">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Needs Attention</h3>
                        <div class="value" id="attentionProjects" style="color: #f59e0b;">0</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                    <div style="position: relative; flex: 1; max-width: 400px;">
                        <input type="text" id="projectSearch" placeholder="Search projects..."
                            style="width: 100%; padding: 12px 16px 12px 44px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px;"
                            oninput="filterProjects()">
                        <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--gray);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                    </div>
                    <select id="projectStatusFilter" onchange="filterProjects()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px; min-width: 150px;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="on_hold">On Hold</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Project #</th>
                                <th>Client</th>
                                <th>Project Name</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTable">
                            <tr><td colspan="6" style="text-align: center; color: var(--gray);">No projects yet. Create one from a proposal or click "+ New Project"</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Invoices Page -->
            <div class="page hidden" id="page-invoices">
                <div class="page-header">
                    <h1 class="page-title">Invoices</h1>
                    <div style="display: flex; gap: 12px;">
                        <a href="https://www.waveapps.com/invoicing" target="_blank" class="btn btn-secondary" style="text-decoration: none;">Open Wave</a>
                        <button class="btn btn-primary" onclick="openModal('newInvoice')">+ New Invoice</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Invoiced</h3>
                        <div class="value" id="totalInvoiced">‚Ç™0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Paid</h3>
                        <div class="value" id="totalPaid" style="color: #10b981;">‚Ç™0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending</h3>
                        <div class="value" id="totalPending" style="color: #f59e0b;">‚Ç™0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Overdue</h3>
                        <div class="value" id="totalOverdue" style="color: #ef4444;">‚Ç™0</div>
                    </div>
                </div>

                <div class="setup-notice" style="background: rgba(99, 102, 241, 0.1); border-color: rgba(99, 102, 241, 0.3);">
                    <h4 style="color: var(--primary);">Wave Integration (Free)</h4>
                    <p>For professional invoicing with payment tracking, use <a href="https://www.waveapps.com" target="_blank" style="color: var(--secondary);">Wave</a> - it's 100% free for invoicing and accounting. Track invoices here for quick overview.</p>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Client</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable">
                            <tr><td colspan="6" style="text-align: center; color: var(--gray);">No invoices yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Page -->
            <div class="page hidden" id="page-expenses">
                <div class="page-header">
                    <h1 class="page-title">Expenses</h1>
                    <div style="display: flex; gap: 12px;">
                        <a href="https://www.waveapps.com/accounting" target="_blank" class="btn btn-secondary" style="text-decoration: none;">Open Wave</a>
                        <button class="btn btn-primary" onclick="openModal('newExpense')">+ Add Expense</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>This Month</h3>
                        <div class="value" id="expensesMonth">‚Ç™0</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Year</h3>
                        <div class="value" id="expensesYear">‚Ç™0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Categories</h3>
                        <div class="value" id="expenseCategories">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg/Month</h3>
                        <div class="value" id="expensesAvg">‚Ç™0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">By Category</h3>
                        <div id="expensesByCategory">
                            <div style="color: var(--gray); font-size: 13px;">No expenses yet</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Recent Expenses</h3>
                        <div id="recentExpenses">
                            <div style="color: var(--gray); font-size: 13px;">No expenses yet</div>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTable">
                            <tr><td colspan="5" style="text-align: center; color: var(--gray);">No expenses yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Page -->
            <div class="page hidden" id="page-analytics">
                <div class="page-header">
                    <h1 class="page-title">Analytics</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Logins</h3>
                        <div class="value" id="totalLogins">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Page Views</h3>
                        <div class="value" id="pageViews">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Proposals Viewed</h3>
                        <div class="value" id="proposalsViewed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Last Login</h3>
                        <div class="value" id="lastLogin" style="font-size: 14px;">-</div>
                    </div>
                </div>

                <div style="margin-top: 30px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 20px;">Recent Activity</h3>
                    <div id="activityLog" style="max-height: 300px; overflow-y: auto;">
                        <div style="color: var(--gray); font-size: 13px;">Activity log will appear here...</div>
                    </div>
                </div>

                <div style="margin-top: 30px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 20px;">Quick Links</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <a href="https://drishticonsulting.com" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">üåê</span>
                            <span>Main Website</span>
                        </a>
                        <a href="https://drishticonsulting.com/proposal-lhd-insurance.html" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">üìÑ</span>
                            <span>LHD Proposal</span>
                        </a>
                        <a href="https://drishticonsulting.com/mockups-lhd-insurance.html" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">üé®</span>
                            <span>LHD Mockups</span>
                        </a>
                        <a href="https://formspree.io/forms" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">üì¨</span>
                            <span>Formspree Dashboard</span>
                        </a>
                        <a href="https://app.netlify.com" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">üöÄ</span>
                            <span>Netlify Dashboard</span>
                        </a>
                        <a href="https://calendly.com/event_types/user/me" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">üìÖ</span>
                            <span>Calendly</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page hidden" id="page-settings">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>

                <div class="setup-notice">
                    <h4>Airtable Integration</h4>
                    <p>Connect your Airtable base to sync clients and proposals. Get your API key from <a href="https://airtable.com/account" target="_blank" style="color: var(--secondary);">Airtable Account</a></p>
                </div>

                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <div class="form-group">
                        <label>Airtable API Key</label>
                        <input type="password" id="airtableKey" placeholder="pat..." value="">
                    </div>
                    <div class="form-group">
                        <label>Base ID</label>
                        <input type="text" id="airtableBase" placeholder="app..." value="">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()" style="width: auto;">Save Settings</button>
                </div>

                <div style="margin-top: 30px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 16px;">Change Admin Password</h3>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                    </div>
                    <button class="btn btn-secondary" onclick="changePassword()" style="width: auto;">Update Password</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="modal-addClient">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Client</h2>
                <button class="modal-close" onclick="closeModal('addClient')">&times;</button>
            </div>
            <form id="addClientForm">
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="clientCompany" required>
                </div>

                <div class="contacts-container">
                    <div class="contacts-header">
                        <label>Contact Persons</label>
                        <button type="button" class="btn-add-contact" onclick="addContactField()">+ Add Contact</button>
                    </div>
                    <div id="contactsList">
                        <div class="contact-entry" data-index="0">
                            <div class="contact-row">
                                <input type="text" name="contact_name_0" placeholder="Name *" required>
                                <input type="text" name="contact_position_0" placeholder="Position">
                            </div>
                            <div class="contact-row">
                                <input type="email" name="contact_email_0" placeholder="Email *" required>
                                <input type="tel" name="contact_phone_0" placeholder="Phone">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Industry</label>
                    <select id="clientIndustry">
                        <option value="">Select industry...</option>
                        <option value="Technology">Technology</option>
                        <option value="Finance">Finance & Insurance</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Retail">Retail</option>
                        <option value="Construction">Construction</option>
                        <option value="Government">Government / Municipal</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="clientNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addClient')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Proposal Modal -->
    <div class="modal-overlay" id="modal-newProposal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create New Proposal</h2>
                <button class="modal-close" onclick="closeModal('newProposal')">&times;</button>
            </div>
            <form id="newProposalForm">
                <div class="form-group">
                    <label>Client</label>
                    <select id="proposalClient" required>
                        <option value="">Select client...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="proposalProject" required placeholder="e.g., Insurance Advisory System">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (NIS)</label>
                        <input type="number" id="proposalAmount" required placeholder="43000">
                    </div>
                    <div class="form-group">
                        <label>Estimated Hours</label>
                        <input type="number" id="proposalHours" placeholder="285">
                    </div>
                </div>
                <div class="form-group">
                    <label>Proposal Type</label>
                    <select id="proposalType">
                        <option value="development">System Development</option>
                        <option value="characterization">Characterization Phase</option>
                        <option value="consulting">Consulting</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="proposalDesc" rows="3" placeholder="Brief project description..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newProposal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Proposal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Invoice Modal -->
    <div class="modal-overlay" id="modal-newInvoice">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create Invoice</h2>
                <button class="modal-close" onclick="closeModal('newInvoice')">&times;</button>
            </div>
            <form id="newInvoiceForm">
                <div class="form-group">
                    <label>Client</label>
                    <select id="invoiceClient" required>
                        <option value="">Select client...</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Invoice Number</label>
                        <input type="text" id="invoiceNumber" required placeholder="INV-001">
                    </div>
                    <div class="form-group">
                        <label>Amount (‚Ç™)</label>
                        <input type="number" id="invoiceAmount" required placeholder="10000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Issue Date</label>
                        <input type="date" id="invoiceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="invoiceDueDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="invoiceDesc" rows="2" placeholder="Services rendered..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newInvoice')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Expense Modal -->
    <div class="modal-overlay" id="modal-newExpense">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Expense</h2>
                <button class="modal-close" onclick="closeModal('newExpense')">&times;</button>
            </div>
            <form id="newExpenseForm">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expenseDesc" required placeholder="Office supplies, Software subscription...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (‚Ç™)</label>
                        <input type="number" id="expenseAmount" required placeholder="500">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="expenseCategory" required>
                        <option value="">Select category...</option>
                        <option value="Software">Software & Subscriptions</option>
                        <option value="Office">Office Supplies</option>
                        <option value="Travel">Travel & Transportation</option>
                        <option value="Marketing">Marketing & Advertising</option>
                        <option value="Professional">Professional Services</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Utilities">Utilities & Internet</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="expenseNotes" rows="2" placeholder="Additional details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newExpense')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="modal-newProject">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Create New Project</h2>
                <button class="modal-close" onclick="closeModal('newProject')">&times;</button>
            </div>
            <form id="newProjectForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Client</label>
                        <select id="projectClient" required>
                            <option value="">Select client...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>From Proposal (optional)</label>
                        <select id="projectProposal">
                            <option value="">No proposal linked</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" required placeholder="e.g., Insurance Advisory System">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Project Type</label>
                        <select id="projectType" required onchange="loadStageTemplate()">
                            <option value="">Select type...</option>
                            <option value="development">System Development</option>
                            <option value="characterization">Characterization Phase</option>
                            <option value="consulting">Consulting</option>
                            <option value="custom">Custom (Define stages manually)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total Budget (‚Ç™)</label>
                        <input type="number" id="projectBudget" required placeholder="43000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Total Hours</label>
                        <input type="number" id="projectHours" required placeholder="285" onchange="recalculateStageHours()">
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="projectStartDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Expected End Date</label>
                    <input type="date" id="projectEndDate" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription" rows="2" placeholder="Brief project description..."></textarea>
                </div>

                <!-- Stages Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <label style="font-size: 14px; font-weight: 600;">Project Stages</label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addProjectStage()">+ Add Stage</button>
                    </div>
                    <div id="stagesList" style="max-height: 300px; overflow-y: auto;">
                        <div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">
                            Select a project type to load stage template, or add stages manually
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newProject')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Management Modal -->
    <div class="modal-overlay" id="modal-manageProject">
        <div class="modal" style="max-width: 800px; max-height: 95vh;">
            <div class="modal-header">
                <h2 class="modal-title" id="manageProjectTitle">Manage Project</h2>
                <button class="modal-close" onclick="closeModal('manageProject')">&times;</button>
            </div>
            <div id="manageProjectContent">
                <!-- Dynamic content loaded by openProjectManagement() -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">Saved successfully!</div>

    <script>
        // Simple password (you should change this!)
        // Reset password to default on load (clear any old stored password)
        localStorage.removeItem('adminPassword');
        const ADMIN_PASSWORD = 'drishti2026';

        // Data storage (localStorage for demo, Airtable for production)
        const sampleClients = [
            {
                id: 1001,
                company: 'LHD Insurance Consulting',
                sector: 'finance',
                contacts: [
                    { name: '◊û◊©◊î ◊õ◊î◊ü', position: '◊û◊†◊õ"◊ú', email: 'moshe@lhd-insurance.co.il', phone: '052-1234567' },
                    { name: '◊®◊ó◊ú ◊ú◊ï◊ô', position: '◊°◊û◊†◊õ"◊ú ◊õ◊°◊§◊ô◊ù', email: 'rachel@lhd-insurance.co.il', phone: '052-7654321' }
                ],
                status: 'active'
            },
            {
                id: 1002,
                company: '◊ò◊ë◊¢ ◊™◊¢◊©◊ô◊ï◊™ ◊§◊®◊û◊¶◊ë◊ò◊ô◊ï◊™',
                sector: 'manufacturing',
                contacts: [
                    { name: '◊ì◊ï◊ì ◊ô◊©◊®◊ê◊ú◊ô', position: 'VP Operations', email: 'david@teva.co.il', phone: '054-9876543' }
                ],
                status: 'active'
            },
            {
                id: 1003,
                company: '◊ê◊ú◊ë◊ô◊ò ◊û◊¢◊®◊õ◊ï◊™',
                sector: 'technology',
                contacts: [
                    { name: '◊ô◊¢◊ú ◊ê◊ë◊®◊î◊ù', position: 'CTO', email: 'yael@elbit.co.il', phone: '053-1112233' },
                    { name: '◊ê◊ï◊®◊ô ◊©◊û◊©', position: 'Project Manager', email: 'uri@elbit.co.il', phone: '053-4445566' }
                ],
                status: 'active'
            },
            {
                id: 1004,
                company: '◊¢◊ñ◊®◊ô◊ê◊ú◊ô ◊û◊®◊õ◊ñ◊ô◊ù',
                sector: 'realestate',
                contacts: [
                    { name: '◊©◊®◊î ◊í◊ï◊ú◊ü', position: '◊û◊†◊î◊ú◊™ ◊§◊ô◊™◊ï◊ó ◊¢◊°◊ß◊ô', email: 'sara@azrieli.com', phone: '050-7778899' }
                ],
                status: 'lead'
            },
            {
                id: 1005,
                company: '◊ë◊†◊ß ◊ú◊ê◊ï◊û◊ô',
                sector: 'finance',
                contacts: [
                    { name: '◊ê◊ë◊ô ◊®◊ï◊ñ◊†◊ë◊®◊í', position: 'Head of Innovation', email: 'avi.r@leumi.co.il', phone: '052-3334455' }
                ],
                status: 'lead'
            },
            {
                id: 1006,
                company: 'Tag Urbanic Investment Management',
                companyHe: '◊™◊í◊ê ◊ê◊ï◊®◊ë◊†◊ô◊ß ◊†◊ô◊î◊ï◊ú ◊î◊©◊ß◊¢◊ï◊™ ◊ë◊¢"◊û',
                sector: 'realestate',
                companyId: '515876589',
                contacts: [
                    { name: 'Guy Gafni', nameHe: '◊í◊ô◊ê ◊í◊§◊†◊ô', position: 'CEO', email: 'guy@tagurbanic.co.il', phone: '' }
                ],
                status: 'active'
            }
        ];

        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        if (clients.length === 0) {
            clients = sampleClients;
            localStorage.setItem('clients', JSON.stringify(clients));
        }
        let proposals = JSON.parse(localStorage.getItem('proposals')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let projects = JSON.parse(localStorage.getItem('projects')) || [];

        // Force update LHD Insurance to v2.0 (always replace to ensure latest data)
        const LHD_DATA_VERSION = 'v2.0-20260107';
        const existingLHD = proposals.find(p => p.proposalNumber === 'LHD-001-26');
        if (!existingLHD || existingLHD.dataVersion !== LHD_DATA_VERSION) {
            // Remove old version and replace with v2.0
            proposals = proposals.filter(p => p.proposalNumber !== 'LHD-001-26');
            const sampleProposal = {
                id: 2001,
                proposalNumber: 'LHD-001-26',
                version: '2.0',
                dataVersion: LHD_DATA_VERSION,
                clientId: 1001,
                clientName: 'LHD Insurance Consulting',
                projectName: '◊û◊ï◊ì◊ï◊ú ◊î◊©◊ï◊ï◊ê◊™ ◊ê◊ô◊©◊ï◊®◊ô ◊ë◊ô◊ò◊ï◊ó - Insurance Certificate Comparison Module',
                description: '◊ë◊†◊ô◊ô◊™ ◊û◊ï◊ì◊ï◊ú ◊ú◊î◊©◊ï◊ï◊ê◊™ ◊ì◊®◊ô◊©◊ï◊™ ◊ë◊™◊†◊ê◊ô ◊û◊õ◊®◊ñ ◊©◊ú ◊ú◊ß◊ï◊ó◊ï◊™ ◊û◊ï◊ú ◊ê◊ô◊©◊ï◊®◊ô ◊î◊ë◊ô◊ò◊ï◊ó ◊©◊û◊°◊ï◊§◊ß◊ô◊ù ◊¢◊ú ◊ô◊ì◊ô ◊†◊ï◊™◊†◊ô ◊©◊ô◊®◊ï◊™ ◊ú◊ê◊ï◊™◊ù ◊ú◊ß◊ï◊ó◊ï◊™',
                amount: 48000,
                amountWithVat: 56640,
                currency: 'NIS',
                hours: 240,
                hourlyRate: 200,
                status: 'sent',
                validUntil: '2026-02-07',
                proposalType: 'development',
                lineItems: [
                    { description: '◊ê◊§◊ô◊ï◊ü ◊û◊§◊ï◊®◊ò ◊ï◊™◊õ◊†◊ï◊ü ◊û◊¢◊®◊õ◊™', hours: 25, rate: 200 },
                    { description: '◊î◊ß◊û◊™ ◊™◊©◊™◊ô◊™ ◊ï◊ê◊®◊õ◊ô◊ò◊ß◊ò◊ï◊®◊î (Backend + DB + Cloud)', hours: 30, rate: 200 },
                    { description: '◊û◊ï◊ì◊ï◊ú ◊î◊©◊ï◊ï◊ê◊™◊ô ◊ú◊§◊®◊û◊ò◊®◊ô◊ù ◊©◊ú ◊ê◊ô◊©◊ï◊®◊ô ◊ë◊ô◊ò◊ï◊ó', hours: 45, rate: 200 },
                    { description: 'Knowledge Base ◊ë◊ô◊ò◊ï◊ó◊ô◊ù (◊û◊ô◊§◊ï◊ô + Rule Engine)', hours: 30, rate: 200 },
                    { description: '◊û◊†◊ï◊¢ OCR ◊ú◊î◊©◊ï◊ï◊ê◊™ ◊î◊¶◊¢◊ï◊™', hours: 40, rate: 200 },
                    { description: '◊û◊†◊ï◊¢ OCR / AI', hours: 35, rate: 200 },
                    { description: '◊û◊û◊©◊ß ◊û◊©◊™◊û◊© UI/UX (React Frontend)', hours: 20, rate: 200 },
                    { description: '◊ë◊ì◊ô◊ß◊ï◊™ ◊ï◊î◊ò◊û◊¢◊î (QA)', hours: 15, rate: 200 }
                ],
                executiveSummary: '◊î◊¶◊¢◊î ◊ñ◊ï ◊û◊™◊ô◊ô◊ó◊°◊™ ◊ú◊§◊ô◊™◊ï◊ó ◊û◊ï◊ì◊ï◊ú ◊ú◊î◊©◊ï◊ï◊ê◊™ ◊ì◊®◊ô◊©◊ï◊™ ◊ë◊™◊†◊ê◊ô ◊û◊õ◊®◊ñ ◊©◊ú ◊ú◊ß◊ï◊ó◊ï◊™ ◊û◊ï◊ú ◊ê◊ô◊©◊ï◊®◊ô ◊î◊ë◊ô◊ò◊ï◊ó ◊©◊û◊°◊ï◊§◊ß◊ô◊ù ◊¢◊ú ◊ô◊ì◊ô ◊†◊ï◊™◊†◊ô ◊©◊ô◊®◊ï◊™ ◊ú◊ê◊ï◊™◊ù ◊ú◊ß◊ï◊ó◊ï◊™. ◊î◊û◊¢◊®◊õ◊™ ◊™◊õ◊ú◊ï◊ú ◊û◊†◊ï◊¢ OCR/AI ◊ú◊†◊ô◊™◊ï◊ó ◊û◊°◊û◊õ◊ô◊ù, ◊û◊ï◊ì◊ï◊ú ◊î◊©◊ï◊ï◊ê◊î ◊ó◊õ◊ù, ◊ï◊û◊û◊©◊ß ◊û◊©◊™◊û◊© ◊†◊ï◊ó.',
                included: '‚Ä¢ ◊§◊ô◊™◊ï◊ó ◊û◊ú◊ê ◊©◊ú ◊î◊û◊ï◊ì◊ï◊ú\n‚Ä¢ ◊û◊†◊ï◊¢ OCR / AI\n‚Ä¢ ◊î◊ß◊û◊™ ◊™◊©◊™◊ô◊™ ◊¢◊†◊ü\n‚Ä¢ ◊™◊ô◊¢◊ï◊ì ◊ò◊õ◊†◊ô ◊ï◊û◊ì◊®◊ô◊ö ◊ú◊û◊©◊™◊û◊©\n‚Ä¢ 3 ◊ó◊ï◊ì◊©◊ô ◊™◊û◊ô◊õ◊î ◊ò◊õ◊†◊ô◊™ ◊ï◊©◊ô◊§◊ï◊®◊ô◊ù',
                excluded: '‚Ä¢ ◊¢◊ú◊ï◊ô◊ï◊™ ◊¢◊†◊ü ◊©◊ï◊ò◊§◊ï◊™\n‚Ä¢ ◊î◊ñ◊†◊™ ◊†◊™◊ï◊†◊ô◊ù ◊®◊ê◊©◊ï◊†◊ô◊™\n‚Ä¢ *◊û◊ï◊ì◊ú ◊ó◊ú◊ï◊ß◊™ ◊®◊ï◊ï◊ó◊ô◊ù ◊ô◊ô◊ë◊ó◊ü ◊ë◊î◊û◊©◊ö ◊ú◊ê◊ó◊® ◊°◊ô◊ï◊ù ◊î◊ë◊ô◊¶◊ï◊¢ - ◊ô◊© ◊¢◊ú◊ï◊™ ◊™◊ó◊ñ◊ï◊ß◊î ◊©◊ï◊ò◊§◊™ ◊ú◊û◊¢◊®◊õ◊™ ◊©◊™◊ô◊ë◊ó◊ü ◊ë◊î◊û◊©◊ö',
                paymentNotes: '◊™◊†◊ê◊ô ◊™◊©◊ú◊ï◊ù: 40% ◊¢◊ù ◊ó◊™◊ô◊û◊™ ◊î◊î◊°◊õ◊ù, 40% ◊ú◊ê◊ó◊® ◊î◊©◊ú◊û◊™ ◊û◊ï◊ì◊ï◊ú ◊î-OCR, 20% ◊û◊°◊ô◊®◊™ ◊î◊§◊®◊ï◊ô◊ß◊ò.\n\n◊§◊®◊ò◊ô ◊ó◊©◊ë◊ï◊ü: ◊ë◊†◊ß ◊ì◊ô◊°◊ß◊ï◊†◊ò (11), ◊°◊†◊ô◊£ ◊û◊®◊ï◊ù ◊†◊ï◊ï◊î (096), ◊ó◊©◊ë◊ï◊ü 178380913, ◊¢◊¥◊© ◊ê◊ë◊ô ◊ú◊ï◊ë◊¶◊≥◊ô◊ß\n\n*◊û◊ï◊ì◊ú ◊ó◊ú◊ï◊ß◊™ ◊®◊ï◊ï◊ó◊ô◊ù ◊ô◊ô◊ë◊ó◊ü ◊ë◊î◊û◊©◊ö ◊ú◊ê◊ó◊® ◊°◊ô◊ï◊ù ◊î◊ë◊ô◊¶◊ï◊¢.',
                projectDuration: '6 ◊©◊ë◊ï◊¢◊ï◊™',
                versions: [
                    { version: '1.0', date: '2026-01-05T08:00:00.000Z', note: '◊í◊®◊°◊î ◊®◊ê◊©◊ï◊†◊ô◊™' },
                    { version: '2.0', date: new Date().toISOString(), note: '◊¢◊ì◊õ◊ï◊ü: ◊û◊ï◊ì◊ï◊ú ◊î◊©◊ï◊ï◊ê◊™ ◊ê◊ô◊©◊ï◊®◊ô ◊ë◊ô◊ò◊ï◊ó, ◊î◊ï◊°◊§◊™ OCR/AI, ◊î◊°◊®◊™ ◊ì◊©◊ë◊ï◊®◊ì ◊ï◊†◊ô◊î◊ï◊ú ◊ú◊ß◊ï◊ó◊ï◊™' }
                ],
                notes: '◊™◊†◊ê◊ô ◊™◊©◊ú◊ï◊ù: 40% ◊¢◊ù ◊ó◊™◊ô◊û◊™ ◊î◊î◊°◊õ◊ù, 40% ◊ú◊ê◊ó◊® ◊î◊©◊ú◊û◊™ ◊û◊ï◊ì◊ï◊ú ◊î-OCR, 20% ◊û◊°◊ô◊®◊™ ◊î◊§◊®◊ï◊ô◊ß◊ò. ◊û◊©◊ö ◊§◊®◊ï◊ô◊ß◊ò: 6 ◊©◊ë◊ï◊¢◊ï◊™. *◊û◊ï◊ì◊ú ◊ó◊ú◊ï◊ß◊™ ◊®◊ï◊ï◊ó◊ô◊ù ◊ô◊ô◊ë◊ó◊ü ◊ë◊î◊û◊©◊ö ◊ú◊ê◊ó◊® ◊°◊ô◊ï◊ù ◊î◊ë◊ô◊¶◊ï◊¢',
                created: '2026-01-05T08:00:00.000Z',
                sentDate: '2026-01-07T08:00:00.000Z',
                updated: new Date().toISOString()
            };
            proposals.push(sampleProposal);
            localStorage.setItem('proposals', JSON.stringify(proposals));
        }

        // Sample project for demo
        if (projects.length === 0) {
            const sampleProject = {
                id: 1001,
                projectNumber: 'PRJ-2026-001',
                proposalId: 2001,
                proposalNumber: 'LHD-001-26',
                clientId: 1001,
                clientName: 'LHD Insurance Consulting',
                clientEmail: 'moshe@lhd-insurance.co.il',
                name: 'Insurance Claims Management System',
                description: 'Digital transformation of claims processing workflow',
                type: 'development',
                totalBudget: 85000,
                totalHours: 320,
                startDate: '2026-01-05',
                expectedEndDate: '2026-03-30',
                actualEndDate: null,
                status: 'active',
                overallProgress: 52,
                stages: [
                    { id: 0, name: 'Discovery & Requirements', description: 'Understanding needs', estimatedHours: 32, actualHours: 30, status: 'completed', completionPercent: 100, startDate: '2026-01-05', completedDate: '2026-01-12', notes: 'All requirements documented, stakeholders interviewed', blockers: '', actionRequired: '' },
                    { id: 1, name: 'System Design', description: 'Architecture design', estimatedHours: 48, actualHours: 52, status: 'completed', completionPercent: 100, startDate: '2026-01-13', completedDate: '2026-01-25', notes: 'Database schema finalized, UI mockups approved', blockers: '', actionRequired: '' },
                    { id: 2, name: 'Development - Phase 1', description: 'Backend development', estimatedHours: 80, actualHours: 65, status: 'in_progress', completionPercent: 75, startDate: '2026-01-26', completedDate: null, notes: 'API endpoints 90% complete, authentication done, JWT auth implemented', blockers: 'Waiting for client API credentials for legacy system integration', actionRequired: 'Please provide API credentials and documentation for the legacy claims system (SOAP/REST endpoints, authentication keys)' },
                    { id: 3, name: 'Development - Phase 2', description: 'Frontend development', estimatedHours: 80, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '', actionRequired: '' },
                    { id: 4, name: 'Testing & QA', description: 'Quality assurance', estimatedHours: 48, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '', actionRequired: '' },
                    { id: 5, name: 'Deployment & Training', description: 'Go-live', estimatedHours: 32, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '', actionRequired: '' }
                ],
                totalHoursSpent: 147,
                shortId: 'lhd-001',
                shareToken: 'demo123abc',
                lastClientView: null,
                created: '2026-01-05T08:00:00.000Z',
                updated: new Date().toISOString(),
                // Technical details for client visibility
                technicalDetails: {
                    dbSchema: `claims (id, policy_id, status)
policies (id, client_id, type)
users (id, email, role)
audit_log (id, action, date)`,
                    apiEndpoints: `POST /api/claims
GET  /api/claims/:id
PUT  /api/claims/:id/status
GET  /api/policies
POST /api/auth/login`,
                    deliverables: [
                        { name: 'User authentication system', done: true },
                        { name: 'Claims submission API', done: true },
                        { name: 'Policy lookup service', done: true },
                        { name: 'Status update workflow', done: false },
                        { name: 'Legacy system integration', done: false },
                        { name: 'Admin dashboard', done: false }
                    ]
                }
            };
            projects.push(sampleProject);
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // TAG Urbanic proposal (add if not exists)
        if (!proposals.find(p => p.proposalNumber === 'DRS-2024-TAG')) {
            const tagProposal = {
                id: 2002,
                proposalNumber: 'DRS-2024-TAG',
                clientId: 1006,
                clientName: 'Tag Urbanic Investment Management',
                projectName: 'Monday.com to Excel - Automatic Data Sync',
                description: '◊ó◊ô◊ë◊ï◊® ◊û◊û◊©◊ß Monday.com ◊ú◊ê◊ß◊°◊ú ‚Äì ◊°◊†◊õ◊®◊ï◊ü ◊†◊™◊ï◊†◊ô◊ù ◊ê◊ï◊ò◊ï◊û◊ò◊ô. ◊û◊û◊©◊ß ◊™◊¶◊ï◊í◊î ◊ê◊ô◊†◊ò◊®◊†◊ò◊ô ◊©◊ô◊°◊™◊†◊õ◊®◊ü ◊ë◊†◊™◊ï◊†◊ô ◊ê◊û◊™ ◊û◊î◊û◊ê◊†◊ì◊ô◊ô ◊õ◊ú 4 ◊©◊¢◊ï◊™',
                amount: 7500,
                amountWithVat: 8775,
                currency: 'NIS',
                hours: 20,
                hourlyRate: 375,
                status: 'accepted',
                validUntil: '2025-01-09',
                proposalType: 'development',
                paidAmount: 3835,
                items: [
                    { description: '◊ê◊§◊ô◊ï◊ü ◊û◊ë◊†◊î ◊î◊†◊™◊ï◊†◊ô◊ù ◊î◊®◊ú◊ï◊ï◊†◊ò◊ô ◊ë◊û◊¢◊®◊õ◊™ Monday', hours: 5, amount: 1875 },
                    { description: '◊ó◊ô◊ë◊ï◊® ◊ò◊õ◊†◊ô ◊ë◊ô◊ü Monday ◊ú◊ë◊ô◊ü Excel ◊ë◊ê◊û◊¶◊¢◊ï◊™ API / ◊ê◊ï◊ò◊ï◊û◊¶◊ô◊î', hours: 8, amount: 3000 },
                    { description: '◊ë◊ì◊ô◊ß◊ï◊™ ◊™◊ß◊ô◊†◊ï◊™, ◊°◊†◊õ◊®◊ï◊ü ◊ï◊ô◊¶◊ô◊ë◊ï◊™', hours: 4, amount: 1500 },
                    { description: '◊û◊û◊©◊ß ◊™◊¶◊ï◊í◊î ◊ê◊ô◊†◊ò◊®◊†◊ò◊ô ◊©◊ô◊°◊™◊†◊õ◊®◊ü ◊ë◊†◊™◊ï◊†◊ô ◊ê◊û◊™ ◊û◊î◊û◊ê◊†◊ì◊ô◊ô ◊õ◊ú 4 ◊©◊¢◊ï◊™', hours: 3, amount: 1125 }
                ],
                notes: '◊™◊†◊ê◊ô ◊™◊©◊ú◊ï◊ù: 50% ◊¢◊ù ◊ê◊ô◊©◊ï◊® ◊¢◊ë◊ï◊ì◊î ◊ï-50% ◊¢◊ù ◊ß◊ë◊ú◊™ ◊î◊¢◊ë◊ï◊ì◊î ◊ï◊ê◊ô◊©◊ï◊®◊î. ◊î◊û◊ó◊ô◊®◊ô◊ù ◊ê◊ô◊†◊ù ◊õ◊ï◊ú◊ú◊ô◊ù ◊û◊¢"◊û. ◊û◊ê◊ï◊©◊®: ◊í◊ô◊ê ◊í◊§◊†◊ô 01/01/2026',
                created: '2024-12-25T08:00:00.000Z',
                sentDate: '2024-12-25T08:00:00.000Z',
                acceptedDate: '2026-01-01T08:00:00.000Z'
            };
            proposals.push(tagProposal);
            localStorage.setItem('proposals', JSON.stringify(proposals));
        }

        // TAG Urbanic project (completed)
        if (!projects.find(p => p.projectNumber === 'PRJ-2024-TAG')) {
            const tagProject = {
                id: 1002,
                projectNumber: 'PRJ-2024-TAG',
                proposalId: 2002,
                proposalNumber: 'DRS-2024-TAG',
                clientId: 1006,
                clientName: 'Tag Urbanic Investment Management',
                clientEmail: 'guy@tagurbanic.co.il',
                name: 'Monday.com to Excel - Data Sync Interface',
                description: 'Automatic data synchronization from Monday.com to Excel with 4-hour refresh',
                type: 'development',
                totalBudget: 8775,
                totalHours: 20,
                paidAmount: 3835,
                startDate: '2024-12-25',
                expectedEndDate: '2026-01-01',
                actualEndDate: '2026-01-01',
                status: 'completed',
                overallProgress: 100,
                stages: [
                    { id: 0, name: 'Data Structure Analysis', description: 'Monday.com mapping', estimatedHours: 4, actualHours: 4, status: 'completed', completionPercent: 100, startDate: '2024-12-25', completedDate: '2024-12-27', notes: 'Monday.com board structure mapped, all fields identified', blockers: '', actionRequired: '' },
                    { id: 1, name: 'API Integration Development', description: 'Monday to Excel connection', estimatedHours: 8, actualHours: 8, status: 'completed', completionPercent: 100, startDate: '2024-12-28', completedDate: '2024-12-30', notes: 'Monday.com API connected, Excel output configured', blockers: '', actionRequired: '' },
                    { id: 2, name: 'Testing & Validation', description: 'Sync verification', estimatedHours: 4, actualHours: 4, status: 'completed', completionPercent: 100, startDate: '2024-12-30', completedDate: '2024-12-31', notes: 'Data sync verified, 4-hour refresh cycle tested successfully', blockers: '', actionRequired: '' },
                    { id: 3, name: 'Deployment & Handover', description: 'Go-live and training', estimatedHours: 4, actualHours: 4, status: 'completed', completionPercent: 100, startDate: '2024-12-31', completedDate: '2026-01-01', notes: 'System live, client trained on usage', blockers: '', actionRequired: '' }
                ],
                totalHoursSpent: 20,
                shortId: 'tag-001',
                shareToken: 'tag001xyz',
                lastClientView: '2026-01-01T10:00:00.000Z',
                created: '2024-12-25T08:00:00.000Z',
                updated: '2026-01-01T12:00:00.000Z',
                technicalDetails: {
                    dbSchema: `Monday.com Boards:
- Properties (id, name, status, value)
- Investments (id, property_id, amount)
- Contacts (id, name, email, phone)`,
                    apiEndpoints: `GET /boards/{id}/items
GET /items/{id}/column_values
Excel Export: Auto-refresh every 4 hours
Webhook: Real-time updates`,
                    deliverables: [
                        { name: 'Monday.com API connection', done: true },
                        { name: 'Excel sync automation', done: true },
                        { name: '4-hour auto-refresh scheduler', done: true },
                        { name: 'Web display interface', done: true },
                        { name: 'Data validation tests', done: true },
                        { name: 'Client documentation & training', done: true }
                    ]
                }
            };
            projects.push(tagProject);
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // Stage templates by project type
        const stageTemplates = {
            development: [
                { name: 'Discovery & Requirements', percent: 10, description: 'Understanding needs, documenting requirements' },
                { name: 'System Design', percent: 15, description: 'Architecture, database design, UI mockups' },
                { name: 'Development - Phase 1', percent: 25, description: 'Core functionality, backend development' },
                { name: 'Development - Phase 2', percent: 25, description: 'Frontend, integrations, features' },
                { name: 'Testing & QA', percent: 15, description: 'Testing, bug fixes, quality assurance' },
                { name: 'Deployment & Training', percent: 10, description: 'Go-live, documentation, user training' }
            ],
            characterization: [
                { name: 'Initial Assessment', percent: 20, description: 'Current state analysis' },
                { name: 'Stakeholder Interviews', percent: 25, description: 'Gathering requirements from users' },
                { name: 'Requirements Documentation', percent: 30, description: 'Writing detailed specifications' },
                { name: 'Recommendations Report', percent: 25, description: 'Final deliverable with recommendations' }
            ],
            consulting: [
                { name: 'Kickoff & Discovery', percent: 15, description: 'Project initiation, understanding context' },
                { name: 'Analysis & Research', percent: 35, description: 'Deep dive, data analysis, research' },
                { name: 'Strategy Development', percent: 30, description: 'Developing recommendations' },
                { name: 'Final Deliverables', percent: 20, description: 'Reports, presentations, handoff' }
            ]
        };

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            if (password === ADMIN_PASSWORD || password === localStorage.getItem('adminPassword')) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                trackLogin();
                renderClients();
                updateStats();
            } else {
                alert('Invalid password');
            }
        });

        function logout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('password').value = '';
        }

        // Navigation
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;

                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                document.getElementById('page-' + page).classList.remove('hidden');

                trackPageView(page);

                if (page === 'proposals') {
                    renderProposals();
                    updateProposalClientSelect();
                }
                if (page === 'invoices') {
                    renderInvoices();
                    updateInvoiceStats();
                    updateInvoiceClientSelect();
                }
                if (page === 'expenses') {
                    renderExpenses();
                    updateExpenseStats();
                }
                if (page === 'projects') {
                    renderProjects();
                    updateProjectStats();
                }
                if (page === 'analytics') {
                    updateAnalytics();
                }
            });
        });

        // Modal functions
        function openModal(name) {
            document.getElementById('modal-' + name).classList.add('active');
            if (name === 'newProposal') {
                updateProposalClientSelect();
            }
            if (name === 'newInvoice') {
                updateInvoiceClientSelect();
            }
            if (name === 'newExpense') {
                // Set default date to today
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            }
            if (name === 'newProject') {
                updateProjectClientSelect();
                updateProjectProposalSelect();
                document.getElementById('projectStartDate').value = new Date().toISOString().split('T')[0];
                // Clear stages list
                document.getElementById('stagesList').innerHTML = '<div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">Select a project type to load stage template, or add stages manually</div>';
            }
        }

        function closeModal(name) {
            document.getElementById('modal-' + name).classList.remove('active');
            if (name === 'addClient') {
                resetClientForm();
            }
            if (name === 'newProposal') {
                resetProposalForm();
            }
            if (name === 'newInvoice') {
                resetInvoiceForm();
            }
            if (name === 'newExpense') {
                resetExpenseForm();
            }
            if (name === 'newProject') {
                resetProjectForm();
            }
        }

        // Contact management
        let contactIndex = 1;

        function addContactField() {
            const contactsList = document.getElementById('contactsList');
            const newContact = document.createElement('div');
            newContact.className = 'contact-entry';
            newContact.dataset.index = contactIndex;
            newContact.innerHTML = `
                <button type="button" class="btn-remove-contact" onclick="removeContact(this)">&times;</button>
                <div class="contact-row">
                    <input type="text" name="contact_name_${contactIndex}" placeholder="Name *" required>
                    <input type="text" name="contact_position_${contactIndex}" placeholder="Position">
                </div>
                <div class="contact-row">
                    <input type="email" name="contact_email_${contactIndex}" placeholder="Email *" required>
                    <input type="tel" name="contact_phone_${contactIndex}" placeholder="Phone">
                </div>
            `;
            contactsList.appendChild(newContact);
            contactIndex++;
        }

        function removeContact(btn) {
            const entry = btn.closest('.contact-entry');
            const contactsList = document.getElementById('contactsList');
            if (contactsList.children.length > 1) {
                entry.remove();
            } else {
                alert('At least one contact is required');
            }
        }

        function getContacts() {
            const contacts = [];
            const entries = document.querySelectorAll('#contactsList .contact-entry');
            entries.forEach(entry => {
                const idx = entry.dataset.index;
                const name = entry.querySelector(`input[name="contact_name_${idx}"]`).value;
                const email = entry.querySelector(`input[name="contact_email_${idx}"]`).value;
                if (name && email) {
                    contacts.push({
                        name: name,
                        position: entry.querySelector(`input[name="contact_position_${idx}"]`).value,
                        email: email,
                        phone: entry.querySelector(`input[name="contact_phone_${idx}"]`).value
                    });
                }
            });
            return contacts;
        }

        function resetContactFields() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = `
                <div class="contact-entry" data-index="0">
                    <div class="contact-row">
                        <input type="text" name="contact_name_0" placeholder="Name *" required>
                        <input type="text" name="contact_position_0" placeholder="Position">
                    </div>
                    <div class="contact-row">
                        <input type="email" name="contact_email_0" placeholder="Email *" required>
                        <input type="tel" name="contact_phone_0" placeholder="Phone">
                    </div>
                </div>
            `;
            contactIndex = 1;
        }

        // Client management
        document.getElementById('addClientForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const contacts = getContacts();
            if (contacts.length === 0) {
                alert('Please add at least one contact');
                return;
            }

            if (editingClientId) {
                // Update existing client
                const clientIndex = clients.findIndex(c => c.id === editingClientId);
                if (clientIndex !== -1) {
                    clients[clientIndex] = {
                        ...clients[clientIndex],
                        company: document.getElementById('clientCompany').value,
                        contacts: contacts,
                        contact: contacts[0].name,
                        position: contacts[0].position,
                        email: contacts[0].email,
                        phone: contacts[0].phone,
                        industry: document.getElementById('clientIndustry').value,
                        notes: document.getElementById('clientNotes').value,
                        updated: new Date().toISOString()
                    };
                }
                saveData();
                renderClients();
                updateStats();
                closeModal('addClient');
                resetClientForm();
                showToast('Client updated successfully!');
            } else {
                // Add new client
                const client = {
                    id: Date.now(),
                    company: document.getElementById('clientCompany').value,
                    contacts: contacts,
                    contact: contacts[0].name,
                    position: contacts[0].position,
                    email: contacts[0].email,
                    phone: contacts[0].phone,
                    industry: document.getElementById('clientIndustry').value,
                    notes: document.getElementById('clientNotes').value,
                    status: 'active',
                    created: new Date().toISOString()
                };

                clients.push(client);
                saveData();
                renderClients();
                updateStats();
                closeModal('addClient');
                this.reset();
                resetContactFields();
                showToast('Client added successfully!');
            }
        });

        function renderClients(filteredClients = null) {
            const tbody = document.getElementById('clientsTable');
            const clientsToRender = filteredClients || clients;

            if (clientsToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">No clients found</td></tr>';
                return;
            }

            tbody.innerHTML = clientsToRender.map(client => {
                const contacts = client.contacts || [{ name: client.contact, position: client.position, email: client.email, phone: client.phone }];
                const contactsHtml = contacts.map(c => `${c.name}${c.position ? ' (' + c.position + ')' : ''}`).join('<br>');
                const emailsHtml = contacts.map(c => c.email).join('<br>');
                const contactCount = contacts.length > 1 ? `<span style="color: var(--primary); font-size: 11px;">(${contacts.length} contacts)</span>` : '';

                return `
                <tr>
                    <td><strong>${client.company}</strong><br><small style="color: var(--gray)">${client.industry || 'N/A'}</small></td>
                    <td>${contactsHtml} ${contactCount}</td>
                    <td><small>${emailsHtml}</small></td>
                    <td><span class="status-badge status-active">Active</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-secondary btn-sm" onclick="editClient(${client.id})">Edit</button>
                            <button class="btn btn-secondary btn-sm" onclick="createProposalFor(${client.id})">Proposal</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteClient(${client.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function filterClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase().trim();
            const industryFilter = document.getElementById('clientIndustryFilter').value;

            let filtered = clients;

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(client => {
                    const contacts = client.contacts || [{ name: client.contact, email: client.email }];
                    const contactMatch = contacts.some(c =>
                        (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                        (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                        (c.position && c.position.toLowerCase().includes(searchTerm))
                    );
                    return client.company.toLowerCase().includes(searchTerm) ||
                           (client.industry && client.industry.toLowerCase().includes(searchTerm)) ||
                           contactMatch;
                });
            }

            // Filter by industry
            if (industryFilter) {
                filtered = filtered.filter(client => client.industry === industryFilter);
            }

            renderClients(filtered);
        }

        function deleteClient(id) {
            if (confirm('Delete this client?')) {
                clients = clients.filter(c => c.id !== id);
                saveData();
                renderClients();
                updateStats();
                showToast('Client deleted');
            }
        }

        // Edit client
        let editingClientId = null;

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            editingClientId = id;

            // Update modal title
            document.querySelector('#modal-addClient .modal-title').textContent = 'Edit Client';
            document.querySelector('#modal-addClient form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields
            document.getElementById('clientCompany').value = client.company;
            document.getElementById('clientIndustry').value = client.industry || '';
            document.getElementById('clientNotes').value = client.notes || '';

            // Fill contacts
            const contacts = client.contacts || [{
                name: client.contact,
                position: client.position,
                email: client.email,
                phone: client.phone
            }];

            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            contactIndex = 0;

            contacts.forEach((contact, idx) => {
                const isFirst = idx === 0;
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact-entry';
                contactDiv.dataset.index = idx;
                contactDiv.innerHTML = `
                    ${!isFirst ? '<button type="button" class="btn-remove-contact" onclick="removeContact(this)">&times;</button>' : ''}
                    <div class="contact-row">
                        <input type="text" name="contact_name_${idx}" placeholder="Name *" value="${contact.name || ''}" required>
                        <input type="text" name="contact_position_${idx}" placeholder="Position" value="${contact.position || ''}">
                    </div>
                    <div class="contact-row">
                        <input type="email" name="contact_email_${idx}" placeholder="Email *" value="${contact.email || ''}" required>
                        <input type="tel" name="contact_phone_${idx}" placeholder="Phone" value="${contact.phone || ''}">
                    </div>
                `;
                contactsList.appendChild(contactDiv);
                contactIndex = idx + 1;
            });

            openModal('addClient');
        }

        function resetClientForm() {
            editingClientId = null;
            document.querySelector('#modal-addClient .modal-title').textContent = 'Add New Client';
            document.querySelector('#modal-addClient form button[type="submit"]').textContent = 'Add Client';
            document.getElementById('addClientForm').reset();
            resetContactFields();
        }

        function createProposalFor(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                openModal('newProposal');
                setTimeout(() => {
                    document.getElementById('proposalClient').value = clientId;
                }, 100);
            }
        }

        // Proposal management
        document.getElementById('newProposalForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const clientId = parseInt(document.getElementById('proposalClient').value);
            const client = clients.find(c => c.id === clientId);

            if (editingProposalId) {
                // Update existing proposal
                const proposalIndex = proposals.findIndex(p => p.id === editingProposalId);
                if (proposalIndex !== -1) {
                    proposals[proposalIndex] = {
                        ...proposals[proposalIndex],
                        clientId: clientId,
                        clientName: client ? client.company : 'Unknown',
                        projectName: document.getElementById('proposalProject').value,
                        amount: parseInt(document.getElementById('proposalAmount').value),
                        hours: parseInt(document.getElementById('proposalHours').value) || 0,
                        proposalType: document.getElementById('proposalType').value,
                        description: document.getElementById('proposalDesc').value,
                        updated: new Date().toISOString()
                    };
                }
                saveData();
                renderProposals();
                updateStats();
                closeModal('newProposal');
                resetProposalForm();
                showToast('Proposal updated!');
            } else {
                // Create new proposal
                const proposal = {
                    id: Date.now(),
                    proposalNumber: 'DRS-2026-' + String(proposals.length + 1).padStart(3, '0'),
                    clientId: clientId,
                    clientName: client ? client.company : 'Unknown',
                    projectName: document.getElementById('proposalProject').value,
                    amount: parseInt(document.getElementById('proposalAmount').value),
                    hours: parseInt(document.getElementById('proposalHours').value) || 0,
                    proposalType: document.getElementById('proposalType').value,
                    description: document.getElementById('proposalDesc').value,
                    status: 'draft',
                    created: new Date().toISOString()
                };

                proposals.push(proposal);
                saveData();
                renderProposals();
                updateStats();
                closeModal('newProposal');
                this.reset();
                showToast('Proposal created!');
            }
        });

        function renderProposals() {
            const tbody = document.getElementById('proposalsTable');
            tbody.innerHTML = proposals.map(p => {
                const hasProject = projects.some(proj => proj.proposalId === p.id);
                const number = p.proposalNumber || p.number || 'N/A';
                const project = p.projectName || p.project || 'N/A';
                const version = p.version || '1.0';
                const statusColors = {
                    'draft': 'pending',
                    'sent': 'sent',
                    'accepted': 'active',
                    'active': 'active',
                    'working': 'active',
                    'completed': 'active'
                };
                const statusClass = statusColors[p.status] || 'pending';
                const statusLabels = {
                    'draft': 'Draft',
                    'sent': 'Sent',
                    'accepted': 'Accepted',
                    'active': 'Active',
                    'working': 'Working',
                    'completed': 'Completed'
                };
                return `
                <tr>
                    <td><strong>${number}</strong> <span style="color: var(--gray); font-size: 10px;">v${version}</span></td>
                    <td>${p.clientName}</td>
                    <td>${project}</td>
                    <td>‚Ç™${p.amount.toLocaleString()}</td>
                    <td>
                        <select onchange="changeProposalStatus(${p.id}, this.value)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 4px 8px; color: var(--light); font-size: 11px; cursor: pointer;">
                            <option value="draft" ${p.status === 'draft' ? 'selected' : ''}>Draft</option>
                            <option value="sent" ${p.status === 'sent' ? 'selected' : ''}>Sent</option>
                            <option value="accepted" ${p.status === 'accepted' ? 'selected' : ''}>Accepted</option>
                            <option value="active" ${p.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="working" ${p.status === 'working' ? 'selected' : ''}>Working</option>
                            <option value="completed" ${p.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-success btn-sm" onclick="previewProposal(${p.id})" title="Preview">üëÅ</button>
                            <button class="btn btn-primary btn-sm" onclick="openProposalEditor(${p.id})">Edit</button>
                            <button class="btn btn-secondary btn-sm" onclick="copyProposalLink(${p.id})">Copy Link</button>
                            ${!hasProject ? `<button class="btn btn-secondary btn-sm" onclick="convertToProject(${p.id})">‚Üí Project</button>` : ''}
                            ${hasProject ? `<span style="color: var(--success); font-size: 11px;">‚úì Project</span>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteProposal(${p.id})">√ó</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function changeProposalStatus(id, newStatus) {
            const proposal = proposals.find(p => p.id === id);
            if (proposal) {
                proposal.status = newStatus;
                if (newStatus === 'accepted') proposal.acceptedDate = new Date().toISOString();
                if (newStatus === 'active' || newStatus === 'working') proposal.activatedDate = new Date().toISOString();
                proposal.updated = new Date().toISOString();
                saveData();
                updateStats();
                showToast(`Status changed to ${newStatus}`);
            }
        }

        function copyProposalLink(id) {
            const proposal = proposals.find(p => p.id === id);
            if (!proposal) return;

            // Generate short ID based on proposal number
            const shortId = (proposal.proposalNumber || proposal.number || '').toLowerCase().replace('drs-2026-', '').replace('drs-2024-', '') || id;
            const link = `https://drishticonsulting.com/proposal-view.html?p=lhd-001`;

            navigator.clipboard.writeText('https://tinyurl.com/drishti-lhd-v2').then(() => {
                showToast('Link copied: tinyurl.com/drishti-lhd-v2');
            }).catch(() => {
                prompt('Copy this link:', 'https://tinyurl.com/drishti-lhd-v2');
            });
        }

        function openProposalEditor(id) {
            window.open('proposal-editor.html?id=' + id, '_blank');
        }

        function previewProposal(id) {
            // Open the client-facing proposal view
            window.open('proposal-view.html?p=lhd-001', '_blank');
        }

        function markAccepted(id) {
            const proposal = proposals.find(p => p.id === id);
            if (proposal) {
                proposal.status = 'accepted';
                proposal.acceptedDate = new Date().toISOString();
                saveData();
                renderProposals();
                updateStats();
                showToast('Proposal accepted!');
            }
        }

        function generateProposal(id) {
            const proposal = proposals.find(p => p.id === id);
            const client = clients.find(c => c.id === proposal.clientId);

            // Handle both old and new field names
            const projectName = proposal.projectName || proposal.project || '';
            const proposalNumber = proposal.proposalNumber || proposal.number || '';

            // Open proposal template in new window
            const proposalUrl = `proposal-template.html?client=${encodeURIComponent(client?.company || '')}&project=${encodeURIComponent(projectName)}&amount=${proposal.amount}&number=${proposalNumber}`;
            window.open(proposalUrl, '_blank');

            showToast('Generating proposal...');
        }

        function markSent(id) {
            const proposal = proposals.find(p => p.id === id);
            if (proposal) {
                proposal.status = 'sent';
                saveData();
                renderProposals();
                updateStats();
                showToast('Marked as sent');
            }
        }

        function deleteProposal(id) {
            if (confirm('Delete this proposal?')) {
                proposals = proposals.filter(p => p.id !== id);
                saveData();
                renderProposals();
                updateStats();
                showToast('Proposal deleted');
            }
        }

        // Edit proposal
        let editingProposalId = null;

        function editProposal(id) {
            const proposal = proposals.find(p => p.id === id);
            if (!proposal) return;

            editingProposalId = id;

            // Update modal title
            document.querySelector('#modal-newProposal .modal-title').textContent = 'Edit Proposal';
            document.querySelector('#modal-newProposal form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields (handle both old and new field names)
            document.getElementById('proposalClient').value = proposal.clientId;
            document.getElementById('proposalProject').value = proposal.projectName || proposal.project || '';
            document.getElementById('proposalAmount').value = proposal.amount;
            document.getElementById('proposalHours').value = proposal.hours || '';
            document.getElementById('proposalType').value = proposal.proposalType || proposal.type || 'development';
            document.getElementById('proposalDesc').value = proposal.description || '';

            openModal('newProposal');
        }

        function resetProposalForm() {
            editingProposalId = null;
            document.querySelector('#modal-newProposal .modal-title').textContent = 'Create New Proposal';
            document.querySelector('#modal-newProposal form button[type="submit"]').textContent = 'Create Proposal';
            document.getElementById('newProposalForm').reset();
        }

        function updateProposalClientSelect() {
            const select = document.getElementById('proposalClient');
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${c.id}">${c.company}</option>`).join('');
        }

        // Stats
        function updateStats() {
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('activeProjects').textContent = proposals.filter(p => p.status !== 'completed').length;
            document.getElementById('proposalsSent').textContent = proposals.filter(p => p.status === 'sent').length;
            document.getElementById('pendingProposals').textContent = proposals.filter(p => p.status === 'draft').length;
            updateAnalytics();
        }

        // Analytics tracking
        let analytics = JSON.parse(localStorage.getItem('analytics')) || {
            logins: 0,
            pageViews: 0,
            proposalsViewed: 0,
            lastLogin: null,
            activities: []
        };

        function trackLogin() {
            analytics.logins++;
            analytics.lastLogin = new Date().toISOString();
            logActivity('Logged in');
            saveAnalytics();
        }

        function trackPageView(page) {
            analytics.pageViews++;
            logActivity(`Viewed ${page} page`);
            saveAnalytics();
        }

        function trackProposalView() {
            analytics.proposalsViewed++;
            logActivity('Viewed proposal');
            saveAnalytics();
        }

        function logActivity(action) {
            analytics.activities.unshift({
                action: action,
                timestamp: new Date().toISOString()
            });
            // Keep only last 50 activities
            if (analytics.activities.length > 50) {
                analytics.activities = analytics.activities.slice(0, 50);
            }
        }

        function saveAnalytics() {
            localStorage.setItem('analytics', JSON.stringify(analytics));
        }

        function updateAnalytics() {
            document.getElementById('totalLogins').textContent = analytics.logins;
            document.getElementById('pageViews').textContent = analytics.pageViews;
            document.getElementById('proposalsViewed').textContent = analytics.proposalsViewed;
            document.getElementById('lastLogin').textContent = analytics.lastLogin
                ? new Date(analytics.lastLogin).toLocaleString('he-IL')
                : '-';

            // Render activity log
            const activityLog = document.getElementById('activityLog');
            if (analytics.activities.length > 0) {
                activityLog.innerHTML = analytics.activities.slice(0, 20).map(a => `
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px;">
                        <span>${a.action}</span>
                        <span style="color: var(--gray);">${new Date(a.timestamp).toLocaleString('he-IL')}</span>
                    </div>
                `).join('');
            }
        }

        // Settings
        function saveSettings() {
            const key = document.getElementById('airtableKey').value;
            const base = document.getElementById('airtableBase').value;
            localStorage.setItem('airtableKey', key);
            localStorage.setItem('airtableBase', base);
            showToast('Settings saved!');
        }

        function changePassword() {
            const newPass = document.getElementById('newPassword').value;
            if (newPass && newPass.length >= 6) {
                localStorage.setItem('adminPassword', newPass);
                showToast('Password updated!');
                document.getElementById('newPassword').value = '';
            } else {
                alert('Password must be at least 6 characters');
            }
        }

        // Load saved settings
        document.getElementById('airtableKey').value = localStorage.getItem('airtableKey') || '';
        document.getElementById('airtableBase').value = localStorage.getItem('airtableBase') || '';

        // Data persistence
        function saveData() {
            localStorage.setItem('clients', JSON.stringify(clients));
            localStorage.setItem('proposals', JSON.stringify(proposals));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // Invoice management
        let editingInvoiceId = null;

        document.getElementById('newInvoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const clientId = parseInt(document.getElementById('invoiceClient').value);
            const client = clients.find(c => c.id === clientId);

            if (editingInvoiceId) {
                // Update existing invoice
                const invoiceIndex = invoices.findIndex(inv => inv.id === editingInvoiceId);
                if (invoiceIndex !== -1) {
                    invoices[invoiceIndex] = {
                        ...invoices[invoiceIndex],
                        number: document.getElementById('invoiceNumber').value,
                        clientId: clientId,
                        clientName: client ? client.company : 'Unknown',
                        amount: parseFloat(document.getElementById('invoiceAmount').value),
                        date: document.getElementById('invoiceDate').value,
                        dueDate: document.getElementById('invoiceDueDate').value,
                        description: document.getElementById('invoiceDesc').value,
                        updated: new Date().toISOString()
                    };
                }
                saveData();
                renderInvoices();
                updateInvoiceStats();
                closeModal('newInvoice');
                resetInvoiceForm();
                showToast('Invoice updated!');
            } else {
                // Create new invoice
                const invoice = {
                    id: Date.now(),
                    number: document.getElementById('invoiceNumber').value,
                    clientId: clientId,
                    clientName: client ? client.company : 'Unknown',
                    amount: parseFloat(document.getElementById('invoiceAmount').value),
                    date: document.getElementById('invoiceDate').value,
                    dueDate: document.getElementById('invoiceDueDate').value,
                    description: document.getElementById('invoiceDesc').value,
                    status: 'pending',
                    created: new Date().toISOString()
                };

                invoices.push(invoice);
                saveData();
                renderInvoices();
                updateInvoiceStats();
                closeModal('newInvoice');
                this.reset();
                showToast('Invoice created!');
            }
        });

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            editingInvoiceId = id;

            // Update modal title
            document.querySelector('#modal-newInvoice .modal-title').textContent = 'Edit Invoice';
            document.querySelector('#modal-newInvoice form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields
            updateInvoiceClientSelect();
            document.getElementById('invoiceClient').value = invoice.clientId;
            document.getElementById('invoiceNumber').value = invoice.number;
            document.getElementById('invoiceAmount').value = invoice.amount;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate;
            document.getElementById('invoiceDesc').value = invoice.description || '';

            openModal('newInvoice');
        }

        function resetInvoiceForm() {
            editingInvoiceId = null;
            document.querySelector('#modal-newInvoice .modal-title').textContent = 'Create Invoice';
            document.querySelector('#modal-newInvoice form button[type="submit"]').textContent = 'Create Invoice';
            document.getElementById('newInvoiceForm').reset();
        }

        function renderInvoices() {
            const tbody = document.getElementById('invoicesTable');
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">No invoices yet</td></tr>';
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const dueDate = new Date(inv.dueDate);
                const today = new Date();
                const isOverdue = inv.status === 'pending' && dueDate < today;
                const statusClass = inv.status === 'paid' ? 'status-active' : (isOverdue ? 'status-badge' : 'status-pending');
                const statusStyle = isOverdue && inv.status !== 'paid' ? 'background: rgba(239, 68, 68, 0.1); color: #ef4444;' : '';
                const statusText = inv.status === 'paid' ? 'Paid' : (isOverdue ? 'Overdue' : 'Pending');

                return `
                <tr>
                    <td><strong>${inv.number}</strong></td>
                    <td>${inv.clientName}</td>
                    <td>‚Ç™${inv.amount.toLocaleString()}</td>
                    <td>${new Date(inv.dueDate).toLocaleDateString('he-IL')}</td>
                    <td><span class="status-badge ${statusClass}" style="${statusStyle}">${statusText}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-secondary btn-sm" onclick="editInvoice(${inv.id})">Edit</button>
                            ${inv.status !== 'paid' ? `<button class="btn btn-success btn-sm" onclick="markInvoicePaid(${inv.id})">Mark Paid</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice(${inv.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function markInvoicePaid(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                invoice.status = 'paid';
                invoice.paidDate = new Date().toISOString();
                saveData();
                renderInvoices();
                updateInvoiceStats();
                showToast('Invoice marked as paid');
            }
        }

        function deleteInvoice(id) {
            if (confirm('Delete this invoice?')) {
                invoices = invoices.filter(inv => inv.id !== id);
                saveData();
                renderInvoices();
                updateInvoiceStats();
                showToast('Invoice deleted');
            }
        }

        function updateInvoiceStats() {
            const total = invoices.reduce((sum, inv) => sum + inv.amount, 0);
            const paid = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + inv.amount, 0);
            const pending = invoices.filter(inv => inv.status === 'pending').reduce((sum, inv) => sum + inv.amount, 0);

            const today = new Date();
            const overdue = invoices.filter(inv => {
                return inv.status === 'pending' && new Date(inv.dueDate) < today;
            }).reduce((sum, inv) => sum + inv.amount, 0);

            document.getElementById('totalInvoiced').textContent = '‚Ç™' + total.toLocaleString();
            document.getElementById('totalPaid').textContent = '‚Ç™' + paid.toLocaleString();
            document.getElementById('totalPending').textContent = '‚Ç™' + (pending - overdue).toLocaleString();
            document.getElementById('totalOverdue').textContent = '‚Ç™' + overdue.toLocaleString();
        }

        function updateInvoiceClientSelect() {
            const select = document.getElementById('invoiceClient');
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${c.id}">${c.company}</option>`).join('');

            // Set default invoice number
            const nextNum = invoices.length + 1;
            document.getElementById('invoiceNumber').value = 'INV-' + String(nextNum).padStart(3, '0');

            // Set default dates
            const today = new Date();
            document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
            const dueDate = new Date(today.setDate(today.getDate() + 30));
            document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
        }

        // Expense management
        let editingExpenseId = null;

        document.getElementById('newExpenseForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (editingExpenseId) {
                // Update existing expense
                const expenseIndex = expenses.findIndex(exp => exp.id === editingExpenseId);
                if (expenseIndex !== -1) {
                    expenses[expenseIndex] = {
                        ...expenses[expenseIndex],
                        description: document.getElementById('expenseDesc').value,
                        amount: parseFloat(document.getElementById('expenseAmount').value),
                        date: document.getElementById('expenseDate').value,
                        category: document.getElementById('expenseCategory').value,
                        notes: document.getElementById('expenseNotes').value,
                        updated: new Date().toISOString()
                    };
                }
                saveData();
                renderExpenses();
                updateExpenseStats();
                closeModal('newExpense');
                resetExpenseForm();
                showToast('Expense updated!');
            } else {
                // Create new expense
                const expense = {
                    id: Date.now(),
                    description: document.getElementById('expenseDesc').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    date: document.getElementById('expenseDate').value,
                    category: document.getElementById('expenseCategory').value,
                    notes: document.getElementById('expenseNotes').value,
                    created: new Date().toISOString()
                };

                expenses.push(expense);
                saveData();
                renderExpenses();
                updateExpenseStats();
                closeModal('newExpense');
                this.reset();
                showToast('Expense added!');
            }
        });

        function editExpense(id) {
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) return;

            editingExpenseId = id;

            // Update modal title
            document.querySelector('#modal-newExpense .modal-title').textContent = 'Edit Expense';
            document.querySelector('#modal-newExpense form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields
            document.getElementById('expenseDesc').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseNotes').value = expense.notes || '';

            openModal('newExpense');
        }

        function resetExpenseForm() {
            editingExpenseId = null;
            document.querySelector('#modal-newExpense .modal-title').textContent = 'Add Expense';
            document.querySelector('#modal-newExpense form button[type="submit"]').textContent = 'Add Expense';
            document.getElementById('newExpenseForm').reset();
        }

        function renderExpenses() {
            const tbody = document.getElementById('expensesTable');
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">No expenses yet</td></tr>';
                return;
            }

            // Sort by date descending
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sortedExpenses.map(exp => `
                <tr>
                    <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                    <td><strong>${exp.description}</strong>${exp.notes ? `<br><small style="color: var(--gray);">${exp.notes}</small>` : ''}</td>
                    <td><span class="status-badge" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">${exp.category}</span></td>
                    <td>‚Ç™${exp.amount.toLocaleString()}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-secondary btn-sm" onclick="editExpense(${exp.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExpense(${exp.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Render recent expenses in sidebar
            const recentExpenses = document.getElementById('recentExpenses');
            if (sortedExpenses.length > 0) {
                recentExpenses.innerHTML = sortedExpenses.slice(0, 5).map(exp => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px;">
                        <span>${exp.description}</span>
                        <span style="color: var(--warning);">‚Ç™${exp.amount.toLocaleString()}</span>
                    </div>
                `).join('');
            }

            // Render category breakdown
            renderExpensesByCategory();
        }

        function renderExpensesByCategory() {
            const categoryTotals = {};
            expenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const expensesByCategory = document.getElementById('expensesByCategory');
            if (Object.keys(categoryTotals).length === 0) {
                expensesByCategory.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No expenses yet</div>';
                return;
            }

            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);

            expensesByCategory.innerHTML = sortedCategories.map(([category, amount]) => {
                const percentage = ((amount / total) * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
                            <span>${category}</span>
                            <span>‚Ç™${amount.toLocaleString()} (${percentage}%)</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 6px; overflow: hidden;">
                            <div style="background: var(--gradient); height: 100%; width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                expenses = expenses.filter(exp => exp.id !== id);
                saveData();
                renderExpenses();
                updateExpenseStats();
                showToast('Expense deleted');
            }
        }

        function updateExpenseStats() {
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();

            const monthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === thisMonth && expDate.getFullYear() === thisYear;
            }).reduce((sum, exp) => sum + exp.amount, 0);

            const yearExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getFullYear() === thisYear;
            }).reduce((sum, exp) => sum + exp.amount, 0);

            const categories = [...new Set(expenses.map(exp => exp.category))];

            // Calculate average monthly (over all months with expenses)
            const monthsWithExpenses = new Set();
            expenses.forEach(exp => {
                const d = new Date(exp.date);
                monthsWithExpenses.add(`${d.getFullYear()}-${d.getMonth()}`);
            });
            const avgMonthly = monthsWithExpenses.size > 0
                ? expenses.reduce((sum, exp) => sum + exp.amount, 0) / monthsWithExpenses.size
                : 0;

            document.getElementById('expensesMonth').textContent = '‚Ç™' + monthExpenses.toLocaleString();
            document.getElementById('expensesYear').textContent = '‚Ç™' + yearExpenses.toLocaleString();
            document.getElementById('expenseCategories').textContent = categories.length;
            document.getElementById('expensesAvg').textContent = '‚Ç™' + Math.round(avgMonthly).toLocaleString();
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // =============================================
        // PROJECT MANAGEMENT
        // =============================================

        let currentStages = [];
        let stageIndex = 0;
        let currentManagingProjectId = null;

        function updateProjectClientSelect() {
            const select = document.getElementById('projectClient');
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${c.id}">${c.company}</option>`).join('');
        }

        function updateProjectProposalSelect() {
            const select = document.getElementById('projectProposal');
            const sentProposals = proposals.filter(p => p.status === 'sent');
            select.innerHTML = '<option value="">No proposal linked</option>' +
                sentProposals.map(p => `<option value="${p.id}">${p.number} - ${p.project} (‚Ç™${p.amount.toLocaleString()})</option>`).join('');
        }

        function loadStageTemplate() {
            const type = document.getElementById('projectType').value;
            const totalHours = parseInt(document.getElementById('projectHours').value) || 0;

            if (type && type !== 'custom' && stageTemplates[type]) {
                currentStages = stageTemplates[type].map((stage, idx) => ({
                    id: idx, name: stage.name, description: stage.description,
                    estimatedHours: totalHours > 0 ? Math.round(totalHours * stage.percent / 100) : 0,
                    percent: stage.percent, actualHours: 0, status: 'not_started',
                    completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: ''
                }));
                stageIndex = currentStages.length;
            } else if (type === 'custom') {
                currentStages = [];
                stageIndex = 0;
            }
            renderStagesList();
        }

        function recalculateStageHours() {
            const totalHours = parseInt(document.getElementById('projectHours').value) || 0;
            currentStages.forEach(stage => {
                if (stage.percent) stage.estimatedHours = Math.round(totalHours * stage.percent / 100);
            });
            renderStagesList();
        }

        function addProjectStage() {
            currentStages.push({ id: stageIndex++, name: '', description: '', estimatedHours: 0, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '' });
            renderStagesList();
        }

        function removeStage(id) {
            currentStages = currentStages.filter(s => s.id !== id);
            renderStagesList();
        }

        function renderStagesList() {
            const container = document.getElementById('stagesList');
            if (currentStages.length === 0) {
                container.innerHTML = '<div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">Select a project type to load stage template, or add stages manually</div>';
                return;
            }
            container.innerHTML = currentStages.map((stage, idx) => `
                <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative;">
                    <button type="button" onclick="removeStage(${stage.id})" style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 14px;">&times;</button>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                        <span style="background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${idx + 1}</span>
                        <input type="text" value="${stage.name}" placeholder="Stage name" onchange="updateStageName(${stage.id}, this.value)" style="flex: 1; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 13px;">
                        <input type="number" value="${stage.estimatedHours}" placeholder="Hours" onchange="updateStageHours(${stage.id}, this.value)" style="width: 80px; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 13px; text-align: center;">
                    </div>
                    <input type="text" value="${stage.description || ''}" placeholder="Stage description (optional)" onchange="updateStageDescription(${stage.id}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 12px;">
                </div>
            `).join('');
        }

        function updateStageName(id, value) { const s = currentStages.find(s => s.id === id); if (s) s.name = value; }
        function updateStageHours(id, value) { const s = currentStages.find(s => s.id === id); if (s) s.estimatedHours = parseInt(value) || 0; }
        function updateStageDescription(id, value) { const s = currentStages.find(s => s.id === id); if (s) s.description = value; }

        function generateShareToken() { return Math.random().toString(36).substring(2, 10) + Date.now().toString(36); }

        document.getElementById('newProjectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (currentStages.length === 0) { alert('Please add at least one project stage'); return; }
            if (currentStages.filter(s => !s.name.trim()).length > 0) { alert('All stages must have a name'); return; }

            const clientId = parseInt(document.getElementById('projectClient').value);
            const client = clients.find(c => c.id === clientId);
            const proposalId = parseInt(document.getElementById('projectProposal').value) || null;
            const proposal = proposalId ? proposals.find(p => p.id === proposalId) : null;

            const project = {
                id: Date.now(),
                projectNumber: 'PRJ-2026-' + String(projects.length + 1).padStart(3, '0'),
                proposalId, proposalNumber: proposal ? proposal.number : null,
                clientId, clientName: client ? client.company : 'Unknown',
                clientEmail: client && client.contacts ? client.contacts[0].email : '',
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                type: document.getElementById('projectType').value,
                totalBudget: parseFloat(document.getElementById('projectBudget').value),
                totalHours: parseInt(document.getElementById('projectHours').value),
                startDate: document.getElementById('projectStartDate').value,
                expectedEndDate: document.getElementById('projectEndDate').value,
                actualEndDate: null, status: 'active', overallProgress: 0,
                stages: currentStages.map((s, idx) => ({ ...s, id: idx })),
                totalHoursSpent: 0, shareToken: generateShareToken(),
                lastClientView: null, created: new Date().toISOString(), updated: new Date().toISOString()
            };

            projects.push(project);
            saveData();
            renderProjects();
            updateProjectStats();
            closeModal('newProject');
            this.reset();
            currentStages = [];
            showToast('Project created!');
        });

        function resetProjectForm() {
            document.getElementById('newProjectForm').reset();
            currentStages = [];
            stageIndex = 0;
            document.getElementById('stagesList').innerHTML = '<div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">Select a project type to load stage template, or add stages manually</div>';
        }

        function renderProjects(filteredProjects = null) {
            const tbody = document.getElementById('projectsTable');
            const list = filteredProjects || projects;
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">No projects yet</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(p => {
                const progress = p.overallProgress || 0;
                const statusColors = { active: 'status-active', on_hold: 'status-pending', completed: 'status-sent' };
                return `<tr>
                    <td><strong>${p.projectNumber}</strong></td>
                    <td>${p.clientName}</td>
                    <td>${p.name}</td>
                    <td style="min-width: 150px;"><div style="display: flex; align-items: center; gap: 8px;"><div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;"><div style="background: var(--gradient); height: 100%; width: ${progress}%;"></div></div><span style="font-size: 12px;">${progress}%</span></div></td>
                    <td><span class="status-badge ${statusColors[p.status] || 'status-pending'}">${p.status.replace('_', ' ')}</span></td>
                    <td><div class="action-btns"><button class="btn btn-primary btn-sm" onclick="openProjectManagement(${p.id})">Manage</button><button class="btn btn-danger btn-sm" onclick="deleteProject(${p.id})">Delete</button></div></td>
                </tr>`;
            }).join('');
        }

        function filterProjects() {
            const search = document.getElementById('projectSearch').value.toLowerCase().trim();
            const status = document.getElementById('projectStatusFilter').value;
            let filtered = projects;
            if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search) || p.clientName.toLowerCase().includes(search) || p.projectNumber.toLowerCase().includes(search));
            if (status) filtered = filtered.filter(p => p.status === status);
            renderProjects(filtered);
        }

        function updateProjectStats() {
            document.getElementById('activeProjectsCount').textContent = projects.filter(p => p.status === 'active').length;
            document.getElementById('totalProjectsCount').textContent = projects.length;
            document.getElementById('onTrackProjects').textContent = projects.filter(p => p.status === 'active' && p.overallProgress > 0).length;
            document.getElementById('attentionProjects').textContent = projects.filter(p => p.status === 'on_hold').length;
        }

        function deleteProject(id) {
            if (confirm('Delete this project?')) {
                projects = projects.filter(p => p.id !== id);
                saveData(); renderProjects(); updateProjectStats();
                showToast('Project deleted');
            }
        }

        function openProjectManagement(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            currentManagingProjectId = id;
            document.getElementById('manageProjectTitle').textContent = project.projectNumber + ': ' + project.name;

            const totalHoursSpent = project.stages.reduce((sum, s) => sum + (s.actualHours || 0), 0);
            const completedStages = project.stages.filter(s => s.status === 'completed').length;

            const content = `
                <div style="margin-bottom: 20px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;"><span style="color: var(--gray-light);">Client: ${project.clientName}</span><span style="color: var(--gray-light);">Budget: ‚Ç™${project.totalBudget.toLocaleString()}</span></div>
                    <div style="margin-bottom: 8px; font-size: 14px;">Overall Progress</div>
                    <div style="display: flex; align-items: center; gap: 12px;"><div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 6px; height: 12px; overflow: hidden;"><div style="background: var(--gradient); height: 100%; width: ${project.overallProgress}%;"></div></div><span style="font-size: 18px; font-weight: 600;">${project.overallProgress}%</span></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 13px; color: var(--gray-light);"><span>Time: ${totalHoursSpent}/${project.totalHours} hours</span><span>Stages: ${completedStages}/${project.stages.length} completed</span></div>
                </div>
                <div style="margin-bottom: 20px;"><h3 style="margin-bottom: 12px; font-size: 14px;">Project Stages</h3><div style="max-height: 350px; overflow-y: auto;">
                    ${project.stages.map((stage, idx) => {
                        const icon = stage.status === 'completed' ? '‚úì' : stage.status === 'in_progress' ? '‚ñ∫' : '‚óã';
                        const color = stage.status === 'completed' ? '#10b981' : stage.status === 'in_progress' ? '#6366f1' : '#64748b';
                        return `<div style="background: rgba(255,255,255,0.02); border: 1px solid ${stage.status === 'in_progress' ? 'var(--primary)' : 'rgba(255,255,255,0.08)'}; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;"><span style="color: ${color}; font-size: 16px;">${icon}</span><span style="font-weight: 600; flex: 1;">${idx + 1}. ${stage.name}</span><span style="font-size: 12px; color: var(--gray-light);">${stage.actualHours}/${stage.estimatedHours} hrs</span><span style="font-size: 12px; color: ${color};">${stage.completionPercent}%</span></div>
                            ${stage.status !== 'completed' ? `<div style="display: flex; gap: 8px; margin-bottom: 8px;"><input type="range" min="0" max="100" value="${stage.completionPercent}" onchange="updateStageProgress(${project.id}, ${idx}, this.value)" style="flex: 1;"><input type="number" value="${stage.actualHours}" placeholder="Hrs" onchange="updateStageActualHours(${project.id}, ${idx}, this.value)" style="width: 60px; padding: 4px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 12px;">
                            ${stage.status === 'not_started' ? `<button class="btn btn-secondary btn-sm" onclick="startStage(${project.id}, ${idx})">Start</button>` : `<button class="btn btn-success btn-sm" onclick="completeStage(${project.id}, ${idx})">Complete</button>`}</div>
                            <input type="text" placeholder="Notes" value="${stage.notes || ''}" onchange="updateStageNotes(${project.id}, ${idx}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 12px; margin-bottom: 6px;">
                            <input type="text" placeholder="Blockers" value="${stage.blockers || ''}" onchange="updateStageBlockers(${project.id}, ${idx}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px; color: var(--light); font-size: 12px; margin-bottom: 6px;">
                            <input type="text" placeholder="Action Required from Client" value="${stage.actionRequired || ''}" onchange="updateStageActionRequired(${project.id}, ${idx}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 4px; color: var(--light); font-size: 12px;">` : `<div style="font-size: 12px; color: var(--gray-light);">${stage.completedDate ? 'Completed: ' + new Date(stage.completedDate).toLocaleDateString('he-IL') : ''}</div>`}
                        </div>`;
                    }).join('')}
                </div></div>
                <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px;">Client Portal Link</h3>
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 10px; color: var(--gray-light);">Short Project ID (for TinyURL):</label>
                        <input type="text" id="shortId-${project.id}" value="${project.shortId || ''}" placeholder="e.g. tag-001, lhd-001" onchange="updateShortId(${project.id}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px; margin-top: 4px;">
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="shareLink-${project.id}" value="${project.shortId ? 'https://tinyurl.com/drishti-' + project.shortId : 'Set short ID above first'}" readonly style="flex: 1; min-width: 180px; padding: 6px 10px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px; color: #22c55e; font-size: 11px; font-weight: 600;">
                        <button class="btn btn-secondary btn-sm" onclick="copyShareLink(${project.id})">Copy</button>
                        <button class="btn btn-primary btn-sm" onclick="sendToClient(${project.id})">Email</button>
                        <button class="btn btn-warning btn-sm" onclick="createTinyUrl(${project.id})">Create TinyURL</button>
                    </div>
                </div>
                <div style="background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px; color: var(--primary);">Technical Details (Visible to Client)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="font-size: 10px; color: var(--gray-light); display: block; margin-bottom: 4px;">DATABASE SCHEMA</label>
                            <textarea placeholder="e.g. users (id, email, role)&#10;orders (id, user_id, status)" onchange="updateTechDetails(${project.id}, 'dbSchema', this.value)" style="width: 100%; height: 80px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 10px; font-family: monospace; resize: none;">${project.technicalDetails?.dbSchema || ''}</textarea>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: var(--gray-light); display: block; margin-bottom: 4px;">API ENDPOINTS</label>
                            <textarea placeholder="e.g. POST /api/users&#10;GET /api/orders" onchange="updateTechDetails(${project.id}, 'apiEndpoints', this.value)" style="width: 100%; height: 80px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 10px; font-family: monospace; resize: none;">${project.technicalDetails?.apiEndpoints || ''}</textarea>
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 10px; color: var(--gray-light); display: block; margin-bottom: 4px;">KEY DELIVERABLES</label>
                        <div id="deliverables-${project.id}" style="background: rgba(255,255,255,0.02); border-radius: 4px; padding: 6px; max-height: 100px; overflow-y: auto;">
                            ${(project.technicalDetails?.deliverables || []).map((d, i) => `
                                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <input type="checkbox" ${d.done ? 'checked' : ''} onchange="updateDeliverable(${project.id}, ${i}, 'done', this.checked)" style="width: 14px; height: 14px;">
                                    <input type="text" value="${d.name}" onchange="updateDeliverable(${project.id}, ${i}, 'name', this.value)" style="flex: 1; padding: 4px 6px; background: transparent; border: none; color: var(--light); font-size: 11px;">
                                    <button onclick="removeDeliverable(${project.id}, ${i})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 14px;">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addDeliverable(${project.id})" class="btn btn-secondary btn-sm" style="margin-top: 6px; width: 100%;">+ Add Deliverable</button>
                    </div>
                </div>
                <div style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px; color: #f59e0b;">Client Feedback ‚Üí Tasks</h3>
                    <textarea id="feedbackInput-${project.id}" placeholder="Paste client feedback here...&#10;&#10;Example:&#10;- Please add export to PDF&#10;- The login is slow&#10;- Need Hebrew support" style="width: 100%; height: 80px; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px; resize: none; margin-bottom: 8px;"></textarea>
                    <button onclick="convertFeedbackToTasks(${project.id})" class="btn btn-warning btn-sm" style="width: 100%;">Convert to Tasks</button>
                    <div id="generatedTasks-${project.id}" style="margin-top: 10px; display: none;">
                        <div style="font-size: 10px; color: var(--gray-light); margin-bottom: 6px;">GENERATED TASKS (check to add as deliverables):</div>
                        <div id="tasksList-${project.id}" style="background: rgba(255,255,255,0.02); border-radius: 4px; padding: 6px; max-height: 120px; overflow-y: auto;"></div>
                        <button onclick="addSelectedTasks(${project.id})" class="btn btn-success btn-sm" style="width: 100%; margin-top: 6px;">Add Selected Tasks</button>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;"><select onchange="updateProjectStatus(${project.id}, this.value)" style="padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 11px;"><option value="active" ${project.status === 'active' ? 'selected' : ''}>Active</option><option value="on_hold" ${project.status === 'on_hold' ? 'selected' : ''}>On Hold</option><option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option></select><button class="btn btn-secondary" onclick="closeModal('manageProject')" style="flex: 1;">Close</button></div>`;

            document.getElementById('manageProjectContent').innerHTML = content;
            document.getElementById('modal-manageProject').classList.add('active');
        }

        function updateStageProgress(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].completionPercent = parseInt(value); recalculateProjectProgress(p); saveData(); }}
        function updateStageActualHours(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].actualHours = parseInt(value) || 0; p.totalHoursSpent = p.stages.reduce((sum, s) => sum + (s.actualHours || 0), 0); saveData(); }}
        function updateStageNotes(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].notes = value; saveData(); }}
        function updateStageBlockers(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].blockers = value; saveData(); }}
        function updateStageActionRequired(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].actionRequired = value; saveData(); }}

        // Technical details functions
        function updateTechDetails(projectId, field, value) {
            const p = projects.find(p => p.id === projectId);
            if (p) {
                if (!p.technicalDetails) p.technicalDetails = { dbSchema: '', apiEndpoints: '', deliverables: [] };
                p.technicalDetails[field] = value;
                p.updated = new Date().toISOString();
                saveData();
            }
        }

        function updateDeliverable(projectId, idx, field, value) {
            const p = projects.find(p => p.id === projectId);
            if (p && p.technicalDetails?.deliverables?.[idx]) {
                p.technicalDetails.deliverables[idx][field] = value;
                p.updated = new Date().toISOString();
                saveData();
            }
        }

        function addDeliverable(projectId) {
            const p = projects.find(p => p.id === projectId);
            if (p) {
                if (!p.technicalDetails) p.technicalDetails = { dbSchema: '', apiEndpoints: '', deliverables: [] };
                if (!p.technicalDetails.deliverables) p.technicalDetails.deliverables = [];
                p.technicalDetails.deliverables.push({ name: 'New deliverable', done: false });
                p.updated = new Date().toISOString();
                saveData();
                openProjectManagement(projectId);
            }
        }

        function removeDeliverable(projectId, idx) {
            const p = projects.find(p => p.id === projectId);
            if (p && p.technicalDetails?.deliverables) {
                p.technicalDetails.deliverables.splice(idx, 1);
                p.updated = new Date().toISOString();
                saveData();
                openProjectManagement(projectId);
            }
        }

        function startStage(projectId, idx) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].status = 'in_progress'; p.stages[idx].startDate = new Date().toISOString(); saveData(); openProjectManagement(projectId); }}
        function completeStage(projectId, idx) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].status = 'completed'; p.stages[idx].completionPercent = 100; p.stages[idx].completedDate = new Date().toISOString(); recalculateProjectProgress(p); saveData(); openProjectManagement(projectId); showToast('Stage completed!'); }}

        function recalculateProjectProgress(project) {
            const total = project.stages.length;
            if (total === 0) { project.overallProgress = 0; return; }
            project.overallProgress = Math.round(project.stages.reduce((sum, s) => sum + s.completionPercent, 0) / total);
            project.updated = new Date().toISOString();
        }

        // Convert client feedback to task list
        function convertFeedbackToTasks(projectId) {
            const textarea = document.getElementById('feedbackInput-' + projectId);
            const feedback = textarea.value.trim();
            if (!feedback) {
                showToast('Please paste client feedback first');
                return;
            }

            // Parse feedback into tasks - look for lines starting with -, *, ‚Ä¢, numbers, or just new lines
            const lines = feedback.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => {
                    // Remove common prefixes
                    return line.replace(/^[-*‚Ä¢‚Üí]\s*/, '')
                               .replace(/^\d+[.)]\s*/, '')
                               .replace(/^please\s+/i, '')
                               .trim();
                })
                .filter(line => line.length > 3); // Skip very short lines

            // Convert to English task format (imperative form)
            const tasks = lines.map(line => {
                // Capitalize first letter
                let task = line.charAt(0).toUpperCase() + line.slice(1);
                // Remove trailing punctuation
                task = task.replace(/[.!?]+$/, '');
                return task;
            });

            if (tasks.length === 0) {
                showToast('No tasks could be extracted from feedback');
                return;
            }

            // Show generated tasks
            const tasksContainer = document.getElementById('generatedTasks-' + projectId);
            const tasksList = document.getElementById('tasksList-' + projectId);

            tasksList.innerHTML = tasks.map((task, i) => `
                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <input type="checkbox" id="task-${projectId}-${i}" checked style="width: 14px; height: 14px;">
                    <input type="text" id="taskText-${projectId}-${i}" value="${task}" style="flex: 1; padding: 4px 6px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px;">
                </div>
            `).join('');

            tasksContainer.style.display = 'block';
            showToast(tasks.length + ' tasks extracted');
        }

        function addSelectedTasks(projectId) {
            const p = projects.find(p => p.id === projectId);
            if (!p) return;

            if (!p.technicalDetails) p.technicalDetails = { dbSchema: '', apiEndpoints: '', deliverables: [] };
            if (!p.technicalDetails.deliverables) p.technicalDetails.deliverables = [];

            // Find all checked tasks
            let addedCount = 0;
            let i = 0;
            while (document.getElementById('task-' + projectId + '-' + i)) {
                const checkbox = document.getElementById('task-' + projectId + '-' + i);
                const textInput = document.getElementById('taskText-' + projectId + '-' + i);

                if (checkbox.checked && textInput.value.trim()) {
                    p.technicalDetails.deliverables.push({
                        name: textInput.value.trim(),
                        done: false
                    });
                    addedCount++;
                }
                i++;
            }

            if (addedCount > 0) {
                p.updated = new Date().toISOString();
                saveData();
                showToast(addedCount + ' tasks added as deliverables');
                openProjectManagement(projectId); // Refresh modal
            } else {
                showToast('No tasks selected');
            }
        }

        function updateShortId(projectId, shortId) {
            const p = projects.find(p => p.id === projectId);
            if (p) {
                p.shortId = shortId.toLowerCase().replace(/[^a-z0-9-]/g, '');
                saveData();
                document.getElementById('shareLink-' + projectId).value = p.shortId ? 'https://tinyurl.com/drishti-' + p.shortId : 'Set short ID above first';
            }
        }

        async function createTinyUrl(projectId) {
            const p = projects.find(p => p.id === projectId);
            if (!p || !p.shortId) {
                showToast('Please set a short ID first');
                return;
            }

            const baseUrl = 'https://luvchikavi.github.io/drishti-consulting-website/progress.html?p=' + p.shortId;
            const alias = 'drishti-' + p.shortId;

            showToast('Creating TinyURL...');

            try {
                const response = await fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(baseUrl) + '&alias=' + alias);
                const tinyUrl = await response.text();

                if (tinyUrl.includes('tinyurl.com')) {
                    document.getElementById('shareLink-' + projectId).value = tinyUrl;
                    showToast('TinyURL created! ' + tinyUrl);
                } else {
                    // Alias might already exist, use it anyway
                    document.getElementById('shareLink-' + projectId).value = 'https://tinyurl.com/' + alias;
                    showToast('TinyURL ready: https://tinyurl.com/' + alias);
                }
            } catch (e) {
                document.getElementById('shareLink-' + projectId).value = 'https://tinyurl.com/' + alias;
                showToast('TinyURL: https://tinyurl.com/' + alias);
            }
        }

        function updateProjectStatus(projectId, status) { const p = projects.find(p => p.id === projectId); if (p) { p.status = status; if (status === 'completed') p.actualEndDate = new Date().toISOString(); saveData(); renderProjects(); updateProjectStats(); showToast('Status updated'); }}

        function encodeProjectData(project) {
            const data = {
                n: project.name,
                c: project.clientName,
                p: project.overallProgress,
                b: project.totalBudget,
                h: project.totalHours,
                hs: project.stages.reduce((sum, s) => sum + (s.actualHours || 0), 0),
                sd: project.startDate,
                ed: project.expectedEndDate,
                s: project.stages.map(s => ({
                    n: s.name,
                    p: s.completionPercent,
                    st: s.status,
                    eh: s.estimatedHours,
                    ah: s.actualHours,
                    nt: s.notes,
                    bl: s.blockers,
                    ar: s.actionRequired || ''
                })),
                u: project.updated,
                // Technical details
                tech: project.technicalDetails ? {
                    db: project.technicalDetails.dbSchema || '',
                    api: project.technicalDetails.apiEndpoints || '',
                    deliverables: project.technicalDetails.deliverables || []
                } : null
            };
            return btoa(encodeURIComponent(JSON.stringify(data)));
        }

        function copyShareLink(projectId) { const input = document.getElementById('shareLink-' + projectId); input.select(); document.execCommand('copy'); showToast('Link copied!'); }

        function sendToClient(projectId) {
            const p = projects.find(p => p.id === projectId); if (!p) return;
            const link = document.getElementById('shareLink-' + projectId).value;
            const subject = encodeURIComponent(`Project Update: ${p.name}`);
            const body = encodeURIComponent(`Hi,\n\nHere's the latest progress update for "${p.name}".\n\nProgress: ${p.overallProgress}%\n\nView details: ${link}\n\nBest regards,\nDrishti Consulting`);
            window.open(`mailto:${p.clientEmail}?subject=${subject}&body=${body}`, '_blank');
        }

        function convertToProject(proposalId) {
            const proposal = proposals.find(p => p.id === proposalId); if (!proposal) return;

            // Handle both old and new field names
            const projectName = proposal.projectName || proposal.project || '';
            const proposalType = proposal.proposalType || proposal.type || '';

            openModal('newProject');
            setTimeout(() => {
                document.getElementById('projectProposal').value = proposalId;
                document.getElementById('projectClient').value = proposal.clientId;
                document.getElementById('projectName').value = projectName;
                document.getElementById('projectBudget').value = proposal.amount;
                document.getElementById('projectHours').value = proposal.hours || '';
                document.getElementById('projectType').value = proposalType;
                document.getElementById('projectDescription').value = proposal.description || '';
                if (proposalType && proposalType !== 'custom') loadStageTemplate();
            }, 100);
        }

        // Initialize
        updateStats();
    </script>
</body>
</html>
