<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Drishti Consulting</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #0ea5e9;
            --accent: #8b5cf6;
            --dark: #0f172a;
            --darker: #020617;
            --light: #f8fafc;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #d946ef 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--darker);
            color: var(--light);
            min-height: 100vh;
            font-size: 12px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
        }

        .login-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 13px;
        }

        .form-group {
            margin-bottom: 12px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 10px;
            color: var(--gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--light);
            font-size: 12px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--light);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 10px;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 180px;
            height: 100vh;
            background: rgba(255,255,255,0.02);
            border-right: 1px solid rgba(255,255,255,0.08);
            padding: 16px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .sidebar-logo svg {
            width: 28px;
            height: 28px;
        }

        .sidebar-logo span {
            font-size: 14px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--gray-light);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--light);
        }

        .nav-item.active {
            border-left: 3px solid var(--primary);
        }

        .nav-item svg {
            width: 16px;
            height: 16px;
        }

        .main-content {
            margin-left: 180px;
            padding: 20px;
            min-height: 100vh;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .page-title {
            font-size: 18px;
            font-weight: 700;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px 16px;
        }

        .stat-card h3 {
            font-size: 10px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-card .value {
            font-size: 22px;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Table */
        .data-table {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            overflow: hidden;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .data-table th {
            background: rgba(99, 102, 241, 0.1);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-light);
            font-weight: 600;
        }

        .data-table tr:hover td {
            background: rgba(255,255,255,0.02);
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-sent {
            background: rgba(14, 165, 233, 0.1);
            color: var(--secondary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .action-btns {
            display: flex;
            gap: 6px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--dark);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 18px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .form-actions .btn {
            flex: 1;
        }

        /* Airtable Setup Notice */
        .setup-notice {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .setup-notice h4 {
            color: var(--warning);
            margin-bottom: 8px;
        }

        .setup-notice p {
            color: var(--gray-light);
            font-size: 13px;
        }

        .setup-notice code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success);
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            font-weight: 600;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 2000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        /* Multiple Contacts */
        .contacts-container {
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .contacts-header label {
            font-size: 12px;
            color: var(--gray-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-add-contact {
            padding: 6px 12px;
            font-size: 11px;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            color: var(--primary);
            border-radius: 6px;
            cursor: pointer;
        }

        .contact-entry {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            position: relative;
        }

        .contact-entry:last-child {
            margin-bottom: 0;
        }

        .contact-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .contact-row:last-child {
            margin-bottom: 0;
        }

        .contact-entry input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--light);
            font-size: 13px;
            font-family: inherit;
        }

        .contact-entry input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .contact-entry input::placeholder {
            color: var(--gray);
        }

        .btn-remove-contact {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: var(--danger);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }

        /* Client Pipeline Styles */
        .pipeline-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 200px;
        }

        .pipeline-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
            cursor: grab;
            transition: all 0.2s;
        }

        .pipeline-card:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.15);
        }

        .pipeline-card:active {
            cursor: grabbing;
        }

        .pipeline-card.dragging {
            opacity: 0.5;
        }

        .pipeline-card-company {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .pipeline-card-contact {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .pipeline-card-value {
            font-size: 13px;
            color: #10b981;
            font-weight: 500;
        }

        .pipeline-card-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        /* Client Tab Styles */
        .client-tab {
            background: transparent;
            border: none;
            color: var(--gray);
            padding: 12px 16px;
            font-size: 13px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .client-tab:hover {
            color: var(--light);
        }

        .client-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .client-tab-content.hidden {
            display: none;
        }

        /* Communication Log Styles */
        .comm-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .comm-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .comm-icon.call { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .comm-icon.email { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .comm-icon.meeting { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
        .comm-icon.video { background: rgba(236, 72, 153, 0.2); color: #ec4899; }
        .comm-icon.note { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

        .comm-content {
            flex: 1;
        }

        .comm-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 4px;
        }

        .comm-subject {
            font-weight: 500;
            font-size: 14px;
        }

        .comm-date {
            font-size: 11px;
            color: var(--gray);
        }

        .comm-notes {
            font-size: 13px;
            color: var(--gray);
            line-height: 1.5;
        }

        .comm-followup {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border-radius: 4px;
            font-size: 11px;
        }

        /* Stage Badge Colors */
        .stage-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .stage-badge.lead { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .stage-badge.qualified { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .stage-badge.proposal { background: rgba(139,92,246,0.15); color: #8b5cf6; }
        .stage-badge.negotiation { background: rgba(236,72,153,0.15); color: #ec4899; }
        .stage-badge.customer { background: rgba(16,185,129,0.15); color: #10b981; }
        .stage-badge.lost { background: rgba(107,114,128,0.15); color: #6b7280; }

        /* Responsive */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <svg class="login-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="none" stroke="#4a5568" stroke-width="2"/>
                <circle cx="50" cy="50" r="32" fill="none" stroke="#4a5568" stroke-width="2"/>
                <circle cx="50" cy="50" r="20" fill="none" stroke="#4a5568" stroke-width="2"/>
                <circle cx="50" cy="50" r="10" fill="none" stroke="#6366f1" stroke-width="2.5"/>
                <circle cx="50" cy="50" r="4" fill="#6366f1"/>
            </svg>
            <h1 class="login-title">Admin Panel</h1>
            <p class="login-subtitle">Focused Vision. Precise Execution.</p>

            <form id="loginForm">
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Enter admin password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Active Timer Bar -->
        <div id="activeTimerBar" style="display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-bottom: 2px solid var(--danger); padding: 8px 24px; justify-content: space-between; align-items: center;">
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <a href="https://drishticonsulting.com" target="_blank" class="sidebar-logo" style="text-decoration: none; color: inherit;">
                <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#4a5568" stroke-width="2"/>
                    <circle cx="50" cy="50" r="32" fill="none" stroke="#4a5568" stroke-width="2"/>
                    <circle cx="50" cy="50" r="20" fill="none" stroke="#4a5568" stroke-width="2"/>
                    <circle cx="50" cy="50" r="10" fill="none" stroke="#6366f1" stroke-width="2.5"/>
                    <circle cx="50" cy="50" r="4" fill="#6366f1"/>
                </svg>
                <span>Drishti</span>
            </a>

            <nav>
                <div class="nav-item active" data-page="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Dashboard
                </div>
                <div class="nav-item" data-page="clients">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    Clients
                </div>
                <div class="nav-item" data-page="proposals">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    Proposals
                </div>
                <div class="nav-item" data-page="projects">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        <line x1="12" y1="11" x2="12" y2="17"/>
                        <line x1="9" y1="14" x2="15" y2="14"/>
                    </svg>
                    Projects
                </div>
                <div class="nav-item" data-page="invoices">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <path d="M14 2v6h6"/>
                        <path d="M16 13H8"/>
                        <path d="M16 17H8"/>
                        <path d="M10 9H8"/>
                    </svg>
                    Invoices
                </div>
                <div class="nav-item" data-page="expenses">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                    Expenses
                </div>
                <div class="nav-item" data-page="timetracking">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Time Tracking
                </div>
                <div class="nav-item" data-page="tasks">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    Tasks
                </div>
                <div class="nav-item" data-page="documents">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    Documents
                </div>
                <div class="nav-item" data-page="analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10"/>
                        <path d="M12 20V4"/>
                        <path d="M6 20v-6"/>
                    </svg>
                    Analytics
                </div>
                <div class="nav-item" data-page="templates">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <line x1="3" y1="9" x2="21" y2="9"/>
                        <line x1="9" y1="21" x2="9" y2="9"/>
                    </svg>
                    Templates
                </div>
                <div class="nav-item" data-page="payslips">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="18" rx="2"/>
                        <path d="M8 7h8"/>
                        <path d="M8 11h8"/>
                        <path d="M8 15h4"/>
                        <circle cx="16" cy="16" r="2"/>
                    </svg>
                    Payslips
                </div>
                <div class="nav-item" data-page="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </div>
            </nav>

            <div style="position: absolute; bottom: 24px; left: 24px; right: 24px;">
                <div class="nav-item" onclick="logout()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Clients Page -->
            <div class="page" id="page-clients">
                <div class="page-header">
                    <h1 class="page-title">Clients & Leads</h1>
                    <div style="display: flex; gap: 12px;">
                        <div style="display: flex; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="clientViewTable" onclick="setClientView('table')" class="btn btn-sm" style="border-radius: 0; border: none; background: var(--primary);">Table</button>
                            <button id="clientViewPipeline" onclick="setClientView('pipeline')" class="btn btn-sm" style="border-radius: 0; border: none; background: rgba(255,255,255,0.05);">Pipeline</button>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('addClient')">+ Add Client</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Clients</h3>
                        <div class="value" id="totalClients">0</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="filterByPipeline('lead')">
                        <h3>Leads</h3>
                        <div class="value" id="leadsCount" style="color: #f59e0b;">0</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="filterByPipeline('qualified')">
                        <h3>Qualified</h3>
                        <div class="value" id="qualifiedCount" style="color: #3b82f6;">0</div>
                    </div>
                    <div class="stat-card" style="cursor: pointer;" onclick="filterByPipeline('customer')">
                        <h3>Customers</h3>
                        <div class="value" id="customersCount" style="color: #10b981;">0</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <div style="position: relative; flex: 1; max-width: 400px;">
                        <input type="text" id="clientSearch" placeholder="Search clients by name, company, email..."
                            style="width: 100%; padding: 12px 16px 12px 44px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px;"
                            oninput="filterClients()">
                        <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--gray);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                    </div>
                    <select id="clientPipelineFilter" onchange="filterClients()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px; min-width: 140px;">
                        <option value="">All Stages</option>
                        <option value="lead">Lead</option>
                        <option value="qualified">Qualified</option>
                        <option value="proposal">Proposal Sent</option>
                        <option value="negotiation">Negotiation</option>
                        <option value="customer">Customer</option>
                        <option value="lost">Lost</option>
                    </select>
                    <select id="clientIndustryFilter" onchange="filterClients()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px; min-width: 150px;">
                        <option value="">All Industries</option>
                        <option value="Technology">Technology</option>
                        <option value="Finance">Finance & Insurance</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Retail">Retail</option>
                        <option value="Construction">Construction</option>
                        <option value="Government">Government / Municipal</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Table View -->
                <div id="clientsTableView" class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Contact</th>
                                <th>Email</th>
                                <th>Stage</th>
                                <th>Last Contact</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>

                <!-- Pipeline (Kanban) View -->
                <div id="clientsPipelineView" style="display: none;">
                    <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px;">
                        <!-- Lead Column -->
                        <div class="pipeline-column" data-stage="lead" style="min-width: 280px; flex: 1; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="font-size: 14px; color: #f59e0b; margin: 0;">Lead</h3>
                                <span id="pipelineLeadCount" style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                            </div>
                            <div id="pipelineLeadCards" class="pipeline-cards" ondragover="allowDrop(event)" ondrop="dropClient(event, 'lead')"></div>
                        </div>
                        <!-- Qualified Column -->
                        <div class="pipeline-column" data-stage="qualified" style="min-width: 280px; flex: 1; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="font-size: 14px; color: #3b82f6; margin: 0;">Qualified</h3>
                                <span id="pipelineQualifiedCount" style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                            </div>
                            <div id="pipelineQualifiedCards" class="pipeline-cards" ondragover="allowDrop(event)" ondrop="dropClient(event, 'qualified')"></div>
                        </div>
                        <!-- Proposal Column -->
                        <div class="pipeline-column" data-stage="proposal" style="min-width: 280px; flex: 1; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="font-size: 14px; color: #8b5cf6; margin: 0;">Proposal Sent</h3>
                                <span id="pipelineProposalCount" style="background: rgba(139,92,246,0.2); color: #8b5cf6; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                            </div>
                            <div id="pipelineProposalCards" class="pipeline-cards" ondragover="allowDrop(event)" ondrop="dropClient(event, 'proposal')"></div>
                        </div>
                        <!-- Negotiation Column -->
                        <div class="pipeline-column" data-stage="negotiation" style="min-width: 280px; flex: 1; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="font-size: 14px; color: #ec4899; margin: 0;">Negotiation</h3>
                                <span id="pipelineNegotiationCount" style="background: rgba(236,72,153,0.2); color: #ec4899; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                            </div>
                            <div id="pipelineNegotiationCards" class="pipeline-cards" ondragover="allowDrop(event)" ondrop="dropClient(event, 'negotiation')"></div>
                        </div>
                        <!-- Customer Column -->
                        <div class="pipeline-column" data-stage="customer" style="min-width: 280px; flex: 1; background: rgba(255,255,255,0.02); border-radius: 12px; padding: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="font-size: 14px; color: #10b981; margin: 0;">Customer</h3>
                                <span id="pipelineCustomerCount" style="background: rgba(16,185,129,0.2); color: #10b981; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                            </div>
                            <div id="pipelineCustomerCards" class="pipeline-cards" ondragover="allowDrop(event)" ondrop="dropClient(event, 'customer')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Proposals Page -->
            <div class="page hidden" id="page-proposals">
                <div class="page-header">
                    <h1 class="page-title">Proposals</h1>
                    <button class="btn btn-primary" onclick="openModal('newProposal')">+ New Proposal</button>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Proposal #</th>
                                <th>Client</th>
                                <th>Project</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="proposalsTable">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Projects Page -->
            <div class="page hidden" id="page-projects">
                <div class="page-header">
                    <h1 class="page-title">Ongoing Projects</h1>
                    <div style="display: flex; gap: 12px;">
                        <div style="display: flex; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="viewList" onclick="setProjectView('list')" class="btn btn-sm" style="border-radius: 0; border: none; background: var(--primary);">List</button>
                            <button id="viewGantt" onclick="setProjectView('gantt')" class="btn btn-sm" style="border-radius: 0; border: none; background: rgba(255,255,255,0.05);">Gantt</button>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('newProject')">+ New Project</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Active Projects</h3>
                        <div class="value" id="activeProjectsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Projects</h3>
                        <div class="value" id="totalProjectsCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>On Track</h3>
                        <div class="value" id="onTrackProjects" style="color: #10b981;">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Needs Attention</h3>
                        <div class="value" id="attentionProjects" style="color: #f59e0b;">0</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                    <div style="position: relative; flex: 1; max-width: 400px;">
                        <input type="text" id="projectSearch" placeholder="Search projects..."
                            style="width: 100%; padding: 12px 16px 12px 44px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px;"
                            oninput="filterProjects()">
                        <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: var(--gray);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                    </div>
                    <select id="projectStatusFilter" onchange="filterProjects()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px; min-width: 150px;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="on_hold">On Hold</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <!-- List View -->
                <div id="projectsListView" class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Project #</th>
                                <th>Client</th>
                                <th>Project Name</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th style="text-align: center;">Timer</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTable">
                            <tr><td colspan="6" style="text-align: center; color: var(--gray);">No projects yet. Create one from a proposal or click "+ New Project"</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Gantt View -->
                <div id="projectsGanttView" style="display: none;">
                    <div id="ganttContainer" style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px; overflow-x: auto;">
                        <div id="ganttChart" style="min-width: 800px;"></div>
                    </div>
                </div>
            </div>

            <!-- Invoices Page -->
            <div class="page hidden" id="page-invoices">
                <div class="page-header">
                    <h1 class="page-title">Invoices</h1>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="openModal('recurringInvoices')">Recurring</button>
                        <a href="https://www.waveapps.com/invoicing" target="_blank" class="btn btn-secondary" style="text-decoration: none;">Open Wave</a>
                        <button class="btn btn-primary" onclick="openModal('newInvoice')">+ New Invoice</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Invoiced</h3>
                        <div class="value" id="totalInvoiced">₪0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Paid</h3>
                        <div class="value" id="totalPaid" style="color: #10b981;">₪0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Outstanding</h3>
                        <div class="value" id="totalOutstanding" style="color: #f59e0b;">₪0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Overdue</h3>
                        <div class="value" id="totalOverdue" style="color: #ef4444;">₪0</div>
                    </div>
                </div>

                <!-- Overdue Alerts -->
                <div id="overdueAlerts" style="display: none; margin-bottom: 20px;">
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: #ef4444;">Payment Reminders Needed</h4>
                                <p id="overdueAlertText" style="margin: 0; color: var(--gray); font-size: 13px;">You have overdue invoices that need attention</p>
                            </div>
                            <button class="btn btn-sm" onclick="sendBulkReminders()" style="background: rgba(239,68,68,0.2); color: #ef4444;">Send Reminders</button>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                    <select id="invoiceStatusFilter" onchange="filterInvoices()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px; min-width: 140px;">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="partial">Partially Paid</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                    <select id="invoiceClientFilter" onchange="filterInvoices()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--light); font-size: 14px; min-width: 150px;">
                        <option value="">All Clients</option>
                    </select>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Client</th>
                                <th>Amount</th>
                                <th>Paid</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTable">
                            <tr><td colspan="7" style="text-align: center; color: var(--gray);">No invoices yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Expenses Page -->
            <div class="page hidden" id="page-expenses">
                <div class="page-header">
                    <h1 class="page-title">Expenses</h1>
                    <div style="display: flex; gap: 12px;">
                        <a href="https://www.waveapps.com/accounting" target="_blank" class="btn btn-secondary" style="text-decoration: none;">Open Wave</a>
                        <button class="btn btn-primary" onclick="openModal('newExpense')">+ Add Expense</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>This Month</h3>
                        <div class="value" id="expensesMonth">₪0</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Year</h3>
                        <div class="value" id="expensesYear">₪0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Categories</h3>
                        <div class="value" id="expenseCategories">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg/Month</h3>
                        <div class="value" id="expensesAvg">₪0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">By Category</h3>
                        <div id="expensesByCategory">
                            <div style="color: var(--gray); font-size: 13px;">No expenses yet</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Recent Expenses</h3>
                        <div id="recentExpenses">
                            <div style="color: var(--gray); font-size: 13px;">No expenses yet</div>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTable">
                            <tr><td colspan="5" style="text-align: center; color: var(--gray);">No expenses yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Time Tracking Page -->
            <div class="page hidden" id="page-timetracking">
                <div class="page-header">
                    <h1 class="page-title">Time Tracking</h1>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div id="runningTimer" style="display: none; background: rgba(16, 185, 129, 0.2); border: 1px solid var(--success); padding: 8px 16px; border-radius: 8px; font-family: monospace; font-size: 16px;">
                            <span id="timerDisplay">00:00:00</span>
                            <button class="btn btn-danger" onclick="stopTimer()" style="margin-left: 10px; padding: 4px 10px;">Stop</button>
                        </div>
                        <button class="btn btn-success" onclick="startTimer()" id="startTimerBtn">▶ Start Timer</button>
                        <button class="btn btn-primary" onclick="openModal('newTimeEntry')">+ Log Time</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Today</h3>
                        <div class="value" id="timeToday">0h</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Week</h3>
                        <div class="value" id="timeWeek">0h</div>
                    </div>
                    <div class="stat-card">
                        <h3>This Month</h3>
                        <div class="value" id="timeMonth">0h</div>
                    </div>
                    <div class="stat-card">
                        <h3>Billable %</h3>
                        <div class="value" id="billablePercent">0%</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Weekly Timesheet</h3>
                        <div id="weeklyTimesheet">
                            <div style="color: var(--gray); font-size: 13px;">No time entries yet</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">By Project</h3>
                        <div id="timeByProject">
                            <div style="color: var(--gray); font-size: 13px;">No time entries yet</div>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Project</th>
                                <th>Description</th>
                                <th>Hours</th>
                                <th>Billable</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="timeEntriesTable">
                            <tr><td colspan="6" style="text-align: center; color: var(--gray);">No time entries yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tasks Page -->
            <div class="page hidden" id="page-tasks">
                <div class="page-header">
                    <h1 class="page-title">Tasks & Activities</h1>
                    <div style="display: flex; gap: 12px;">
                        <select id="taskFilterStatus" onchange="renderTasks()" style="padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light);">
                            <option value="">All Status</option>
                            <option value="todo">To Do</option>
                            <option value="in_progress">In Progress</option>
                            <option value="done">Done</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('newTask')">+ Add Task</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Overdue</h3>
                        <div class="value" style="color: var(--danger);" id="tasksOverdue">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Due Today</h3>
                        <div class="value" style="color: var(--warning);" id="tasksDueToday">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>In Progress</h3>
                        <div class="value" style="color: var(--secondary);" id="tasksInProgress">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completed</h3>
                        <div class="value" style="color: var(--success);" id="tasksCompleted">0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- To Do Column -->
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                        <h3 style="margin-bottom: 16px; font-size: 13px; color: var(--gray-light); display: flex; align-items: center; gap: 8px;">
                            <span style="width: 8px; height: 8px; background: var(--gray); border-radius: 50%;"></span>
                            To Do <span id="todoCount" style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px;">0</span>
                        </h3>
                        <div id="tasksTodo" style="min-height: 200px;"></div>
                    </div>
                    <!-- In Progress Column -->
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                        <h3 style="margin-bottom: 16px; font-size: 13px; color: var(--secondary); display: flex; align-items: center; gap: 8px;">
                            <span style="width: 8px; height: 8px; background: var(--secondary); border-radius: 50%;"></span>
                            In Progress <span id="inProgressCount" style="background: rgba(14, 165, 233, 0.2); padding: 2px 8px; border-radius: 10px; font-size: 11px;">0</span>
                        </h3>
                        <div id="tasksInProgressList" style="min-height: 200px;"></div>
                    </div>
                    <!-- Done Column -->
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 16px;">
                        <h3 style="margin-bottom: 16px; font-size: 13px; color: var(--success); display: flex; align-items: center; gap: 8px;">
                            <span style="width: 8px; height: 8px; background: var(--success); border-radius: 50%;"></span>
                            Done <span id="doneCount" style="background: rgba(16, 185, 129, 0.2); padding: 2px 8px; border-radius: 10px; font-size: 11px;">0</span>
                        </h3>
                        <div id="tasksDoneList" style="min-height: 200px;"></div>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Upcoming Follow-ups</h3>
                    <div id="upcomingFollowups">
                        <div style="color: var(--gray); font-size: 13px;">No follow-ups scheduled</div>
                    </div>
                </div>
            </div>

            <!-- Documents Page -->
            <div class="page hidden" id="page-documents">
                <div class="page-header">
                    <h1 class="page-title">Documents & Contracts</h1>
                    <div style="display: flex; gap: 12px;">
                        <select id="docFilterType" onchange="renderDocuments()" style="padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light);">
                            <option value="">All Types</option>
                            <option value="contract">Contracts</option>
                            <option value="proposal">Proposals</option>
                            <option value="invoice">Invoices</option>
                            <option value="receipt">Receipts</option>
                            <option value="other">Other</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('newDocument')">+ Upload Document</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Documents</h3>
                        <div class="value" id="docsTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Contracts</h3>
                        <div class="value" id="docsContracts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Expiring Soon</h3>
                        <div class="value" style="color: var(--warning);" id="docsExpiring">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Storage Used</h3>
                        <div class="value" id="docsStorage">0 MB</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Contract Renewals</h3>
                        <div id="contractRenewals">
                            <div style="color: var(--gray); font-size: 13px;">No contracts expiring soon</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Recent Documents</h3>
                        <div id="recentDocuments">
                            <div style="color: var(--gray); font-size: 13px;">No documents yet</div>
                        </div>
                    </div>
                </div>

                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Expiry</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTable">
                            <tr><td colspan="6" style="text-align: center; color: var(--gray);">No documents yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div class="page hidden" id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">Executive Dashboard</h1>
                    <div style="display: flex; gap: 12px;">
                        <select id="dashboardPeriod" onchange="updateDashboard()" style="padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light);">
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportDashboardReport()">Export Report</button>
                    </div>
                </div>

                <!-- Revenue KPIs -->
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 12px; color: var(--gray); text-transform: uppercase; margin-bottom: 12px;">Revenue & Income</h3>
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left: 3px solid var(--success);">
                            <h3>Total Revenue</h3>
                            <div class="value" style="color: var(--success);" id="dashRevenue">₪0</div>
                            <div style="font-size: 10px; color: var(--gray); margin-top: 4px;" id="dashRevenueChange">vs last period</div>
                        </div>
                        <div class="stat-card" style="border-left: 3px solid var(--primary);">
                            <h3>Collected</h3>
                            <div class="value" id="dashCollected">₪0</div>
                        </div>
                        <div class="stat-card" style="border-left: 3px solid var(--warning);">
                            <h3>Outstanding</h3>
                            <div class="value" style="color: var(--warning);" id="dashOutstanding">₪0</div>
                        </div>
                        <div class="stat-card" style="border-left: 3px solid var(--danger);">
                            <h3>Expenses</h3>
                            <div class="value" style="color: var(--danger);" id="dashExpenses">₪0</div>
                        </div>
                    </div>
                </div>

                <!-- Profit & Pipeline -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Profit & Loss</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <div style="font-size: 11px; color: var(--gray);">Gross Profit</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="dashGrossProfit">₪0</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--gray);">Profit Margin</div>
                                <div style="font-size: 24px; font-weight: 700;" id="dashProfitMargin">0%</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--gray); font-size: 11px;">Revenue</span>
                                <span id="dashPLRevenue">₪0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--gray); font-size: 11px;">- Expenses</span>
                                <span style="color: var(--danger);" id="dashPLExpenses">₪0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <span style="font-weight: 600;">Net Profit</span>
                                <span style="font-weight: 600; color: var(--success);" id="dashNetProfit">₪0</span>
                            </div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Sales Pipeline</h3>
                        <div id="pipelineBreakdown">
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                                    <span>Leads</span>
                                    <span id="pipelineLeads">0</span>
                                </div>
                                <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                    <div id="pipelineLeadsBar" style="height: 100%; background: var(--gray); width: 0%;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                                    <span>Proposals Sent</span>
                                    <span id="pipelineProposals">0</span>
                                </div>
                                <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                    <div id="pipelineProposalsBar" style="height: 100%; background: var(--secondary); width: 0%;"></div>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                                    <span>Won</span>
                                    <span id="pipelineWon">0</span>
                                </div>
                                <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                    <div id="pipelineWonBar" style="height: 100%; background: var(--success); width: 0%;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">
                            <div>
                                <div style="font-size: 11px; color: var(--gray);">Win Rate</div>
                                <div style="font-size: 18px; font-weight: 600;" id="dashWinRate">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--gray);">Avg Deal Size</div>
                                <div style="font-size: 18px; font-weight: 600;" id="dashAvgDeal">₪0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projects & Clients -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Project Status</h3>
                        <div id="projectStatusBreakdown"></div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Top Clients by Revenue</h3>
                        <div id="topClients"></div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Time Utilization</h3>
                        <div id="timeUtilization"></div>
                    </div>
                </div>

                <!-- Upcoming & Alerts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--gray-light);">Upcoming Deadlines</h3>
                        <div id="upcomingDeadlines">
                            <div style="color: var(--gray); font-size: 13px;">No upcoming deadlines</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 14px; color: var(--warning);">⚠️ Alerts & Reminders</h3>
                        <div id="dashboardAlerts">
                            <div style="color: var(--gray); font-size: 13px;">No alerts</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Page -->
            <div class="page hidden" id="page-analytics">
                <div class="page-header">
                    <h1 class="page-title">Analytics</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Logins</h3>
                        <div class="value" id="totalLogins">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Page Views</h3>
                        <div class="value" id="pageViews">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Proposals Viewed</h3>
                        <div class="value" id="proposalsViewed">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Last Login</h3>
                        <div class="value" id="lastLogin" style="font-size: 14px;">-</div>
                    </div>
                </div>

                <div style="margin-top: 30px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 20px;">Recent Activity</h3>
                    <div id="activityLog" style="max-height: 300px; overflow-y: auto;">
                        <div style="color: var(--gray); font-size: 13px;">Activity log will appear here...</div>
                    </div>
                </div>

                <div style="margin-top: 30px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 20px;">Quick Links</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <a href="https://drishticonsulting.com" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">🌐</span>
                            <span>Main Website</span>
                        </a>
                        <a href="https://drishticonsulting.com/proposal-lhd-insurance.html" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">📄</span>
                            <span>LHD Proposal</span>
                        </a>
                        <a href="https://drishticonsulting.com/mockups-lhd-insurance.html" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">🎨</span>
                            <span>LHD Mockups</span>
                        </a>
                        <a href="https://formspree.io/forms" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">📬</span>
                            <span>Formspree Dashboard</span>
                        </a>
                        <a href="https://app.netlify.com" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">🚀</span>
                            <span>Netlify Dashboard</span>
                        </a>
                        <a href="https://calendly.com/event_types/user/me" target="_blank" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; color: var(--light); text-decoration: none; transition: all 0.2s;">
                            <span style="font-size: 20px;">📅</span>
                            <span>Calendly</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Templates Page -->
            <div class="page hidden" id="page-templates">
                <div class="page-header">
                    <h1 class="page-title">Document Templates</h1>
                </div>

                <div class="setup-notice">
                    <h4>Proposal & Invoice Templates</h4>
                    <p>Manage your document templates and numbering system. Templates are used when creating new proposals and invoices.</p>
                </div>

                <!-- Document Numbering System -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                        Document Numbering System
                    </h3>
                    <p style="color: var(--gray); font-size: 12px; margin-bottom: 16px;">Format: <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">[TYPE]-[CLIENT]-[SEQ]-[YY]</code></p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 8px; padding: 12px;">
                            <div style="font-weight: 600; color: var(--primary);">PP</div>
                            <div style="font-size: 11px; color: var(--gray);">Proposal Pending</div>
                            <div style="font-size: 10px; color: var(--light); margin-top: 4px;">Example: PP-LHD-001-26</div>
                        </div>
                        <div style="background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 8px; padding: 12px;">
                            <div style="font-weight: 600; color: var(--secondary);">PA</div>
                            <div style="font-size: 11px; color: var(--gray);">Proposal Accepted</div>
                            <div style="font-size: 10px; color: var(--light); margin-top: 4px;">Example: PA-LHD-001-26</div>
                        </div>
                        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 12px;">
                            <div style="font-weight: 600; color: var(--accent);">PJ</div>
                            <div style="font-size: 11px; color: var(--gray);">Project Active</div>
                            <div style="font-size: 10px; color: var(--light); margin-top: 4px;">Example: PJ-LHD-001-26</div>
                        </div>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px;">
                            <div style="font-weight: 600; color: var(--success);">PC</div>
                            <div style="font-size: 11px; color: var(--gray);">Project Completed</div>
                            <div style="font-size: 10px; color: var(--light); margin-top: 4px;">Example: PC-LHD-001-26</div>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 12px;">
                            <div style="font-weight: 600; color: var(--warning);">IN</div>
                            <div style="font-size: 11px; color: var(--gray);">Invoice</div>
                            <div style="font-size: 10px; color: var(--light); margin-top: 4px;">Example: IN-LHD-001-26</div>
                        </div>
                    </div>

                    <h4 style="margin-bottom: 12px; font-size: 13px;">Client Codes</h4>
                    <div id="clientCodesTable" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                        <!-- Dynamic client codes -->
                    </div>
                </div>

                <!-- Proposal Templates -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--secondary)" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
                        Proposal Templates
                    </h3>

                    <div id="proposalTemplatesGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                        <!-- Dynamic templates -->
                    </div>

                    <button class="btn btn-primary" onclick="openModal('newTemplate')" style="margin-top: 16px;">+ Create Template</button>
                </div>

                <!-- Audit Trail Section -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                        Document Audit Trail
                    </h3>
                    <p style="color: var(--gray); font-size: 12px; margin-bottom: 16px;">Track all document changes, views, and actions across the system.</p>

                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <select id="auditFilterType" onchange="filterAuditLog()" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--light); font-size: 12px;">
                            <option value="">All Types</option>
                            <option value="proposal">Proposals</option>
                            <option value="project">Projects</option>
                            <option value="invoice">Invoices</option>
                            <option value="client">Clients</option>
                        </select>
                        <select id="auditFilterAction" onchange="filterAuditLog()" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--light); font-size: 12px;">
                            <option value="">All Actions</option>
                            <option value="created">Created</option>
                            <option value="updated">Updated</option>
                            <option value="deleted">Deleted</option>
                            <option value="converted">Converted</option>
                            <option value="sent">Sent</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="clearAuditLog()">Clear Log</button>
                    </div>

                    <div id="auditLogContainer" style="max-height: 400px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <!-- Audit entries rendered here -->
                    </div>
                </div>

                <!-- Bank Details Template -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                        Bank Details (for Invoices & Proposals)
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="form-group">
                            <label>Bank Name</label>
                            <input type="text" id="bankName" value="בנק דיסקונט" onchange="saveBankDetails()">
                        </div>
                        <div class="form-group">
                            <label>Bank Code</label>
                            <input type="text" id="bankCode" value="11" onchange="saveBankDetails()">
                        </div>
                        <div class="form-group">
                            <label>Branch Name</label>
                            <input type="text" id="branchName" value="מרום נווה" onchange="saveBankDetails()">
                        </div>
                        <div class="form-group">
                            <label>Branch Code</label>
                            <input type="text" id="branchCode" value="096" onchange="saveBankDetails()">
                        </div>
                        <div class="form-group">
                            <label>Account Number</label>
                            <input type="text" id="accountNumber" value="178380913" onchange="saveBankDetails()">
                        </div>
                        <div class="form-group">
                            <label>Account Name</label>
                            <input type="text" id="accountName" value="אבי לובצ'יק" onchange="saveBankDetails()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payslips Page -->
            <div class="page hidden" id="page-payslips">
                <div class="page-header">
                    <h1 class="page-title">Payslips (תלושי שכר)</h1>
                    <button class="btn btn-primary" onclick="openModal('newPayslip')">+ Create Payslip</button>
                </div>

                <div class="setup-notice">
                    <h4>Employee Payslip Management</h4>
                    <p>Manage employees and generate professional payslips. Add employees first, then create monthly payslips for each.</p>
                </div>

                <!-- Stats Row -->
                <div class="stats-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stat-card" style="background: rgba(99, 102, 241, 0.1); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="stat-employees">0</div>
                        <div style="font-size: 11px; color: var(--gray);">Employees</div>
                    </div>
                    <div class="stat-card" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="stat-payslips-month">0</div>
                        <div style="font-size: 11px; color: var(--gray);">This Month</div>
                    </div>
                    <div class="stat-card" style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="stat-total-gross">₪0</div>
                        <div style="font-size: 11px; color: var(--gray);">Total Gross</div>
                    </div>
                    <div class="stat-card" style="background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.3); border-radius: 12px; padding: 16px;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--secondary);" id="stat-total-net">₪0</div>
                        <div style="font-size: 11px; color: var(--gray);">Total Net</div>
                    </div>
                </div>

                <!-- Employees Section -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Employees (עובדים)
                        </h3>
                        <button class="btn btn-secondary btn-sm" onclick="openModal('addEmployee')">+ Add Employee</button>
                    </div>
                    <div id="employeesTable" style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Name</th>
                                    <th style="padding: 10px 12px; text-align: left; font-weight: 600;">ID Number</th>
                                    <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Position</th>
                                    <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Base Salary</th>
                                    <th style="padding: 10px 12px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                                <tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--gray);">No employees added yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Payslips Section -->
                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><rect x="2" y="3" width="20" height="18" rx="2"/><path d="M8 7h8"/><path d="M8 11h8"/><path d="M8 15h4"/></svg>
                            Recent Payslips (תלושים אחרונים)
                        </h3>
                        <select id="payslipMonthFilter" onchange="filterPayslips()" style="padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 11px;">
                            <option value="">All Months</option>
                        </select>
                    </div>
                    <div id="payslipsTable" style="background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.05);">
                                    <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Month</th>
                                    <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Employee</th>
                                    <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Gross</th>
                                    <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Net</th>
                                    <th style="padding: 10px 12px; text-align: center; font-weight: 600;">Status</th>
                                    <th style="padding: 10px 12px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payslipsTableBody">
                                <tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--gray);">No payslips created yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page hidden" id="page-settings">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                </div>

                <div class="setup-notice">
                    <h4>Airtable Integration</h4>
                    <p>Connect your Airtable base to sync clients and proposals. Get your API key from <a href="https://airtable.com/account" target="_blank" style="color: var(--secondary);">Airtable Account</a></p>
                </div>

                <div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <div class="form-group">
                        <label>Airtable API Key</label>
                        <input type="password" id="airtableKey" placeholder="pat..." value="">
                    </div>
                    <div class="form-group">
                        <label>Base ID</label>
                        <input type="text" id="airtableBase" placeholder="app..." value="">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()" style="width: auto;">Save Settings</button>
                </div>

                <div style="margin-top: 30px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 16px;">Change Admin Password</h3>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                    </div>
                    <button class="btn btn-secondary" onclick="changePassword()" style="width: auto;">Update Password</button>
                </div>

                <!-- Green Invoice Integration -->
                <div style="margin-top: 30px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                        Green Invoice (חשבונית ירוקה) Integration
                    </h3>
                    <p style="color: var(--gray); font-size: 11px; margin-bottom: 16px;">Connect to Green Invoice API to create official invoices. Get your API credentials from <a href="https://app.greeninvoice.co.il/settings/api" target="_blank" style="color: var(--success);">Green Invoice Settings → API</a></p>

                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>API ID (מזהה)</label>
                            <input type="text" id="greenInvoiceId" placeholder="Your API ID" value="">
                        </div>
                        <div class="form-group">
                            <label>API Secret (סוד)</label>
                            <input type="password" id="greenInvoiceSecret" placeholder="Your API Secret" value="">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Default Document Type</label>
                        <select id="greenInvoiceDocType">
                            <option value="320">חשבונית מס / קבלה (Invoice/Receipt - 320)</option>
                            <option value="305">חשבונית מס (Tax Invoice - 305)</option>
                            <option value="400">קבלה (Receipt - 400)</option>
                            <option value="330">חשבונית זיכוי (Credit Invoice - 330)</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="btn btn-success" onclick="saveGreenInvoiceSettings()" style="width: auto;">Save API Settings</button>
                        <button class="btn btn-secondary" onclick="testGreenInvoiceConnection()" style="width: auto;">Test Connection</button>
                    </div>

                    <div id="greenInvoiceStatus" style="margin-top: 12px; font-size: 11px;"></div>

                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <p style="color: var(--gray); font-size: 10px; margin-bottom: 8px;">
                            <strong>Logo Setup:</strong> Upload your Drishti logo in Green Invoice: Settings → Business Details → Logo
                        </p>
                        <a href="https://app.greeninvoice.co.il/settings/business" target="_blank" class="btn btn-secondary btn-sm">Open Green Invoice Settings →</a>
                    </div>
                </div>

                <!-- Data Management -->
                <div style="margin-top: 30px; background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 16px; padding: 24px;">
                    <h3 style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.27 6.96L12 12.01l8.73-5.05"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                        Data Management
                    </h3>
                    <p style="color: var(--gray); font-size: 11px; margin-bottom: 16px;">Manage your portal data. Load demo data to test features or clear all data to start fresh.</p>

                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="loadDemoData()" style="width: auto;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Load Demo Data
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()" style="width: auto; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger);">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            Clear All Data
                        </button>
                        <button class="btn btn-secondary" onclick="exportAllData()" style="width: auto;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            Export Data (JSON)
                        </button>
                    </div>

                    <div id="dataManagementStatus" style="margin-top: 12px; font-size: 11px;"></div>

                    <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div style="font-size: 11px; color: var(--gray); margin-bottom: 8px;">Current Data Summary:</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; font-size: 12px;">
                            <div><span style="color: var(--gray);">Clients:</span> <strong id="dataCountClients">0</strong></div>
                            <div><span style="color: var(--gray);">Proposals:</span> <strong id="dataCountProposals">0</strong></div>
                            <div><span style="color: var(--gray);">Projects:</span> <strong id="dataCountProjects">0</strong></div>
                            <div><span style="color: var(--gray);">Invoices:</span> <strong id="dataCountInvoices">0</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div class="modal-overlay" id="modal-addEmployee">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Employee (הוספת עובד)</h2>
                <button class="modal-close" onclick="closeModal('addEmployee')">&times;</button>
            </div>
            <form id="addEmployeeForm" onsubmit="saveEmployee(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>First Name (שם פרטי)</label>
                        <input type="text" id="empFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name (שם משפחה)</label>
                        <input type="text" id="empLastName" required>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>ID Number (ת.ז.)</label>
                        <input type="text" id="empIdNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Start Date (תאריך תחילה)</label>
                        <input type="date" id="empStartDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Position (תפקיד)</label>
                    <input type="text" id="empPosition" placeholder="e.g., Consultant, Developer">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>Base Salary (שכר בסיס)</label>
                        <input type="number" id="empBaseSalary" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Employment Type</label>
                        <select id="empType">
                            <option value="monthly">Monthly (חודשי)</option>
                            <option value="hourly">Hourly (שעתי)</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="empBankName" placeholder="בנק הפועלים">
                    </div>
                    <div class="form-group">
                        <label>Bank Branch</label>
                        <input type="text" id="empBankBranch" placeholder="123">
                    </div>
                </div>
                <div class="form-group">
                    <label>Bank Account Number</label>
                    <input type="text" id="empBankAccount" placeholder="123456789">
                </div>
                <div class="form-group">
                    <label>Email (for sending payslip)</label>
                    <input type="email" id="empEmail">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addEmployee')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Payslip Modal -->
    <div class="modal-overlay" id="modal-newPayslip">
        <div class="modal" style="max-width: 750px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Payslip (יצירת תלוש שכר)</h2>
                <button class="modal-close" onclick="closeModal('newPayslip')">&times;</button>
            </div>
            <form id="newPayslipForm" onsubmit="generatePayslip(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group">
                        <label>Employee (עובד)</label>
                        <select id="payslipEmployee" required onchange="loadEmployeeDefaults()">
                            <option value="">Select employee...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pay Period (תקופת שכר)</label>
                        <input type="month" id="payslipPeriod" required>
                    </div>
                </div>

                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h4 style="margin-bottom: 12px; font-size: 12px; color: var(--primary);">Earnings (תשלומים)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Base Salary (שכר יסוד)</label>
                            <input type="number" id="payBaseSalary" step="0.01" value="0" oninput="autoCalculatePayslip()">
                        </div>
                        <div class="form-group">
                            <label>Work Days (ימי עבודה)</label>
                            <input type="number" id="payWorkDays" value="22">
                        </div>
                        <div class="form-group">
                            <label>Work Hours (שעות עבודה)</label>
                            <input type="number" id="payWorkHours" step="0.5" value="186">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Overtime 125% (ש. נוספות)</label>
                            <input type="number" id="payOvertime125" step="0.5" value="0" oninput="autoCalculatePayslip()">
                        </div>
                        <div class="form-group">
                            <label>Overtime 150% (ש. נוספות)</label>
                            <input type="number" id="payOvertime150" step="0.5" value="0" oninput="autoCalculatePayslip()">
                        </div>
                        <div class="form-group">
                            <label>Travel (נסיעות)</label>
                            <input type="number" id="payTravel" step="0.01" value="236" oninput="autoCalculatePayslip()">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Bonus (בונוס)</label>
                            <input type="number" id="payBonus" step="0.01" value="0" oninput="autoCalculatePayslip()">
                        </div>
                        <div class="form-group">
                            <label>Commission (עמלות)</label>
                            <input type="number" id="payCommission" step="0.01" value="0" oninput="autoCalculatePayslip()">
                        </div>
                        <div class="form-group">
                            <label>Recuperation (הבראה)</label>
                            <input type="number" id="payRecuperation" step="0.01" value="0" oninput="autoCalculatePayslip()">
                        </div>
                    </div>
                </div>

                <div style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h4 style="margin-bottom: 12px; font-size: 12px; color: var(--danger);">Deductions (ניכויים) - Auto-calculated from Gross</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Income Tax (מס הכנסה) <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="payIncomeTaxRate" step="0.1" value="20" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="payIncomeTax" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>National Ins. (ביטוח לאומי) <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="payNationalInsRate" step="0.1" value="5.8" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="payNationalIns" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Health Ins. (ביטוח בריאות) <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="payHealthInsRate" step="0.1" value="4.8" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="payHealthIns" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Pension Employee (פנסיה) <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="payPensionEmpRate" step="0.1" value="6" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="payPensionEmp" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Study Fund (קרן השתלמות) <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="payStudyFundRate" step="0.1" value="2.5" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="payStudyFund" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Other Deductions (אחר)</label>
                            <input type="number" id="payOtherDeduct" step="0.01" value="0" oninput="autoCalculatePayslip()">
                        </div>
                    </div>
                </div>

                <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h4 style="margin-bottom: 12px; font-size: 12px; color: var(--success);">Employer Contributions (הפרשות מעסיק) - Auto-calculated from Base</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Pension Employer (פנסיה) <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="payPensionEmployerRate" step="0.1" value="6.5" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="payPensionEmployer" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Severance (פיצויים) <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="paySeveranceRate" step="0.1" value="8.33" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="paySeverance" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Study Fund Employer <span style="color: var(--warning);">%</span></label>
                            <div style="display: flex; gap: 6px;">
                                <input type="number" id="payStudyFundEmployerRate" step="0.1" value="7.5" style="width: 70px;" oninput="autoCalculatePayslip()">
                                <input type="number" id="payStudyFundEmployer" step="0.01" value="0" style="flex: 1;" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <h4 style="margin-bottom: 12px; font-size: 12px; color: var(--accent);">Leave Balance (יתרות חופש)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Vacation Days (חופשה)</label>
                            <input type="number" id="payVacationDays" step="0.5" value="12">
                        </div>
                        <div class="form-group">
                            <label>Sick Days (מחלה)</label>
                            <input type="number" id="paySickDays" step="0.5" value="18">
                        </div>
                        <div class="form-group">
                            <label>Recuperation Days (הבראה)</label>
                            <input type="number" id="payRecuperationDays" step="0.5" value="6">
                        </div>
                    </div>
                </div>

                <div id="payslipSummary" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Total Gross</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--success);" id="summaryGross">₪0</div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Total Deductions</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--danger);" id="summaryDeductions">₪0</div>
                        </div>
                        <div>
                            <div style="font-size: 10px; color: var(--gray); text-transform: uppercase;">Net Pay</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--primary);" id="summaryNet">₪0</div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newPayslip')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Generate Payslip</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="modal-addClient">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Add New Client</h2>
                <button class="modal-close" onclick="closeModal('addClient')">&times;</button>
            </div>
            <form id="addClientForm">
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="clientCompany" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Pipeline Stage</label>
                        <select id="clientPipelineStage">
                            <option value="lead">Lead</option>
                            <option value="qualified">Qualified</option>
                            <option value="proposal">Proposal Sent</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="customer">Customer</option>
                            <option value="lost">Lost</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lead Source</label>
                        <select id="clientLeadSource">
                            <option value="">Select source...</option>
                            <option value="referral">Referral</option>
                            <option value="website">Website</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="cold_outreach">Cold Outreach</option>
                            <option value="conference">Conference/Event</option>
                            <option value="existing">Existing Contact</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="contacts-container">
                    <div class="contacts-header">
                        <label>Contact Persons</label>
                        <button type="button" class="btn-add-contact" onclick="addContactField()">+ Add Contact</button>
                    </div>
                    <div id="contactsList">
                        <div class="contact-entry" data-index="0">
                            <div class="contact-row">
                                <input type="text" name="contact_name_0" placeholder="Name *" required>
                                <input type="text" name="contact_position_0" placeholder="Position">
                            </div>
                            <div class="contact-row">
                                <input type="email" name="contact_email_0" placeholder="Email *" required>
                                <input type="tel" name="contact_phone_0" placeholder="Phone">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Industry</label>
                        <select id="clientIndustry">
                            <option value="">Select industry...</option>
                            <option value="Technology">Technology</option>
                            <option value="Finance">Finance & Insurance</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Retail">Retail</option>
                            <option value="Construction">Construction</option>
                            <option value="Government">Government / Municipal</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estimated Value (NIS)</label>
                        <input type="number" id="clientEstimatedValue" placeholder="50000">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="clientNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addClient')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Communication Log Modal -->
    <div class="modal-overlay" id="modal-logCommunication">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">Log Communication</h2>
                <button class="modal-close" onclick="closeModal('logCommunication')">&times;</button>
            </div>
            <form id="logCommunicationForm">
                <input type="hidden" id="commClientId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="commType" required>
                            <option value="call">Phone Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="video">Video Call</option>
                            <option value="note">Note</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="datetime-local" id="commDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Contact Person</label>
                    <select id="commContact">
                        <option value="">Select contact...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subject</label>
                    <input type="text" id="commSubject" placeholder="Brief subject..." required>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="commNotes" rows="4" placeholder="Communication details, action items, follow-up needed..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="commFollowUp" style="width: auto; margin-right: 8px;">
                        Follow-up Required
                    </label>
                    <input type="date" id="commFollowUpDate" style="margin-top: 8px; display: none;" placeholder="Follow-up date">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('logCommunication')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Log</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div class="modal-overlay" id="modal-clientDetail">
        <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="clientDetailTitle">Client Details</h2>
                <button class="modal-close" onclick="closeModal('clientDetail')">&times;</button>
            </div>
            <div id="clientDetailContent">
                <!-- Client 360 Financial Summary Bar -->
                <div id="client360Summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(139,92,246,0.1) 100%); border-radius: 12px; border: 1px solid rgba(99,102,241,0.2);">
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: var(--gray); text-transform: uppercase; margin-bottom: 4px;">Total Revenue</div>
                        <div id="client360Revenue" style="font-size: 18px; font-weight: 700; color: var(--success);">₪0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: var(--gray); text-transform: uppercase; margin-bottom: 4px;">Outstanding</div>
                        <div id="client360Outstanding" style="font-size: 18px; font-weight: 700; color: var(--warning);">₪0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: var(--gray); text-transform: uppercase; margin-bottom: 4px;">Active Projects</div>
                        <div id="client360Projects" style="font-size: 18px; font-weight: 700; color: var(--primary);">0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: var(--gray); text-transform: uppercase; margin-bottom: 4px;">Proposals</div>
                        <div id="client360Proposals" style="font-size: 18px; font-weight: 700; color: var(--accent);">0</div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div style="display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 0;">
                    <button class="client-tab active" data-tab="overview" onclick="switchClientTab('overview')">Overview</button>
                    <button class="client-tab" data-tab="contacts" onclick="switchClientTab('contacts')">Contacts</button>
                    <button class="client-tab" data-tab="communications" onclick="switchClientTab('communications')">Communications</button>
                    <button class="client-tab" data-tab="proposals" onclick="switchClientTab('proposals')">Proposals</button>
                    <button class="client-tab" data-tab="projects" onclick="switchClientTab('projects')">Projects</button>
                    <button class="client-tab" data-tab="invoices" onclick="switchClientTab('invoices')">Invoices</button>
                </div>

                <!-- Overview Tab -->
                <div class="client-tab-content" id="tabOverview">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h4 style="color: var(--gray); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Company Info</h4>
                            <div id="clientOverviewInfo" style="background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px;"></div>
                        </div>
                        <div>
                            <h4 style="color: var(--gray); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Pipeline Stage</h4>
                            <div id="clientOverviewStage" style="background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px;"></div>
                        </div>
                    </div>
                    <div style="margin-top: 24px;">
                        <h4 style="color: var(--gray); font-size: 11px; text-transform: uppercase; margin-bottom: 8px;">Recent Activity</h4>
                        <div id="clientRecentActivity" style="background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px;"></div>
                    </div>
                </div>

                <!-- Contacts Tab -->
                <div class="client-tab-content hidden" id="tabContacts">
                    <div id="clientContactsList" style="display: grid; gap: 12px;"></div>
                </div>

                <!-- Communications Tab -->
                <div class="client-tab-content hidden" id="tabCommunications">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h4 style="margin: 0;">Communication History</h4>
                        <button class="btn btn-primary btn-sm" onclick="openLogCommunication()">+ Log Communication</button>
                    </div>
                    <div id="clientCommunicationsList"></div>
                </div>

                <!-- Proposals Tab -->
                <div class="client-tab-content hidden" id="tabProposals">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h4 style="margin: 0;">Client Proposals</h4>
                        <button class="btn btn-primary btn-sm" onclick="closeModal('clientDetail'); createProposalFor(viewingClientId);">+ New Proposal</button>
                    </div>
                    <div id="clientProposalsList"></div>
                </div>

                <!-- Projects Tab -->
                <div class="client-tab-content hidden" id="tabProjects">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h4 style="margin: 0;">Active Projects</h4>
                        <button class="btn btn-primary btn-sm" onclick="closeModal('clientDetail'); createProjectFor(viewingClientId);">+ New Project</button>
                    </div>
                    <div id="clientProjectsList"></div>
                </div>

                <!-- Invoices Tab -->
                <div class="client-tab-content hidden" id="tabInvoices">
                    <div id="clientInvoicesList"></div>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 24px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('clientDetail')">Close</button>
                <button type="button" class="btn btn-primary" id="editClientFromDetail">Edit Client</button>
            </div>
        </div>
    </div>

    <!-- New Proposal Modal -->
    <div class="modal-overlay" id="modal-newProposal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create New Proposal</h2>
                <button class="modal-close" onclick="closeModal('newProposal')">&times;</button>
            </div>
            <form id="newProposalForm">
                <div class="form-group">
                    <label>Client</label>
                    <select id="proposalClient" required>
                        <option value="">Select client...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="proposalProject" required placeholder="e.g., Insurance Advisory System">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (NIS)</label>
                        <input type="number" id="proposalAmount" required placeholder="43000">
                    </div>
                    <div class="form-group">
                        <label>Estimated Hours</label>
                        <input type="number" id="proposalHours" placeholder="285">
                    </div>
                </div>
                <div class="form-group">
                    <label>Proposal Type</label>
                    <select id="proposalType">
                        <option value="development">System Development</option>
                        <option value="characterization">Characterization Phase</option>
                        <option value="consulting">Consulting</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="proposalDesc" rows="3" placeholder="Brief project description..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newProposal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Proposal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Invoice Modal -->
    <div class="modal-overlay" id="modal-newInvoice">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 class="modal-title">Create Invoice</h2>
                <button class="modal-close" onclick="closeModal('newInvoice')">&times;</button>
            </div>
            <form id="newInvoiceForm">
                <div class="form-group">
                    <label>Client</label>
                    <select id="invoiceClient" required onchange="updateInvoiceProposalSelect()">
                        <option value="">Select client...</option>
                    </select>
                </div>
                <!-- Proposal Selection - Required for invoice creation -->
                <div class="form-group">
                    <label>Based on Proposal <span style="color: var(--danger);">*</span></label>
                    <select id="invoiceProposal" required onchange="updateInvoiceFromProposal()">
                        <option value="">Select approved proposal...</option>
                    </select>
                    <small style="color: var(--gray); font-size: 10px;">Only accepted proposals can be invoiced</small>
                </div>
                <!-- Proposal Summary Box -->
                <div id="invoiceProposalSummary" style="display: none; background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                        <div><span style="color: var(--gray);">Proposal Amount:</span> <strong id="invoiceProposalTotal">₪0</strong></div>
                        <div><span style="color: var(--gray);">Already Invoiced:</span> <strong id="invoiceProposalInvoiced" style="color: var(--warning);">₪0</strong></div>
                        <div><span style="color: var(--gray);">Remaining:</span> <strong id="invoiceProposalRemaining" style="color: var(--success);">₪0</strong></div>
                        <div><span style="color: var(--gray);">Milestone:</span> <span id="invoiceProposalMilestone">-</span></div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Invoice Number</label>
                        <input type="text" id="invoiceNumber" required placeholder="INV-001">
                    </div>
                    <div class="form-group">
                        <label>Amount (₪) <span id="invoiceMaxAmount" style="color: var(--gray); font-size: 10px;"></span></label>
                        <input type="number" id="invoiceAmount" required placeholder="10000" oninput="validateInvoiceAmount()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Issue Date</label>
                        <input type="date" id="invoiceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="invoiceDueDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount Paid (₪)</label>
                        <input type="number" id="invoiceAmountPaid" placeholder="0" value="0" oninput="updateInvoiceBalance()">
                    </div>
                    <div class="form-group">
                        <label>Balance Due (₪)</label>
                        <input type="number" id="invoiceBalance" placeholder="Auto-calculated" readonly style="background: rgba(255,255,255,0.02);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="invoiceDesc" rows="2" placeholder="Services rendered..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="invoiceRecurring" style="width: auto; margin-right: 8px;" onchange="toggleRecurringOptions()">
                        Make this a recurring invoice
                    </label>
                </div>
                <div id="recurringOptions" style="display: none; background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Frequency</label>
                            <select id="invoiceRecurringFreq">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>End Date (optional)</label>
                            <input type="date" id="invoiceRecurringEnd">
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newInvoice')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div class="modal-overlay" id="modal-recordPayment">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Record Payment</h2>
                <button class="modal-close" onclick="closeModal('recordPayment')">&times;</button>
            </div>
            <form id="recordPaymentForm">
                <input type="hidden" id="paymentInvoiceId">
                <div style="background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Invoice Total:</span>
                        <span id="paymentInvoiceTotal">₪0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--gray);">Previously Paid:</span>
                        <span id="paymentPreviouslyPaid" style="color: #10b981;">₪0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">
                        <span style="font-weight: 500;">Balance Due:</span>
                        <span id="paymentBalanceDue" style="color: #f59e0b; font-weight: 500;">₪0</span>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Payment Amount (₪)</label>
                        <input type="number" id="paymentAmount" required placeholder="Enter amount">
                    </div>
                    <div class="form-group">
                        <label>Payment Date</label>
                        <input type="date" id="paymentDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Payment Method</label>
                    <select id="paymentMethod">
                        <option value="transfer">Bank Transfer</option>
                        <option value="check">Check</option>
                        <option value="credit">Credit Card</option>
                        <option value="cash">Cash</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <input type="text" id="paymentNotes" placeholder="Reference number, etc.">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('recordPayment')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record Payment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recurring Invoices Modal -->
    <div class="modal-overlay" id="modal-recurringInvoices">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Recurring Invoices</h2>
                <button class="modal-close" onclick="closeModal('recurringInvoices')">&times;</button>
            </div>
            <div id="recurringInvoicesList" style="max-height: 400px; overflow-y: auto;">
                <p style="color: var(--gray); text-align: center;">No recurring invoices set up yet</p>
            </div>
            <div class="form-actions" style="margin-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('recurringInvoices')">Close</button>
                <button type="button" class="btn btn-primary" onclick="closeModal('recurringInvoices'); openModal('newInvoice');">+ New Recurring Invoice</button>
            </div>
        </div>
    </div>

    <!-- New Expense Modal (Enhanced) -->
    <div class="modal-overlay" id="modal-newExpense">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="expenseModalTitle">Add Expense</h2>
                <button class="modal-close" onclick="closeModal('newExpense')">&times;</button>
            </div>
            <form id="newExpenseForm">
                <input type="hidden" id="editingExpenseId">
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="expenseDesc" required placeholder="Office supplies, Software subscription...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (₪)</label>
                        <input type="number" id="expenseAmount" step="0.01" required placeholder="500" oninput="calculateExpenseVAT()">
                    </div>
                    <div class="form-group">
                        <label>VAT (17%)</label>
                        <input type="number" id="expenseVAT" step="0.01" placeholder="Auto-calculated" readonly style="background: rgba(255,255,255,0.02);">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="expenseCategory" required>
                            <option value="">Select category...</option>
                            <option value="Software">Software & Subscriptions</option>
                            <option value="Office">Office Supplies</option>
                            <option value="Travel">Travel & Transportation</option>
                            <option value="Marketing">Marketing & Advertising</option>
                            <option value="Professional">Professional Services</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Utilities">Utilities & Internet</option>
                            <option value="Rent">Rent & Facilities</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Meals">Meals & Entertainment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vendor</label>
                        <select id="expenseVendor">
                            <option value="">Select or add vendor...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Project (optional)</label>
                        <select id="expenseProject">
                            <option value="">No project linked</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select id="expensePaymentMethod">
                            <option value="credit_card">Credit Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="cash">Cash</option>
                            <option value="check">Check</option>
                            <option value="paypal">PayPal</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><input type="checkbox" id="expenseRecurring" onchange="toggleRecurringOptions()"> Recurring Expense</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="expenseTaxDeductible" checked> Tax Deductible</label>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="expenseBillable"> Billable to Client</label>
                    </div>
                </div>
                <div id="recurringOptions" style="display: none; background: rgba(99, 102, 241, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Frequency</label>
                            <select id="expenseRecurringFreq">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>End Date (optional)</label>
                            <input type="date" id="expenseRecurringEnd">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Receipt</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="expenseReceipt" accept="image/*,.pdf" onchange="previewReceipt(event)" style="flex: 1;">
                        <span id="receiptStatus" style="font-size: 11px; color: var(--gray);">No receipt</span>
                    </div>
                    <div id="receiptPreview" style="margin-top: 8px; display: none;">
                        <img id="receiptImage" style="max-width: 200px; max-height: 150px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes (optional)</label>
                    <textarea id="expenseNotes" rows="2" placeholder="Additional details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newExpense')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="expenseSubmitBtn">Add Expense</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Time Entry Modal -->
    <div class="modal-overlay" id="modal-newTimeEntry">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="timeEntryModalTitle">Log Time</h2>
                <button class="modal-close" onclick="closeModal('newTimeEntry')">&times;</button>
            </div>
            <form id="newTimeEntryForm">
                <input type="hidden" id="editingTimeEntryId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Project</label>
                        <select id="timeProject" required>
                            <option value="">Select project...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="timeDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hours</label>
                        <input type="number" id="timeHours" step="0.25" min="0.25" required placeholder="2.5">
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate (₪)</label>
                        <input type="number" id="timeRate" step="0.01" placeholder="Auto from project">
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="timeDescription" rows="2" required placeholder="What did you work on?"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><input type="checkbox" id="timeBillable" checked> Billable</label>
                    </div>
                    <div class="form-group">
                        <label>Stage (optional)</label>
                        <select id="timeStage">
                            <option value="">No stage</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newTimeEntry')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Log Time</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Task Modal -->
    <div class="modal-overlay" id="modal-newTask">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="taskModalTitle">Add Task</h2>
                <button class="modal-close" onclick="closeModal('newTask')">&times;</button>
            </div>
            <form id="newTaskForm">
                <input type="hidden" id="editingTaskId">
                <div class="form-group">
                    <label>Task Title</label>
                    <input type="text" id="taskTitle" required placeholder="e.g., Review proposal draft">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="taskPriority" required>
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="taskDueDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Link to Client</label>
                        <select id="taskClient">
                            <option value="">No client</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Link to Project</label>
                        <select id="taskProject">
                            <option value="">No project</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="taskDescription" rows="3" placeholder="Task details..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><input type="checkbox" id="taskIsFollowup"> This is a follow-up</label>
                    </div>
                    <div class="form-group">
                        <label>Reminder</label>
                        <select id="taskReminder">
                            <option value="">No reminder</option>
                            <option value="1day">1 day before</option>
                            <option value="3days">3 days before</option>
                            <option value="1week">1 week before</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newTask')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Quote Modal -->
    <div class="modal-overlay" id="modal-newQuote">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="quoteModalTitle">Create Quote</h2>
                <button class="modal-close" onclick="closeModal('newQuote')">&times;</button>
            </div>
            <form id="newQuoteForm">
                <input type="hidden" id="editingQuoteId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Client</label>
                        <select id="quoteClient" required>
                            <option value="">Select client...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valid Until</label>
                        <input type="date" id="quoteValidUntil" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Quote Title</label>
                    <input type="text" id="quoteTitle" required placeholder="e.g., System Development Services">
                </div>

                <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px; margin: 16px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label style="font-weight: 600;">Line Items</label>
                        <button type="button" class="btn btn-secondary" onclick="addQuoteLineItem()" style="padding: 4px 10px; font-size: 10px;">+ Add Item</button>
                    </div>
                    <div id="quoteLineItems">
                        <!-- Line items will be added here -->
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: 20px; margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div>
                            <span style="color: var(--gray); font-size: 11px;">Subtotal:</span>
                            <span id="quoteSubtotal" style="font-weight: 600; margin-left: 8px;">₪0</span>
                        </div>
                        <div>
                            <span style="color: var(--gray); font-size: 11px;">VAT (17%):</span>
                            <span id="quoteVAT" style="margin-left: 8px;">₪0</span>
                        </div>
                        <div>
                            <span style="color: var(--gray); font-size: 11px;">Total:</span>
                            <span id="quoteTotal" style="font-weight: 700; color: var(--success); margin-left: 8px;">₪0</span>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Discount (%)</label>
                        <input type="number" id="quoteDiscount" value="0" min="0" max="100" oninput="calculateQuoteTotals()">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="quoteIncludeVAT" checked onchange="calculateQuoteTotals()"> Include VAT</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes / Terms</label>
                    <textarea id="quoteNotes" rows="3" placeholder="Payment terms, conditions, etc."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newQuote')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Quote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Document Modal -->
    <div class="modal-overlay" id="modal-newDocument">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="documentModalTitle">Upload Document</h2>
                <button class="modal-close" onclick="closeModal('newDocument')">&times;</button>
            </div>
            <form id="newDocumentForm">
                <input type="hidden" id="editingDocumentId">
                <div class="form-group">
                    <label>Document Name</label>
                    <input type="text" id="documentName" required placeholder="e.g., Service Agreement - LHD">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="documentType" required onchange="toggleContractFields()">
                            <option value="contract">Contract</option>
                            <option value="proposal">Proposal</option>
                            <option value="invoice">Invoice</option>
                            <option value="receipt">Receipt</option>
                            <option value="report">Report</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Client</label>
                        <select id="documentClient">
                            <option value="">No client</option>
                        </select>
                    </div>
                </div>
                <div id="contractFields" style="background: rgba(99, 102, 241, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Contract Value (₪)</label>
                            <input type="number" id="documentContractValue" placeholder="Contract amount">
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="documentStartDate">
                        </div>
                        <div class="form-group">
                            <label>End/Renewal Date</label>
                            <input type="date" id="documentEndDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="documentAutoRenew"> Auto-renews</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Upload File</label>
                    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" onchange="previewDocument(event)">
                    <div id="documentPreview" style="margin-top: 8px; font-size: 11px; color: var(--gray);"></div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="documentNotes" rows="2" placeholder="Additional notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newDocument')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload Document</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vendor Modal -->
    <div class="modal-overlay" id="modal-newVendor">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Vendor</h2>
                <button class="modal-close" onclick="closeModal('newVendor')">&times;</button>
            </div>
            <form id="newVendorForm">
                <div class="form-group">
                    <label>Vendor Name</label>
                    <input type="text" id="vendorName" required placeholder="e.g., Microsoft, AWS">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Contact Email</label>
                        <input type="email" id="vendorEmail" placeholder="billing@vendor.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="vendorPhone" placeholder="+972-...">
                    </div>
                </div>
                <div class="form-group">
                    <label>VAT Number (עוסק מורשה)</label>
                    <input type="text" id="vendorVAT" placeholder="514123456">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="vendorCategory">
                        <option value="Software">Software & Services</option>
                        <option value="Office">Office Supplies</option>
                        <option value="Professional">Professional Services</option>
                        <option value="Utilities">Utilities</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newVendor')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Vendor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Budget Modal -->
    <div class="modal-overlay" id="modal-setBudget">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Set Category Budget</h2>
                <button class="modal-close" onclick="closeModal('setBudget')">&times;</button>
            </div>
            <form id="setBudgetForm">
                <div class="form-group">
                    <label>Category</label>
                    <select id="budgetCategory" required>
                        <option value="">Select category...</option>
                        <option value="Software">Software & Subscriptions</option>
                        <option value="Office">Office Supplies</option>
                        <option value="Travel">Travel & Transportation</option>
                        <option value="Marketing">Marketing & Advertising</option>
                        <option value="Professional">Professional Services</option>
                        <option value="Equipment">Equipment</option>
                        <option value="Utilities">Utilities & Internet</option>
                        <option value="Rent">Rent & Facilities</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Monthly Budget (₪)</label>
                        <input type="number" id="budgetMonthly" placeholder="5000">
                    </div>
                    <div class="form-group">
                        <label>Yearly Budget (₪)</label>
                        <input type="number" id="budgetYearly" placeholder="60000">
                    </div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="budgetAlert" checked> Alert when 80% spent</label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('setBudget')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Set Budget</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timer Stop Modal -->
    <div class="modal-overlay" id="modal-stopTimer">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Save Time Entry</h2>
                <button class="modal-close" onclick="closeModal('stopTimer')">&times;</button>
            </div>
            <form id="stopTimerForm">
                <div class="form-group">
                    <label>Duration</label>
                    <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="timerDurationDisplay">0h 0m</div>
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="timerProject" required>
                        <option value="">Select project...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="timerDescription" rows="2" required placeholder="What did you work on?"></textarea>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="timerBillable" checked> Billable</label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="discardTimer()">Discard</button>
                    <button type="submit" class="btn btn-primary">Save Entry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal-overlay" id="modal-newProject">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Create New Project</h2>
                <button class="modal-close" onclick="closeModal('newProject')">&times;</button>
            </div>
            <form id="newProjectForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Client</label>
                        <select id="projectClient" required>
                            <option value="">Select client...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>From Proposal (optional)</label>
                        <select id="projectProposal">
                            <option value="">No proposal linked</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="projectName" required placeholder="e.g., Insurance Advisory System">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Project Type</label>
                        <select id="projectType" required onchange="loadStageTemplate()">
                            <option value="">Select type...</option>
                            <option value="development">System Development</option>
                            <option value="characterization">Characterization Phase</option>
                            <option value="consulting">Consulting</option>
                            <option value="custom">Custom (Define stages manually)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Total Budget (₪)</label>
                        <input type="number" id="projectBudget" required placeholder="43000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Total Hours</label>
                        <input type="number" id="projectHours" required placeholder="285" onchange="recalculateStageHours()">
                    </div>
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="projectStartDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Expected End Date</label>
                    <input type="date" id="projectEndDate" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDescription" rows="2" placeholder="Brief project description..."></textarea>
                </div>

                <!-- Stages Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <label style="font-size: 14px; font-weight: 600;">Project Stages</label>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addProjectStage()">+ Add Stage</button>
                    </div>
                    <div id="stagesList" style="max-height: 300px; overflow-y: auto;">
                        <div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">
                            Select a project type to load stage template, or add stages manually
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newProject')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Management Modal -->
    <div class="modal-overlay" id="modal-manageProject">
        <div class="modal" style="max-width: 800px; max-height: 95vh;">
            <div class="modal-header">
                <h2 class="modal-title" id="manageProjectTitle">Manage Project</h2>
                <button class="modal-close" onclick="closeModal('manageProject')">&times;</button>
            </div>
            <div id="manageProjectContent">
                <!-- Dynamic content loaded by openProjectManagement() -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">Saved successfully!</div>

    <script>
        // Simple password (you should change this!)
        // Reset password to default on load (clear any old stored password)
        localStorage.removeItem('adminPassword');
        const ADMIN_PASSWORD = 'luvchik2026';

        // Data storage (localStorage for demo, Airtable for production)
        const sampleClients = [
            {
                id: 1007,
                company: 'GreenTech Solutions Ltd',
                companyHe: 'גרינטק פתרונות בע"מ',
                sector: 'technology',
                companyId: '516789012',
                industry: 'Technology',
                pipelineStage: 'customer',
                estimatedValue: 120000,
                leadSource: 'referral',
                contacts: [
                    { name: 'Dana Cohen', nameHe: 'דנה כהן', position: 'CEO', email: 'dana@greentech.co.il', phone: '054-1234567' },
                    { name: 'Amit Levy', nameHe: 'עמית לוי', position: 'CTO', email: 'amit@greentech.co.il', phone: '052-9876543' }
                ],
                notes: 'ESG-focused tech company. Interested in sustainability reporting platform and carbon tracking system. High potential for long-term partnership.',
                status: 'active',
                created: '2025-10-15T10:00:00.000Z'
            },
            {
                id: 1001,
                company: 'LHD Insurance Consulting',
                sector: 'finance',
                contacts: [
                    { name: 'משה כהן', position: 'מנכ"ל', email: 'moshe@lhd-insurance.co.il', phone: '052-1234567' },
                    { name: 'רחל לוי', position: 'סמנכ"ל כספים', email: 'rachel@lhd-insurance.co.il', phone: '052-7654321' }
                ],
                status: 'active'
            },
            {
                id: 1002,
                company: 'טבע תעשיות פרמצבטיות',
                sector: 'manufacturing',
                contacts: [
                    { name: 'דוד ישראלי', position: 'VP Operations', email: 'david@teva.co.il', phone: '054-9876543' }
                ],
                status: 'active'
            },
            {
                id: 1003,
                company: 'אלביט מערכות',
                sector: 'technology',
                contacts: [
                    { name: 'יעל אברהם', position: 'CTO', email: 'yael@elbit.co.il', phone: '053-1112233' },
                    { name: 'אורי שמש', position: 'Project Manager', email: 'uri@elbit.co.il', phone: '053-4445566' }
                ],
                status: 'active'
            },
            {
                id: 1004,
                company: 'עזריאלי מרכזים',
                sector: 'realestate',
                contacts: [
                    { name: 'שרה גולן', position: 'מנהלת פיתוח עסקי', email: 'sara@azrieli.com', phone: '050-7778899' }
                ],
                status: 'lead'
            },
            {
                id: 1005,
                company: 'בנק לאומי',
                sector: 'finance',
                contacts: [
                    { name: 'אבי רוזנברג', position: 'Head of Innovation', email: 'avi.r@leumi.co.il', phone: '052-3334455' }
                ],
                status: 'lead'
            },
            {
                id: 1006,
                company: 'Tag Urbanic Investment Management',
                companyHe: 'תגא אורבניק ניהול השקעות בע"מ',
                sector: 'realestate',
                companyId: '515876589',
                contacts: [
                    { name: 'Guy Gafni', nameHe: 'גיא גפני', position: 'CEO', email: 'guy@tagurbanic.co.il', phone: '' }
                ],
                status: 'active'
            }
        ];

        // Load data from localStorage (no automatic sample data - user controls this)
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let proposals = JSON.parse(localStorage.getItem('proposals')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let projects = JSON.parse(localStorage.getItem('projects')) || [];
        let clientCodes = JSON.parse(localStorage.getItem('clientCodes')) || {};
        let proposalTemplates = JSON.parse(localStorage.getItem('proposalTemplates')) || [];
        let bankDetails = JSON.parse(localStorage.getItem('bankDetails')) || {
            bank: 'בנק דיסקונט', bankCode: '11', branch: 'מרום נווה', branchCode: '096', account: '178380913', name: 'אבי לובצ\'יק'
        };
        let documentCounters = JSON.parse(localStorage.getItem('documentCounters')) || {};
        let employees = JSON.parse(localStorage.getItem('employees')) || [];
        let payslips = JSON.parse(localStorage.getItem('payslips')) || [];

        // New CRM data arrays
        let timeEntries = JSON.parse(localStorage.getItem('timeEntries')) || [];
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let quotes = JSON.parse(localStorage.getItem('quotes')) || [];
        let documents = JSON.parse(localStorage.getItem('documents')) || [];
        let vendors = JSON.parse(localStorage.getItem('vendors')) || [];
        let budgets = JSON.parse(localStorage.getItem('budgets')) || {};
        let recurringExpenses = JSON.parse(localStorage.getItem('recurringExpenses')) || [];
        let communicationLogs = JSON.parse(localStorage.getItem('communicationLogs')) || [];

        // Audit Log for document tracking
        let auditLog = JSON.parse(localStorage.getItem('auditLog')) || [];

        // Log audit events for document tracking
        function logAuditEvent(entityType, entityId, action, details, userId = 'admin') {
            const event = {
                id: Date.now(),
                entityType,  // 'proposal', 'invoice', 'project', 'client', 'document'
                entityId,
                action,      // 'created', 'updated', 'deleted', 'viewed', 'sent', 'converted_to_project', etc.
                details,
                userId,
                timestamp: new Date().toISOString(),
                ipAddress: 'local'  // Would be actual IP in production
            };
            auditLog.push(event);
            // Keep only last 1000 entries to prevent localStorage overflow
            if (auditLog.length > 1000) {
                auditLog = auditLog.slice(-1000);
            }
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
            return event;
        }

        // Get audit history for an entity
        function getAuditHistory(entityType, entityId) {
            return auditLog.filter(e => e.entityType === entityType && e.entityId === entityId)
                          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Client view state
        let currentClientView = 'table';
        let viewingClientId = null;

        // Timer state
        let timerInterval = null;
        let timerStartTime = null;
        let timerElapsed = 0;

        // Add Oporto Carbon employee and payslips for all 2025
        const PAYSLIP_DATA_VERSION = 'v3.0-oporto-2025-varied';
        if (!localStorage.getItem('payslipDataVersion') || localStorage.getItem('payslipDataVersion') !== PAYSLIP_DATA_VERSION) {
            employees = [];
            payslips = [];

            const sampleEmployee = {
                id: 1001,
                firstName: 'אבי',
                lastName: 'לובצ\'יק',
                firstNameEn: 'Avi',
                lastNameEn: 'Luvchik',
                idNumber: '3588645/6',
                startDate: '2022-10-01',
                position: 'יועץ בכיר',
                baseSalary: 35000,
                dailyRate: 1590.91,
                hourlyRate: 192.31,
                employmentType: 'monthly',
                bankName: 'בנק דיסקונט',
                bankCode: '11',
                bankBranch: '096',
                bankAccount: '178380913',
                email: 'avi@oportocarbon.com',
                address: 'שניר 10 א\' אורנית 4381300',
                maritalStatus: 'גרוש',
                birthDate: '1978-11-01',
                children: 4,
                healthFund: 'מכבי',
                positionPercent: 100,
                status: 'active',
                created: new Date().toISOString()
            };
            employees.push(sampleEmployee);

            // Monthly salary variations - higher in Oct, Nov, Dec
            // Gross range: 35,459 - 37,984, Net range: 22,234 - 24,789
            const monthlyData = [
                { gross: 35687, net: 22456, bonus: 0, overtime: 3, travel: 236 },      // Jan
                { gross: 35459, net: 22234, bonus: 0, overtime: 2, travel: 236 },      // Feb
                { gross: 36124, net: 22789, bonus: 500, overtime: 4, travel: 236 },    // Mar
                { gross: 35892, net: 22567, bonus: 300, overtime: 3, travel: 236 },    // Apr
                { gross: 36345, net: 22934, bonus: 700, overtime: 5, travel: 236 },    // May
                { gross: 35756, net: 22512, bonus: 200, overtime: 3, travel: 236 },    // Jun
                { gross: 36567, net: 23123, bonus: 800, overtime: 6, travel: 236 },    // Jul
                { gross: 35934, net: 22678, bonus: 400, overtime: 4, travel: 236 },    // Aug
                { gross: 36234, net: 22856, bonus: 600, overtime: 5, travel: 236 },    // Sep
                { gross: 37456, net: 24123, bonus: 1500, overtime: 8, travel: 300 },   // Oct - HIGH
                { gross: 37789, net: 24456, bonus: 1800, overtime: 10, travel: 300 },  // Nov - HIGH
                { gross: 37984, net: 24789, bonus: 2000, overtime: 12, travel: 350 }   // Dec - HIGHEST
            ];

            // Leave balance tracking - starts fresh in January
            let vacationBalance = 7;  // Starting balance
            let sickBalance = 38;     // Starting balance
            let recupBalance = 2.5;   // Starting balance

            const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
            let cumGross = 0, cumTax = 0, cumNatIns = 0, cumHealth = 0;

            months.forEach((month, index) => {
                const data = monthlyData[index];
                const baseSalary = 35000;
                const hourlyRate = 192.31;
                const dailyRate = 1590.91;

                // Calculate components
                const overtimePay = data.overtime * hourlyRate * 1.25;
                const totalGross = data.gross;

                // Tax calculations based on gross (roughly 20% tax rate, 5.8% national ins, 4.8% health)
                const taxRate = 0.20 + (data.gross > 37000 ? 0.02 : 0);
                const incomeTax = Math.round((totalGross * taxRate) * 100) / 100;
                const nationalIns = Math.round((totalGross * 0.058) * 100) / 100;
                const healthIns = Math.round((totalGross * 0.048) * 100) / 100;

                // Pension calculations
                const pensionPhoenix = Math.round((baseSalary * 0.035) * 100) / 100;
                const pensionClal = Math.round((baseSalary * 0.025) * 100) / 100;
                const studyFund = Math.round((baseSalary * 0.025) * 100) / 100;
                const pensionEmp = pensionPhoenix + pensionClal;

                const totalTaxDeductions = incomeTax + nationalIns + healthIns;
                const totalPensionDeductions = pensionEmp + studyFund;
                const totalDeductions = totalGross - data.net;

                // Leave tracking - monthly accrual
                const vacationAccrual = 1;  // 12 days/year = 1/month
                const sickAccrual = 1.5;    // 18 days/year = 1.5/month
                const recupAccrual = 0.5;   // 6 days/year = 0.5/month

                const vacationUsed = [1, 0, 2, 1, 0, 3, 2, 1, 0, 1, 0, 2][index];
                const sickUsed = [0, 1, 0, 0.5, 0, 1, 0, 2, 0, 0, 1, 0][index];
                const recupUsed = [0, 0, 0, 0, 0.5, 0, 1, 0, 0, 0, 0, 0.5][index];

                const vacationPrev = vacationBalance;
                const sickPrev = sickBalance;
                const recupPrev = recupBalance;

                vacationBalance = vacationBalance + vacationAccrual - vacationUsed;
                sickBalance = sickBalance + sickAccrual - sickUsed;
                recupBalance = recupBalance + recupAccrual - recupUsed;

                // Cumulative totals
                cumGross += totalGross;
                cumTax += incomeTax;
                cumNatIns += nationalIns;
                cumHealth += healthIns;

                const payslip = {
                    id: 2001 + index,
                    employeeId: 1001,
                    employeeName: 'אבי לובצ\'יק',
                    employeeNameEn: 'Avi Luvchik',
                    employeeIdNumber: '3588645/6',
                    period: '2025-' + month,
                    company: 'Oporto Carbon',

                    // Earnings
                    baseSalary: baseSalary,
                    dailyRate: dailyRate,
                    hourlyRate: hourlyRate,
                    workDays: 22,
                    workHours: 186,
                    overtime125: data.overtime,
                    overtime150: 0,
                    travel: data.travel,
                    bonus: data.bonus,
                    commission: 0,
                    recuperation: 0,

                    // Mandatory Deductions
                    incomeTax: incomeTax,
                    nationalIns: nationalIns,
                    healthIns: healthIns,

                    // Pension deductions (employee)
                    pensionPhoenix: pensionPhoenix,
                    pensionClal: pensionClal,
                    pensionEmp: pensionEmp,
                    studyFund: studyFund,
                    otherDeduct: 0,

                    // Employer contributions
                    pensionEmployer: Math.round((baseSalary * 0.07) * 100) / 100,
                    severance: Math.round((baseSalary * 0.0833) * 100) / 100,
                    studyFundEmployer: Math.round((baseSalary * 0.075) * 100) / 100,

                    // Leave balance - annual quota stays constant, balances update
                    vacationQuota: 12,
                    vacationPrev: Math.round(vacationPrev * 100) / 100,
                    vacationUsed: vacationUsed,
                    vacationBalance: Math.round(vacationBalance * 100) / 100,
                    sickQuota: 18,
                    sickPrev: Math.round(sickPrev * 100) / 100,
                    sickUsed: sickUsed,
                    sickBalance: Math.round(sickBalance * 100) / 100,
                    recuperationQuota: 6,
                    recuperationPrev: Math.round(recupPrev * 100) / 100,
                    recuperationUsed: recupUsed,
                    recuperationBalance: Math.round(recupBalance * 100) / 100,

                    // Totals
                    totalGross: totalGross,
                    totalTaxDeductions: Math.round(totalTaxDeductions * 100) / 100,
                    totalPensionDeductions: Math.round(totalPensionDeductions * 100) / 100,
                    totalDeductions: Math.round(totalDeductions * 100) / 100,
                    netPay: data.net,

                    // Bank details
                    bankName: 'בנק דיסקונט',
                    bankCode: '11',
                    bankBranch: '096',
                    bankAccount: '178380913',

                    // Cumulative data
                    cumGrossIncome: Math.round(cumGross),
                    cumNationalIns: Math.round(cumGross),
                    cumIncomeTax: Math.round(cumTax),
                    cumNationalInsDeduction: Math.round(cumNatIns),
                    cumHealthIns: Math.round(cumHealth),

                    status: 'sent',
                    created: new Date().toISOString()
                };
                payslips.push(payslip);
            });

            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('payslips', JSON.stringify(payslips));
            localStorage.setItem('payslipDataVersion', PAYSLIP_DATA_VERSION);
        }

        // Force update LHD Insurance to v2.0 (always replace to ensure latest data)
        const LHD_DATA_VERSION = 'v2.0-20260107';
        const existingLHD = proposals.find(p => p.proposalNumber === 'LHD-001-26');
        if (!existingLHD || existingLHD.dataVersion !== LHD_DATA_VERSION) {
            // Remove old version and replace with v2.0
            proposals = proposals.filter(p => p.proposalNumber !== 'LHD-001-26');
            const sampleProposal = {
                id: 2001,
                proposalNumber: 'LHD-001-26',
                version: '2.0',
                dataVersion: LHD_DATA_VERSION,
                clientId: 1001,
                clientName: 'LHD Insurance Consulting',
                projectName: 'מודול השוואת אישורי ביטוח - Insurance Certificate Comparison Module',
                description: 'בניית מודול להשוואת דרישות בתנאי מכרז של לקוחות מול אישורי הביטוח שמסופקים על ידי נותני שירות לאותם לקוחות',
                amount: 48000,
                amountWithVat: 56640,
                currency: 'NIS',
                hours: 240,
                hourlyRate: 200,
                status: 'sent',
                validUntil: '2026-02-07',
                proposalType: 'development',
                lineItems: [
                    { description: 'אפיון מפורט ותכנון מערכת', hours: 25, rate: 200 },
                    { description: 'הקמת תשתית וארכיטקטורה (Backend + DB + Cloud)', hours: 30, rate: 200 },
                    { description: 'מודול השוואתי לפרמטרים של אישורי ביטוח', hours: 45, rate: 200 },
                    { description: 'Knowledge Base ביטוחים (מיפוי + Rule Engine)', hours: 30, rate: 200 },
                    { description: 'מנוע OCR להשוואת הצעות', hours: 40, rate: 200 },
                    { description: 'מנוע OCR / AI', hours: 35, rate: 200 },
                    { description: 'ממשק משתמש UI/UX (React Frontend)', hours: 20, rate: 200 },
                    { description: 'בדיקות והטמעה (QA)', hours: 15, rate: 200 }
                ],
                executiveSummary: 'הצעה זו מתייחסת לפיתוח מודול להשוואת דרישות בתנאי מכרז של לקוחות מול אישורי הביטוח שמסופקים על ידי נותני שירות לאותם לקוחות. המערכת תכלול מנוע OCR/AI לניתוח מסמכים, מודול השוואה חכם, וממשק משתמש נוח.',
                included: '• פיתוח מלא של המודול\n• מנוע OCR / AI\n• הקמת תשתית ענן\n• תיעוד טכני ומדריך למשתמש\n• 3 חודשי תמיכה טכנית ושיפורים',
                excluded: '• עלויות ענן שוטפות\n• הזנת נתונים ראשונית\n• *מודל חלוקת רווחים ייבחן בהמשך לאחר סיום הביצוע - יש עלות תחזוקה שוטפת למערכת שתיבחן בהמשך',
                paymentNotes: 'תנאי תשלום: 40% עם חתימת ההסכם, 40% לאחר השלמת מודול ה-OCR, 20% מסירת הפרויקט.\n\nפרטי חשבון: בנק דיסקונט (11), סניף מרום נווה (096), חשבון 178380913, ע״ש אבי לובצ׳יק\n\n*מודל חלוקת רווחים ייבחן בהמשך לאחר סיום הביצוע.',
                projectDuration: '6 שבועות',
                versions: [
                    { version: '1.0', date: '2026-01-05T08:00:00.000Z', note: 'גרסה ראשונית' },
                    { version: '2.0', date: new Date().toISOString(), note: 'עדכון: מודול השוואת אישורי ביטוח, הוספת OCR/AI, הסרת דשבורד וניהול לקוחות' }
                ],
                notes: 'תנאי תשלום: 40% עם חתימת ההסכם, 40% לאחר השלמת מודול ה-OCR, 20% מסירת הפרויקט. משך פרויקט: 6 שבועות. *מודל חלוקת רווחים ייבחן בהמשך לאחר סיום הביצוע',
                created: '2026-01-05T08:00:00.000Z',
                sentDate: '2026-01-07T08:00:00.000Z',
                updated: new Date().toISOString()
            };
            proposals.push(sampleProposal);
            localStorage.setItem('proposals', JSON.stringify(proposals));
        }

        // LHD Insurance v3 proposal - same pricing as v2, with additional comments/clarifications
        const LHD_V3_VERSION = 'v3.0-20260111b';
        const existingLHDv3 = proposals.find(p => p.proposalNumber === 'LHD-001-26-v3');
        if (!existingLHDv3 || existingLHDv3.dataVersion !== LHD_V3_VERSION) {
            proposals = proposals.filter(p => p.proposalNumber !== 'LHD-001-26-v3');
            const lhdV3Proposal = {
                id: 2003,
                proposalNumber: 'LHD-001-26-v3',
                version: '3.0',
                dataVersion: LHD_V3_VERSION,
                clientId: 1001,
                clientName: 'LHD Insurance Consulting',
                projectName: 'מודול השוואת אישורי ביטוח - Insurance Certificate Comparison Module',
                description: 'בניית מודול להשוואת דרישות בתנאי מכרז של לקוחות מול אישורי הביטוח שמסופקים על ידי נותני שירות לאותם לקוחות',
                amount: 48000,
                amountWithVat: 56640,
                currency: 'NIS',
                hours: 240,
                hourlyRate: 200,
                status: 'draft',
                validUntil: '2026-02-15',
                proposalType: 'development',
                lineItems: [
                    { description: 'אפיון מפורט ותכנון מערכת (כולל מוקאפים בסיסיים UX למסכים - לראות UX עין בעין לפני בניית מנועים)', hours: 25, rate: 200 },
                    { description: 'הקמת תשתית וארכיטקטורה (Backend + DB + Cloud)', hours: 30, rate: 200 },
                    { description: 'מודול השוואתי לפרמטרים של אישורי ביטוח', hours: 45, rate: 200 },
                    { description: 'Knowledge Base ביטוחים (מיפוי + Rule Engine)', hours: 30, rate: 200 },
                    { description: 'מחולל RFQ להשוואת הצעות (יצוא ל-Word, PDF ו-Excel) + ניהול תהליך RFQ מקצה לקצה (מעקב סטטוס הצעות, השוואת תשובות מחברות ביטוח, ניתוח הצעות מחיר)', hours: 40, rate: 200 },
                    { description: 'מנוע OCR / AI + שאלון דינמי לשני תרחישים: א. לקוח שמעלה מסמכים + שאלון (הזנה ידנית כהכנה ל-AI/OCR + השוואה בין קיים למוצע), ב. לקוח שעונה רק על שאלון', hours: 35, rate: 200 },
                    { description: 'ממשק משתמש UI/UX (React Frontend)', hours: 20, rate: 200 },
                    { description: 'בדיקות והטמעה (QA)', hours: 15, rate: 200 }
                ],
                executiveSummary: 'הצעה זו מתייחסת לפיתוח מודול להשוואת דרישות בתנאי מכרז של לקוחות מול אישורי הביטוח שמסופקים על ידי נותני שירות לאותם לקוחות. המערכת תכלול מנוע OCR/AI לניתוח מסמכים, מודול השוואה חכם, וממשק משתמש נוח.',
                included: `• פיתוח מלא של המודול
• אפיון מפורט כולל מוקאפים בסיסיים (UX Wireframes) לכל המסכים - נראה את ה-UX עין בעין לפני בניית מנועים
• מחולל RFQ עם יצוא ל-Word, PDF ו-Excel
• ניהול תהליך RFQ מקצה לקצה (מעקב סטטוס הצעות, השוואת תשובות מחברות ביטוח, ניתוח הצעות מחיר)
• שאלון דינמי לשני תרחישים:
  א. לקוח שמעלה מסמכים + שאלון: הזנה ידנית כהכנה ל-AI/OCR + השוואה בין קיים למוצע
  ב. לקוח שעונה רק על שאלון
• מנוע OCR / AI
• הקמת תשתית ענן
• תיעוד טכני ומדריך למשתמש
• 3 חודשי תמיכה טכנית ושיפורים`,
                excluded: `• עלויות ענן שוטפות
• הזנת נתונים ראשונית
• *מודל חלוקת רווחים ייבחן בהמשך לאחר סיום הביצוע - יש עלות תחזוקה שוטפת למערכת שתיבחן בהמשך`,
                ipOwnership: `זכויות קניין רוחני (IP):

1. קוד המקור, הלוגיקה העסקית, והמודלים (כולל מודלי AI/ML, Rule Engine, ו-Knowledge Base) יישארו בבעלות מלאה של דרישתי קונסלטינג בע"מ ("המפתח"). אין שימוש חוזר של הקוד מחוץ לפרויקט זה ללא אישור מפורש.

2. הלקוח מקבל רישיון שימוש בלעדי ובלתי-הדיר במערכת לצרכיו העסקיים בלבד.

3. המפתח שומר לעצמו את הזכות לשימוש חוזר בקוד, בארכיטקטורה, ובמודלים לפרויקטים אחרים, בתנאי שלא ייעשה שימוש בנתוני הלקוח.

4. הלקוח לא יהיה רשאי להעתיק, לשנות, להפיץ, או להעביר את קוד המקור לצד שלישי ללא אישור מראש ובכתב מהמפתח.

5. נתוני הלקוח שיוזנו למערכת יישארו בבעלות מלאה של הלקוח.`,
                paymentNotes: `תנאי תשלום: 40% עם חתימת ההסכם, 40% לאחר השלמת מודול ה-OCR, 20% מסירת הפרויקט.

פרטי חשבון: בנק דיסקונט (11), סניף מרום נווה (096), חשבון 178380913, ע״ש אבי לובצ׳יק

*מודל חלוקת רווחים ייבחן בהמשך לאחר סיום הביצוע.`,
                projectDuration: '6 שבועות',
                versions: [
                    { version: '1.0', date: '2026-01-05T08:00:00.000Z', note: 'גרסה ראשונית' },
                    { version: '2.0', date: '2026-01-07T08:00:00.000Z', note: 'עדכון: מודול השוואת אישורי ביטוח, הוספת OCR/AI, הסרת דשבורד וניהול לקוחות' },
                    { version: '3.0', date: new Date().toISOString(), note: 'הבהרות: יצוא Excel ב-RFQ, ניהול תהליך RFQ מקצה לקצה, מוקאפים UX באפיון, שאלון דינמי לשני תרחישים, 3 חודשי תמיכה, סעיף IP' }
                ],
                notes: `תנאי תשלום: 40% עם חתימת ההסכם, 40% לאחר השלמת מודול ה-OCR, 20% מסירת הפרויקט. משך פרויקט: 6 שבועות. *מודל חלוקת רווחים ייבחן בהמשך לאחר סיום הביצוע

הבהרות בגרסה 3.0:
1. מחולל RFQ - יצוא גם ל-Excel בנוסף ל-Word/PDF
2. ניהול תהליך RFQ מקצה לקצה - מעקב סטטוס הצעות, השוואת תשובות מחברות ביטוח, ניתוח הצעות מחיר (כמו בהצעה הקודמת)
3. אפיון כולל מוקאפים בסיסיים (UX Wireframes) - לראות UX עין בעין לפני בניית מנועים
4. תמיכה טכנית: 3 חודשים (יישור קו עם הצעה ראשונה)
5. שאלון דינמי - שני תרחישים:
   א. לקוח שמעלה מסמכים + שאלון: הזנה ידנית כהכנה ל-AI/OCR + השוואה בין קיים למוצע
   ב. לקוח שעונה רק על שאלון
6. סעיף קניין רוחני (IP) - קוד/לוגיקה/מודלים נשארים אצל דרישתי, ללא שימוש חוזר החוצה`,
                created: new Date().toISOString(),
                updated: new Date().toISOString()
            };
            proposals.push(lhdV3Proposal);
            localStorage.setItem('proposals', JSON.stringify(proposals));
        }

        // Sample project for demo
        if (projects.length === 0) {
            const sampleProject = {
                id: 1001,
                projectNumber: 'PRJ-2026-001',
                proposalId: 2001,
                proposalNumber: 'LHD-001-26',
                clientId: 1001,
                clientName: 'LHD Insurance Consulting',
                clientEmail: 'moshe@lhd-insurance.co.il',
                name: 'Insurance Claims Management System',
                description: 'Digital transformation of claims processing workflow',
                type: 'development',
                totalBudget: 85000,
                totalHours: 320,
                startDate: '2026-01-05',
                expectedEndDate: '2026-03-30',
                actualEndDate: null,
                status: 'active',
                overallProgress: 52,
                stages: [
                    { id: 0, name: 'Discovery & Requirements', description: 'Understanding needs', estimatedHours: 32, actualHours: 30, status: 'completed', completionPercent: 100, startDate: '2026-01-05', completedDate: '2026-01-12', notes: 'All requirements documented, stakeholders interviewed', blockers: '', actionRequired: '' },
                    { id: 1, name: 'System Design', description: 'Architecture design', estimatedHours: 48, actualHours: 52, status: 'completed', completionPercent: 100, startDate: '2026-01-13', completedDate: '2026-01-25', notes: 'Database schema finalized, UI mockups approved', blockers: '', actionRequired: '' },
                    { id: 2, name: 'Development - Phase 1', description: 'Backend development', estimatedHours: 80, actualHours: 65, status: 'in_progress', completionPercent: 75, startDate: '2026-01-26', completedDate: null, notes: 'API endpoints 90% complete, authentication done, JWT auth implemented', blockers: 'Waiting for client API credentials for legacy system integration', actionRequired: 'Please provide API credentials and documentation for the legacy claims system (SOAP/REST endpoints, authentication keys)' },
                    { id: 3, name: 'Development - Phase 2', description: 'Frontend development', estimatedHours: 80, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '', actionRequired: '' },
                    { id: 4, name: 'Testing & QA', description: 'Quality assurance', estimatedHours: 48, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '', actionRequired: '' },
                    { id: 5, name: 'Deployment & Training', description: 'Go-live', estimatedHours: 32, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '', actionRequired: '' }
                ],
                totalHoursSpent: 147,
                shortId: 'lhd-001',
                shareToken: 'demo123abc',
                lastClientView: null,
                created: '2026-01-05T08:00:00.000Z',
                updated: new Date().toISOString(),
                // Technical details for client visibility
                technicalDetails: {
                    dbSchema: `claims (id, policy_id, status)
policies (id, client_id, type)
users (id, email, role)
audit_log (id, action, date)`,
                    apiEndpoints: `POST /api/claims
GET  /api/claims/:id
PUT  /api/claims/:id/status
GET  /api/policies
POST /api/auth/login`,
                    deliverables: [
                        { name: 'User authentication system', done: true },
                        { name: 'Claims submission API', done: true },
                        { name: 'Policy lookup service', done: true },
                        { name: 'Status update workflow', done: false },
                        { name: 'Legacy system integration', done: false },
                        { name: 'Admin dashboard', done: false }
                    ]
                }
            };
            projects.push(sampleProject);
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // TAG Urbanic proposal (add if not exists)
        if (!proposals.find(p => p.proposalNumber === 'DRS-2024-TAG')) {
            const tagProposal = {
                id: 2002,
                proposalNumber: 'DRS-2024-TAG',
                clientId: 1006,
                clientName: 'Tag Urbanic Investment Management',
                projectName: 'Monday.com to Excel - Automatic Data Sync',
                description: 'חיבור ממשק Monday.com לאקסל – סנכרון נתונים אוטומטי. ממשק תצוגה אינטרנטי שיסתנכרן בנתוני אמת מהמאנדיי כל 4 שעות',
                amount: 7500,
                amountWithVat: 8775,
                currency: 'NIS',
                hours: 20,
                hourlyRate: 375,
                status: 'accepted',
                validUntil: '2025-01-09',
                proposalType: 'development',
                paidAmount: 3835,
                items: [
                    { description: 'אפיון מבנה הנתונים הרלוונטי במערכת Monday', hours: 5, amount: 1875 },
                    { description: 'חיבור טכני בין Monday לבין Excel באמצעות API / אוטומציה', hours: 8, amount: 3000 },
                    { description: 'בדיקות תקינות, סנכרון ויציבות', hours: 4, amount: 1500 },
                    { description: 'ממשק תצוגה אינטרנטי שיסתנכרן בנתוני אמת מהמאנדיי כל 4 שעות', hours: 3, amount: 1125 }
                ],
                notes: 'תנאי תשלום: 50% עם אישור עבודה ו-50% עם קבלת העבודה ואישורה. המחירים אינם כוללים מע"מ. מאושר: גיא גפני 01/01/2026',
                created: '2024-12-25T08:00:00.000Z',
                sentDate: '2024-12-25T08:00:00.000Z',
                acceptedDate: '2026-01-01T08:00:00.000Z'
            };
            proposals.push(tagProposal);
            localStorage.setItem('proposals', JSON.stringify(proposals));
        }

        // TAG Urbanic project (completed)
        if (!projects.find(p => p.projectNumber === 'PRJ-2024-TAG')) {
            const tagProject = {
                id: 1002,
                projectNumber: 'PRJ-2024-TAG',
                proposalId: 2002,
                proposalNumber: 'DRS-2024-TAG',
                clientId: 1006,
                clientName: 'Tag Urbanic Investment Management',
                clientEmail: 'guy@tagurbanic.co.il',
                name: 'Monday.com to Excel - Data Sync Interface',
                description: 'Automatic data synchronization from Monday.com to Excel with 4-hour refresh',
                type: 'development',
                totalBudget: 8775,
                totalHours: 20,
                paidAmount: 3835,
                startDate: '2024-12-25',
                expectedEndDate: '2026-01-01',
                actualEndDate: '2026-01-01',
                status: 'completed',
                overallProgress: 100,
                stages: [
                    { id: 0, name: 'Data Structure Analysis', description: 'Monday.com mapping', estimatedHours: 4, actualHours: 4, status: 'completed', completionPercent: 100, startDate: '2024-12-25', completedDate: '2024-12-27', notes: 'Monday.com board structure mapped, all fields identified', blockers: '', actionRequired: '' },
                    { id: 1, name: 'API Integration Development', description: 'Monday to Excel connection', estimatedHours: 8, actualHours: 8, status: 'completed', completionPercent: 100, startDate: '2024-12-28', completedDate: '2024-12-30', notes: 'Monday.com API connected, Excel output configured', blockers: '', actionRequired: '' },
                    { id: 2, name: 'Testing & Validation', description: 'Sync verification', estimatedHours: 4, actualHours: 4, status: 'completed', completionPercent: 100, startDate: '2024-12-30', completedDate: '2024-12-31', notes: 'Data sync verified, 4-hour refresh cycle tested successfully', blockers: '', actionRequired: '' },
                    { id: 3, name: 'Deployment & Handover', description: 'Go-live and training', estimatedHours: 4, actualHours: 4, status: 'completed', completionPercent: 100, startDate: '2024-12-31', completedDate: '2026-01-01', notes: 'System live, client trained on usage', blockers: '', actionRequired: '' }
                ],
                totalHoursSpent: 20,
                shortId: 'tag-001',
                shareToken: 'tag001xyz',
                lastClientView: '2026-01-01T10:00:00.000Z',
                created: '2024-12-25T08:00:00.000Z',
                updated: '2026-01-01T12:00:00.000Z',
                technicalDetails: {
                    dbSchema: `Monday.com Boards:
- Properties (id, name, status, value)
- Investments (id, property_id, amount)
- Contacts (id, name, email, phone)`,
                    apiEndpoints: `GET /boards/{id}/items
GET /items/{id}/column_values
Excel Export: Auto-refresh every 4 hours
Webhook: Real-time updates`,
                    deliverables: [
                        { name: 'Monday.com API connection', done: true },
                        { name: 'Excel sync automation', done: true },
                        { name: '4-hour auto-refresh scheduler', done: true },
                        { name: 'Web display interface', done: true },
                        { name: 'Data validation tests', done: true },
                        { name: 'Client documentation & training', done: true }
                    ]
                }
            };
            projects.push(tagProject);
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // Stage templates by project type
        const stageTemplates = {
            development: [
                { name: 'Discovery & Requirements', percent: 10, description: 'Understanding needs, documenting requirements' },
                { name: 'System Design', percent: 15, description: 'Architecture, database design, UI mockups' },
                { name: 'Development - Phase 1', percent: 25, description: 'Core functionality, backend development' },
                { name: 'Development - Phase 2', percent: 25, description: 'Frontend, integrations, features' },
                { name: 'Testing & QA', percent: 15, description: 'Testing, bug fixes, quality assurance' },
                { name: 'Deployment & Training', percent: 10, description: 'Go-live, documentation, user training' }
            ],
            characterization: [
                { name: 'Initial Assessment', percent: 20, description: 'Current state analysis' },
                { name: 'Stakeholder Interviews', percent: 25, description: 'Gathering requirements from users' },
                { name: 'Requirements Documentation', percent: 30, description: 'Writing detailed specifications' },
                { name: 'Recommendations Report', percent: 25, description: 'Final deliverable with recommendations' }
            ],
            consulting: [
                { name: 'Kickoff & Discovery', percent: 15, description: 'Project initiation, understanding context' },
                { name: 'Analysis & Research', percent: 35, description: 'Deep dive, data analysis, research' },
                { name: 'Strategy Development', percent: 30, description: 'Developing recommendations' },
                { name: 'Final Deliverables', percent: 20, description: 'Reports, presentations, handoff' }
            ]
        };

        // Login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('password').value;
            if (password === ADMIN_PASSWORD || password === localStorage.getItem('adminPassword')) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                trackLogin();
                renderClients();
                updateStats();
                updateClientStats();
            } else {
                alert('Invalid password');
            }
        });

        function logout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('password').value = '';
        }

        // Navigation
        document.querySelectorAll('.nav-item[data-page]').forEach(item => {
            item.addEventListener('click', function() {
                const page = this.dataset.page;

                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                document.getElementById('page-' + page).classList.remove('hidden');

                trackPageView(page);

                if (page === 'proposals') {
                    renderProposals();
                    updateProposalClientSelect();
                }
                if (page === 'invoices') {
                    renderInvoices();
                    updateInvoiceStats();
                    updateInvoiceClientSelect();
                }
                if (page === 'expenses') {
                    renderExpenses();
                    updateExpenseStats();
                }
                if (page === 'projects') {
                    renderProjects();
                    updateProjectStats();
                }
                if (page === 'analytics') {
                    updateAnalytics();
                }
                if (page === 'templates') {
                    renderTemplatesPage();
                }
                if (page === 'settings') {
                    updateDataCounts();
                }
                if (page === 'dashboard') {
                    updateDashboard();
                    updateDashboardAlerts();
                    updateUpcomingDeadlines();
                }
            });
        });

        // Modal functions
        function openModal(name) {
            document.getElementById('modal-' + name).classList.add('active');
            if (name === 'newProposal') {
                updateProposalClientSelect();
            }
            if (name === 'newInvoice') {
                updateInvoiceClientSelect();
            }
            if (name === 'newExpense') {
                // Set default date to today
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            }
            if (name === 'newProject') {
                updateProjectClientSelect();
                updateProjectProposalSelect();
                document.getElementById('projectStartDate').value = new Date().toISOString().split('T')[0];
                // Clear stages list
                document.getElementById('stagesList').innerHTML = '<div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">Select a project type to load stage template, or add stages manually</div>';
            }
        }

        function closeModal(name) {
            document.getElementById('modal-' + name).classList.remove('active');
            if (name === 'addClient') {
                resetClientForm();
            }
            if (name === 'newProposal') {
                resetProposalForm();
            }
            if (name === 'newInvoice') {
                resetInvoiceForm();
            }
            if (name === 'newExpense') {
                resetExpenseForm();
            }
            if (name === 'newProject') {
                resetProjectForm();
            }
        }

        // Contact management
        let contactIndex = 1;

        function addContactField() {
            const contactsList = document.getElementById('contactsList');
            const newContact = document.createElement('div');
            newContact.className = 'contact-entry';
            newContact.dataset.index = contactIndex;
            newContact.innerHTML = `
                <button type="button" class="btn-remove-contact" onclick="removeContact(this)">&times;</button>
                <div class="contact-row">
                    <input type="text" name="contact_name_${contactIndex}" placeholder="Name *" required>
                    <input type="text" name="contact_position_${contactIndex}" placeholder="Position">
                </div>
                <div class="contact-row">
                    <input type="email" name="contact_email_${contactIndex}" placeholder="Email *" required>
                    <input type="tel" name="contact_phone_${contactIndex}" placeholder="Phone">
                </div>
            `;
            contactsList.appendChild(newContact);
            contactIndex++;
        }

        function removeContact(btn) {
            const entry = btn.closest('.contact-entry');
            const contactsList = document.getElementById('contactsList');
            if (contactsList.children.length > 1) {
                entry.remove();
            } else {
                alert('At least one contact is required');
            }
        }

        function getContacts() {
            const contacts = [];
            const entries = document.querySelectorAll('#contactsList .contact-entry');
            entries.forEach(entry => {
                const idx = entry.dataset.index;
                const name = entry.querySelector(`input[name="contact_name_${idx}"]`).value;
                const email = entry.querySelector(`input[name="contact_email_${idx}"]`).value;
                if (name && email) {
                    contacts.push({
                        name: name,
                        position: entry.querySelector(`input[name="contact_position_${idx}"]`).value,
                        email: email,
                        phone: entry.querySelector(`input[name="contact_phone_${idx}"]`).value
                    });
                }
            });
            return contacts;
        }

        function resetContactFields() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = `
                <div class="contact-entry" data-index="0">
                    <div class="contact-row">
                        <input type="text" name="contact_name_0" placeholder="Name *" required>
                        <input type="text" name="contact_position_0" placeholder="Position">
                    </div>
                    <div class="contact-row">
                        <input type="email" name="contact_email_0" placeholder="Email *" required>
                        <input type="tel" name="contact_phone_0" placeholder="Phone">
                    </div>
                </div>
            `;
            contactIndex = 1;
        }

        // Client management
        document.getElementById('addClientForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const contacts = getContacts();
            if (contacts.length === 0) {
                alert('Please add at least one contact');
                return;
            }

            if (editingClientId) {
                // Update existing client
                const clientIndex = clients.findIndex(c => c.id === editingClientId);
                if (clientIndex !== -1) {
                    clients[clientIndex] = {
                        ...clients[clientIndex],
                        company: document.getElementById('clientCompany').value,
                        contacts: contacts,
                        contact: contacts[0].name,
                        position: contacts[0].position,
                        email: contacts[0].email,
                        phone: contacts[0].phone,
                        industry: document.getElementById('clientIndustry').value,
                        notes: document.getElementById('clientNotes').value,
                        pipelineStage: document.getElementById('clientPipelineStage').value,
                        leadSource: document.getElementById('clientLeadSource').value,
                        estimatedValue: parseInt(document.getElementById('clientEstimatedValue').value) || 0,
                        updated: new Date().toISOString()
                    };
                }
                saveData();
                renderClients();
                renderPipeline();
                updateStats();
                updateClientStats();
                closeModal('addClient');
                resetClientForm();
                showToast('Client updated successfully!');
            } else {
                // Add new client
                const client = {
                    id: Date.now(),
                    company: document.getElementById('clientCompany').value,
                    contacts: contacts,
                    contact: contacts[0].name,
                    position: contacts[0].position,
                    email: contacts[0].email,
                    phone: contacts[0].phone,
                    industry: document.getElementById('clientIndustry').value,
                    notes: document.getElementById('clientNotes').value,
                    pipelineStage: document.getElementById('clientPipelineStage').value || 'lead',
                    leadSource: document.getElementById('clientLeadSource').value,
                    estimatedValue: parseInt(document.getElementById('clientEstimatedValue').value) || 0,
                    status: 'active',
                    created: new Date().toISOString()
                };

                clients.push(client);
                saveData();
                renderClients();
                renderPipeline();
                updateStats();
                updateClientStats();
                closeModal('addClient');
                this.reset();
                resetContactFields();
                showToast('Client added successfully!');
            }
        });

        function renderClients(filteredClients = null) {
            const tbody = document.getElementById('clientsTable');
            const clientsToRender = filteredClients || clients;

            if (clientsToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">No clients found</td></tr>';
                return;
            }

            tbody.innerHTML = clientsToRender.map(client => {
                const contacts = client.contacts || [{ name: client.contact, position: client.position, email: client.email, phone: client.phone }];
                const contactsHtml = contacts.map(c => `${c.name}${c.position ? ' (' + c.position + ')' : ''}`).join('<br>');
                const emailsHtml = contacts.map(c => c.email).join('<br>');
                const contactCount = contacts.length > 1 ? `<span style="color: var(--primary); font-size: 11px;">(${contacts.length} contacts)</span>` : '';
                const stage = client.pipelineStage || 'customer';
                const stageLabels = { lead: 'Lead', qualified: 'Qualified', proposal: 'Proposal Sent', negotiation: 'Negotiation', customer: 'Customer', lost: 'Lost' };
                const lastComm = getLastCommunication(client.id);
                const lastContactDate = lastComm ? formatRelativeDate(lastComm.date) : 'Never';

                return `
                <tr style="cursor: pointer;" ondblclick="viewClient(${client.id})">
                    <td><strong>${client.company}</strong><br><small style="color: var(--gray)">${client.industry || 'N/A'}</small></td>
                    <td>${contactsHtml} ${contactCount}</td>
                    <td><small>${emailsHtml}</small></td>
                    <td><span class="stage-badge ${stage}">${stageLabels[stage] || stage}</span></td>
                    <td><small style="color: var(--gray);">${lastContactDate}</small></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); viewClient(${client.id})" title="View">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openLogCommunicationFor(${client.id})" title="Log">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editClient(${client.id})" title="Edit">Edit</button>
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); createProposalFor(${client.id})" title="Proposal">Proposal</button>
                            <button class="btn btn-sm" style="background: var(--danger); color: white;" onclick="event.stopPropagation(); deleteClient(${client.id})" title="Delete">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function filterClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase().trim();
            const industryFilter = document.getElementById('clientIndustryFilter').value;
            const pipelineFilter = document.getElementById('clientPipelineFilter').value;

            let filtered = clients;

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(client => {
                    const contacts = client.contacts || [{ name: client.contact, email: client.email }];
                    const contactMatch = contacts.some(c =>
                        (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                        (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                        (c.position && c.position.toLowerCase().includes(searchTerm))
                    );
                    return client.company.toLowerCase().includes(searchTerm) ||
                           (client.industry && client.industry.toLowerCase().includes(searchTerm)) ||
                           contactMatch;
                });
            }

            // Filter by industry
            if (industryFilter) {
                filtered = filtered.filter(client => client.industry === industryFilter);
            }

            // Filter by pipeline stage
            if (pipelineFilter) {
                filtered = filtered.filter(client => (client.pipelineStage || 'customer') === pipelineFilter);
            }

            renderClients(filtered);
        }

        function filterByPipeline(stage) {
            document.getElementById('clientPipelineFilter').value = stage;
            filterClients();
        }

        function deleteClient(id) {
            if (confirm('Delete this client?')) {
                clients = clients.filter(c => c.id !== id);
                saveData();
                renderClients();
                renderPipeline();
                updateStats();
                updateClientStats();
                showToast('Client deleted');
            }
        }

        // Edit client
        let editingClientId = null;

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            editingClientId = id;

            // Update modal title
            document.querySelector('#modal-addClient .modal-title').textContent = 'Edit Client';
            document.querySelector('#modal-addClient form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields
            document.getElementById('clientCompany').value = client.company;
            document.getElementById('clientIndustry').value = client.industry || '';
            document.getElementById('clientNotes').value = client.notes || '';
            document.getElementById('clientPipelineStage').value = client.pipelineStage || 'lead';
            document.getElementById('clientLeadSource').value = client.leadSource || '';
            document.getElementById('clientEstimatedValue').value = client.estimatedValue || '';

            // Fill contacts
            const contacts = client.contacts || [{
                name: client.contact,
                position: client.position,
                email: client.email,
                phone: client.phone
            }];

            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';
            contactIndex = 0;

            contacts.forEach((contact, idx) => {
                const isFirst = idx === 0;
                const contactDiv = document.createElement('div');
                contactDiv.className = 'contact-entry';
                contactDiv.dataset.index = idx;
                contactDiv.innerHTML = `
                    ${!isFirst ? '<button type="button" class="btn-remove-contact" onclick="removeContact(this)">&times;</button>' : ''}
                    <div class="contact-row">
                        <input type="text" name="contact_name_${idx}" placeholder="Name *" value="${contact.name || ''}" required>
                        <input type="text" name="contact_position_${idx}" placeholder="Position" value="${contact.position || ''}">
                    </div>
                    <div class="contact-row">
                        <input type="email" name="contact_email_${idx}" placeholder="Email *" value="${contact.email || ''}" required>
                        <input type="tel" name="contact_phone_${idx}" placeholder="Phone" value="${contact.phone || ''}">
                    </div>
                `;
                contactsList.appendChild(contactDiv);
                contactIndex = idx + 1;
            });

            openModal('addClient');
        }

        function resetClientForm() {
            editingClientId = null;
            document.querySelector('#modal-addClient .modal-title').textContent = 'Add New Client';
            document.querySelector('#modal-addClient form button[type="submit"]').textContent = 'Add Client';
            document.getElementById('addClientForm').reset();
            document.getElementById('clientPipelineStage').value = 'lead';
            document.getElementById('clientLeadSource').value = '';
            document.getElementById('clientEstimatedValue').value = '';
            resetContactFields();
        }

        function createProposalFor(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                openModal('newProposal');
                setTimeout(() => {
                    document.getElementById('proposalClient').value = clientId;
                }, 100);
            }
        }

        // ========== Client Pipeline & CRM Functions ==========

        function setClientView(view) {
            currentClientView = view;
            const tableBtn = document.getElementById('clientViewTable');
            const pipelineBtn = document.getElementById('clientViewPipeline');
            const tableView = document.getElementById('clientsTableView');
            const pipelineView = document.getElementById('clientsPipelineView');

            if (view === 'table') {
                tableBtn.style.background = 'var(--primary)';
                pipelineBtn.style.background = 'rgba(255,255,255,0.05)';
                tableView.style.display = 'block';
                pipelineView.style.display = 'none';
                renderClients();
            } else {
                tableBtn.style.background = 'rgba(255,255,255,0.05)';
                pipelineBtn.style.background = 'var(--primary)';
                tableView.style.display = 'none';
                pipelineView.style.display = 'block';
                renderPipeline();
            }
        }

        function renderPipeline() {
            const stages = ['lead', 'qualified', 'proposal', 'negotiation', 'customer'];
            const stageCounts = {};

            stages.forEach(stage => {
                stageCounts[stage] = 0;
                const container = document.getElementById(`pipeline${stage.charAt(0).toUpperCase() + stage.slice(1)}Cards`);
                if (container) container.innerHTML = '';
            });

            clients.forEach(client => {
                const stage = client.pipelineStage || 'customer';
                if (!stages.includes(stage)) return;

                stageCounts[stage]++;
                const container = document.getElementById(`pipeline${stage.charAt(0).toUpperCase() + stage.slice(1)}Cards`);
                if (!container) return;

                const contacts = client.contacts || [{ name: client.contact, email: client.email }];
                const primaryContact = contacts[0];
                const value = client.estimatedValue ? `₪${client.estimatedValue.toLocaleString()}` : '';

                const card = document.createElement('div');
                card.className = 'pipeline-card';
                card.draggable = true;
                card.dataset.clientId = client.id;
                card.ondragstart = (e) => dragClient(e, client.id);
                card.ondragend = () => card.classList.remove('dragging');
                card.ondblclick = () => viewClient(client.id);

                card.innerHTML = `
                    <div class="pipeline-card-company">${client.company}</div>
                    <div class="pipeline-card-contact">${primaryContact.name}</div>
                    ${value ? `<div class="pipeline-card-value">${value}</div>` : ''}
                    <div class="pipeline-card-actions">
                        <button class="btn btn-sm" onclick="event.stopPropagation(); viewClient(${client.id})" style="padding: 4px 8px; font-size: 11px;">View</button>
                        <button class="btn btn-sm" onclick="event.stopPropagation(); openLogCommunicationFor(${client.id})" style="padding: 4px 8px; font-size: 11px;">Log</button>
                    </div>
                `;
                container.appendChild(card);
            });

            // Update counts
            stages.forEach(stage => {
                const countEl = document.getElementById(`pipeline${stage.charAt(0).toUpperCase() + stage.slice(1)}Count`);
                if (countEl) countEl.textContent = stageCounts[stage];
            });
        }

        function updateClientStats() {
            const stages = { lead: 0, qualified: 0, proposal: 0, negotiation: 0, customer: 0 };
            clients.forEach(c => {
                const stage = c.pipelineStage || 'customer';
                if (stages.hasOwnProperty(stage)) stages[stage]++;
            });

            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('leadsCount').textContent = stages.lead;
            document.getElementById('qualifiedCount').textContent = stages.qualified;
            document.getElementById('customersCount').textContent = stages.customer;
        }

        function dragClient(e, clientId) {
            e.dataTransfer.setData('text/plain', clientId);
            e.target.classList.add('dragging');
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dropClient(e, newStage) {
            e.preventDefault();
            const clientId = parseInt(e.dataTransfer.getData('text/plain'));
            const client = clients.find(c => c.id === clientId);
            if (client && client.pipelineStage !== newStage) {
                client.pipelineStage = newStage;
                client.updated = new Date().toISOString();
                saveData();
                renderPipeline();
                updateClientStats();
                showToast(`Moved to ${newStage}`);
            }
        }

        // Helper functions for communication
        function getLastCommunication(clientId) {
            const clientComms = communicationLogs.filter(c => c.clientId === clientId);
            if (clientComms.length === 0) return null;
            return clientComms.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        }

        function formatRelativeDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diff === 0) return 'Today';
            if (diff === 1) return 'Yesterday';
            if (diff < 7) return `${diff} days ago`;
            if (diff < 30) return `${Math.floor(diff / 7)} weeks ago`;
            if (diff < 365) return `${Math.floor(diff / 30)} months ago`;
            return date.toLocaleDateString('en-GB');
        }

        // Client Detail View - Client 360
        function viewClient(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;

            viewingClientId = id;
            document.getElementById('clientDetailTitle').textContent = client.company;
            document.getElementById('editClientFromDetail').onclick = () => {
                closeModal('clientDetail');
                editClient(id);
            };

            // Reset to overview tab
            document.querySelectorAll('.client-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.client-tab[data-tab="overview"]').classList.add('active');
            document.querySelectorAll('.client-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('tabOverview').classList.remove('hidden');

            // Render Client 360 Summary
            renderClient360Summary(client);
            renderClientOverview(client);
            renderClientContacts(client);
            renderClientCommunications(client);
            renderClientProposals(client);
            renderClientProjects(client);
            renderClientInvoices(client);

            openModal('clientDetail');
        }

        // Client 360 Financial Summary
        function renderClient360Summary(client) {
            const clientInvoices = invoices.filter(i => i.clientId === client.id);
            const clientProposals = proposals.filter(p => p.clientId === client.id);
            const clientProjects = projects.filter(p => p.clientId === client.id);

            // Calculate totals
            const totalRevenue = clientInvoices.filter(i => i.status === 'paid').reduce((sum, i) => sum + (i.amount || 0), 0);
            const outstanding = clientInvoices.filter(i => i.status !== 'paid').reduce((sum, i) => sum + (i.amount || 0), 0);
            const activeProjects = clientProjects.filter(p => p.status === 'active' || p.status === 'in-progress').length;
            const pendingProposals = clientProposals.filter(p => p.status === 'sent' || p.status === 'draft').length;

            document.getElementById('client360Revenue').textContent = '₪' + totalRevenue.toLocaleString();
            document.getElementById('client360Outstanding').textContent = '₪' + outstanding.toLocaleString();
            document.getElementById('client360Projects').textContent = activeProjects;
            document.getElementById('client360Proposals').textContent = clientProposals.length + (pendingProposals > 0 ? ` (${pendingProposals} pending)` : '');
        }

        // Render client projects in Client 360 view
        function renderClientProjects(client) {
            const clientProjects = projects.filter(p => p.clientId === client.id);
            const container = document.getElementById('clientProjectsList');

            if (clientProjects.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No projects for this client</p>';
                return;
            }

            container.innerHTML = clientProjects.map(p => {
                const progress = p.overallProgress || 0;
                const statusColors = { active: 'var(--success)', 'in-progress': 'var(--primary)', completed: 'var(--gray)', 'on-hold': 'var(--warning)' };
                const statusColor = statusColors[p.status] || 'var(--gray)';

                return `
                    <div style="background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0 0 4px 0;">${p.name}</h4>
                                <p style="margin: 0; color: var(--gray); font-size: 12px;">${p.description || 'No description'}</p>
                            </div>
                            <span style="background: ${statusColor}22; color: ${statusColor}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${p.status || 'active'}</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--gray); margin-bottom: 4px;">
                                <span>Progress</span>
                                <span>${progress}%</span>
                            </div>
                            <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; width: ${progress}%; background: var(--gradient); border-radius: 3px;"></div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--gray);">
                            <span>Budget: ₪${(p.totalBudget || 0).toLocaleString()}</span>
                            <span>Hours: ${p.totalHoursSpent || 0}/${p.totalHours || 0}</span>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="closeModal('clientDetail'); openProjectManagement(${p.id});">Manage</button>
                            <button class="btn btn-sm" style="background: rgba(99,102,241,0.2); color: var(--primary);" onclick="closeModal('clientDetail'); showPage('projects');">View All</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Create project for specific client
        function createProjectFor(clientId) {
            openModal('newProject');
            setTimeout(() => {
                document.getElementById('projectClient').value = clientId;
            }, 100);
        }

        function switchClientTab(tab) {
            document.querySelectorAll('.client-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.client-tab[data-tab="${tab}"]`).classList.add('active');
            document.querySelectorAll('.client-tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');
        }

        function renderClientOverview(client) {
            const stageLabels = { lead: 'Lead', qualified: 'Qualified', proposal: 'Proposal Sent', negotiation: 'Negotiation', customer: 'Customer', lost: 'Lost' };
            const sourceLabels = { referral: 'Referral', website: 'Website', linkedin: 'LinkedIn', cold_outreach: 'Cold Outreach', conference: 'Conference/Event', existing: 'Existing Contact', other: 'Other' };

            document.getElementById('clientOverviewInfo').innerHTML = `
                <p style="margin: 0 0 8px 0;"><strong>Industry:</strong> ${client.industry || 'N/A'}</p>
                <p style="margin: 0 0 8px 0;"><strong>Lead Source:</strong> ${sourceLabels[client.leadSource] || 'N/A'}</p>
                <p style="margin: 0 0 8px 0;"><strong>Est. Value:</strong> ${client.estimatedValue ? '₪' + client.estimatedValue.toLocaleString() : 'N/A'}</p>
                <p style="margin: 0;"><strong>Notes:</strong> ${client.notes || 'None'}</p>
            `;

            const stage = client.pipelineStage || 'customer';
            document.getElementById('clientOverviewStage').innerHTML = `
                <div style="text-align: center;">
                    <span class="stage-badge ${stage}" style="font-size: 14px; padding: 8px 16px;">${stageLabels[stage]}</span>
                    <p style="margin: 12px 0 0 0; color: var(--gray); font-size: 12px;">
                        Client since ${new Date(client.created).toLocaleDateString('en-GB')}
                    </p>
                </div>
            `;

            // Recent activity
            const recentComms = communicationLogs.filter(c => c.clientId === client.id).sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
            const recentProposals = proposals.filter(p => p.clientId === client.id).sort((a, b) => new Date(b.created) - new Date(a.created)).slice(0, 2);

            let activityHtml = '';
            if (recentComms.length === 0 && recentProposals.length === 0) {
                activityHtml = '<p style="color: var(--gray); margin: 0;">No recent activity</p>';
            } else {
                recentComms.forEach(comm => {
                    activityHtml += `<p style="margin: 0 0 8px 0;"><span style="color: var(--primary);">${comm.type}</span>: ${comm.subject} - ${formatRelativeDate(comm.date)}</p>`;
                });
                recentProposals.forEach(p => {
                    activityHtml += `<p style="margin: 0 0 8px 0;"><span style="color: #8b5cf6;">Proposal</span>: ${p.projectName || p.project} - ₪${p.amount.toLocaleString()}</p>`;
                });
            }
            document.getElementById('clientRecentActivity').innerHTML = activityHtml;
        }

        function renderClientContacts(client) {
            const contacts = client.contacts || [{ name: client.contact, position: client.position, email: client.email, phone: client.phone }];
            const container = document.getElementById('clientContactsList');

            container.innerHTML = contacts.map((c, i) => `
                <div style="background: rgba(255,255,255,0.02); border-radius: 8px; padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h4 style="margin: 0 0 4px 0;">${c.name}</h4>
                            <p style="margin: 0; color: var(--gray); font-size: 13px;">${c.position || 'No title'}</p>
                        </div>
                        ${i === 0 ? '<span style="background: rgba(99,102,241,0.2); color: var(--primary); padding: 2px 8px; border-radius: 4px; font-size: 11px;">Primary</span>' : ''}
                    </div>
                    <div style="margin-top: 12px; display: flex; gap: 16px; font-size: 13px;">
                        <a href="mailto:${c.email}" style="color: var(--primary); text-decoration: none;">${c.email}</a>
                        ${c.phone ? `<span style="color: var(--gray);">${c.phone}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderClientCommunications(client) {
            const comms = communicationLogs.filter(c => c.clientId === client.id).sort((a, b) => new Date(b.date) - new Date(a.date));
            const container = document.getElementById('clientCommunicationsList');

            if (comms.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No communications logged yet</p>';
                return;
            }

            const icons = {
                call: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
                email: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
                meeting: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
                video: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>',
                note: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>'
            };

            container.innerHTML = comms.map(comm => `
                <div class="comm-item">
                    <div class="comm-icon ${comm.type}">${icons[comm.type] || icons.note}</div>
                    <div class="comm-content">
                        <div class="comm-header">
                            <span class="comm-subject">${comm.subject}</span>
                            <span class="comm-date">${new Date(comm.date).toLocaleString('en-GB', { dateStyle: 'medium', timeStyle: 'short' })}</span>
                        </div>
                        ${comm.contactName ? `<p style="margin: 4px 0; font-size: 12px; color: var(--gray);">With: ${comm.contactName}</p>` : ''}
                        ${comm.notes ? `<p class="comm-notes">${comm.notes}</p>` : ''}
                        ${comm.followUp ? `<div class="comm-followup"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Follow-up: ${new Date(comm.followUpDate).toLocaleDateString('en-GB')}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderClientProposals(client) {
            const clientProposals = proposals.filter(p => p.clientId === client.id);
            const container = document.getElementById('clientProposalsList');

            if (clientProposals.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No proposals for this client</p>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr><th>Proposal #</th><th>Project</th><th>Amount</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        ${clientProposals.map(p => `
                            <tr>
                                <td>${p.proposalNumber || p.number || 'N/A'}</td>
                                <td>${p.projectName || p.project}</td>
                                <td>₪${p.amount.toLocaleString()}</td>
                                <td><span class="status-badge status-${p.status === 'accepted' ? 'active' : p.status === 'draft' ? 'pending' : 'sent'}">${p.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderClientInvoices(client) {
            const clientInvoices = invoices.filter(i => i.clientId === client.id);
            const container = document.getElementById('clientInvoicesList');

            if (clientInvoices.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center;">No invoices for this client</p>';
                return;
            }

            container.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr><th>Invoice #</th><th>Amount</th><th>Date</th><th>Status</th></tr>
                    </thead>
                    <tbody>
                        ${clientInvoices.map(i => `
                            <tr>
                                <td>${i.number}</td>
                                <td>₪${i.amount.toLocaleString()}</td>
                                <td>${new Date(i.date).toLocaleDateString('en-GB')}</td>
                                <td><span class="status-badge status-${i.status === 'paid' ? 'active' : i.status === 'overdue' ? 'overdue' : 'pending'}">${i.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Communication Logging
        function openLogCommunicationFor(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            document.getElementById('commClientId').value = clientId;
            document.getElementById('commDate').value = new Date().toISOString().slice(0, 16);

            // Populate contacts dropdown
            const contactSelect = document.getElementById('commContact');
            const contacts = client.contacts || [{ name: client.contact }];
            contactSelect.innerHTML = '<option value="">Select contact...</option>' +
                contacts.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            document.getElementById('logCommunicationForm').reset();
            document.getElementById('commClientId').value = clientId;
            document.getElementById('commDate').value = new Date().toISOString().slice(0, 16);

            openModal('logCommunication');
        }

        function openLogCommunication() {
            if (viewingClientId) {
                openLogCommunicationFor(viewingClientId);
            }
        }

        // Follow-up toggle
        document.getElementById('commFollowUp').addEventListener('change', function() {
            const dateField = document.getElementById('commFollowUpDate');
            dateField.style.display = this.checked ? 'block' : 'none';
            if (this.checked && !dateField.value) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                dateField.value = tomorrow.toISOString().split('T')[0];
            }
        });

        // Communication form submission
        document.getElementById('logCommunicationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const comm = {
                id: Date.now(),
                clientId: parseInt(document.getElementById('commClientId').value),
                type: document.getElementById('commType').value,
                date: document.getElementById('commDate').value,
                contactName: document.getElementById('commContact').value,
                subject: document.getElementById('commSubject').value,
                notes: document.getElementById('commNotes').value,
                followUp: document.getElementById('commFollowUp').checked,
                followUpDate: document.getElementById('commFollowUp').checked ? document.getElementById('commFollowUpDate').value : null,
                created: new Date().toISOString()
            };

            communicationLogs.push(comm);
            saveData();
            closeModal('logCommunication');
            this.reset();

            // Refresh views
            renderClients();
            if (currentClientView === 'pipeline') renderPipeline();
            if (viewingClientId) {
                const client = clients.find(c => c.id === viewingClientId);
                if (client) renderClientCommunications(client);
            }

            showToast('Communication logged!');
        });

        // Proposal management
        document.getElementById('newProposalForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const clientId = parseInt(document.getElementById('proposalClient').value);
            const client = clients.find(c => c.id === clientId);

            if (editingProposalId) {
                // Update existing proposal
                const proposalIndex = proposals.findIndex(p => p.id === editingProposalId);
                if (proposalIndex !== -1) {
                    proposals[proposalIndex] = {
                        ...proposals[proposalIndex],
                        clientId: clientId,
                        clientName: client ? client.company : 'Unknown',
                        projectName: document.getElementById('proposalProject').value,
                        amount: parseInt(document.getElementById('proposalAmount').value),
                        hours: parseInt(document.getElementById('proposalHours').value) || 0,
                        proposalType: document.getElementById('proposalType').value,
                        description: document.getElementById('proposalDesc').value,
                        updated: new Date().toISOString()
                    };
                }
                saveData();
                renderProposals();
                updateStats();
                closeModal('newProposal');
                resetProposalForm();
                showToast('Proposal updated!');
            } else {
                // Create new proposal with new numbering system
                const proposal = {
                    id: Date.now(),
                    proposalNumber: generateDocumentNumber('PP', clientId),
                    clientId: clientId,
                    clientName: client ? client.company : 'Unknown',
                    projectName: document.getElementById('proposalProject').value,
                    amount: parseInt(document.getElementById('proposalAmount').value),
                    hours: parseInt(document.getElementById('proposalHours').value) || 0,
                    proposalType: document.getElementById('proposalType').value,
                    description: document.getElementById('proposalDesc').value,
                    status: 'draft',
                    created: new Date().toISOString()
                };

                proposals.push(proposal);
                saveData();
                renderProposals();
                updateStats();
                closeModal('newProposal');
                this.reset();
                showToast('Proposal created!');
            }
        });

        function renderProposals() {
            const tbody = document.getElementById('proposalsTable');
            tbody.innerHTML = proposals.map(p => {
                const hasProject = projects.some(proj => proj.proposalId === p.id);
                const number = p.proposalNumber || p.number || 'N/A';
                const project = p.projectName || p.project || 'N/A';
                const version = p.version || '1.0';
                const statusColors = {
                    'draft': 'pending',
                    'sent': 'sent',
                    'accepted': 'active',
                    'active': 'active',
                    'working': 'active',
                    'completed': 'active'
                };
                const statusClass = statusColors[p.status] || 'pending';
                const statusLabels = {
                    'draft': 'Draft',
                    'sent': 'Sent',
                    'accepted': 'Accepted',
                    'active': 'Active',
                    'working': 'Working',
                    'completed': 'Completed'
                };
                return `
                <tr>
                    <td><strong>${number}</strong> <span style="color: var(--gray); font-size: 10px;">v${version}</span></td>
                    <td>${p.clientName}</td>
                    <td>${project}</td>
                    <td>₪${p.amount.toLocaleString()}</td>
                    <td>
                        <select onchange="changeProposalStatus(${p.id}, this.value)" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; padding: 4px 8px; color: var(--light); font-size: 11px; cursor: pointer;">
                            <option value="draft" ${p.status === 'draft' ? 'selected' : ''}>Draft</option>
                            <option value="sent" ${p.status === 'sent' ? 'selected' : ''}>Sent</option>
                            <option value="accepted" ${p.status === 'accepted' ? 'selected' : ''}>Accepted</option>
                            <option value="active" ${p.status === 'active' ? 'selected' : ''}>Active</option>
                            <option value="working" ${p.status === 'working' ? 'selected' : ''}>Working</option>
                            <option value="completed" ${p.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                    </td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-success btn-sm" onclick="previewProposal(${p.id})" title="Preview">👁</button>
                            <button class="btn btn-primary btn-sm" onclick="openProposalEditor(${p.id})">Edit</button>
                            <button class="btn btn-secondary btn-sm" onclick="copyProposalLink(${p.id})">Copy Link</button>
                            ${!hasProject ? `<button class="btn btn-secondary btn-sm" onclick="convertToProject(${p.id})">→ Project</button>` : ''}
                            ${hasProject ? `<span style="color: var(--success); font-size: 11px;">✓ Project</span>` : ''}
                            <button class="btn btn-success btn-sm" onclick="openDocumentTypeModal(${p.id})" title="Create Document in Green Invoice">₪ Document</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProposal(${p.id})">×</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function changeProposalStatus(id, newStatus) {
            const proposal = proposals.find(p => p.id === id);
            if (proposal) {
                proposal.status = newStatus;
                // Update document number prefix based on status
                if (proposal.proposalNumber && proposal.proposalNumber.match(/^(PP|PA|PJ|PC)-/)) {
                    proposal.proposalNumber = updateDocumentNumberForStatus(proposal.proposalNumber, newStatus);
                }
                if (newStatus === 'accepted') proposal.acceptedDate = new Date().toISOString();
                if (newStatus === 'active' || newStatus === 'working') proposal.activatedDate = new Date().toISOString();
                proposal.updated = new Date().toISOString();
                saveData();
                renderProposals();
                updateStats();
                showToast(`Status changed to ${newStatus}`);
            }
        }

        function copyProposalLink(id) {
            const proposal = proposals.find(p => p.id === id);
            if (!proposal) return;

            // Map proposal number to proposals-data.json key
            let key = 'lhd-001';
            if (proposal.proposalNumber === 'LHD-001-26-v3') {
                key = 'lhd-001-v3';
            } else if (proposal.proposalNumber === 'LHD-001-26') {
                key = 'lhd-001';
            }
            const link = `https://drishticonsulting.com/proposal-view.html?p=${key}`;

            navigator.clipboard.writeText(link).then(() => {
                showToast('Link copied: ' + link);
            }).catch(() => {
                prompt('Copy this link:', link);
            });
        }

        function openProposalEditor(id) {
            window.open('proposal-editor.html?id=' + id, '_blank');
        }

        function previewProposal(id) {
            // Open the client-facing proposal view
            const proposal = proposals.find(p => p.id === id);
            if (proposal) {
                // Map proposal number to proposals-data.json key
                let key = 'lhd-001';
                if (proposal.proposalNumber === 'LHD-001-26-v3') {
                    key = 'lhd-001-v3';
                } else if (proposal.proposalNumber === 'LHD-001-26') {
                    key = 'lhd-001';
                }
                window.open('https://drishticonsulting.com/proposal-view.html?p=' + key, '_blank');
            }
        }

        function markAccepted(id) {
            const proposal = proposals.find(p => p.id === id);
            if (proposal) {
                proposal.status = 'accepted';
                proposal.acceptedDate = new Date().toISOString();
                saveData();
                renderProposals();
                updateStats();
                showToast('Proposal accepted!');
            }
        }

        function generateProposal(id) {
            const proposal = proposals.find(p => p.id === id);
            const client = clients.find(c => c.id === proposal.clientId);

            // Handle both old and new field names
            const projectName = proposal.projectName || proposal.project || '';
            const proposalNumber = proposal.proposalNumber || proposal.number || '';

            // Open proposal template in new window
            const proposalUrl = `proposal-template.html?client=${encodeURIComponent(client?.company || '')}&project=${encodeURIComponent(projectName)}&amount=${proposal.amount}&number=${proposalNumber}`;
            window.open(proposalUrl, '_blank');

            showToast('Generating proposal...');
        }

        function markSent(id) {
            const proposal = proposals.find(p => p.id === id);
            if (proposal) {
                proposal.status = 'sent';
                saveData();
                renderProposals();
                updateStats();
                showToast('Marked as sent');
            }
        }

        function deleteProposal(id) {
            if (confirm('Delete this proposal?')) {
                proposals = proposals.filter(p => p.id !== id);
                saveData();
                renderProposals();
                updateStats();
                showToast('Proposal deleted');
            }
        }

        // Edit proposal
        let editingProposalId = null;

        function editProposal(id) {
            const proposal = proposals.find(p => p.id === id);
            if (!proposal) return;

            editingProposalId = id;

            // Update modal title
            document.querySelector('#modal-newProposal .modal-title').textContent = 'Edit Proposal';
            document.querySelector('#modal-newProposal form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields (handle both old and new field names)
            document.getElementById('proposalClient').value = proposal.clientId;
            document.getElementById('proposalProject').value = proposal.projectName || proposal.project || '';
            document.getElementById('proposalAmount').value = proposal.amount;
            document.getElementById('proposalHours').value = proposal.hours || '';
            document.getElementById('proposalType').value = proposal.proposalType || proposal.type || 'development';
            document.getElementById('proposalDesc').value = proposal.description || '';

            openModal('newProposal');
        }

        function resetProposalForm() {
            editingProposalId = null;
            document.querySelector('#modal-newProposal .modal-title').textContent = 'Create New Proposal';
            document.querySelector('#modal-newProposal form button[type="submit"]').textContent = 'Create Proposal';
            document.getElementById('newProposalForm').reset();
        }

        function updateProposalClientSelect() {
            const select = document.getElementById('proposalClient');
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${c.id}">${c.company}</option>`).join('');
        }

        // Stats
        function updateStats() {
            // Dashboard stats (with null checks for safety)
            const totalClientsEl = document.getElementById('totalClients');
            if (totalClientsEl) totalClientsEl.textContent = clients.length;

            // Update pipeline counts on Dashboard
            const leadsCountEl = document.getElementById('leadsCount');
            if (leadsCountEl) leadsCountEl.textContent = clients.filter(c => c.pipelineStage === 'lead').length;

            const qualifiedCountEl = document.getElementById('qualifiedCount');
            if (qualifiedCountEl) qualifiedCountEl.textContent = clients.filter(c => c.pipelineStage === 'qualified').length;

            const customersCountEl = document.getElementById('customersCount');
            if (customersCountEl) customersCountEl.textContent = clients.filter(c => c.pipelineStage === 'customer').length;

            // Projects page stats
            const activeProjectsEl = document.getElementById('activeProjectsCount');
            if (activeProjectsEl) activeProjectsEl.textContent = projects.filter(p => p.status === 'active' || p.status === 'in-progress').length;

            const totalProjectsEl = document.getElementById('totalProjectsCount');
            if (totalProjectsEl) totalProjectsEl.textContent = projects.length;

            updateAnalytics();
        }

        // Analytics tracking
        let analytics = JSON.parse(localStorage.getItem('analytics')) || {
            logins: 0,
            pageViews: 0,
            proposalsViewed: 0,
            lastLogin: null,
            activities: []
        };

        function trackLogin() {
            analytics.logins++;
            analytics.lastLogin = new Date().toISOString();
            logActivity('Logged in');
            saveAnalytics();
        }

        function trackPageView(page) {
            analytics.pageViews++;
            logActivity(`Viewed ${page} page`);
            saveAnalytics();
        }

        function trackProposalView() {
            analytics.proposalsViewed++;
            logActivity('Viewed proposal');
            saveAnalytics();
        }

        function logActivity(action) {
            analytics.activities.unshift({
                action: action,
                timestamp: new Date().toISOString()
            });
            // Keep only last 50 activities
            if (analytics.activities.length > 50) {
                analytics.activities = analytics.activities.slice(0, 50);
            }
        }

        function saveAnalytics() {
            localStorage.setItem('analytics', JSON.stringify(analytics));
        }

        function updateAnalytics() {
            document.getElementById('totalLogins').textContent = analytics.logins;
            document.getElementById('pageViews').textContent = analytics.pageViews;
            document.getElementById('proposalsViewed').textContent = analytics.proposalsViewed;
            document.getElementById('lastLogin').textContent = analytics.lastLogin
                ? new Date(analytics.lastLogin).toLocaleString('he-IL')
                : '-';

            // Render activity log
            const activityLog = document.getElementById('activityLog');
            if (analytics.activities.length > 0) {
                activityLog.innerHTML = analytics.activities.slice(0, 20).map(a => `
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px;">
                        <span>${a.action}</span>
                        <span style="color: var(--gray);">${new Date(a.timestamp).toLocaleString('he-IL')}</span>
                    </div>
                `).join('');
            }
        }

        // Settings
        function saveSettings() {
            const key = document.getElementById('airtableKey').value;
            const base = document.getElementById('airtableBase').value;
            localStorage.setItem('airtableKey', key);
            localStorage.setItem('airtableBase', base);
            showToast('Settings saved!');
        }

        function changePassword() {
            const newPass = document.getElementById('newPassword').value;
            if (newPass && newPass.length >= 6) {
                localStorage.setItem('adminPassword', newPass);
                showToast('Password updated!');
                document.getElementById('newPassword').value = '';
            } else {
                alert('Password must be at least 6 characters');
            }
        }

        // Data Management Functions
        function loadDemoData() {
            if (!confirm('This will add demo data (GreenTech Solutions client with proposals, projects, and invoices). Continue?')) return;

            // Add demo client if not exists
            const existingClient = clients.find(c => c.id === 1007);
            if (!existingClient) {
                clients.push({
                    id: 1007,
                    company: 'GreenTech Solutions Ltd',
                    companyHe: 'גרינטק פתרונות בע"מ',
                    sector: 'technology',
                    companyId: '516789012',
                    industry: 'Technology',
                    pipelineStage: 'customer',
                    estimatedValue: 120000,
                    leadSource: 'referral',
                    contacts: [
                        { name: 'Dana Cohen', nameHe: 'דנה כהן', position: 'CEO', email: 'dana@greentech.co.il', phone: '054-1234567' },
                        { name: 'Amit Levy', nameHe: 'עמית לוי', position: 'CTO', email: 'amit@greentech.co.il', phone: '052-9876543' }
                    ],
                    notes: 'ESG-focused tech company. Interested in sustainability reporting platform and carbon tracking system.',
                    status: 'active',
                    created: '2025-10-15T10:00:00.000Z'
                });
            }

            // Add demo proposals
            const existingProposal = proposals.find(p => p.id === 2001);
            if (!existingProposal) {
                proposals.push({
                    id: 2001,
                    proposalNumber: 'PP-GTS-001-26',
                    clientId: 1007,
                    clientName: 'GreenTech Solutions Ltd',
                    projectName: 'ESG Reporting Platform',
                    project: 'ESG Reporting Platform',
                    proposalType: 'development',
                    type: 'development',
                    amount: 85000,
                    hours: 450,
                    status: 'accepted',
                    description: 'Development of a comprehensive ESG reporting platform.',
                    created: '2025-11-01T10:00:00.000Z',
                    projectId: 3001
                });
                proposals.push({
                    id: 2002,
                    proposalNumber: 'PP-GTS-002-26',
                    clientId: 1007,
                    clientName: 'GreenTech Solutions Ltd',
                    projectName: 'Carbon Footprint Calculator API',
                    project: 'Carbon Footprint Calculator API',
                    proposalType: 'integration',
                    type: 'integration',
                    amount: 35000,
                    hours: 180,
                    status: 'accepted',
                    description: 'API integration for carbon footprint calculations.',
                    created: '2025-12-01T10:00:00.000Z'
                });
            }

            // Add demo project
            const existingProject = projects.find(p => p.id === 3001);
            if (!existingProject) {
                projects.push({
                    id: 3001,
                    projectNumber: 'PRJ-2026-001',
                    proposalId: 2001,
                    proposalNumber: 'PP-GTS-001-26',
                    proposalAmount: 85000,
                    clientId: 1007,
                    clientName: 'GreenTech Solutions Ltd',
                    name: 'ESG Reporting Platform',
                    description: 'Comprehensive ESG reporting platform',
                    type: 'development',
                    totalBudget: 85000,
                    totalHours: 450,
                    totalHoursSpent: 120,
                    overallProgress: 35,
                    status: 'active',
                    startDate: '2025-11-20',
                    expectedEndDate: '2026-04-30',
                    totalInvoiced: 34000,
                    stages: [
                        { id: 0, name: 'Discovery & Planning', estimatedHours: 60, actualHours: 55, status: 'completed', completionPercent: 100 },
                        { id: 1, name: 'Backend Development', estimatedHours: 120, actualHours: 65, status: 'in_progress', completionPercent: 55 },
                        { id: 2, name: 'Frontend Development', estimatedHours: 100, actualHours: 0, status: 'not_started', completionPercent: 0 },
                        { id: 3, name: 'Integration & Testing', estimatedHours: 80, actualHours: 0, status: 'not_started', completionPercent: 0 },
                        { id: 4, name: 'Deployment', estimatedHours: 90, actualHours: 0, status: 'not_started', completionPercent: 0 }
                    ],
                    created: '2025-11-15T10:00:00.000Z'
                });
            }

            // Add demo invoice
            const existingInvoice = invoices.find(i => i.id === 4001);
            if (!existingInvoice) {
                invoices.push({
                    id: 4001,
                    number: 'IN-GTS-001-26',
                    proposalId: 2001,
                    proposalNumber: 'PP-GTS-001-26',
                    projectName: 'ESG Reporting Platform',
                    milestoneNumber: 1,
                    clientId: 1007,
                    clientName: 'GreenTech Solutions Ltd',
                    amount: 34000,
                    amountPaid: 34000,
                    balance: 0,
                    date: '2025-11-20',
                    dueDate: '2025-12-20',
                    description: 'Milestone 1 (40% deposit)',
                    status: 'paid',
                    created: '2025-11-20T10:00:00.000Z'
                });
            }

            saveData();
            renderClients();
            renderProposals();
            renderProjects();
            renderInvoices();
            updateStats();
            updateDataCounts();
            showToast('Demo data loaded successfully!', 'success');
            document.getElementById('dataManagementStatus').innerHTML = '<span style="color: var(--success);">✓ Demo data loaded</span>';
        }

        function clearAllData() {
            if (!confirm('⚠️ WARNING: This will permanently delete ALL data (clients, proposals, projects, invoices, etc.). This cannot be undone. Are you sure?')) return;
            if (!confirm('Please confirm again: Delete all data?')) return;

            clients = [];
            proposals = [];
            projects = [];
            invoices = [];
            expenses = [];
            timeEntries = [];
            tasks = [];
            communicationLogs = [];
            auditLog = [];

            saveData();
            localStorage.removeItem('auditLog');

            renderClients();
            renderProposals();
            renderProjects();
            renderInvoices();
            updateStats();
            updateDataCounts();
            showToast('All data cleared', 'warning');
            document.getElementById('dataManagementStatus').innerHTML = '<span style="color: var(--warning);">⚠ All data cleared</span>';
        }

        function exportAllData() {
            const exportData = {
                exportDate: new Date().toISOString(),
                clients,
                proposals,
                projects,
                invoices,
                expenses,
                timeEntries,
                tasks,
                communicationLogs,
                auditLog
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `drishti-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        }

        function updateDataCounts() {
            const countsClients = document.getElementById('dataCountClients');
            const countsProposals = document.getElementById('dataCountProposals');
            const countsProjects = document.getElementById('dataCountProjects');
            const countsInvoices = document.getElementById('dataCountInvoices');
            if (countsClients) countsClients.textContent = clients.length;
            if (countsProposals) countsProposals.textContent = proposals.length;
            if (countsProjects) countsProjects.textContent = projects.length;
            if (countsInvoices) countsInvoices.textContent = invoices.length;
        }

        // Time Logger for Projects
        let activeTimer = JSON.parse(localStorage.getItem('activeTimer')) || null;
        let timerInterval = null;

        function startProjectTimer(projectId, stageName = '') {
            if (activeTimer) {
                if (!confirm('Another timer is running. Stop it and start a new one?')) return;
                stopProjectTimer(false);
            }

            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            activeTimer = {
                projectId,
                projectName: project.name,
                clientName: project.clientName,
                stageName,
                startTime: new Date().toISOString(),
                elapsed: 0
            };
            localStorage.setItem('activeTimer', JSON.stringify(activeTimer));

            startTimerDisplay();
            renderProjects();
            showToast(`Timer started for ${project.name}`, 'success');
        }

        function stopProjectTimer(save = true) {
            if (!activeTimer) return;

            clearInterval(timerInterval);
            const endTime = new Date();
            const startTime = new Date(activeTimer.startTime);
            const durationMs = endTime - startTime;
            const durationHours = Math.round((durationMs / 1000 / 60 / 60) * 100) / 100;

            if (save && durationHours > 0.01) {
                // Create time entry (compatible with dashboard time utilization)
                const entry = {
                    id: Date.now(),
                    projectId: activeTimer.projectId,
                    projectName: activeTimer.projectName,
                    clientName: activeTimer.clientName,
                    stageName: activeTimer.stageName,
                    startTime: activeTimer.startTime,
                    endTime: endTime.toISOString(),
                    date: endTime.toISOString().split('T')[0],  // For dashboard filtering
                    duration: durationHours,
                    hours: durationHours,  // For dashboard calculations
                    billable: true,  // Assume billable by default
                    notes: '',
                    created: new Date().toISOString()
                };
                timeEntries.push(entry);

                // Update project hours
                const project = projects.find(p => p.id === activeTimer.projectId);
                if (project) {
                    project.totalHoursSpent = (project.totalHoursSpent || 0) + durationHours;
                    // Update stage hours if specified
                    if (activeTimer.stageName && project.stages) {
                        const stage = project.stages.find(s => s.name === activeTimer.stageName);
                        if (stage) {
                            stage.actualHours = (stage.actualHours || 0) + durationHours;
                        }
                    }
                }

                saveData();
                showToast(`Time logged: ${durationHours.toFixed(2)} hours`, 'success');
            }

            activeTimer = null;
            localStorage.removeItem('activeTimer');
            updateTimerDisplay();
            renderProjects();
        }

        function startTimerDisplay() {
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function updateTimerDisplay() {
            const timerBar = document.getElementById('activeTimerBar');
            if (!timerBar) return;

            if (activeTimer) {
                const elapsed = Math.floor((new Date() - new Date(activeTimer.startTime)) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                const timeStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                timerBar.style.display = 'flex';
                timerBar.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%; animation: pulse 1s infinite;"></div>
                        <span style="font-weight: 600;">${timeStr}</span>
                        <span style="color: var(--gray);">|</span>
                        <span>${activeTimer.projectName}</span>
                        ${activeTimer.stageName ? `<span style="color: var(--gray);">- ${activeTimer.stageName}</span>` : ''}
                    </div>
                    <button onclick="stopProjectTimer(true)" class="btn btn-sm" style="background: var(--danger); padding: 4px 12px;">
                        Stop & Save
                    </button>
                `;
            } else {
                timerBar.style.display = 'none';
            }
        }

        // Load saved settings
        document.getElementById('airtableKey').value = localStorage.getItem('airtableKey') || '';
        document.getElementById('airtableBase').value = localStorage.getItem('airtableBase') || '';

        // Data persistence
        function saveData() {
            localStorage.setItem('clients', JSON.stringify(clients));
            localStorage.setItem('proposals', JSON.stringify(proposals));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('projects', JSON.stringify(projects));
            localStorage.setItem('clientCodes', JSON.stringify(clientCodes));
            localStorage.setItem('proposalTemplates', JSON.stringify(proposalTemplates));
            localStorage.setItem('bankDetails', JSON.stringify(bankDetails));
            localStorage.setItem('documentCounters', JSON.stringify(documentCounters));
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('payslips', JSON.stringify(payslips));
            // New CRM data
            localStorage.setItem('timeEntries', JSON.stringify(timeEntries));
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('quotes', JSON.stringify(quotes));
            localStorage.setItem('documents', JSON.stringify(documents));
            localStorage.setItem('vendors', JSON.stringify(vendors));
            localStorage.setItem('budgets', JSON.stringify(budgets));
            localStorage.setItem('recurringExpenses', JSON.stringify(recurringExpenses));
            localStorage.setItem('communicationLogs', JSON.stringify(communicationLogs));
        }

        // Invoice management
        let editingInvoiceId = null;
        let recurringInvoiceTemplates = JSON.parse(localStorage.getItem('recurringInvoiceTemplates')) || [];

        document.getElementById('newInvoiceForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const clientId = parseInt(document.getElementById('invoiceClient').value);
            const client = clients.find(c => c.id === clientId);
            const proposalId = parseInt(document.getElementById('invoiceProposal').value) || null;
            const proposal = proposalId ? proposals.find(p => p.id === proposalId) : null;
            const amount = parseFloat(document.getElementById('invoiceAmount').value);
            const amountPaid = parseFloat(document.getElementById('invoiceAmountPaid').value) || 0;
            const isRecurring = document.getElementById('invoiceRecurring').checked;

            // Validate proposal is selected and amount doesn't exceed remaining
            if (!proposalId) {
                alert('Please select an approved proposal to invoice against.');
                return;
            }

            if (!validateInvoiceAmount()) {
                alert('Invoice amount exceeds remaining proposal balance.');
                return;
            }

            if (editingInvoiceId) {
                // Update existing invoice
                const invoiceIndex = invoices.findIndex(inv => inv.id === editingInvoiceId);
                if (invoiceIndex !== -1) {
                    invoices[invoiceIndex] = {
                        ...invoices[invoiceIndex],
                        number: document.getElementById('invoiceNumber').value,
                        clientId: clientId,
                        clientName: client ? client.company : 'Unknown',
                        proposalId: proposalId,
                        proposalNumber: proposal ? (proposal.proposalNumber || proposal.number) : null,
                        amount: amount,
                        amountPaid: amountPaid,
                        balance: amount - amountPaid,
                        date: document.getElementById('invoiceDate').value,
                        dueDate: document.getElementById('invoiceDueDate').value,
                        description: document.getElementById('invoiceDesc').value,
                        status: amountPaid >= amount ? 'paid' : (amountPaid > 0 ? 'partial' : 'pending'),
                        updated: new Date().toISOString()
                    };
                    logAuditEvent('invoice', editingInvoiceId, 'updated', `Invoice updated: ${invoices[invoiceIndex].number}`);
                }
                saveData();
                renderInvoices();
                updateInvoiceStats();
                closeModal('newInvoice');
                resetInvoiceForm();
                showToast('Invoice updated!');
            } else {
                // Calculate milestone number
                const milestoneNum = invoices.filter(inv => inv.proposalId === proposalId).length + 1;

                // Create new invoice
                const invoice = {
                    id: Date.now(),
                    number: document.getElementById('invoiceNumber').value,
                    clientId: clientId,
                    clientName: client ? client.company : 'Unknown',
                    proposalId: proposalId,
                    proposalNumber: proposal ? (proposal.proposalNumber || proposal.number) : null,
                    projectName: proposal ? (proposal.projectName || proposal.project) : '',
                    milestoneNumber: milestoneNum,
                    amount: amount,
                    amountPaid: amountPaid,
                    balance: amount - amountPaid,
                    date: document.getElementById('invoiceDate').value,
                    dueDate: document.getElementById('invoiceDueDate').value,
                    description: document.getElementById('invoiceDesc').value,
                    status: amountPaid >= amount ? 'paid' : (amountPaid > 0 ? 'partial' : 'pending'),
                    payments: amountPaid > 0 ? [{ amount: amountPaid, date: new Date().toISOString(), method: 'initial' }] : [],
                    isRecurring: isRecurring,
                    recurringFreq: isRecurring ? document.getElementById('invoiceRecurringFreq').value : null,
                    recurringEnd: isRecurring ? document.getElementById('invoiceRecurringEnd').value : null,
                    created: new Date().toISOString()
                };

                invoices.push(invoice);

                // Log audit event
                logAuditEvent('invoice', invoice.id, 'created', `Invoice created: ${invoice.number} (Milestone ${milestoneNum} for ${proposal.proposalNumber || proposal.number})`);

                // Update project totalInvoiced if linked
                if (proposal && proposal.projectId) {
                    const project = projects.find(p => p.id === proposal.projectId);
                    if (project) {
                        project.totalInvoiced = (project.totalInvoiced || 0) + amount;
                        logAuditEvent('project', project.id, 'updated', `Invoice ${invoice.number} created, total invoiced: ₪${project.totalInvoiced.toLocaleString()}`);
                    }
                }

                // Add to recurring templates if recurring
                if (isRecurring) {
                    recurringInvoiceTemplates.push({
                        id: Date.now(),
                        clientId: clientId,
                        clientName: client ? client.company : 'Unknown',
                        proposalId: proposalId,
                        amount: amount,
                        description: document.getElementById('invoiceDesc').value,
                        frequency: document.getElementById('invoiceRecurringFreq').value,
                        endDate: document.getElementById('invoiceRecurringEnd').value,
                        nextDate: calculateNextRecurringDate(document.getElementById('invoiceDate').value, document.getElementById('invoiceRecurringFreq').value),
                        active: true,
                        created: new Date().toISOString()
                    });
                    localStorage.setItem('recurringInvoiceTemplates', JSON.stringify(recurringInvoiceTemplates));
                }

                saveData();
                renderInvoices();
                updateInvoiceStats();
                closeModal('newInvoice');
                this.reset();
                document.getElementById('invoiceProposalSummary').style.display = 'none';
                showToast(`Invoice created! (Milestone ${milestoneNum})`);
            }
        });

        function calculateNextRecurringDate(startDate, frequency) {
            const date = new Date(startDate);
            switch(frequency) {
                case 'monthly': date.setMonth(date.getMonth() + 1); break;
                case 'quarterly': date.setMonth(date.getMonth() + 3); break;
                case 'yearly': date.setFullYear(date.getFullYear() + 1); break;
            }
            return date.toISOString().split('T')[0];
        }

        function toggleRecurringOptions() {
            const recurringOptions = document.getElementById('recurringOptions');
            recurringOptions.style.display = document.getElementById('invoiceRecurring').checked ? 'block' : 'none';
        }

        function updateInvoiceBalance() {
            const amount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
            const paid = parseFloat(document.getElementById('invoiceAmountPaid').value) || 0;
            document.getElementById('invoiceBalance').value = amount - paid;
        }

        // Update proposal select based on selected client
        function updateInvoiceProposalSelect() {
            const clientId = parseInt(document.getElementById('invoiceClient').value);
            const select = document.getElementById('invoiceProposal');
            select.innerHTML = '<option value="">Select approved proposal...</option>';

            if (!clientId) {
                document.getElementById('invoiceProposalSummary').style.display = 'none';
                return;
            }

            // Get only accepted proposals for this client
            const clientProposals = proposals.filter(p => p.clientId === clientId && p.status === 'accepted');

            if (clientProposals.length === 0) {
                select.innerHTML = '<option value="">No accepted proposals for this client</option>';
                return;
            }

            clientProposals.forEach(p => {
                const invoiced = getProposalInvoicedAmount(p.id);
                const remaining = p.amount - invoiced;
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.proposalNumber || p.number} - ${p.projectName || p.project} (₪${p.amount.toLocaleString()}, ₪${remaining.toLocaleString()} remaining)`;
                option.disabled = remaining <= 0;
                select.appendChild(option);
            });
        }

        // Calculate total invoiced amount for a proposal
        function getProposalInvoicedAmount(proposalId) {
            return invoices
                .filter(inv => inv.proposalId === proposalId && inv.status !== 'cancelled')
                .reduce((sum, inv) => sum + (inv.amount || 0), 0);
        }

        // Update form when proposal is selected
        function updateInvoiceFromProposal() {
            const proposalId = parseInt(document.getElementById('invoiceProposal').value);
            const summaryBox = document.getElementById('invoiceProposalSummary');

            if (!proposalId) {
                summaryBox.style.display = 'none';
                document.getElementById('invoiceMaxAmount').textContent = '';
                return;
            }

            const proposal = proposals.find(p => p.id === proposalId);
            if (!proposal) return;

            const invoiced = getProposalInvoicedAmount(proposalId);
            const remaining = proposal.amount - invoiced;

            // Show summary box
            summaryBox.style.display = 'block';
            document.getElementById('invoiceProposalTotal').textContent = '₪' + proposal.amount.toLocaleString();
            document.getElementById('invoiceProposalInvoiced').textContent = '₪' + invoiced.toLocaleString();
            document.getElementById('invoiceProposalRemaining').textContent = '₪' + remaining.toLocaleString();

            // Calculate milestone info
            const invoiceCount = invoices.filter(inv => inv.proposalId === proposalId).length;
            document.getElementById('invoiceProposalMilestone').textContent = `Invoice #${invoiceCount + 1}`;

            // Update max amount indicator
            document.getElementById('invoiceMaxAmount').textContent = `(max: ₪${remaining.toLocaleString()})`;

            // Pre-fill description
            document.getElementById('invoiceDesc').value = `${proposal.projectName || proposal.project} - Milestone ${invoiceCount + 1}`;
        }

        // Validate invoice amount doesn't exceed remaining
        function validateInvoiceAmount() {
            const proposalId = parseInt(document.getElementById('invoiceProposal').value);
            const amount = parseFloat(document.getElementById('invoiceAmount').value) || 0;
            const amountField = document.getElementById('invoiceAmount');

            if (!proposalId) return true;

            const proposal = proposals.find(p => p.id === proposalId);
            if (!proposal) return true;

            const invoiced = getProposalInvoicedAmount(proposalId);
            const remaining = proposal.amount - invoiced;

            if (amount > remaining) {
                amountField.style.borderColor = 'var(--danger)';
                amountField.setCustomValidity(`Amount exceeds remaining proposal balance (₪${remaining.toLocaleString()})`);
                return false;
            } else {
                amountField.style.borderColor = '';
                amountField.setCustomValidity('');
                return true;
            }
        }

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            editingInvoiceId = id;

            // Update modal title
            document.querySelector('#modal-newInvoice .modal-title').textContent = 'Edit Invoice';
            document.querySelector('#modal-newInvoice form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields
            updateInvoiceClientSelect();
            document.getElementById('invoiceClient').value = invoice.clientId;
            document.getElementById('invoiceNumber').value = invoice.number;
            document.getElementById('invoiceAmount').value = invoice.amount;
            document.getElementById('invoiceAmountPaid').value = invoice.amountPaid || 0;
            document.getElementById('invoiceBalance').value = invoice.balance || (invoice.amount - (invoice.amountPaid || 0));
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate;
            document.getElementById('invoiceDesc').value = invoice.description || '';
            document.getElementById('invoiceRecurring').checked = invoice.isRecurring || false;
            toggleRecurringOptions();

            openModal('newInvoice');
        }

        function resetInvoiceForm() {
            editingInvoiceId = null;
            document.querySelector('#modal-newInvoice .modal-title').textContent = 'Create Invoice';
            document.querySelector('#modal-newInvoice form button[type="submit"]').textContent = 'Create Invoice';
            document.getElementById('newInvoiceForm').reset();
            document.getElementById('invoiceAmountPaid').value = '0';
            document.getElementById('invoiceBalance').value = '';
            document.getElementById('invoiceRecurring').checked = false;
            document.getElementById('invoiceProposalSummary').style.display = 'none';
            document.getElementById('invoiceMaxAmount').textContent = '';
            document.getElementById('invoiceProposal').innerHTML = '<option value="">Select approved proposal...</option>';
            toggleRecurringOptions();
        }

        function renderInvoices(filteredInvoices = null) {
            const tbody = document.getElementById('invoicesTable');
            const invoicesToRender = filteredInvoices || invoices;

            if (invoicesToRender.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray);">No invoices yet</td></tr>';
                return;
            }

            tbody.innerHTML = invoicesToRender.map(inv => {
                const dueDate = new Date(inv.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const amountPaid = inv.amountPaid || 0;
                const balance = inv.amount - amountPaid;
                const isOverdue = inv.status !== 'paid' && dueDate < today;
                const daysOverdue = isOverdue ? Math.floor((today - dueDate) / (1000 * 60 * 60 * 24)) : 0;

                let statusClass, statusText;
                if (inv.status === 'paid' || amountPaid >= inv.amount) {
                    statusClass = 'status-active';
                    statusText = 'Paid';
                } else if (amountPaid > 0) {
                    statusClass = 'status-sent';
                    statusText = 'Partial';
                } else if (isOverdue) {
                    statusClass = 'status-badge';
                    statusText = `Overdue (${daysOverdue}d)`;
                } else {
                    statusClass = 'status-pending';
                    statusText = 'Pending';
                }

                const statusStyle = isOverdue && inv.status !== 'paid' ? 'background: rgba(239, 68, 68, 0.1); color: #ef4444;' : '';
                const paidDisplay = amountPaid > 0 ? `₪${amountPaid.toLocaleString()}` : '-';
                const recurringBadge = inv.isRecurring ? '<span style="background: rgba(139,92,246,0.2); color: #8b5cf6; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 4px;">Recurring</span>' : '';

                return `
                <tr>
                    <td><strong>${inv.number}</strong>${recurringBadge}</td>
                    <td>${inv.clientName}</td>
                    <td>₪${inv.amount.toLocaleString()}</td>
                    <td style="color: ${amountPaid > 0 ? '#10b981' : 'var(--gray)'}">${paidDisplay}</td>
                    <td>${new Date(inv.dueDate).toLocaleDateString('en-GB')}</td>
                    <td><span class="status-badge ${statusClass}" style="${statusStyle}">${statusText}</span></td>
                    <td>
                        <div class="action-btns">
                            ${inv.status !== 'paid' && amountPaid < inv.amount ? `<button class="btn btn-primary btn-sm" onclick="openRecordPayment(${inv.id})" title="Record Payment">₪+</button>` : ''}
                            <button class="btn btn-secondary btn-sm" onclick="editInvoice(${inv.id})">Edit</button>
                            ${isOverdue ? `<button class="btn btn-sm" onclick="sendReminder(${inv.id})" style="background: rgba(239,68,68,0.2); color: #ef4444;" title="Send Reminder">Remind</button>` : ''}
                            <button class="btn btn-danger btn-sm" onclick="deleteInvoice(${inv.id})">Del</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function filterInvoices() {
            const statusFilter = document.getElementById('invoiceStatusFilter').value;
            const clientFilter = document.getElementById('invoiceClientFilter').value;

            let filtered = invoices;

            if (statusFilter) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                filtered = filtered.filter(inv => {
                    const dueDate = new Date(inv.dueDate);
                    const amountPaid = inv.amountPaid || 0;
                    const isOverdue = inv.status !== 'paid' && dueDate < today;

                    switch(statusFilter) {
                        case 'pending': return inv.status === 'pending' && !isOverdue && amountPaid === 0;
                        case 'partial': return amountPaid > 0 && amountPaid < inv.amount;
                        case 'paid': return inv.status === 'paid' || amountPaid >= inv.amount;
                        case 'overdue': return isOverdue;
                        default: return true;
                    }
                });
            }

            if (clientFilter) {
                filtered = filtered.filter(inv => inv.clientId === parseInt(clientFilter));
            }

            renderInvoices(filtered);
        }

        function openRecordPayment(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            document.getElementById('paymentInvoiceId').value = invoiceId;
            document.getElementById('paymentInvoiceTotal').textContent = '₪' + invoice.amount.toLocaleString();
            document.getElementById('paymentPreviouslyPaid').textContent = '₪' + (invoice.amountPaid || 0).toLocaleString();
            document.getElementById('paymentBalanceDue').textContent = '₪' + (invoice.amount - (invoice.amountPaid || 0)).toLocaleString();
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentAmount').value = '';

            openModal('recordPayment');
        }

        // Record Payment Form
        document.getElementById('recordPaymentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const invoiceId = parseInt(document.getElementById('paymentInvoiceId').value);
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const newPaid = (invoice.amountPaid || 0) + paymentAmount;

            // Add payment record
            if (!invoice.payments) invoice.payments = [];
            invoice.payments.push({
                amount: paymentAmount,
                date: document.getElementById('paymentDate').value,
                method: document.getElementById('paymentMethod').value,
                notes: document.getElementById('paymentNotes').value
            });

            invoice.amountPaid = newPaid;
            invoice.balance = invoice.amount - newPaid;
            invoice.status = newPaid >= invoice.amount ? 'paid' : 'partial';
            if (newPaid >= invoice.amount) {
                invoice.paidDate = new Date().toISOString();
            }

            saveData();
            renderInvoices();
            updateInvoiceStats();
            closeModal('recordPayment');
            this.reset();
            showToast(`Payment of ₪${paymentAmount.toLocaleString()} recorded!`);
        });

        function sendReminder(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            const client = clients.find(c => c.id === invoice.clientId);
            const email = client?.email || client?.contacts?.[0]?.email || '';

            if (!email) {
                showToast('No email found for client');
                return;
            }

            const balance = invoice.amount - (invoice.amountPaid || 0);
            const subject = `Payment Reminder - Invoice ${invoice.number}`;
            const body = `Dear ${client?.company || 'Client'},

This is a friendly reminder that invoice ${invoice.number} for ₪${balance.toLocaleString()} is overdue.

Invoice Date: ${new Date(invoice.date).toLocaleDateString('en-GB')}
Due Date: ${new Date(invoice.dueDate).toLocaleDateString('en-GB')}
Amount Due: ₪${balance.toLocaleString()}

Please arrange payment at your earliest convenience.

Best regards,
Drishti Consulting`;

            window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);

            invoice.lastReminderSent = new Date().toISOString();
            saveData();
            showToast('Reminder email opened');
        }

        function sendBulkReminders() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const overdueInvoices = invoices.filter(inv => inv.status !== 'paid' && new Date(inv.dueDate) < today);

            if (overdueInvoices.length === 0) {
                showToast('No overdue invoices');
                return;
            }

            overdueInvoices.forEach(inv => sendReminder(inv.id));
        }

        function markInvoicePaid(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (invoice) {
                invoice.status = 'paid';
                invoice.amountPaid = invoice.amount;
                invoice.balance = 0;
                invoice.paidDate = new Date().toISOString();
                saveData();
                renderInvoices();
                updateInvoiceStats();
                showToast('Invoice marked as paid');
            }
        }

        function deleteInvoice(id) {
            if (confirm('Delete this invoice?')) {
                invoices = invoices.filter(inv => inv.id !== id);
                saveData();
                renderInvoices();
                updateInvoiceStats();
                showToast('Invoice deleted');
            }
        }

        function updateInvoiceStats() {
            const total = invoices.reduce((sum, inv) => sum + inv.amount, 0);
            const paid = invoices.reduce((sum, inv) => sum + (inv.amountPaid || (inv.status === 'paid' ? inv.amount : 0)), 0);
            const outstanding = total - paid;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const overdue = invoices.filter(inv => {
                return inv.status !== 'paid' && new Date(inv.dueDate) < today;
            }).reduce((sum, inv) => sum + (inv.amount - (inv.amountPaid || 0)), 0);

            document.getElementById('totalInvoiced').textContent = '₪' + total.toLocaleString();
            document.getElementById('totalPaid').textContent = '₪' + paid.toLocaleString();
            document.getElementById('totalOutstanding').textContent = '₪' + outstanding.toLocaleString();
            document.getElementById('totalOverdue').textContent = '₪' + overdue.toLocaleString();

            // Show/hide overdue alert
            const overdueCount = invoices.filter(inv => inv.status !== 'paid' && new Date(inv.dueDate) < today).length;
            const overdueAlerts = document.getElementById('overdueAlerts');
            if (overdueAlerts) {
                overdueAlerts.style.display = overdueCount > 0 ? 'block' : 'none';
                if (overdueCount > 0) {
                    document.getElementById('overdueAlertText').textContent = `You have ${overdueCount} overdue invoice${overdueCount > 1 ? 's' : ''} totaling ₪${overdue.toLocaleString()}`;
                }
            }

            // Update client filter
            updateInvoiceClientFilter();
        }

        function updateInvoiceClientFilter() {
            const select = document.getElementById('invoiceClientFilter');
            if (select) {
                const clientIds = [...new Set(invoices.map(inv => inv.clientId))];
                select.innerHTML = '<option value="">All Clients</option>' +
                    clientIds.map(id => {
                        const client = clients.find(c => c.id === id);
                        return client ? `<option value="${id}">${client.company}</option>` : '';
                    }).filter(Boolean).join('');
            }
        }

        function updateInvoiceClientSelect() {
            const select = document.getElementById('invoiceClient');
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${c.id}">${c.company}</option>`).join('');

            // Set default invoice number
            const nextNum = invoices.length + 1;
            document.getElementById('invoiceNumber').value = 'INV-' + String(nextNum).padStart(3, '0');

            // Set default dates
            const today = new Date();
            document.getElementById('invoiceDate').value = today.toISOString().split('T')[0];
            const dueDate = new Date(today);
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];

            // Reset payment fields
            document.getElementById('invoiceAmountPaid').value = '0';
            document.getElementById('invoiceBalance').value = '';
        }

        // Expense management
        let editingExpenseId = null;

        document.getElementById('newExpenseForm').addEventListener('submit', function(e) {
            e.preventDefault();

            if (editingExpenseId) {
                // Update existing expense
                const expenseIndex = expenses.findIndex(exp => exp.id === editingExpenseId);
                if (expenseIndex !== -1) {
                    expenses[expenseIndex] = {
                        ...expenses[expenseIndex],
                        description: document.getElementById('expenseDesc').value,
                        amount: parseFloat(document.getElementById('expenseAmount').value),
                        date: document.getElementById('expenseDate').value,
                        category: document.getElementById('expenseCategory').value,
                        notes: document.getElementById('expenseNotes').value,
                        updated: new Date().toISOString()
                    };
                }
                saveData();
                renderExpenses();
                updateExpenseStats();
                closeModal('newExpense');
                resetExpenseForm();
                showToast('Expense updated!');
            } else {
                // Create new expense
                const expense = {
                    id: Date.now(),
                    description: document.getElementById('expenseDesc').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    date: document.getElementById('expenseDate').value,
                    category: document.getElementById('expenseCategory').value,
                    notes: document.getElementById('expenseNotes').value,
                    created: new Date().toISOString()
                };

                expenses.push(expense);
                saveData();
                renderExpenses();
                updateExpenseStats();
                closeModal('newExpense');
                this.reset();
                showToast('Expense added!');
            }
        });

        function editExpense(id) {
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) return;

            editingExpenseId = id;

            // Update modal title
            document.querySelector('#modal-newExpense .modal-title').textContent = 'Edit Expense';
            document.querySelector('#modal-newExpense form button[type="submit"]').textContent = 'Save Changes';

            // Fill form fields
            document.getElementById('expenseDesc').value = expense.description;
            document.getElementById('expenseAmount').value = expense.amount;
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            document.getElementById('expenseNotes').value = expense.notes || '';

            openModal('newExpense');
        }

        function resetExpenseForm() {
            editingExpenseId = null;
            document.querySelector('#modal-newExpense .modal-title').textContent = 'Add Expense';
            document.querySelector('#modal-newExpense form button[type="submit"]').textContent = 'Add Expense';
            document.getElementById('newExpenseForm').reset();
        }

        function renderExpenses() {
            const tbody = document.getElementById('expensesTable');
            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--gray);">No expenses yet</td></tr>';
                return;
            }

            // Sort by date descending
            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = sortedExpenses.map(exp => `
                <tr>
                    <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                    <td><strong>${exp.description}</strong>${exp.notes ? `<br><small style="color: var(--gray);">${exp.notes}</small>` : ''}</td>
                    <td><span class="status-badge" style="background: rgba(99, 102, 241, 0.1); color: var(--primary);">${exp.category}</span></td>
                    <td>₪${exp.amount.toLocaleString()}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-secondary btn-sm" onclick="editExpense(${exp.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteExpense(${exp.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Render recent expenses in sidebar
            const recentExpenses = document.getElementById('recentExpenses');
            if (sortedExpenses.length > 0) {
                recentExpenses.innerHTML = sortedExpenses.slice(0, 5).map(exp => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px;">
                        <span>${exp.description}</span>
                        <span style="color: var(--warning);">₪${exp.amount.toLocaleString()}</span>
                    </div>
                `).join('');
            }

            // Render category breakdown
            renderExpensesByCategory();
        }

        function renderExpensesByCategory() {
            const categoryTotals = {};
            expenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const expensesByCategory = document.getElementById('expensesByCategory');
            if (Object.keys(categoryTotals).length === 0) {
                expensesByCategory.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No expenses yet</div>';
                return;
            }

            const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);
            const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);

            expensesByCategory.innerHTML = sortedCategories.map(([category, amount]) => {
                const percentage = ((amount / total) * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 13px;">
                            <span>${category}</span>
                            <span>₪${amount.toLocaleString()} (${percentage}%)</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 4px; height: 6px; overflow: hidden;">
                            <div style="background: var(--gradient); height: 100%; width: ${percentage}%;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                expenses = expenses.filter(exp => exp.id !== id);
                saveData();
                renderExpenses();
                updateExpenseStats();
                showToast('Expense deleted');
            }
        }

        function updateExpenseStats() {
            const today = new Date();
            const thisMonth = today.getMonth();
            const thisYear = today.getFullYear();

            const monthExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getMonth() === thisMonth && expDate.getFullYear() === thisYear;
            }).reduce((sum, exp) => sum + exp.amount, 0);

            const yearExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate.getFullYear() === thisYear;
            }).reduce((sum, exp) => sum + exp.amount, 0);

            const categories = [...new Set(expenses.map(exp => exp.category))];

            // Calculate average monthly (over all months with expenses)
            const monthsWithExpenses = new Set();
            expenses.forEach(exp => {
                const d = new Date(exp.date);
                monthsWithExpenses.add(`${d.getFullYear()}-${d.getMonth()}`);
            });
            const avgMonthly = monthsWithExpenses.size > 0
                ? expenses.reduce((sum, exp) => sum + exp.amount, 0) / monthsWithExpenses.size
                : 0;

            document.getElementById('expensesMonth').textContent = '₪' + monthExpenses.toLocaleString();
            document.getElementById('expensesYear').textContent = '₪' + yearExpenses.toLocaleString();
            document.getElementById('expenseCategories').textContent = categories.length;
            document.getElementById('expensesAvg').textContent = '₪' + Math.round(avgMonthly).toLocaleString();
        }

        // Toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // =============================================
        // PROJECT MANAGEMENT
        // =============================================

        let currentStages = [];
        let stageIndex = 0;
        let currentManagingProjectId = null;

        function updateProjectClientSelect() {
            const select = document.getElementById('projectClient');
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${c.id}">${c.company}</option>`).join('');
        }

        function updateProjectProposalSelect() {
            const select = document.getElementById('projectProposal');
            const sentProposals = proposals.filter(p => p.status === 'sent');
            select.innerHTML = '<option value="">No proposal linked</option>' +
                sentProposals.map(p => `<option value="${p.id}">${p.number} - ${p.project} (₪${p.amount.toLocaleString()})</option>`).join('');
        }

        function loadStageTemplate() {
            const type = document.getElementById('projectType').value;
            const totalHours = parseInt(document.getElementById('projectHours').value) || 0;

            if (type && type !== 'custom' && stageTemplates[type]) {
                currentStages = stageTemplates[type].map((stage, idx) => ({
                    id: idx, name: stage.name, description: stage.description,
                    estimatedHours: totalHours > 0 ? Math.round(totalHours * stage.percent / 100) : 0,
                    percent: stage.percent, actualHours: 0, status: 'not_started',
                    completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: ''
                }));
                stageIndex = currentStages.length;
            } else if (type === 'custom') {
                currentStages = [];
                stageIndex = 0;
            }
            renderStagesList();
        }

        function recalculateStageHours() {
            const totalHours = parseInt(document.getElementById('projectHours').value) || 0;
            currentStages.forEach(stage => {
                if (stage.percent) stage.estimatedHours = Math.round(totalHours * stage.percent / 100);
            });
            renderStagesList();
        }

        function addProjectStage() {
            currentStages.push({ id: stageIndex++, name: '', description: '', estimatedHours: 0, actualHours: 0, status: 'not_started', completionPercent: 0, startDate: null, completedDate: null, notes: '', blockers: '' });
            renderStagesList();
        }

        function removeStage(id) {
            currentStages = currentStages.filter(s => s.id !== id);
            renderStagesList();
        }

        function renderStagesList() {
            const container = document.getElementById('stagesList');
            if (currentStages.length === 0) {
                container.innerHTML = '<div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">Select a project type to load stage template, or add stages manually</div>';
                return;
            }
            container.innerHTML = currentStages.map((stage, idx) => `
                <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative;">
                    <button type="button" onclick="removeStage(${stage.id})" style="position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.2); border: none; color: #ef4444; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 14px;">&times;</button>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px;">
                        <span style="background: var(--primary); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${idx + 1}</span>
                        <input type="text" value="${stage.name}" placeholder="Stage name" onchange="updateStageName(${stage.id}, this.value)" style="flex: 1; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 13px;">
                        <input type="number" value="${stage.estimatedHours}" placeholder="Hours" onchange="updateStageHours(${stage.id}, this.value)" style="width: 80px; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 13px; text-align: center;">
                    </div>
                    <input type="text" value="${stage.description || ''}" placeholder="Stage description (optional)" onchange="updateStageDescription(${stage.id}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 12px;">
                </div>
            `).join('');
        }

        function updateStageName(id, value) { const s = currentStages.find(s => s.id === id); if (s) s.name = value; }
        function updateStageHours(id, value) { const s = currentStages.find(s => s.id === id); if (s) s.estimatedHours = parseInt(value) || 0; }
        function updateStageDescription(id, value) { const s = currentStages.find(s => s.id === id); if (s) s.description = value; }

        function generateShareToken() { return Math.random().toString(36).substring(2, 10) + Date.now().toString(36); }

        document.getElementById('newProjectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (currentStages.length === 0) { alert('Please add at least one project stage'); return; }
            if (currentStages.filter(s => !s.name.trim()).length > 0) { alert('All stages must have a name'); return; }

            const clientId = parseInt(document.getElementById('projectClient').value);
            const client = clients.find(c => c.id === clientId);
            const proposalId = parseInt(document.getElementById('projectProposal').value) || null;
            const proposal = proposalId ? proposals.find(p => p.id === proposalId) : null;

            const project = {
                id: Date.now(),
                projectNumber: 'PRJ-2026-' + String(projects.length + 1).padStart(3, '0'),
                proposalId, proposalNumber: proposal ? (proposal.proposalNumber || proposal.number) : null,
                proposalAmount: proposal ? proposal.amount : null,  // Track original proposal amount
                clientId, clientName: client ? client.company : 'Unknown',
                clientEmail: client && client.contacts ? client.contacts[0].email : '',
                name: document.getElementById('projectName').value,
                description: document.getElementById('projectDescription').value,
                type: document.getElementById('projectType').value,
                totalBudget: parseFloat(document.getElementById('projectBudget').value),
                totalHours: parseInt(document.getElementById('projectHours').value),
                startDate: document.getElementById('projectStartDate').value,
                expectedEndDate: document.getElementById('projectEndDate').value,
                actualEndDate: null, status: 'active', overallProgress: 0,
                stages: currentStages.map((s, idx) => ({ ...s, id: idx })),
                totalHoursSpent: 0, shareToken: generateShareToken(),
                totalInvoiced: 0,  // Track how much has been invoiced
                lastClientView: null, created: new Date().toISOString(), updated: new Date().toISOString()
            };

            projects.push(project);

            // Auto-update proposal status to 'accepted' when converted to project
            if (proposal) {
                proposal.status = 'accepted';
                proposal.projectId = project.id;
                proposal.convertedToProjectDate = new Date().toISOString();
                logAuditEvent('proposal', proposal.id, 'converted_to_project', `Converted to project: ${project.projectNumber}`);
            }

            // Auto-update client pipeline stage to 'customer' if not already
            if (client && client.pipelineStage !== 'customer') {
                client.pipelineStage = 'customer';
                logAuditEvent('client', client.id, 'stage_changed', 'Stage changed to Customer (project created)');
            }

            // Log project creation
            logAuditEvent('project', project.id, 'created', `Project created: ${project.name}`);

            saveData();
            renderProjects();
            updateProjectStats();
            renderProposals();  // Refresh proposals to show updated status
            renderClients();    // Refresh clients to show updated stage
            closeModal('newProject');
            this.reset();
            currentStages = [];
            showToast('Project created!' + (proposal ? ' Proposal marked as accepted.' : ''));
        });

        function resetProjectForm() {
            document.getElementById('newProjectForm').reset();
            currentStages = [];
            stageIndex = 0;
            document.getElementById('stagesList').innerHTML = '<div style="color: var(--gray); font-size: 13px; text-align: center; padding: 20px;">Select a project type to load stage template, or add stages manually</div>';
        }

        function renderProjects(filteredProjects = null) {
            const tbody = document.getElementById('projectsTable');
            const list = filteredProjects || projects;
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray);">No projects yet</td></tr>';
                return;
            }
            tbody.innerHTML = list.map(p => {
                const progress = p.overallProgress || 0;
                const statusColors = { active: 'status-active', on_hold: 'status-pending', completed: 'status-sent' };
                const isTimerActive = activeTimer && activeTimer.projectId === p.id;
                const timerBtn = isTimerActive
                    ? `<button class="btn btn-sm" style="background: var(--danger); animation: pulse 1s infinite;" onclick="stopProjectTimer(true)" title="Stop Timer">⏹ Stop</button>`
                    : `<button class="btn btn-sm" style="background: var(--success);" onclick="startProjectTimer(${p.id})" title="Start Timer">▶ Start</button>`;
                return `<tr ${isTimerActive ? 'style="background: rgba(239, 68, 68, 0.1);"' : ''}>
                    <td><strong>${p.projectNumber || 'N/A'}</strong></td>
                    <td>${p.clientName || 'N/A'}</td>
                    <td>${p.name}</td>
                    <td style="min-width: 150px;"><div style="display: flex; align-items: center; gap: 8px;"><div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 4px; height: 8px; overflow: hidden;"><div style="background: var(--gradient); height: 100%; width: ${progress}%;"></div></div><span style="font-size: 12px;">${progress}%</span></div></td>
                    <td><span class="status-badge ${statusColors[p.status] || 'status-pending'}">${(p.status || 'active').replace('_', ' ')}</span></td>
                    <td style="text-align: center;">${timerBtn}</td>
                    <td><div class="action-btns"><button class="btn btn-primary btn-sm" onclick="openProjectManagement(${p.id})">Manage</button><button class="btn btn-danger btn-sm" onclick="deleteProject(${p.id})">Delete</button></div></td>
                </tr>`;
            }).join('');
        }

        function filterProjects() {
            const search = document.getElementById('projectSearch').value.toLowerCase().trim();
            const status = document.getElementById('projectStatusFilter').value;
            let filtered = projects;
            if (search) filtered = filtered.filter(p => p.name.toLowerCase().includes(search) || p.clientName.toLowerCase().includes(search) || p.projectNumber.toLowerCase().includes(search));
            if (status) filtered = filtered.filter(p => p.status === status);
            renderProjects(filtered);
        }

        function updateProjectStats() {
            document.getElementById('activeProjectsCount').textContent = projects.filter(p => p.status === 'active').length;
            document.getElementById('totalProjectsCount').textContent = projects.length;
            document.getElementById('onTrackProjects').textContent = projects.filter(p => p.status === 'active' && p.overallProgress > 0).length;
            document.getElementById('attentionProjects').textContent = projects.filter(p => p.status === 'on_hold').length;
        }

        function deleteProject(id) {
            if (confirm('Delete this project?')) {
                projects = projects.filter(p => p.id !== id);
                saveData(); renderProjects(); updateProjectStats();
                showToast('Project deleted');
            }
        }

        // Project View Toggle (List/Gantt)
        let currentProjectView = 'list';
        function setProjectView(view) {
            currentProjectView = view;
            document.getElementById('viewList').style.background = view === 'list' ? 'var(--primary)' : 'rgba(255,255,255,0.05)';
            document.getElementById('viewGantt').style.background = view === 'gantt' ? 'var(--primary)' : 'rgba(255,255,255,0.05)';
            document.getElementById('projectsListView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('projectsGanttView').style.display = view === 'gantt' ? 'block' : 'none';
            if (view === 'gantt') renderGanttChart();
        }

        // Gantt Chart Rendering
        function renderGanttChart() {
            const container = document.getElementById('ganttChart');
            if (projects.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 40px;">No projects to display</div>';
                return;
            }

            // Find date range across all projects
            let minDate = new Date();
            let maxDate = new Date();
            projects.forEach(p => {
                if (p.startDate) {
                    const start = new Date(p.startDate);
                    if (start < minDate) minDate = start;
                }
                if (p.expectedEndDate) {
                    const end = new Date(p.expectedEndDate);
                    if (end > maxDate) maxDate = end;
                }
                // Add 2 weeks padding
                maxDate = new Date(maxDate.getTime() + 14 * 24 * 60 * 60 * 1000);
            });

            const totalDays = Math.ceil((maxDate - minDate) / (24 * 60 * 60 * 1000)) || 60;
            const dayWidth = 12;
            const chartWidth = totalDays * dayWidth;

            // Generate weeks header
            let weeksHtml = '';
            let currentWeek = new Date(minDate);
            while (currentWeek < maxDate) {
                const weekNum = getWeekNumber(currentWeek);
                weeksHtml += `<div style="flex: 0 0 ${7 * dayWidth}px; text-align: center; font-size: 10px; color: var(--gray); border-left: 1px solid rgba(255,255,255,0.05);">W${weekNum}</div>`;
                currentWeek.setDate(currentWeek.getDate() + 7);
            }

            let html = `
                <div style="display: flex; font-size: 11px; margin-bottom: 4px;">
                    <div style="width: 200px; flex-shrink: 0; padding-right: 10px;"></div>
                    <div style="display: flex; flex: 1; min-width: ${chartWidth}px;">${weeksHtml}</div>
                </div>
            `;

            projects.forEach(p => {
                const projectStart = p.startDate ? new Date(p.startDate) : minDate;
                const startOffset = Math.max(0, Math.ceil((projectStart - minDate) / (24 * 60 * 60 * 1000)));

                html += `
                    <div style="display: flex; align-items: stretch; margin-bottom: 8px; background: rgba(255,255,255,0.02); border-radius: 8px; overflow: hidden;">
                        <div style="width: 200px; flex-shrink: 0; padding: 10px; border-left: 3px solid ${p.status === 'active' ? 'var(--primary)' : p.status === 'completed' ? '#10b981' : '#f59e0b'};">
                            <div style="font-weight: 600; font-size: 12px; margin-bottom: 2px;">${p.name}</div>
                            <div style="font-size: 10px; color: var(--gray);">${p.clientName}</div>
                            <div style="font-size: 10px; color: var(--primary); margin-top: 4px;">${p.overallProgress}% complete</div>
                        </div>
                        <div style="flex: 1; position: relative; min-width: ${chartWidth}px; background: rgba(255,255,255,0.01);">
                `;

                // Render each stage as a bar
                let stageOffset = startOffset;
                p.stages.forEach((stage, idx) => {
                    const stageDuration = Math.ceil(stage.estimatedHours / 8) || 7; // Assume 8 hours/day
                    const stageWidth = stageDuration * dayWidth;
                    const colors = {
                        'not_started': 'rgba(100,116,139,0.4)',
                        'in_progress': 'var(--primary)',
                        'completed': '#10b981'
                    };
                    const bgColor = colors[stage.status] || colors['not_started'];
                    const progressWidth = (stage.completionPercent || 0) * stageWidth / 100;

                    html += `
                        <div style="position: absolute; top: ${10 + idx * 22}px; left: ${stageOffset * dayWidth}px; width: ${stageWidth}px; height: 18px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; cursor: pointer;" title="${stage.name}: ${stage.completionPercent}%" onclick="openProjectManagement(${p.id})">
                            <div style="height: 100%; width: ${progressWidth}px; background: ${bgColor}; border-radius: 4px;"></div>
                            <span style="position: absolute; left: 4px; top: 2px; font-size: 9px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: ${stageWidth - 8}px;">${stage.name}</span>
                        </div>
                    `;
                    stageOffset += stageDuration;
                });

                html += `</div></div>`;
            });

            container.innerHTML = html;
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function openProjectManagement(id) {
            const project = projects.find(p => p.id === id);
            if (!project) return;
            currentManagingProjectId = id;
            document.getElementById('manageProjectTitle').textContent = project.projectNumber + ': ' + project.name;

            const totalHoursSpent = project.stages.reduce((sum, s) => sum + (s.actualHours || 0), 0);
            const completedStages = project.stages.filter(s => s.status === 'completed').length;

            const content = `
                <div style="margin-bottom: 20px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;"><span style="color: var(--gray-light);">Client: ${project.clientName}</span><span style="color: var(--gray-light);">Budget: ₪${project.totalBudget.toLocaleString()}</span></div>
                    <div style="margin-bottom: 8px; font-size: 14px;">Overall Progress</div>
                    <div style="display: flex; align-items: center; gap: 12px;"><div style="flex: 1; background: rgba(255,255,255,0.1); border-radius: 6px; height: 12px; overflow: hidden;"><div style="background: var(--gradient); height: 100%; width: ${project.overallProgress}%;"></div></div><span style="font-size: 18px; font-weight: 600;">${project.overallProgress}%</span></div>
                    <div style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 13px; color: var(--gray-light);"><span>Time: ${totalHoursSpent}/${project.totalHours} hours</span><span>Stages: ${completedStages}/${project.stages.length} completed</span></div>
                </div>
                <div style="margin-bottom: 20px;"><h3 style="margin-bottom: 12px; font-size: 14px;">Project Stages</h3><div style="max-height: 350px; overflow-y: auto;">
                    ${project.stages.map((stage, idx) => {
                        const icon = stage.status === 'completed' ? '✓' : stage.status === 'in_progress' ? '►' : '○';
                        const color = stage.status === 'completed' ? '#10b981' : stage.status === 'in_progress' ? '#6366f1' : '#64748b';
                        return `<div style="background: rgba(255,255,255,0.02); border: 1px solid ${stage.status === 'in_progress' ? 'var(--primary)' : 'rgba(255,255,255,0.08)'}; border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;"><span style="color: ${color}; font-size: 16px;">${icon}</span><span style="font-weight: 600; flex: 1;">${idx + 1}. ${stage.name}</span><span style="font-size: 12px; color: var(--gray-light);">${stage.actualHours}/${stage.estimatedHours} hrs</span><span style="font-size: 12px; color: ${color};">${stage.completionPercent}%</span></div>
                            ${stage.status !== 'completed' ? `<div style="display: flex; gap: 8px; margin-bottom: 8px;"><input type="range" min="0" max="100" value="${stage.completionPercent}" onchange="updateStageProgress(${project.id}, ${idx}, this.value)" style="flex: 1;"><input type="number" value="${stage.actualHours}" placeholder="Hrs" onchange="updateStageActualHours(${project.id}, ${idx}, this.value)" style="width: 60px; padding: 4px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 12px;">
                            ${stage.status === 'not_started' ? `<button class="btn btn-secondary btn-sm" onclick="startStage(${project.id}, ${idx})">Start</button>` : `<button class="btn btn-success btn-sm" onclick="completeStage(${project.id}, ${idx})">Complete</button>`}</div>
                            <input type="text" placeholder="Notes" value="${stage.notes || ''}" onchange="updateStageNotes(${project.id}, ${idx}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 12px; margin-bottom: 6px;">
                            <input type="text" placeholder="Blockers" value="${stage.blockers || ''}" onchange="updateStageBlockers(${project.id}, ${idx}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px; color: var(--light); font-size: 12px; margin-bottom: 6px;">
                            <input type="text" placeholder="Action Required from Client" value="${stage.actionRequired || ''}" onchange="updateStageActionRequired(${project.id}, ${idx}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 4px; color: var(--light); font-size: 12px;">` : `<div style="font-size: 12px; color: var(--gray-light);">${stage.completedDate ? 'Completed: ' + new Date(stage.completedDate).toLocaleDateString('he-IL') : ''}</div>`}
                        </div>`;
                    }).join('')}
                </div></div>
                <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px;">Client Portal Link</h3>
                    <div style="margin-bottom: 8px;">
                        <label style="font-size: 10px; color: var(--gray-light);">Short Project ID (for TinyURL):</label>
                        <input type="text" id="shortId-${project.id}" value="${project.shortId || ''}" placeholder="e.g. tag-001, lhd-001" onchange="updateShortId(${project.id}, this.value)" style="width: 100%; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px; margin-top: 4px;">
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="shareLink-${project.id}" value="${project.shortId ? 'https://tinyurl.com/drishti-' + project.shortId : 'Set short ID above first'}" readonly style="flex: 1; min-width: 180px; padding: 6px 10px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 4px; color: #22c55e; font-size: 11px; font-weight: 600;">
                        <button class="btn btn-secondary btn-sm" onclick="copyShareLink(${project.id})">Copy</button>
                        <button class="btn btn-primary btn-sm" onclick="sendToClient(${project.id})">Email</button>
                        <button class="btn btn-warning btn-sm" onclick="createTinyUrl(${project.id})">Create TinyURL</button>
                    </div>
                </div>
                <div style="background: rgba(99, 102, 241, 0.05); border: 1px solid rgba(99, 102, 241, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px; color: var(--primary);">Technical Details (Visible to Client)</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="font-size: 10px; color: var(--gray-light); display: block; margin-bottom: 4px;">DATABASE SCHEMA</label>
                            <textarea placeholder="e.g. users (id, email, role)&#10;orders (id, user_id, status)" onchange="updateTechDetails(${project.id}, 'dbSchema', this.value)" style="width: 100%; height: 80px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 10px; font-family: monospace; resize: none;">${project.technicalDetails?.dbSchema || ''}</textarea>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: var(--gray-light); display: block; margin-bottom: 4px;">API ENDPOINTS</label>
                            <textarea placeholder="e.g. POST /api/users&#10;GET /api/orders" onchange="updateTechDetails(${project.id}, 'apiEndpoints', this.value)" style="width: 100%; height: 80px; padding: 6px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 10px; font-family: monospace; resize: none;">${project.technicalDetails?.apiEndpoints || ''}</textarea>
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 10px; color: var(--gray-light); display: block; margin-bottom: 4px;">KEY DELIVERABLES</label>
                        <div id="deliverables-${project.id}" style="background: rgba(255,255,255,0.02); border-radius: 4px; padding: 6px; max-height: 100px; overflow-y: auto;">
                            ${(project.technicalDetails?.deliverables || []).map((d, i) => `
                                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <input type="checkbox" ${d.done ? 'checked' : ''} onchange="updateDeliverable(${project.id}, ${i}, 'done', this.checked)" style="width: 14px; height: 14px;">
                                    <input type="text" value="${d.name}" onchange="updateDeliverable(${project.id}, ${i}, 'name', this.value)" style="flex: 1; padding: 4px 6px; background: transparent; border: none; color: var(--light); font-size: 11px;">
                                    <button onclick="removeDeliverable(${project.id}, ${i})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 14px;">×</button>
                                </div>
                            `).join('')}
                        </div>
                        <button onclick="addDeliverable(${project.id})" class="btn btn-secondary btn-sm" style="margin-top: 6px; width: 100%;">+ Add Deliverable</button>
                    </div>
                </div>
                <div style="background: rgba(245, 158, 11, 0.05); border: 1px solid rgba(245, 158, 11, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px; color: #f59e0b;">Client Feedback → Tasks</h3>
                    <textarea id="feedbackInput-${project.id}" placeholder="Paste client feedback here...&#10;&#10;Example:&#10;- Please add export to PDF&#10;- The login is slow&#10;- Need Hebrew support" style="width: 100%; height: 80px; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px; resize: none; margin-bottom: 8px;"></textarea>
                    <button onclick="convertFeedbackToTasks(${project.id})" class="btn btn-warning btn-sm" style="width: 100%;">Convert to Tasks</button>
                    <div id="generatedTasks-${project.id}" style="margin-top: 10px; display: none;">
                        <div style="font-size: 10px; color: var(--gray-light); margin-bottom: 6px;">GENERATED TASKS (check to add as deliverables):</div>
                        <div id="tasksList-${project.id}" style="background: rgba(255,255,255,0.02); border-radius: 4px; padding: 6px; max-height: 120px; overflow-y: auto;"></div>
                        <button onclick="addSelectedTasks(${project.id})" class="btn btn-success btn-sm" style="width: 100%; margin-top: 6px;">Add Selected Tasks</button>
                    </div>
                </div>
                <div style="background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px; color: #8b5cf6;">📄 Project Documents (Git)</h3>
                    <div style="display: grid; gap: 8px;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="masterPlanPath-${project.id}" value="${project.docs?.masterPlan || ''}" placeholder="/path/to/project/.drishti/master-plan.md" onchange="updateProjectDoc(${project.id}, 'masterPlan', this.value)" style="flex: 1; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px;">
                            <span style="font-size: 10px; color: var(--gray); width: 80px;">Master Plan</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="archDocPath-${project.id}" value="${project.docs?.architecture || ''}" placeholder="/path/to/project/.drishti/architecture.md" onchange="updateProjectDoc(${project.id}, 'architecture', this.value)" style="flex: 1; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px;">
                            <span style="font-size: 10px; color: var(--gray); width: 80px;">Architecture</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="gitRepoPath-${project.id}" value="${project.docs?.gitRepo || ''}" placeholder="https://github.com/user/repo" onchange="updateProjectDoc(${project.id}, 'gitRepo', this.value)" style="flex: 1; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px;">
                            <span style="font-size: 10px; color: var(--gray); width: 80px;">Git Repo</span>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="localPath-${project.id}" value="${project.docs?.localPath || ''}" placeholder="/Users/you/app/ProjectName" onchange="updateProjectDoc(${project.id}, 'localPath', this.value)" style="flex: 1; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px;">
                            <span style="font-size: 10px; color: var(--gray); width: 80px;">Local Path</span>
                        </div>
                    </div>
                    ${project.docs?.gitRepo ? '<a href="' + project.docs.gitRepo + '" target="_blank" class="btn btn-secondary btn-sm" style="margin-top: 8px; width: 100%; text-decoration: none;">Open Git Repository →</a>' : ''}
                </div>
                <div style="background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.15); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <h3 style="margin-bottom: 10px; font-size: 12px; color: #10b981;">⏱️ Hour Logging</h3>
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <input type="number" id="logHours-${project.id}" placeholder="Hours" min="0" step="0.5" style="width: 80px; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 12px;">
                        <input type="text" id="logNote-${project.id}" placeholder="What did you work on?" style="flex: 1; padding: 6px 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 12px;">
                        <button onclick="logProjectHours(${project.id})" class="btn btn-success btn-sm">Log</button>
                    </div>
                    <div style="max-height: 100px; overflow-y: auto; font-size: 10px;">
                        ${(project.hourLogs || []).slice(-5).reverse().map(log => '<div style="padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;"><span>' + log.note + '</span><span style="color: var(--primary);">' + log.hours + 'h - ' + new Date(log.date).toLocaleDateString('he-IL') + '</span></div>').join('') || '<div style="color: var(--gray);">No hours logged yet</div>'}
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: var(--success);">Total logged: ${(project.hourLogs || []).reduce((sum, l) => sum + l.hours, 0)} hours</div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 12px;"><select onchange="updateProjectStatus(${project.id}, this.value)" style="padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 11px;"><option value="active" ${project.status === 'active' ? 'selected' : ''}>Active</option><option value="on_hold" ${project.status === 'on_hold' ? 'selected' : ''}>On Hold</option><option value="completed" ${project.status === 'completed' ? 'selected' : ''}>Completed</option></select><button class="btn btn-secondary" onclick="closeModal('manageProject')" style="flex: 1;">Close</button></div>`;

            document.getElementById('manageProjectContent').innerHTML = content;
            document.getElementById('modal-manageProject').classList.add('active');
        }

        function updateStageProgress(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].completionPercent = parseInt(value); recalculateProjectProgress(p); saveData(); }}
        function updateStageActualHours(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].actualHours = parseInt(value) || 0; p.totalHoursSpent = p.stages.reduce((sum, s) => sum + (s.actualHours || 0), 0); saveData(); }}
        function updateStageNotes(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].notes = value; saveData(); }}
        function updateStageBlockers(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].blockers = value; saveData(); }}
        function updateStageActionRequired(projectId, idx, value) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].actionRequired = value; saveData(); }}

        // Project Documents
        function updateProjectDoc(projectId, field, value) {
            const p = projects.find(p => p.id === projectId);
            if (p) {
                if (!p.docs) p.docs = {};
                p.docs[field] = value;
                p.updated = new Date().toISOString();
                saveData();
                showToast('Document path saved');
            }
        }

        // Hour Logging
        function logProjectHours(projectId) {
            const p = projects.find(p => p.id === projectId);
            if (!p) return;
            const hoursInput = document.getElementById(`logHours-${projectId}`);
            const noteInput = document.getElementById(`logNote-${projectId}`);
            const hours = parseFloat(hoursInput.value);
            const note = noteInput.value.trim();
            if (!hours || hours <= 0) { showToast('Enter valid hours', 'error'); return; }
            if (!note) { showToast('Enter a note', 'error'); return; }
            if (!p.hourLogs) p.hourLogs = [];
            p.hourLogs.push({ hours, note, date: new Date().toISOString() });
            p.totalHoursSpent = (p.totalHoursSpent || 0) + hours;
            p.updated = new Date().toISOString();
            saveData();
            hoursInput.value = '';
            noteInput.value = '';
            openProjectManagement(projectId); // Refresh modal
            showToast(`Logged ${hours} hours`);
        }

        // Technical details functions
        function updateTechDetails(projectId, field, value) {
            const p = projects.find(p => p.id === projectId);
            if (p) {
                if (!p.technicalDetails) p.technicalDetails = { dbSchema: '', apiEndpoints: '', deliverables: [] };
                p.technicalDetails[field] = value;
                p.updated = new Date().toISOString();
                saveData();
            }
        }

        function updateDeliverable(projectId, idx, field, value) {
            const p = projects.find(p => p.id === projectId);
            if (p && p.technicalDetails?.deliverables?.[idx]) {
                p.technicalDetails.deliverables[idx][field] = value;
                p.updated = new Date().toISOString();
                saveData();
            }
        }

        function addDeliverable(projectId) {
            const p = projects.find(p => p.id === projectId);
            if (p) {
                if (!p.technicalDetails) p.technicalDetails = { dbSchema: '', apiEndpoints: '', deliverables: [] };
                if (!p.technicalDetails.deliverables) p.technicalDetails.deliverables = [];
                p.technicalDetails.deliverables.push({ name: 'New deliverable', done: false });
                p.updated = new Date().toISOString();
                saveData();
                openProjectManagement(projectId);
            }
        }

        function removeDeliverable(projectId, idx) {
            const p = projects.find(p => p.id === projectId);
            if (p && p.technicalDetails?.deliverables) {
                p.technicalDetails.deliverables.splice(idx, 1);
                p.updated = new Date().toISOString();
                saveData();
                openProjectManagement(projectId);
            }
        }

        function startStage(projectId, idx) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].status = 'in_progress'; p.stages[idx].startDate = new Date().toISOString(); saveData(); openProjectManagement(projectId); }}
        function completeStage(projectId, idx) { const p = projects.find(p => p.id === projectId); if (p) { p.stages[idx].status = 'completed'; p.stages[idx].completionPercent = 100; p.stages[idx].completedDate = new Date().toISOString(); recalculateProjectProgress(p); saveData(); openProjectManagement(projectId); showToast('Stage completed!'); }}

        function recalculateProjectProgress(project) {
            const total = project.stages.length;
            if (total === 0) { project.overallProgress = 0; return; }
            project.overallProgress = Math.round(project.stages.reduce((sum, s) => sum + s.completionPercent, 0) / total);
            project.updated = new Date().toISOString();
        }

        // Convert client feedback to task list
        function convertFeedbackToTasks(projectId) {
            const textarea = document.getElementById('feedbackInput-' + projectId);
            const feedback = textarea.value.trim();
            if (!feedback) {
                showToast('Please paste client feedback first');
                return;
            }

            // Parse feedback into tasks - look for lines starting with -, *, •, numbers, or just new lines
            const lines = feedback.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(line => {
                    // Remove common prefixes
                    return line.replace(/^[-*•→]\s*/, '')
                               .replace(/^\d+[.)]\s*/, '')
                               .replace(/^please\s+/i, '')
                               .trim();
                })
                .filter(line => line.length > 3); // Skip very short lines

            // Convert to English task format (imperative form)
            const tasks = lines.map(line => {
                // Capitalize first letter
                let task = line.charAt(0).toUpperCase() + line.slice(1);
                // Remove trailing punctuation
                task = task.replace(/[.!?]+$/, '');
                return task;
            });

            if (tasks.length === 0) {
                showToast('No tasks could be extracted from feedback');
                return;
            }

            // Show generated tasks
            const tasksContainer = document.getElementById('generatedTasks-' + projectId);
            const tasksList = document.getElementById('tasksList-' + projectId);

            tasksList.innerHTML = tasks.map((task, i) => `
                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <input type="checkbox" id="task-${projectId}-${i}" checked style="width: 14px; height: 14px;">
                    <input type="text" id="taskText-${projectId}-${i}" value="${task}" style="flex: 1; padding: 4px 6px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: var(--light); font-size: 11px;">
                </div>
            `).join('');

            tasksContainer.style.display = 'block';
            showToast(tasks.length + ' tasks extracted');
        }

        function addSelectedTasks(projectId) {
            const p = projects.find(p => p.id === projectId);
            if (!p) return;

            if (!p.technicalDetails) p.technicalDetails = { dbSchema: '', apiEndpoints: '', deliverables: [] };
            if (!p.technicalDetails.deliverables) p.technicalDetails.deliverables = [];

            // Find all checked tasks
            let addedCount = 0;
            let i = 0;
            while (document.getElementById('task-' + projectId + '-' + i)) {
                const checkbox = document.getElementById('task-' + projectId + '-' + i);
                const textInput = document.getElementById('taskText-' + projectId + '-' + i);

                if (checkbox.checked && textInput.value.trim()) {
                    p.technicalDetails.deliverables.push({
                        name: textInput.value.trim(),
                        done: false
                    });
                    addedCount++;
                }
                i++;
            }

            if (addedCount > 0) {
                p.updated = new Date().toISOString();
                saveData();
                showToast(addedCount + ' tasks added as deliverables');
                openProjectManagement(projectId); // Refresh modal
            } else {
                showToast('No tasks selected');
            }
        }

        function updateShortId(projectId, shortId) {
            const p = projects.find(p => p.id === projectId);
            if (p) {
                p.shortId = shortId.toLowerCase().replace(/[^a-z0-9-]/g, '');
                saveData();
                document.getElementById('shareLink-' + projectId).value = p.shortId ? 'https://tinyurl.com/drishti-' + p.shortId : 'Set short ID above first';
            }
        }

        async function createTinyUrl(projectId) {
            const p = projects.find(p => p.id === projectId);
            if (!p || !p.shortId) {
                showToast('Please set a short ID first');
                return;
            }

            const baseUrl = 'https://luvchikavi.github.io/drishti-consulting-website/progress.html?p=' + p.shortId;
            const alias = 'drishti-' + p.shortId;

            showToast('Creating TinyURL...');

            try {
                const response = await fetch('https://tinyurl.com/api-create.php?url=' + encodeURIComponent(baseUrl) + '&alias=' + alias);
                const tinyUrl = await response.text();

                if (tinyUrl.includes('tinyurl.com')) {
                    document.getElementById('shareLink-' + projectId).value = tinyUrl;
                    showToast('TinyURL created! ' + tinyUrl);
                } else {
                    // Alias might already exist, use it anyway
                    document.getElementById('shareLink-' + projectId).value = 'https://tinyurl.com/' + alias;
                    showToast('TinyURL ready: https://tinyurl.com/' + alias);
                }
            } catch (e) {
                document.getElementById('shareLink-' + projectId).value = 'https://tinyurl.com/' + alias;
                showToast('TinyURL: https://tinyurl.com/' + alias);
            }
        }

        function updateProjectStatus(projectId, status) { const p = projects.find(p => p.id === projectId); if (p) { p.status = status; if (status === 'completed') p.actualEndDate = new Date().toISOString(); saveData(); renderProjects(); updateProjectStats(); showToast('Status updated'); }}

        function encodeProjectData(project) {
            const data = {
                n: project.name,
                c: project.clientName,
                p: project.overallProgress,
                b: project.totalBudget,
                h: project.totalHours,
                hs: project.stages.reduce((sum, s) => sum + (s.actualHours || 0), 0),
                sd: project.startDate,
                ed: project.expectedEndDate,
                s: project.stages.map(s => ({
                    n: s.name,
                    p: s.completionPercent,
                    st: s.status,
                    eh: s.estimatedHours,
                    ah: s.actualHours,
                    nt: s.notes,
                    bl: s.blockers,
                    ar: s.actionRequired || ''
                })),
                u: project.updated,
                // Technical details
                tech: project.technicalDetails ? {
                    db: project.technicalDetails.dbSchema || '',
                    api: project.technicalDetails.apiEndpoints || '',
                    deliverables: project.technicalDetails.deliverables || []
                } : null
            };
            return btoa(encodeURIComponent(JSON.stringify(data)));
        }

        function copyShareLink(projectId) { const input = document.getElementById('shareLink-' + projectId); input.select(); document.execCommand('copy'); showToast('Link copied!'); }

        function sendToClient(projectId) {
            const p = projects.find(p => p.id === projectId); if (!p) return;
            const link = document.getElementById('shareLink-' + projectId).value;
            const subject = encodeURIComponent(`Project Update: ${p.name}`);
            const body = encodeURIComponent(`Hi,\n\nHere's the latest progress update for "${p.name}".\n\nProgress: ${p.overallProgress}%\n\nView details: ${link}\n\nBest regards,\nDrishti Consulting`);
            window.open(`mailto:${p.clientEmail}?subject=${subject}&body=${body}`, '_blank');
        }

        function convertToProject(proposalId) {
            const proposal = proposals.find(p => p.id === proposalId); if (!proposal) return;

            // Handle both old and new field names
            const projectName = proposal.projectName || proposal.project || '';
            const proposalType = proposal.proposalType || proposal.type || '';

            openModal('newProject');
            setTimeout(() => {
                document.getElementById('projectProposal').value = proposalId;
                document.getElementById('projectClient').value = proposal.clientId;
                document.getElementById('projectName').value = projectName;
                document.getElementById('projectBudget').value = proposal.amount;
                document.getElementById('projectHours').value = proposal.hours || '';
                document.getElementById('projectType').value = proposalType;
                document.getElementById('projectDescription').value = proposal.description || '';
                if (proposalType && proposalType !== 'custom') loadStageTemplate();
            }, 100);
        }

        // ========== GREEN INVOICE INTEGRATION ==========

        let greenInvoiceToken = null;
        let greenInvoiceTokenExpiry = null;
        let greenInvoiceSettings = JSON.parse(localStorage.getItem('greenInvoiceSettings')) || {};

        // Load Green Invoice settings on page load
        function loadGreenInvoiceSettings() {
            document.getElementById('greenInvoiceId').value = greenInvoiceSettings.apiId || '';
            document.getElementById('greenInvoiceSecret').value = greenInvoiceSettings.apiSecret || '';
            document.getElementById('greenInvoiceDocType').value = greenInvoiceSettings.defaultDocType || '320';
        }

        function saveGreenInvoiceSettings() {
            greenInvoiceSettings = {
                apiId: document.getElementById('greenInvoiceId').value,
                apiSecret: document.getElementById('greenInvoiceSecret').value,
                defaultDocType: document.getElementById('greenInvoiceDocType').value
            };
            localStorage.setItem('greenInvoiceSettings', JSON.stringify(greenInvoiceSettings));
            showToast('Green Invoice settings saved!');
        }

        // Get JWT token from Green Invoice API
        async function getGreenInvoiceToken() {
            // Check if we have a valid token
            if (greenInvoiceToken && greenInvoiceTokenExpiry && new Date() < greenInvoiceTokenExpiry) {
                return greenInvoiceToken;
            }

            const apiId = greenInvoiceSettings.apiId;
            const apiSecret = greenInvoiceSettings.apiSecret;

            if (!apiId || !apiSecret) {
                throw new Error('Green Invoice API credentials not configured');
            }

            try {
                const response = await fetch('https://api.greeninvoice.co.il/api/v1/account/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id: apiId,
                        secret: apiSecret
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to authenticate with Green Invoice');
                }

                const data = await response.json();
                greenInvoiceToken = data.token;
                // Token expires in 1 hour, refresh 5 minutes before
                greenInvoiceTokenExpiry = new Date(Date.now() + 55 * 60 * 1000);
                return greenInvoiceToken;
            } catch (error) {
                console.error('Green Invoice auth error:', error);
                throw error;
            }
        }

        async function testGreenInvoiceConnection() {
            const statusDiv = document.getElementById('greenInvoiceStatus');
            // Note: Direct API calls from browser are blocked by CORS
            // We'll use the "Open in Green Invoice" approach instead
            saveGreenInvoiceSettings();
            if (greenInvoiceSettings.apiId && greenInvoiceSettings.apiSecret) {
                statusDiv.innerHTML = '<span style="color: var(--success);">✓ Credentials saved! Use "Create Invoice" to open Green Invoice with pre-filled data.</span>';
            } else {
                statusDiv.innerHTML = '<span style="color: var(--danger);">✗ Please enter API credentials</span>';
            }
        }

        // Create invoice in Green Invoice
        async function createGreenInvoice(invoiceData) {
            try {
                const token = await getGreenInvoiceToken();

                const payload = {
                    type: parseInt(greenInvoiceSettings.defaultDocType) || 320,
                    lang: 'he',
                    currency: 'ILS',
                    vatType: 0, // Default VAT
                    description: invoiceData.description || '',
                    remarks: invoiceData.remarks || '',
                    client: {
                        name: invoiceData.clientName,
                        emails: [invoiceData.clientEmail],
                        phone: invoiceData.clientPhone || '',
                        address: invoiceData.clientAddress || '',
                        country: 'IL',
                        taxId: invoiceData.clientTaxId || ''
                    },
                    income: invoiceData.items.map(item => ({
                        catalogNum: item.catalogNum || '',
                        description: item.description,
                        quantity: item.quantity || 1,
                        price: item.price,
                        currency: 'ILS',
                        vatType: 0
                    })),
                    payment: invoiceData.payment ? [{
                        type: invoiceData.payment.type || 4, // 4 = Bank Transfer
                        price: invoiceData.payment.amount,
                        currency: 'ILS',
                        date: invoiceData.payment.date || new Date().toISOString().split('T')[0]
                    }] : []
                };

                const response = await fetch('https://api.greeninvoice.co.il/api/v1/documents', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create invoice');
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Green Invoice create error:', error);
                throw error;
            }
        }

        // Document type selection modal
        function openDocumentTypeModal(proposalId) {
            const proposal = proposals.find(p => p.id === proposalId);
            if (!proposal) return;

            const modalContent = `
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 20px; color: var(--light);">בחר סוג מסמך</h3>
                    <p style="color: var(--gray); margin-bottom: 20px; font-size: 12px;">Select document type to create in Green Invoice</p>

                    <div style="display: grid; gap: 12px;">
                        <button onclick="createDocumentFromProposal(${proposalId}, 300)" class="btn" style="padding: 16px; background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary); display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">📋</span>
                            <div style="text-align: right; flex: 1;">
                                <div style="font-weight: 600; color: var(--primary);">הצעת מחיר</div>
                                <div style="font-size: 11px; color: var(--gray);">Quote / Proposal (300)</div>
                            </div>
                        </button>

                        <button onclick="createDocumentFromProposal(${proposalId}, 100)" class="btn" style="padding: 16px; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">📄</span>
                            <div style="text-align: right; flex: 1;">
                                <div style="font-weight: 600; color: var(--warning);">חשבון עסקה / דרישת תשלום</div>
                                <div style="font-size: 11px; color: var(--gray);">Payment Request / Proforma (100)</div>
                            </div>
                        </button>

                        <button onclick="createDocumentFromProposal(${proposalId}, 305)" class="btn" style="padding: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">🧾</span>
                            <div style="text-align: right; flex: 1;">
                                <div style="font-weight: 600; color: var(--success);">חשבונית מס</div>
                                <div style="font-size: 11px; color: var(--gray);">Tax Invoice (305)</div>
                            </div>
                        </button>

                        <button onclick="createDocumentFromProposal(${proposalId}, 320)" class="btn" style="padding: 16px; background: rgba(16, 185, 129, 0.15); border: 1px solid var(--success); display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">🧾</span>
                            <div style="text-align: right; flex: 1;">
                                <div style="font-weight: 600; color: var(--success);">חשבונית מס / קבלה</div>
                                <div style="font-size: 11px; color: var(--gray);">Invoice + Receipt (320)</div>
                            </div>
                        </button>

                        <button onclick="createDocumentFromProposal(${proposalId}, 400)" class="btn" style="padding: 16px; background: rgba(14, 165, 233, 0.1); border: 1px solid var(--secondary); display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">🧾</span>
                            <div style="text-align: right; flex: 1;">
                                <div style="font-weight: 600; color: var(--secondary);">קבלה</div>
                                <div style="font-size: 11px; color: var(--gray);">Receipt (400)</div>
                            </div>
                        </button>
                    </div>

                    <button onclick="closeModal('documentType')" class="btn btn-secondary" style="margin-top: 16px; width: 100%;">ביטול</button>
                </div>
            `;

            let modal = document.getElementById('modal-documentType');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'modal-documentType';
                modal.innerHTML = '<div class="modal" style="max-width: 400px;"><div id="documentTypeContent"></div></div>';
                document.body.appendChild(modal);
            }

            document.getElementById('documentTypeContent').innerHTML = modalContent;
            modal.classList.add('active');
        }

        // Document type names in Hebrew
        const documentTypeNames = {
            100: 'חשבון עסקה',
            300: 'הצעת מחיר',
            305: 'חשבונית מס',
            320: 'חשבונית מס / קבלה',
            400: 'קבלה'
        };

        // Create document from proposal - opens Green Invoice with pre-filled data
        function createDocumentFromProposal(proposalId, docType = 320) {
            closeModal('documentType');
            createInvoiceFromProposal(proposalId, docType);
        }

        // Create invoice from proposal - enhanced Green Invoice integration
        function createInvoiceFromProposal(proposalId, docType = 320) {
            const proposal = proposals.find(p => p.id === proposalId);
            if (!proposal) {
                showToast('Proposal not found', 'error');
                return;
            }

            const client = clients.find(c => c.id === proposal.clientId);
            if (!client) {
                showToast('Client not found', 'error');
                return;
            }

            // Get primary contact
            const primaryContact = client.contacts?.[0] || {};

            // Determine document prefix based on type
            const docPrefix = docType === 300 ? 'QT' : docType === 100 ? 'PR' : 'IN';
            const docTypeName = documentTypeNames[docType] || 'מסמך';

            // Calculate invoiced amount and milestone number
            const alreadyInvoiced = getProposalInvoicedAmount(proposalId);
            const remainingAmount = proposal.amount - alreadyInvoiced;
            const milestoneNum = invoices.filter(inv => inv.proposalId === proposalId).length + 1;

            // Save document reference in our system first
            const docNumber = generateDocumentNumber(docPrefix, proposal.clientId);
            const invoiceId = Date.now();
            const invoice = {
                id: invoiceId,
                number: docNumber,
                docType: docType,
                docTypeName: docTypeName,
                proposalId: proposalId,
                proposalNumber: proposal.proposalNumber || proposal.number,
                projectName: proposal.projectName || proposal.project,
                milestoneNumber: milestoneNum,
                clientId: proposal.clientId,
                clientName: client.company,
                amount: proposal.amount,
                status: 'draft',
                greenInvoiceId: null,  // Will be filled when created in Green Invoice
                greenInvoiceUrl: null,
                created: new Date().toISOString()
            };

            invoices.push(invoice);
            saveData();
            logAuditEvent('invoice', invoiceId, 'created', `Draft invoice ${docNumber} created for ${docTypeName}`);

            // Open Green Invoice new document page with type parameter
            const greenInvoiceUrl = 'https://app.greeninvoice.co.il/documents/new?type=' + docType;

            // Check if API credentials are configured
            const hasApiCredentials = greenInvoiceSettings.apiId && greenInvoiceSettings.apiSecret;

            // Show modal with document details to copy
            const modalContent = `
                <div style="text-align: right; direction: rtl;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="background: rgba(99, 102, 241, 0.1); padding: 8px 12px; border-radius: 6px; display: inline-block;">
                            <span style="color: var(--primary); font-weight: 600;">${docTypeName}</span>
                        </div>
                        <span style="color: var(--gray); font-size: 11px;">Milestone ${milestoneNum}</span>
                    </div>
                    <h3 style="margin-bottom: 16px; color: var(--success);">צור ${docTypeName} ב-Green Invoice</h3>

                    <!-- Proposal Balance Summary -->
                    <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(99,102,241,0.1) 100%); border: 1px solid rgba(16,185,129,0.2); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; font-size: 11px;">
                            <div>
                                <div style="color: var(--gray);">סה"כ הצעה</div>
                                <div style="color: var(--light); font-weight: 600;">₪${proposal.amount.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: var(--gray);">כבר חויב</div>
                                <div style="color: var(--warning); font-weight: 600;">₪${alreadyInvoiced.toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="color: var(--gray);">יתרה</div>
                                <div style="color: var(--success); font-weight: 600;">₪${remainingAmount.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>

                    <p style="color: var(--gray); margin-bottom: 12px; font-size: 12px;">העתק את הפרטים הבאים ל-Green Invoice:</p>

                    <div style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label style="color: var(--gray); font-size: 10px;">שם לקוח</label>
                                <div style="color: var(--light); font-size: 14px; font-weight: 600;">${client.company}</div>
                            </div>
                            <button onclick="copyToClipboard('${escapeForHtml(client.company)}')" class="btn btn-sm" style="background: rgba(255,255,255,0.1); padding: 4px 8px;">📋</button>
                        </div>
                        ${client.companyId ? `
                        <div style="margin-bottom: 12px;">
                            <label style="color: var(--gray); font-size: 10px;">ח.פ / עוסק מורשה</label>
                            <div style="color: var(--light);">${client.companyId}</div>
                        </div>` : ''}
                        <div style="margin-bottom: 12px;">
                            <label style="color: var(--gray); font-size: 10px;">אימייל</label>
                            <div style="color: var(--light);">${primaryContact.email || 'לא צוין'}</div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="color: var(--gray); font-size: 10px;">טלפון</label>
                            <div style="color: var(--light);">${primaryContact.phone || 'לא צוין'}</div>
                        </div>
                        <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <label style="color: var(--gray); font-size: 10px;">תיאור פריט</label>
                                <div style="color: var(--light);">${proposal.projectName || proposal.project} - Milestone ${milestoneNum}</div>
                            </div>
                            <button onclick="copyToClipboard('${escapeForHtml(proposal.projectName || proposal.project)} - Milestone ${milestoneNum}')" class="btn btn-sm" style="background: rgba(255,255,255,0.1); padding: 4px 8px;">📋</button>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="color: var(--gray); font-size: 10px;">סכום מומלץ (לפני מע"מ)</label>
                            <div style="color: var(--success); font-size: 18px; font-weight: 700;">₪${remainingAmount.toLocaleString()}</div>
                            <small style="color: var(--gray); font-size: 10px;">או סכום חלקי לפי שלב</small>
                        </div>
                        <div>
                            <label style="color: var(--gray); font-size: 10px;">מספר הצעה / הערות</label>
                            <div style="color: var(--primary);">${proposal.proposalNumber || 'N/A'}</div>
                        </div>
                    </div>

                    <!-- Link Green Invoice Document -->
                    <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <label style="color: var(--warning); font-size: 11px; display: block; margin-bottom: 8px;">לאחר יצירת המסמך ב-Green Invoice, הזן את מספר המסמך:</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="greenInvoiceDocId_${invoiceId}" placeholder="מספר מסמך Green Invoice" style="flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--light); font-size: 12px;">
                            <button onclick="linkGreenInvoiceDoc(${invoiceId})" class="btn btn-warning btn-sm">קשר</button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button onclick="window.open('${greenInvoiceUrl}', '_blank');" class="btn btn-success" style="flex: 1;">
                            פתח Green Invoice →
                        </button>
                        <button onclick="closeModal('invoiceDetails')" class="btn btn-secondary">סגור</button>
                    </div>

                    <p style="color: var(--gray); font-size: 10px; margin-top: 12px;">
                        מספר מסמך פנימי: ${docNumber}
                        ${hasApiCredentials ? ' | API מוגדר ✓' : ' | API לא מוגדר'}
                    </p>
                </div>
            `;

            // Create temporary modal if not exists
            let modal = document.getElementById('modal-invoiceDetails');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'modal-invoiceDetails';
                modal.innerHTML = '<div class="modal" style="max-width: 500px;"><div id="invoiceDetailsContent"></div></div>';
                document.body.appendChild(modal);
            }

            document.getElementById('invoiceDetailsContent').innerHTML = modalContent;
            modal.classList.add('active');

            showToast('Draft invoice #' + docNumber + ' created');
            renderInvoices();
        }

        // Copy text to clipboard helper
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Escape string for use in HTML attributes
        function escapeForHtml(str) {
            if (!str) return '';
            return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        // Link Green Invoice document ID to local invoice
        function linkGreenInvoiceDoc(invoiceId) {
            const input = document.getElementById('greenInvoiceDocId_' + invoiceId);
            const greenInvoiceDocId = input.value.trim();

            if (!greenInvoiceDocId) {
                showToast('Please enter the Green Invoice document number');
                return;
            }

            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                invoice.greenInvoiceId = greenInvoiceDocId;
                invoice.greenInvoiceUrl = `https://app.greeninvoice.co.il/documents/${greenInvoiceDocId}`;
                invoice.status = 'sent';
                invoice.sentDate = new Date().toISOString();
                saveData();
                logAuditEvent('invoice', invoiceId, 'linked_to_green_invoice', `Linked to Green Invoice: ${greenInvoiceDocId}`);
                showToast('Invoice linked to Green Invoice #' + greenInvoiceDocId);
                renderInvoices();
                closeModal('invoiceDetails');
            }
        }

        // Add to settings page load
        setTimeout(loadGreenInvoiceSettings, 100);

        // ========== DOCUMENT NUMBERING SYSTEM ==========

        // Generate client code from company name (3-4 uppercase letters)
        function generateClientCode(companyName) {
            if (!companyName) return 'UNK';
            // Remove common words and extract initials
            const cleanName = companyName.replace(/consulting|ltd|בע"מ|חברה|company|inc|corp/gi, '').trim();
            const words = cleanName.split(/\s+/).filter(w => w.length > 0);
            if (words.length === 1) {
                return words[0].substring(0, 3).toUpperCase();
            }
            return words.slice(0, 3).map(w => w[0]).join('').toUpperCase();
        }

        // Get or create client code
        function getClientCode(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return 'UNK';

            if (clientCodes[clientId]) return clientCodes[clientId];

            // Generate new code
            let code = generateClientCode(client.company);
            // Check for duplicates and make unique
            const existingCodes = Object.values(clientCodes);
            let counter = 1;
            let originalCode = code;
            while (existingCodes.includes(code)) {
                code = originalCode + counter;
                counter++;
            }
            clientCodes[clientId] = code;
            saveData();
            return code;
        }

        // Update client code manually
        function updateClientCode(clientId, newCode) {
            newCode = newCode.toUpperCase().substring(0, 4);
            clientCodes[clientId] = newCode;
            saveData();
            renderTemplatesPage();
        }

        // Generate document number: TYPE-CLIENT-SEQ-YY
        function generateDocumentNumber(type, clientId) {
            const clientCode = getClientCode(clientId);
            const year = new Date().getFullYear().toString().slice(-2);
            const counterKey = clientCode + '-' + year;

            if (!documentCounters[counterKey]) {
                documentCounters[counterKey] = 0;
            }
            documentCounters[counterKey]++;

            const seq = String(documentCounters[counterKey]).padStart(3, '0');
            saveData();

            return type + '-' + clientCode + '-' + seq + '-' + year;
        }

        // Update document number when status changes
        function updateDocumentNumberForStatus(docNumber, newStatus) {
            const parts = docNumber.split('-');
            if (parts.length !== 4) return docNumber;

            let newType = parts[0];
            if (newStatus === 'draft' || newStatus === 'sent') newType = 'PP';
            else if (newStatus === 'accepted') newType = 'PA';
            else if (newStatus === 'active' || newStatus === 'working') newType = 'PJ';
            else if (newStatus === 'completed') newType = 'PC';

            return newType + '-' + parts[1] + '-' + parts[2] + '-' + parts[3];
        }

        // ========== TEMPLATES PAGE ==========

        function renderTemplatesPage() {
            renderClientCodes();
            renderProposalTemplates();
            renderAuditLog();
            loadBankDetails();
        }

        // Render audit log entries
        function renderAuditLog(filteredLog = null) {
            const container = document.getElementById('auditLogContainer');
            if (!container) return;

            const logToRender = filteredLog || auditLog.slice().reverse().slice(0, 100);

            if (logToRender.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray);">No audit entries yet. Actions will be logged here.</div>';
                return;
            }

            const typeIcons = {
                proposal: '📋',
                project: '📁',
                invoice: '💰',
                client: '👤',
                document: '📄'
            };

            const actionColors = {
                created: 'var(--success)',
                updated: 'var(--primary)',
                deleted: 'var(--danger)',
                converted_to_project: 'var(--accent)',
                stage_changed: 'var(--warning)',
                sent: 'var(--secondary)',
                linked_to_green_invoice: 'var(--success)'
            };

            container.innerHTML = logToRender.map(entry => {
                const icon = typeIcons[entry.entityType] || '📝';
                const actionColor = actionColors[entry.action] || 'var(--gray)';
                const timeAgo = formatRelativeDate(entry.timestamp);

                return `
                    <div style="padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: flex-start; gap: 12px;">
                        <span style="font-size: 16px;">${icon}</span>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="font-size: 12px; font-weight: 600; color: var(--light);">${entry.entityType.toUpperCase()}</span>
                                <span style="font-size: 10px; color: var(--gray);">${timeAgo}</span>
                            </div>
                            <div style="font-size: 11px; color: ${actionColor}; margin-bottom: 2px;">${entry.action.replace(/_/g, ' ')}</div>
                            <div style="font-size: 11px; color: var(--gray);">${entry.details}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter audit log
        function filterAuditLog() {
            const typeFilter = document.getElementById('auditFilterType').value;
            const actionFilter = document.getElementById('auditFilterAction').value;

            let filtered = auditLog.slice().reverse();

            if (typeFilter) {
                filtered = filtered.filter(e => e.entityType === typeFilter);
            }
            if (actionFilter) {
                filtered = filtered.filter(e => e.action.includes(actionFilter));
            }

            renderAuditLog(filtered.slice(0, 100));
        }

        // Clear audit log
        function clearAuditLog() {
            if (confirm('Clear all audit log entries? This cannot be undone.')) {
                auditLog = [];
                localStorage.setItem('auditLog', JSON.stringify(auditLog));
                renderAuditLog();
                showToast('Audit log cleared');
            }
        }

        function renderClientCodes() {
            const container = document.getElementById('clientCodesTable');
            if (!container) return;

            const html = clients.map(c => {
                const code = clientCodes[c.id] || generateClientCode(c.company);
                return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">' +
                    '<span style="color: var(--light);">' + c.company + '</span>' +
                    '<input type="text" value="' + code + '" maxlength="4" style="width: 60px; text-align: center; padding: 4px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: var(--primary); font-weight: 600; text-transform: uppercase;" onchange="updateClientCode(' + c.id + ', this.value)">' +
                    '</div>';
            }).join('');

            container.innerHTML = html || '<div style="color: var(--gray);">No clients yet. Add clients to generate codes.</div>';
        }

        function renderProposalTemplates() {
            const container = document.getElementById('proposalTemplatesGrid');
            if (!container) return;

            // Initialize default template if none exist
            if (proposalTemplates.length === 0) {
                initializeDefaultTemplate();
            }

            const html = proposalTemplates.map((t, idx) => {
                return '<div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">' +
                    '<div>' +
                    '<h4 style="margin: 0; color: var(--light);">' + t.name + '</h4>' +
                    '<span style="font-size: 10px; color: var(--gray);">' + t.type + '</span>' +
                    '</div>' +
                    (t.isDefault ? '<span style="background: var(--primary); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px;">DEFAULT</span>' : '') +
                    '</div>' +
                    '<p style="font-size: 11px; color: var(--gray); margin-bottom: 12px;">' + (t.description || 'No description') + '</p>' +
                    '<div style="font-size: 10px; color: var(--gray-light); margin-bottom: 12px;">' +
                    '<div>Sections: ' + (t.sections?.length || 0) + '</div>' +
                    '<div>Items: ' + (t.defaultItems?.length || 0) + '</div>' +
                    '</div>' +
                    '<div style="display: flex; gap: 8px;">' +
                    '<button class="btn btn-secondary btn-sm" onclick="editTemplate(' + idx + ')">Edit</button>' +
                    '<button class="btn btn-primary btn-sm" onclick="useTemplate(' + idx + ')">Use</button>' +
                    (!t.isDefault ? '<button class="btn btn-danger btn-sm" onclick="deleteTemplate(' + idx + ')">×</button>' : '') +
                    '</div>' +
                    '</div>';
            }).join('');

            container.innerHTML = html;
        }

        function initializeDefaultTemplate() {
            proposalTemplates = [{
                id: 1,
                name: 'System Development (LHD Style)',
                type: 'development',
                isDefault: true,
                description: 'Full system development proposal based on LHD Insurance project template',
                sections: [
                    { name: 'executiveSummary', label: 'תקציר מנהלים', required: true },
                    { name: 'objectives', label: 'יעדי המערכת', required: true },
                    { name: 'scope', label: 'היקף הפרויקט', required: true },
                    { name: 'timeline', label: 'לוח זמנים', required: true },
                    { name: 'pricing', label: 'פירוט תמחיר', required: true },
                    { name: 'payment', label: 'תנאי תשלום', required: true },
                    { name: 'included', label: 'כלול בהצעה', required: false },
                    { name: 'excluded', label: 'לא כלול בהצעה', required: false },
                    { name: 'bankDetails', label: 'פרטי בנק', required: true }
                ],
                defaultItems: [
                    { desc: 'אפיון מפורט ותכנון', pct: 10 },
                    { desc: 'הקמת תשתית וארכיטקטורה', pct: 15 },
                    { desc: 'פיתוח שלב 1 - Core', pct: 25 },
                    { desc: 'פיתוח שלב 2 - Features', pct: 25 },
                    { desc: 'ממשק משתמש (UI/UX)', pct: 10 },
                    { desc: 'בדיקות והטמעה', pct: 15 }
                ],
                defaultPayment: [
                    { pct: 40, desc: 'עם חתימת ההסכם' },
                    { pct: 40, desc: 'לאחר השלמת פיתוח שלב 1' },
                    { pct: 20, desc: 'מסירת הפרויקט' }
                ],
                defaultIncluded: [
                    'פיתוח מלא של המערכת',
                    'הקמת תשתית ענן',
                    'תיעוד טכני ומדריך למשתמש',
                    '3 חודשי תמיכה טכנית'
                ],
                defaultExcluded: [
                    'עלויות ענן שוטפות',
                    'הזנת נתונים ראשונית'
                ]
            }, {
                id: 2,
                name: 'Consulting Project',
                type: 'consulting',
                isDefault: false,
                description: 'Standard consulting engagement proposal',
                sections: [
                    { name: 'executiveSummary', label: 'תקציר מנהלים', required: true },
                    { name: 'objectives', label: 'יעדי הפרויקט', required: true },
                    { name: 'methodology', label: 'מתודולוגיה', required: true },
                    { name: 'deliverables', label: 'תוצרים', required: true },
                    { name: 'pricing', label: 'תמחיר', required: true },
                    { name: 'payment', label: 'תנאי תשלום', required: true }
                ],
                defaultItems: [
                    { desc: 'פגישת היכרות וגילוי', pct: 15 },
                    { desc: 'ניתוח ומחקר', pct: 35 },
                    { desc: 'פיתוח אסטרטגיה', pct: 30 },
                    { desc: 'דוח והמלצות', pct: 20 }
                ],
                defaultPayment: [
                    { pct: 50, desc: 'עם חתימת ההסכם' },
                    { pct: 50, desc: 'מסירת הדוח הסופי' }
                ]
            }, {
                id: 3,
                name: 'Characterization Phase',
                type: 'characterization',
                isDefault: false,
                description: 'Requirements gathering and system characterization',
                sections: [
                    { name: 'executiveSummary', label: 'תקציר', required: true },
                    { name: 'scope', label: 'היקף האפיון', required: true },
                    { name: 'methodology', label: 'מתודולוגיה', required: true },
                    { name: 'deliverables', label: 'תוצרים', required: true },
                    { name: 'pricing', label: 'תמחיר', required: true }
                ],
                defaultItems: [
                    { desc: 'ראיונות בעלי עניין', pct: 25 },
                    { desc: 'ניתוח תהליכים קיימים', pct: 25 },
                    { desc: 'הגדרת דרישות', pct: 30 },
                    { desc: 'מסמך אפיון', pct: 20 }
                ],
                defaultPayment: [
                    { pct: 50, desc: 'עם חתימת ההסכם' },
                    { pct: 50, desc: 'מסירת מסמך האפיון' }
                ]
            }, {
                id: 4,
                name: 'ESG & Sustainability',
                type: 'esg',
                isDefault: false,
                description: 'ESG assessment, sustainability reporting and compliance',
                sections: [
                    { name: 'executiveSummary', label: 'תקציר מנהלים', required: true },
                    { name: 'background', label: 'רקע ודרישות רגולציה', required: true },
                    { name: 'scope', label: 'היקף הפרויקט', required: true },
                    { name: 'methodology', label: 'מתודולוגיה', required: true },
                    { name: 'deliverables', label: 'תוצרים', required: true },
                    { name: 'timeline', label: 'לוח זמנים', required: true },
                    { name: 'pricing', label: 'תמחיר', required: true }
                ],
                defaultItems: [
                    { desc: 'מיפוי מצב קיים (Baseline Assessment)', pct: 20 },
                    { desc: 'ניתוח מהותיות (Materiality Analysis)', pct: 15 },
                    { desc: 'איסוף וניתוח נתונים סביבתיים', pct: 25 },
                    { desc: 'הכנת דוח ESG/קיימות', pct: 25 },
                    { desc: 'הדרכה ובקרה', pct: 15 }
                ],
                defaultPayment: [
                    { pct: 40, desc: 'עם חתימת ההסכם' },
                    { pct: 30, desc: 'סיום שלב איסוף נתונים' },
                    { pct: 30, desc: 'מסירת הדוח הסופי' }
                ],
                defaultIncluded: [
                    'מיפוי דרישות רגולציה רלוונטיות (CSRD, GRI)',
                    'איסוף נתוני פליטות Scope 1, 2, 3',
                    'ניתוח מהותיות עם בעלי עניין',
                    'הכנת דוח מלא לפי תקן',
                    'פגישות ליווי והדרכה'
                ],
                defaultExcluded: [
                    'אימות צד שלישי (Verification)',
                    'פרויקטי צמצום פליטות',
                    'מערכת ניהול ESG שוטפת'
                ]
            }, {
                id: 5,
                name: 'System Integration',
                type: 'integration',
                isDefault: false,
                description: 'API integration and system connectivity projects',
                sections: [
                    { name: 'executiveSummary', label: 'תקציר', required: true },
                    { name: 'currentState', label: 'מצב קיים', required: true },
                    { name: 'targetState', label: 'יעד', required: true },
                    { name: 'integrations', label: 'פירוט אינטגרציות', required: true },
                    { name: 'timeline', label: 'לוח זמנים', required: true },
                    { name: 'pricing', label: 'תמחיר', required: true }
                ],
                defaultItems: [
                    { desc: 'מיפוי מערכות ו-APIs קיימים', pct: 15 },
                    { desc: 'תכנון ארכיטקטורה', pct: 15 },
                    { desc: 'פיתוח Connectors', pct: 35 },
                    { desc: 'בדיקות אינטגרציה', pct: 20 },
                    { desc: 'תיעוד והדרכה', pct: 15 }
                ],
                defaultPayment: [
                    { pct: 30, desc: 'עם חתימת ההסכם' },
                    { pct: 40, desc: 'סיום פיתוח' },
                    { pct: 30, desc: 'מסירה ואישור' }
                ],
                defaultIncluded: [
                    'פיתוח כל ה-Connectors המפורטים',
                    'תיעוד טכני מלא',
                    'בדיקות E2E',
                    'תמיכה 30 יום לאחר מסירה'
                ],
                defaultExcluded: [
                    'שינויים במערכות מקור',
                    'רישיונות צד שלישי',
                    'תמיכה שוטפת מעבר לתקופת האחריות'
                ]
            }, {
                id: 6,
                name: 'Retainer Agreement',
                type: 'retainer',
                isDefault: false,
                description: 'Monthly retainer for ongoing support and development',
                sections: [
                    { name: 'executiveSummary', label: 'תקציר', required: true },
                    { name: 'servicesIncluded', label: 'שירותים כלולים', required: true },
                    { name: 'availability', label: 'זמינות ו-SLA', required: true },
                    { name: 'pricing', label: 'תמחיר חודשי', required: true },
                    { name: 'terms', label: 'תנאים', required: true }
                ],
                defaultItems: [
                    { desc: 'תמיכה טכנית שוטפת', pct: 30 },
                    { desc: 'פיתוחים ושיפורים', pct: 40 },
                    { desc: 'ניהול ופגישות', pct: 15 },
                    { desc: 'תחזוקה מונעת', pct: 15 }
                ],
                defaultPayment: [
                    { pct: 100, desc: 'תשלום חודשי מראש, ב-1 לכל חודש' }
                ],
                defaultIncluded: [
                    'X שעות פיתוח/תמיכה בחודש',
                    'זמן תגובה עד 24 שעות',
                    'גישה לצוות פיתוח',
                    'דוח חודשי'
                ],
                defaultExcluded: [
                    'שעות מעבר למכסה (יחויבו בנפרד)',
                    'פרויקטים חדשים מעבר לתחזוקה',
                    'עבודות בשעות לא סטנדרטיות'
                ]
            }, {
                id: 7,
                name: 'BI & Dashboard',
                type: 'bi',
                isDefault: false,
                description: 'Business Intelligence and Dashboard development',
                sections: [
                    { name: 'executiveSummary', label: 'תקציר', required: true },
                    { name: 'dataRequirements', label: 'מקורות נתונים', required: true },
                    { name: 'dashboards', label: 'דשבורדים נדרשים', required: true },
                    { name: 'kpis', label: 'מדדים ו-KPIs', required: true },
                    { name: 'timeline', label: 'לוח זמנים', required: true },
                    { name: 'pricing', label: 'תמחיר', required: true }
                ],
                defaultItems: [
                    { desc: 'הגדרת דרישות ו-KPIs', pct: 15 },
                    { desc: 'חיבור מקורות נתונים', pct: 20 },
                    { desc: 'פיתוח מודל נתונים', pct: 20 },
                    { desc: 'עיצוב ופיתוח דשבורדים', pct: 30 },
                    { desc: 'הדרכה ומסירה', pct: 15 }
                ],
                defaultPayment: [
                    { pct: 40, desc: 'עם חתימת ההסכם' },
                    { pct: 40, desc: 'אישור עיצוב דשבורדים' },
                    { pct: 20, desc: 'מסירה סופית' }
                ]
            }];
            saveData();
        }

        function editTemplate(idx) {
            const template = proposalTemplates[idx];
            showToast('Template editing will be available soon');
        }

        function useTemplate(idx) {
            const template = proposalTemplates[idx];
            // Open new proposal modal with template pre-filled
            document.getElementById('proposalType').value = template.type;
            openModal('newProposal');
            showToast('Template "' + template.name + '" selected');
        }

        function deleteTemplate(idx) {
            if (confirm('Delete this template?')) {
                proposalTemplates.splice(idx, 1);
                saveData();
                renderProposalTemplates();
            }
        }

        // ========== BANK DETAILS ==========

        function loadBankDetails() {
            document.getElementById('bankName').value = bankDetails.bank || '';
            document.getElementById('bankCode').value = bankDetails.bankCode || '';
            document.getElementById('branchName').value = bankDetails.branch || '';
            document.getElementById('branchCode').value = bankDetails.branchCode || '';
            document.getElementById('accountNumber').value = bankDetails.account || '';
            document.getElementById('accountName').value = bankDetails.name || '';
        }

        function saveBankDetails() {
            bankDetails = {
                bank: document.getElementById('bankName').value,
                bankCode: document.getElementById('bankCode').value,
                branch: document.getElementById('branchName').value,
                branchCode: document.getElementById('branchCode').value,
                account: document.getElementById('accountNumber').value,
                name: document.getElementById('accountName').value
            };
            saveData();
            showToast('Bank details saved');
        }

        // ========== EMPLOYEE MANAGEMENT ==========

        function saveEmployee(e) {
            e.preventDefault();

            const employee = {
                id: Date.now(),
                firstName: document.getElementById('empFirstName').value,
                lastName: document.getElementById('empLastName').value,
                idNumber: document.getElementById('empIdNumber').value,
                startDate: document.getElementById('empStartDate').value,
                position: document.getElementById('empPosition').value,
                baseSalary: parseFloat(document.getElementById('empBaseSalary').value),
                employmentType: document.getElementById('empType').value,
                bankName: document.getElementById('empBankName').value,
                bankBranch: document.getElementById('empBankBranch').value,
                bankAccount: document.getElementById('empBankAccount').value,
                email: document.getElementById('empEmail').value,
                status: 'active',
                created: new Date().toISOString()
            };

            employees.push(employee);
            saveData();
            renderEmployees();
            updatePayslipStats();
            closeModal('addEmployee');
            document.getElementById('addEmployeeForm').reset();
            showToast('Employee added successfully');
        }

        function renderEmployees() {
            const tbody = document.getElementById('employeesTableBody');

            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--gray);">No employees added yet</td></tr>';
                return;
            }

            tbody.innerHTML = employees.map(emp => {
                return '<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">' +
                    '<td style="padding: 10px 12px;">' + emp.firstName + ' ' + emp.lastName + '</td>' +
                    '<td style="padding: 10px 12px;">' + emp.idNumber + '</td>' +
                    '<td style="padding: 10px 12px;">' + (emp.position || '-') + '</td>' +
                    '<td style="padding: 10px 12px; text-align: right;">₪' + emp.baseSalary.toLocaleString() + '</td>' +
                    '<td style="padding: 10px 12px; text-align: center;">' +
                        '<button class="btn btn-sm btn-primary" onclick="createPayslipForEmployee(' + emp.id + ')">+ Payslip</button> ' +
                        '<button class="btn btn-sm btn-danger" onclick="deleteEmployee(' + emp.id + ')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');

            // Update employee select in payslip modal
            const select = document.getElementById('payslipEmployee');
            select.innerHTML = '<option value="">Select employee...</option>' +
                employees.map(emp => '<option value="' + emp.id + '">' + emp.firstName + ' ' + emp.lastName + '</option>').join('');
        }

        function deleteEmployee(id) {
            if (confirm('Are you sure you want to delete this employee?')) {
                employees = employees.filter(e => e.id !== id);
                saveData();
                renderEmployees();
                updatePayslipStats();
                showToast('Employee deleted');
            }
        }

        function createPayslipForEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (emp) {
                document.getElementById('payslipEmployee').value = id;
                loadEmployeeDefaults();
                openModal('newPayslip');
            }
        }

        // ========== PAYSLIP MANAGEMENT ==========

        function loadEmployeeDefaults() {
            const empId = parseInt(document.getElementById('payslipEmployee').value);
            const emp = employees.find(e => e.id === empId);

            if (emp) {
                document.getElementById('payBaseSalary').value = emp.baseSalary;
                autoCalculatePayslip(); // Trigger auto-calculation
            }

            // Set default period to current month
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('payslipPeriod').value = year + '-' + month;
        }

        // Auto-calculate all deductions and employer contributions based on percentages
        function autoCalculatePayslip() {
            // Get earnings
            const baseSalary = parseFloat(document.getElementById('payBaseSalary').value) || 0;
            const overtime125 = parseFloat(document.getElementById('payOvertime125').value) || 0;
            const overtime150 = parseFloat(document.getElementById('payOvertime150').value) || 0;
            const travel = parseFloat(document.getElementById('payTravel').value) || 0;
            const bonus = parseFloat(document.getElementById('payBonus').value) || 0;
            const commission = parseFloat(document.getElementById('payCommission').value) || 0;
            const recuperation = parseFloat(document.getElementById('payRecuperation').value) || 0;

            // Calculate overtime based on hourly rate (186 work hours per month standard in Israel)
            const hourlyRate = baseSalary / 186;
            const overtime125Pay = overtime125 * hourlyRate * 1.25;
            const overtime150Pay = overtime150 * hourlyRate * 1.5;

            // Total Gross
            const totalGross = baseSalary + overtime125Pay + overtime150Pay + travel + bonus + commission + recuperation;

            // Get percentage rates for deductions
            const incomeTaxRate = parseFloat(document.getElementById('payIncomeTaxRate').value) || 0;
            const nationalInsRate = parseFloat(document.getElementById('payNationalInsRate').value) || 0;
            const healthInsRate = parseFloat(document.getElementById('payHealthInsRate').value) || 0;
            const pensionEmpRate = parseFloat(document.getElementById('payPensionEmpRate').value) || 0;
            const studyFundRate = parseFloat(document.getElementById('payStudyFundRate').value) || 0;
            const otherDeduct = parseFloat(document.getElementById('payOtherDeduct').value) || 0;

            // Calculate deductions from gross (income tax applies to taxable income)
            const incomeTax = totalGross * (incomeTaxRate / 100);
            const nationalIns = totalGross * (nationalInsRate / 100);
            const healthIns = totalGross * (healthInsRate / 100);
            // Pension and study fund calculated from base salary (not full gross)
            const pensionEmp = baseSalary * (pensionEmpRate / 100);
            const studyFund = baseSalary * (studyFundRate / 100);

            // Update deduction amount fields
            document.getElementById('payIncomeTax').value = incomeTax.toFixed(2);
            document.getElementById('payNationalIns').value = nationalIns.toFixed(2);
            document.getElementById('payHealthIns').value = healthIns.toFixed(2);
            document.getElementById('payPensionEmp').value = pensionEmp.toFixed(2);
            document.getElementById('payStudyFund').value = studyFund.toFixed(2);

            // Get percentage rates for employer contributions
            const pensionEmployerRate = parseFloat(document.getElementById('payPensionEmployerRate').value) || 0;
            const severanceRate = parseFloat(document.getElementById('paySeveranceRate').value) || 0;
            const studyFundEmployerRate = parseFloat(document.getElementById('payStudyFundEmployerRate').value) || 0;

            // Calculate employer contributions from base salary
            const pensionEmployer = baseSalary * (pensionEmployerRate / 100);
            const severance = baseSalary * (severanceRate / 100);
            const studyFundEmployer = baseSalary * (studyFundEmployerRate / 100);

            // Update employer contribution fields
            document.getElementById('payPensionEmployer').value = pensionEmployer.toFixed(2);
            document.getElementById('paySeverance').value = severance.toFixed(2);
            document.getElementById('payStudyFundEmployer').value = studyFundEmployer.toFixed(2);

            // Calculate totals
            const totalDeductions = incomeTax + nationalIns + healthIns + pensionEmp + studyFund + otherDeduct;
            const netPay = totalGross - totalDeductions;

            // Update summary display
            document.getElementById('summaryGross').textContent = '₪' + totalGross.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryDeductions').textContent = '₪' + totalDeductions.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryNet').textContent = '₪' + netPay.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            return { gross: totalGross, deductions: totalDeductions, net: netPay };
        }

        function calculatePayslipTotals() {
            // This function now calls autoCalculatePayslip for consistency
            return autoCalculatePayslip();
        }

        function generatePayslip(e) {
            e.preventDefault();

            const empId = parseInt(document.getElementById('payslipEmployee').value);
            const emp = employees.find(e => e.id === empId);

            if (!emp) {
                showToast('Please select an employee', 'error');
                return;
            }

            const totals = calculatePayslipTotals();

            const payslip = {
                id: Date.now(),
                employeeId: empId,
                employeeName: emp.firstName + ' ' + emp.lastName,
                employeeIdNumber: emp.idNumber,
                period: document.getElementById('payslipPeriod').value,

                // Earnings
                baseSalary: parseFloat(document.getElementById('payBaseSalary').value) || 0,
                workDays: parseInt(document.getElementById('payWorkDays').value) || 0,
                workHours: parseFloat(document.getElementById('payWorkHours').value) || 0,
                overtime125: parseFloat(document.getElementById('payOvertime125').value) || 0,
                overtime150: parseFloat(document.getElementById('payOvertime150').value) || 0,
                travel: parseFloat(document.getElementById('payTravel').value) || 0,
                bonus: parseFloat(document.getElementById('payBonus').value) || 0,
                commission: parseFloat(document.getElementById('payCommission').value) || 0,
                recuperation: parseFloat(document.getElementById('payRecuperation').value) || 0,

                // Deductions (amounts)
                incomeTax: parseFloat(document.getElementById('payIncomeTax').value) || 0,
                nationalIns: parseFloat(document.getElementById('payNationalIns').value) || 0,
                healthIns: parseFloat(document.getElementById('payHealthIns').value) || 0,
                pensionEmp: parseFloat(document.getElementById('payPensionEmp').value) || 0,
                studyFund: parseFloat(document.getElementById('payStudyFund').value) || 0,
                otherDeduct: parseFloat(document.getElementById('payOtherDeduct').value) || 0,

                // Deduction rates (percentages) for reference
                incomeTaxRate: parseFloat(document.getElementById('payIncomeTaxRate').value) || 0,
                nationalInsRate: parseFloat(document.getElementById('payNationalInsRate').value) || 0,
                healthInsRate: parseFloat(document.getElementById('payHealthInsRate').value) || 0,
                pensionEmpRate: parseFloat(document.getElementById('payPensionEmpRate').value) || 0,
                studyFundRate: parseFloat(document.getElementById('payStudyFundRate').value) || 0,

                // Employer contributions (amounts)
                pensionEmployer: parseFloat(document.getElementById('payPensionEmployer').value) || 0,
                severance: parseFloat(document.getElementById('paySeverance').value) || 0,
                studyFundEmployer: parseFloat(document.getElementById('payStudyFundEmployer').value) || 0,

                // Employer contribution rates (percentages) for reference
                pensionEmployerRate: parseFloat(document.getElementById('payPensionEmployerRate').value) || 0,
                severanceRate: parseFloat(document.getElementById('paySeveranceRate').value) || 0,
                studyFundEmployerRate: parseFloat(document.getElementById('payStudyFundEmployerRate').value) || 0,

                // Leave balance
                vacationDays: parseFloat(document.getElementById('payVacationDays').value) || 0,
                sickDays: parseFloat(document.getElementById('paySickDays').value) || 0,
                recuperationDays: parseFloat(document.getElementById('payRecuperationDays').value) || 0,

                // Totals
                totalGross: totals.gross,
                totalDeductions: totals.deductions,
                netPay: totals.net,

                // Bank details
                bankName: emp.bankName,
                bankBranch: emp.bankBranch,
                bankAccount: emp.bankAccount,

                status: 'created',
                created: new Date().toISOString()
            };

            payslips.push(payslip);
            saveData();
            renderPayslips();
            updatePayslipStats();
            closeModal('newPayslip');
            document.getElementById('newPayslipForm').reset();

            // Open the payslip for viewing/printing
            openPayslipHTML(payslip);

            showToast('Payslip generated successfully');
        }

        function renderPayslips() {
            const tbody = document.getElementById('payslipsTableBody');
            const filter = document.getElementById('payslipMonthFilter').value;

            let filtered = payslips;
            if (filter) {
                filtered = payslips.filter(p => p.period === filter);
            }

            // Sort by period descending
            filtered.sort((a, b) => b.period.localeCompare(a.period));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--gray);">No payslips created yet</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(ps => {
                const statusClass = ps.status === 'sent' ? 'success' : (ps.status === 'created' ? 'warning' : 'secondary');
                return '<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">' +
                    '<td style="padding: 10px 12px;">' + formatPayPeriod(ps.period) + '</td>' +
                    '<td style="padding: 10px 12px;">' + ps.employeeName + '</td>' +
                    '<td style="padding: 10px 12px; text-align: right;">₪' + ps.totalGross.toLocaleString() + '</td>' +
                    '<td style="padding: 10px 12px; text-align: right;">₪' + ps.netPay.toLocaleString() + '</td>' +
                    '<td style="padding: 10px 12px; text-align: center;"><span class="badge badge-' + statusClass + '">' + ps.status + '</span></td>' +
                    '<td style="padding: 10px 12px; text-align: center;">' +
                        '<button class="btn btn-sm btn-primary" onclick="openPayslipHTML(payslips.find(p=>p.id===' + ps.id + '))">View</button> ' +
                        '<button class="btn btn-sm btn-success" onclick="sendPayslipEmail(' + ps.id + ')">Send</button> ' +
                        '<button class="btn btn-sm btn-danger" onclick="deletePayslip(' + ps.id + ')">Delete</button>' +
                    '</td>' +
                '</tr>';
            }).join('');

            // Update month filter options
            updateMonthFilter();
        }

        function formatPayPeriod(period) {
            const [year, month] = period.split('-');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[parseInt(month) - 1] + ' ' + year;
        }

        function updateMonthFilter() {
            const select = document.getElementById('payslipMonthFilter');
            const periods = [...new Set(payslips.map(p => p.period))].sort().reverse();

            select.innerHTML = '<option value="">All Months</option>' +
                periods.map(p => '<option value="' + p + '">' + formatPayPeriod(p) + '</option>').join('');
        }

        function filterPayslips() {
            renderPayslips();
        }

        function deletePayslip(id) {
            if (confirm('Are you sure you want to delete this payslip?')) {
                payslips = payslips.filter(p => p.id !== id);
                saveData();
                renderPayslips();
                updatePayslipStats();
                showToast('Payslip deleted');
            }
        }

        function updatePayslipStats() {
            document.getElementById('stat-employees').textContent = employees.length;

            const now = new Date();
            const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            const thisMonthPayslips = payslips.filter(p => p.period === currentMonth);

            document.getElementById('stat-payslips-month').textContent = thisMonthPayslips.length;

            const totalGross = thisMonthPayslips.reduce((sum, p) => sum + p.totalGross, 0);
            const totalNet = thisMonthPayslips.reduce((sum, p) => sum + p.netPay, 0);

            document.getElementById('stat-total-gross').textContent = '₪' + totalGross.toLocaleString();
            document.getElementById('stat-total-net').textContent = '₪' + totalNet.toLocaleString();
        }

        function openPayslipHTML(payslip) {
            const emp = employees.find(e => e.id === payslip.employeeId);
            const [year, month] = payslip.period.split('-');
            const monthNames = ['ינואר', 'פברואר', 'מרץ', 'אפריל', 'מאי', 'יוני', 'יולי', 'אוגוסט', 'ספטמבר', 'אוקטובר', 'נובמבר', 'דצמבר'];
            const periodHe = monthNames[parseInt(month) - 1] + ' ' + year;

            const hourlyRate = payslip.hourlyRate || (payslip.baseSalary / 186);
            const dailyRate = payslip.dailyRate || (payslip.baseSalary / 22);
            const companyName = payslip.company || 'Oporto Carbon';

            const html = '<!DOCTYPE html>' +
'<html lang="he" dir="rtl">' +
'<head>' +
'    <meta charset="UTF-8">' +
'    <meta name="viewport" content="width=device-width, initial-scale=1.0">' +
'    <title>תלוש שכר - ' + payslip.employeeName + ' - ' + periodHe + '</title>' +
'    <style>' +
'        * { margin: 0; padding: 0; box-sizing: border-box; }' +
'        body { font-family: Arial, sans-serif; font-size: 11px; background: #f5f5f5; padding: 20px; }' +
'        .payslip { background: white; max-width: 900px; margin: 0 auto; padding: 25px; border: 1px solid #ddd; }' +
'        .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #1a1a2e; padding-bottom: 12px; margin-bottom: 15px; }' +
'        .company-info { text-align: right; }' +
'        .company-name { font-size: 20px; font-weight: bold; color: #1a1a2e; }' +
'        .payslip-title { font-size: 14px; font-weight: 600; margin-top: 5px; }' +
'        .employee-box { text-align: left; background: #f0f0f0; padding: 12px 15px; border-radius: 4px; }' +
'        .employee-name { font-size: 14px; font-weight: 700; }' +
'        .employee-details { font-size: 10px; color: #555; margin-top: 4px; }' +
'        .summary-box { background: #f8f9fa; border: 2px solid #1a1a2e; padding: 15px; margin-bottom: 15px; }' +
'        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }' +
'        .summary-item { display: flex; justify-content: space-between; padding: 6px 10px; background: white; border: 1px solid #ddd; }' +
'        .summary-label { font-weight: 500; }' +
'        .summary-value { font-weight: 700; direction: ltr; }' +
'        .net-pay { background: #1a1a2e; color: white; font-size: 14px; padding: 12px; margin-top: 12px; display: flex; justify-content: space-between; }' +
'        .net-pay .amount { font-size: 20px; font-weight: 700; }' +
'        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }' +
'        .section { border: 1px solid #ddd; margin-bottom: 12px; }' +
'        .section-title { background: #1a1a2e; color: white; padding: 6px 10px; font-weight: 600; font-size: 11px; }' +
'        .section-content { padding: 10px; }' +
'        table { width: 100%; border-collapse: collapse; font-size: 10px; }' +
'        th, td { padding: 5px 8px; text-align: right; border: 1px solid #eee; }' +
'        th { background: #f5f5f5; font-weight: 600; }' +
'        .number { text-align: left; direction: ltr; }' +
'        .total-row { background: #f0f0f0; font-weight: 600; }' +
'        .print-btn { background: #1a1a2e; color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 4px; margin-bottom: 20px; font-size: 14px; }' +
'        .print-btn:hover { background: #333; }' +
'        .footer { margin-top: 20px; padding-top: 12px; border-top: 1px solid #ddd; font-size: 9px; color: #666; text-align: center; }' +
'        @media print { .print-btn { display: none; } body { padding: 0; background: white; } .payslip { border: none; box-shadow: none; } }' +
'    </style>' +
'</head>' +
'<body>' +
'    <button class="print-btn" onclick="window.print()">🖨️ הדפס תלוש</button>' +
'    <div class="payslip">' +
'        <div class="header">' +
'            <div class="company-info">' +
'                <div class="company-name">' + companyName + '</div>' +
'                <div class="payslip-title">תלוש שכר לחודש: ' + periodHe + '</div>' +
'            </div>' +
'            <div class="employee-box">' +
'                <div class="employee-name">' + payslip.employeeName + '</div>' +
'                <div class="employee-details">' + (emp ? emp.address || '' : '') + '</div>' +
'                <div class="employee-details">ת.ז: ' + payslip.employeeIdNumber + '</div>' +
'            </div>' +
'        </div>' +
'        <div class="summary-box">' +
'            <div style="font-weight: 700; margin-bottom: 10px; font-size: 12px;">ריכוז הנתונים בתלוש שכר זה</div>' +
'            <div class="summary-grid">' +
'                <div class="summary-item"><span class="summary-label">סה"כ תשלומים</span><span class="summary-value">' + payslip.totalGross.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span></div>' +
'                <div class="summary-item"><span class="summary-label">ניכויי חובה מיסים</span><span class="summary-value">' + (payslip.totalTaxDeductions || (payslip.incomeTax + payslip.nationalIns + payslip.healthIns)).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span></div>' +
'                <div class="summary-item"><span class="summary-label">ניכויים קופות גמל</span><span class="summary-value">' + (payslip.totalPensionDeductions || (payslip.pensionEmp + payslip.studyFund)).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span></div>' +
'                <div class="summary-item"><span class="summary-label">ניכויים שונים</span><span class="summary-value">' + (payslip.otherDeduct || 0).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span></div>' +
'            </div>' +
'            <div class="net-pay"><span>נטו לתשלום</span><span class="amount">₪ ' + payslip.netPay.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</span></div>' +
'        </div>' +
'        <div class="main-grid">' +
'            <div>' +
'                <div class="section"><div class="section-title">פרטי חשבון הבנק</div><div class="section-content"><table><tr><th>בנק</th><th>סניף</th><th>מספר חשבון</th></tr><tr><td>' + (payslip.bankCode || '11') + '</td><td>' + (payslip.bankBranch || '96') + '</td><td>' + (payslip.bankAccount || '') + '</td></tr></table></div></div>' +
'                <div class="section"><div class="section-title">תעריפים</div><div class="section-content"><table><tr><th>תאור</th><th>סכום בש"ח</th></tr><tr><td>תעריף יום</td><td class="number">' + dailyRate.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr><td>תעריף שעה</td><td class="number">' + hourlyRate.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr><td>שכר בסיס</td><td class="number">' + payslip.baseSalary.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr></table></div></div>' +
'                <div class="section"><div class="section-title">נתונים אישיים</div><div class="section-content"><table><tr><td>מספר עובד</td><td>' + payslip.employeeIdNumber + '</td></tr><tr><td>מספר זהות</td><td>' + payslip.employeeIdNumber + '</td></tr><tr><td>מצב משפחתי</td><td>' + (emp ? emp.maritalStatus || '-' : '-') + '</td></tr><tr><td>תאריך לידה</td><td>' + (emp ? emp.birthDate || '-' : '-') + '</td></tr><tr><td>ילדים עד גיל 19</td><td>' + (emp ? emp.children || '0' : '0') + '</td></tr><tr><td>קופת חולים</td><td>' + (emp ? emp.healthFund || '-' : '-') + '</td></tr><tr><td>התחלת עבודה</td><td>' + (emp ? emp.startDate || '-' : '-') + '</td></tr><tr><td>אחוז משרה</td><td>' + (emp ? emp.positionPercent || '100' : '100') + '</td></tr></table></div></div>' +
'                <div class="section"><div class="section-title">נתונים מצטברים</div><div class="section-content"><table><tr><th>פרטים</th><th>סכום בש"ח</th></tr><tr><td>ברוטו למס הכנסה</td><td class="number">' + (payslip.cumGrossIncome || 0).toLocaleString() + '</td></tr><tr><td>ברוטו לביטוח לאומי</td><td class="number">' + (payslip.cumNationalIns || 0).toLocaleString() + '</td></tr><tr><td>ניכוי למס הכנסה</td><td class="number">' + (payslip.cumIncomeTax || 0).toLocaleString() + '</td></tr><tr><td>ניכוי לביטוח לאומי</td><td class="number">' + (payslip.cumNationalInsDeduction || 0).toLocaleString() + '</td></tr><tr><td>ביטוח בריאות</td><td class="number">' + (payslip.cumHealthIns || 0).toLocaleString() + '</td></tr></table></div></div>' +
'            </div>' +
'            <div>' +
'                <div class="section"><div class="section-title">פרוט התשלומים</div><div class="section-content"><table><tr><th>סמל</th><th>תאור</th><th>קוד</th><th>כמות</th><th>תעריף</th><th>סכום</th></tr><tr><td>1</td><td>משכורת</td><td></td><td></td><td></td><td class="number">' + payslip.baseSalary.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr>' + (payslip.travel > 0 ? '<tr><td>15</td><td>נסיעות</td><td>ק</td><td>1.00</td><td>' + payslip.travel.toFixed(2) + '</td><td class="number">' + payslip.travel.toFixed(2) + '</td></tr>' : '') + '<tr class="total-row"><td colspan="5">סה"כ תשלומים</td><td class="number">' + payslip.totalGross.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr></table></div></div>' +
'                <div class="section"><div class="section-title">ניכויי חובה / קופות גמל</div><div class="section-content"><table><tr><th>סמל</th><th>תאור</th><th>מספר חשבון</th><th>סכום</th></tr><tr><td></td><td>מס הכנסה</td><td></td><td class="number">' + payslip.incomeTax.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr><td></td><td>ביטוח לאומי</td><td></td><td class="number">' + payslip.nationalIns.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr><td></td><td>ביטוח בריאות</td><td></td><td class="number">' + payslip.healthIns.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr class="total-row"><td colspan="3">סה"כ ניכויי חובה</td><td class="number">' + (payslip.incomeTax + payslip.nationalIns + payslip.healthIns).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr></table><div style="margin-top: 10px; font-weight: 600; font-size: 10px;">ניכויים והפרשות לקופות גמל</div><table style="margin-top: 5px;"><tr><td>14</td><td>פניקס פנסיה</td><td></td><td class="number">' + (payslip.pensionPhoenix || 1240.70).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr><td>16</td><td>כלל קצבה</td><td></td><td class="number">' + (payslip.pensionClal || 859.30).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr><td>32</td><td>מגור השתלמות</td><td></td><td class="number">' + payslip.studyFund.toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr><tr class="total-row"><td colspan="3">סה"כ קופות גמל</td><td class="number">' + (payslip.totalPensionDeductions || (payslip.pensionEmp + payslip.studyFund)).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</td></tr></table></div></div>' +
'                <div class="section"><div class="section-title">נתוני העדרויות</div><div class="section-content"><table><tr><th>תאור</th><th>מכסה שנתית</th><th>יתרה קודמת</th><th>ניצול חודשי</th><th>יתרה</th></tr><tr><td>חופשה</td><td>' + (payslip.vacationQuota || 12) + '</td><td>' + (payslip.vacationPrev || 7).toFixed(2) + '</td><td>' + (payslip.vacationUsed || 1).toFixed(2) + '</td><td>' + (payslip.vacationBalance || 8).toFixed(2) + '</td></tr><tr><td>מחלה</td><td>' + (payslip.sickQuota || 18) + '</td><td>' + (payslip.sickPrev || 38).toFixed(2) + '</td><td>' + (payslip.sickUsed || 1.5).toFixed(2) + '</td><td>' + (payslip.sickBalance || 39.5).toFixed(2) + '</td></tr><tr><td>הבראה</td><td>' + (payslip.recuperationQuota || 6) + '</td><td>' + (payslip.recuperationPrev || 2.5).toFixed(2) + '</td><td>' + (payslip.recuperationUsed || 0.5).toFixed(2) + '</td><td>' + (payslip.recuperationBalance || 3).toFixed(2) + '</td></tr></table></div></div>' +
'            </div>' +
'        </div>' +
'        <div class="footer">' +
'            <div>עיבוד והפקה - ' + companyName + '</div>' +
'            <div style="margin-top: 5px;">בהתאם לחוק הגנת השכר התשי"ח - 1958 | עמוד 1 מתוך 1</div>' +
'        </div>' +
'    </div>' +
'</body>' +
'</html>';

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        }

        function sendPayslipEmail(id) {
            const ps = payslips.find(p => p.id === id);
            const emp = employees.find(e => e.id === ps.employeeId);

            if (!emp || !emp.email) {
                showToast('Employee email not found', 'error');
                return;
            }

            // Open mail client with pre-filled email
            const subject = encodeURIComponent('תלוש שכר - ' + formatPayPeriod(ps.period));
            const body = encodeURIComponent('שלום ' + ps.employeeName + ',\n\nמצורף תלוש השכר לחודש ' + formatPayPeriod(ps.period) + '.\n\nסכום נטו לתשלום: ₪' + ps.netPay.toLocaleString() + '\n\nבברכה,\nDrishti Consulting');

            window.open('mailto:' + emp.email + '?subject=' + subject + '&body=' + body);

            // Update status
            ps.status = 'sent';
            saveData();
            renderPayslips();
            showToast('Email opened - payslip marked as sent');
        }

        // Initialize payslip section
        function initPayslips() {
            renderEmployees();
            renderPayslips();
            updatePayslipStats();
        }

        // ========== ENHANCED EXPENSES MODULE ==========

        function calculateExpenseVAT() {
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const vat = amount * 0.17 / 1.17; // Extract VAT from total
            document.getElementById('expenseVAT').value = vat.toFixed(2);
        }

        function toggleRecurringOptions() {
            const recurring = document.getElementById('expenseRecurring').checked;
            document.getElementById('recurringOptions').style.display = recurring ? 'block' : 'none';
        }

        function previewReceipt(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('receiptPreview').style.display = 'block';
                    document.getElementById('receiptImage').src = e.target.result;
                    document.getElementById('receiptStatus').textContent = file.name;
                };
                reader.readAsDataURL(file);
            }
        }

        function populateExpenseDropdowns() {
            // Populate vendors
            const vendorSelect = document.getElementById('expenseVendor');
            vendorSelect.innerHTML = '<option value="">Select or add vendor...</option>' +
                '<option value="__new__">+ Add New Vendor</option>' +
                vendors.map(v => `<option value="${v.id}">${v.name}</option>`).join('');

            // Populate projects
            const projectSelect = document.getElementById('expenseProject');
            if (projectSelect) {
                projectSelect.innerHTML = '<option value="">No project linked</option>' +
                    projects.filter(p => p.status === 'active').map(p =>
                        `<option value="${p.id}">${p.name} (${p.clientName})</option>`
                    ).join('');
            }
        }

        // ========== TIME TRACKING MODULE ==========

        function startTimer() {
            timerStartTime = Date.now();
            timerElapsed = 0;
            document.getElementById('runningTimer').style.display = 'flex';
            document.getElementById('startTimerBtn').style.display = 'none';
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function updateTimerDisplay() {
            timerElapsed = Date.now() - timerStartTime;
            const hours = Math.floor(timerElapsed / 3600000);
            const minutes = Math.floor((timerElapsed % 3600000) / 60000);
            const seconds = Math.floor((timerElapsed % 60000) / 1000);
            document.getElementById('timerDisplay').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopTimer() {
            clearInterval(timerInterval);
            const hours = timerElapsed / 3600000;
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            document.getElementById('timerDurationDisplay').textContent = `${h}h ${m}m`;
            populateTimerProjectSelect();
            openModal('stopTimer');
        }

        function discardTimer() {
            clearInterval(timerInterval);
            document.getElementById('runningTimer').style.display = 'none';
            document.getElementById('startTimerBtn').style.display = 'inline-flex';
            timerStartTime = null;
            timerElapsed = 0;
            closeModal('stopTimer');
        }

        function populateTimerProjectSelect() {
            const select = document.getElementById('timerProject');
            select.innerHTML = '<option value="">Select project...</option>' +
                projects.filter(p => p.status === 'active').map(p =>
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
        }

        document.getElementById('stopTimerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const hours = Math.round((timerElapsed / 3600000) * 4) / 4; // Round to nearest 0.25
            const projectId = parseInt(document.getElementById('timerProject').value);
            const project = projects.find(p => p.id === projectId);

            const entry = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                projectId: projectId,
                projectName: project ? project.name : 'Unknown',
                clientId: project ? project.clientId : null,
                description: document.getElementById('timerDescription').value,
                hours: Math.max(0.25, hours),
                billable: document.getElementById('timerBillable').checked,
                rate: project ? (project.budget / project.totalHours) : 150,
                created: new Date().toISOString()
            };

            timeEntries.push(entry);
            saveData();
            renderTimeEntries();
            updateTimeStats();
            discardTimer();
            showToast('Time entry saved');
        });

        function renderTimeEntries() {
            const tbody = document.getElementById('timeEntriesTable');
            const sorted = [...timeEntries].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">No time entries yet</td></tr>';
                return;
            }

            tbody.innerHTML = sorted.map(entry => `
                <tr>
                    <td>${new Date(entry.date).toLocaleDateString('he-IL')}</td>
                    <td>${entry.projectName}</td>
                    <td>${entry.description}</td>
                    <td>${entry.hours}h</td>
                    <td>${entry.billable ? '<span style="color: var(--success);">Yes</span>' : '<span style="color: var(--gray);">No</span>'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editTimeEntry(${entry.id})" style="padding: 4px 8px;">Edit</button>
                        <button class="btn btn-danger" onclick="deleteTimeEntry(${entry.id})" style="padding: 4px 8px;">Delete</button>
                    </td>
                </tr>
            `).join('');

            renderTimeByProject();
            renderWeeklyTimesheet();
        }

        function renderTimeByProject() {
            const container = document.getElementById('timeByProject');
            const byProject = {};
            timeEntries.forEach(e => {
                if (!byProject[e.projectName]) byProject[e.projectName] = 0;
                byProject[e.projectName] += e.hours;
            });

            const total = Object.values(byProject).reduce((a, b) => a + b, 0);
            if (total === 0) {
                container.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No time entries yet</div>';
                return;
            }

            container.innerHTML = Object.entries(byProject)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, hours]) => {
                    const pct = (hours / total * 100).toFixed(0);
                    return `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px;">
                                <span>${name}</span>
                                <span>${hours}h (${pct}%)</span>
                            </div>
                            <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: var(--primary); width: ${pct}%;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderWeeklyTimesheet() {
            const container = document.getElementById('weeklyTimesheet');
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());

            const days = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                days.push(d.toISOString().split('T')[0]);
            }

            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const hoursPerDay = days.map(day =>
                timeEntries.filter(e => e.date === day).reduce((sum, e) => sum + e.hours, 0)
            );

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between;">
                    ${days.map((day, i) => `
                        <div style="text-align: center; flex: 1;">
                            <div style="font-size: 10px; color: var(--gray);">${dayNames[i]}</div>
                            <div style="font-size: 16px; font-weight: 600; ${hoursPerDay[i] > 0 ? 'color: var(--primary);' : ''}">${hoursPerDay[i] || '-'}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between;">
                    <span style="color: var(--gray); font-size: 11px;">Week Total</span>
                    <span style="font-weight: 600;">${hoursPerDay.reduce((a, b) => a + b, 0)}h</span>
                </div>
            `;
        }

        function updateTimeStats() {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const todayHours = timeEntries.filter(e => e.date === today).reduce((s, e) => s + e.hours, 0);
            const weekHours = timeEntries.filter(e => new Date(e.date) >= startOfWeek).reduce((s, e) => s + e.hours, 0);
            const monthHours = timeEntries.filter(e => new Date(e.date) >= startOfMonth).reduce((s, e) => s + e.hours, 0);
            const billableHours = timeEntries.filter(e => e.billable).reduce((s, e) => s + e.hours, 0);
            const totalHours = timeEntries.reduce((s, e) => s + e.hours, 0);

            document.getElementById('timeToday').textContent = todayHours + 'h';
            document.getElementById('timeWeek').textContent = weekHours + 'h';
            document.getElementById('timeMonth').textContent = monthHours + 'h';
            document.getElementById('billablePercent').textContent = totalHours > 0 ? Math.round(billableHours / totalHours * 100) + '%' : '0%';
        }

        function editTimeEntry(id) {
            const entry = timeEntries.find(e => e.id === id);
            if (!entry) return;
            document.getElementById('editingTimeEntryId').value = id;
            document.getElementById('timeEntryModalTitle').textContent = 'Edit Time Entry';
            populateTimeProjectSelect();
            document.getElementById('timeProject').value = entry.projectId;
            document.getElementById('timeDate').value = entry.date;
            document.getElementById('timeHours').value = entry.hours;
            document.getElementById('timeDescription').value = entry.description;
            document.getElementById('timeBillable').checked = entry.billable;
            openModal('newTimeEntry');
        }

        function deleteTimeEntry(id) {
            if (!confirm('Delete this time entry?')) return;
            timeEntries = timeEntries.filter(e => e.id !== id);
            saveData();
            renderTimeEntries();
            updateTimeStats();
            showToast('Time entry deleted');
        }

        function populateTimeProjectSelect() {
            const select = document.getElementById('timeProject');
            select.innerHTML = '<option value="">Select project...</option>' +
                projects.filter(p => p.status === 'active').map(p =>
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
        }

        document.getElementById('newTimeEntryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const editId = document.getElementById('editingTimeEntryId').value;
            const projectId = parseInt(document.getElementById('timeProject').value);
            const project = projects.find(p => p.id === projectId);

            const entry = {
                id: editId ? parseInt(editId) : Date.now(),
                date: document.getElementById('timeDate').value,
                projectId: projectId,
                projectName: project ? project.name : 'Unknown',
                clientId: project ? project.clientId : null,
                description: document.getElementById('timeDescription').value,
                hours: parseFloat(document.getElementById('timeHours').value),
                billable: document.getElementById('timeBillable').checked,
                rate: parseFloat(document.getElementById('timeRate').value) || (project ? (project.budget / project.totalHours) : 150),
                created: new Date().toISOString()
            };

            if (editId) {
                const idx = timeEntries.findIndex(e => e.id === parseInt(editId));
                if (idx !== -1) timeEntries[idx] = entry;
            } else {
                timeEntries.push(entry);
            }

            saveData();
            renderTimeEntries();
            updateTimeStats();
            closeModal('newTimeEntry');
            document.getElementById('newTimeEntryForm').reset();
            document.getElementById('editingTimeEntryId').value = '';
            document.getElementById('timeEntryModalTitle').textContent = 'Log Time';
            showToast(editId ? 'Time entry updated' : 'Time entry added');
        });

        // ========== TASKS MODULE ==========

        function renderTasks() {
            const filter = document.getElementById('taskFilterStatus').value;
            let filtered = tasks;
            if (filter) {
                filtered = tasks.filter(t => t.status === filter);
            }

            // Render kanban columns
            const todo = filtered.filter(t => t.status === 'todo');
            const inProgress = filtered.filter(t => t.status === 'in_progress');
            const done = filtered.filter(t => t.status === 'done');

            document.getElementById('todoCount').textContent = todo.length;
            document.getElementById('inProgressCount').textContent = inProgress.length;
            document.getElementById('doneCount').textContent = done.length;

            document.getElementById('tasksTodo').innerHTML = todo.length ? todo.map(t => renderTaskCard(t)).join('') : '<div style="color: var(--gray); font-size: 12px;">No tasks</div>';
            document.getElementById('tasksInProgressList').innerHTML = inProgress.length ? inProgress.map(t => renderTaskCard(t)).join('') : '<div style="color: var(--gray); font-size: 12px;">No tasks</div>';
            document.getElementById('tasksDoneList').innerHTML = done.length ? done.map(t => renderTaskCard(t)).join('') : '<div style="color: var(--gray); font-size: 12px;">No tasks</div>';

            updateTaskStats();
            renderUpcomingFollowups();
        }

        function renderTaskCard(task) {
            const priorityColors = { low: 'var(--gray)', medium: 'var(--secondary)', high: 'var(--warning)', urgent: 'var(--danger)' };
            const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'done';
            const project = task.projectId ? projects.find(p => p.id === task.projectId) : null;
            const isGeneral = !task.clientId && !task.projectId;

            return `
                <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 3px solid ${priorityColors[task.priority]};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="font-weight: 500; font-size: 12px;">${task.title}</div>
                        <div style="display: flex; gap: 4px;">
                            ${task.status !== 'done' ? `<button onclick="moveTask(${task.id}, 'next')" style="background: none; border: none; color: var(--success); cursor: pointer; font-size: 14px;">→</button>` : ''}
                            <button onclick="editTask(${task.id})" style="background: none; border: none; color: var(--gray); cursor: pointer;">✎</button>
                            <button onclick="deleteTask(${task.id})" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 12px;">×</button>
                        </div>
                    </div>
                    ${task.dueDate ? `<div style="font-size: 10px; margin-top: 6px; color: ${isOverdue ? 'var(--danger)' : 'var(--gray)'};">${isOverdue ? '⚠️ Overdue: ' : 'Due: '}${new Date(task.dueDate).toLocaleDateString('he-IL')}</div>` : ''}
                    ${project ? `<div style="font-size: 10px; color: var(--primary); margin-top: 4px;">📁 ${project.projectNumber || project.name}</div>` : ''}
                    ${task.clientName ? `<div style="font-size: 10px; color: var(--secondary); margin-top: 4px;">🏢 ${task.clientName}</div>` : ''}
                    ${isGeneral ? `<div style="font-size: 10px; color: var(--gray); margin-top: 4px; font-style: italic;">📌 General Task</div>` : ''}
                </div>
            `;
        }

        function moveTask(id, direction) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            const flow = ['todo', 'in_progress', 'done'];
            const currentIdx = flow.indexOf(task.status);
            if (direction === 'next' && currentIdx < flow.length - 1) {
                task.status = flow[currentIdx + 1];
                if (task.status === 'done') task.completedDate = new Date().toISOString();
            }
            saveData();
            renderTasks();
        }

        function deleteTask(id) {
            if (confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                saveData();
                renderTasks();
                showToast('Task deleted');
            }
        }

        function updateTaskStats() {
            const today = new Date().toISOString().split('T')[0];
            const overdue = tasks.filter(t => t.dueDate && t.dueDate < today && t.status !== 'done').length;
            const dueToday = tasks.filter(t => t.dueDate === today && t.status !== 'done').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const completed = tasks.filter(t => t.status === 'done').length;

            document.getElementById('tasksOverdue').textContent = overdue;
            document.getElementById('tasksDueToday').textContent = dueToday;
            document.getElementById('tasksInProgress').textContent = inProgress;
            document.getElementById('tasksCompleted').textContent = completed;
        }

        function renderUpcomingFollowups() {
            const container = document.getElementById('upcomingFollowups');
            const followups = tasks.filter(t => t.isFollowup && t.status !== 'done')
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                .slice(0, 5);

            if (followups.length === 0) {
                container.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No follow-ups scheduled</div>';
                return;
            }

            container.innerHTML = followups.map(t => `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div>
                        <div style="font-size: 12px;">${t.title}</div>
                        <div style="font-size: 10px; color: var(--gray);">${t.clientName || 'No client'}</div>
                    </div>
                    <div style="font-size: 11px; color: var(--warning);">${t.dueDate ? new Date(t.dueDate).toLocaleDateString('he-IL') : 'No date'}</div>
                </div>
            `).join('');
        }

        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            document.getElementById('editingTaskId').value = id;
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskPriority').value = task.priority;
            document.getElementById('taskDueDate').value = task.dueDate || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskIsFollowup').checked = task.isFollowup;
            populateTaskDropdowns();
            document.getElementById('taskClient').value = task.clientId || '';
            document.getElementById('taskProject').value = task.projectId || '';
            openModal('newTask');
        }

        function populateTaskDropdowns() {
            document.getElementById('taskClient').innerHTML = '<option value="">No client</option>' +
                clients.map(c => `<option value="${c.id}">${c.company || (c.firstName + ' ' + c.lastName)}</option>`).join('');
            document.getElementById('taskProject').innerHTML = '<option value="">No project</option>' +
                projects.filter(p => p.status === 'active').map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        document.getElementById('newTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const editId = document.getElementById('editingTaskId').value;
            const clientId = document.getElementById('taskClient').value;
            const client = clientId ? clients.find(c => c.id === parseInt(clientId)) : null;

            const task = {
                id: editId ? parseInt(editId) : Date.now(),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                priority: document.getElementById('taskPriority').value,
                dueDate: document.getElementById('taskDueDate').value || null,
                clientId: clientId ? parseInt(clientId) : null,
                clientName: client ? (client.company || client.firstName + ' ' + client.lastName) : null,
                projectId: document.getElementById('taskProject').value ? parseInt(document.getElementById('taskProject').value) : null,
                isFollowup: document.getElementById('taskIsFollowup').checked,
                reminder: document.getElementById('taskReminder').value,
                status: editId ? tasks.find(t => t.id === parseInt(editId))?.status || 'todo' : 'todo',
                created: new Date().toISOString()
            };

            if (editId) {
                const idx = tasks.findIndex(t => t.id === parseInt(editId));
                if (idx !== -1) tasks[idx] = task;
            } else {
                tasks.push(task);
            }

            saveData();
            renderTasks();
            closeModal('newTask');
            document.getElementById('newTaskForm').reset();
            document.getElementById('editingTaskId').value = '';
            document.getElementById('taskModalTitle').textContent = 'Add Task';
            showToast(editId ? 'Task updated' : 'Task added');
        });

        // ========== QUOTES MODULE ==========

        let quoteLineItemCount = 0;

        function addQuoteLineItem() {
            const container = document.getElementById('quoteLineItems');
            const id = quoteLineItemCount++;
            const html = `
                <div id="lineItem-${id}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center;">
                    <input type="text" placeholder="Description" class="line-desc" style="padding: 6px; font-size: 11px;">
                    <input type="number" placeholder="Qty" class="line-qty" value="1" min="1" oninput="calculateQuoteTotals()" style="padding: 6px; font-size: 11px;">
                    <input type="number" placeholder="Rate (₪)" class="line-rate" oninput="calculateQuoteTotals()" style="padding: 6px; font-size: 11px;">
                    <div class="line-total" style="font-weight: 600; text-align: right;">₪0</div>
                    <button type="button" onclick="removeQuoteLineItem(${id})" style="background: var(--danger); color: white; border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer;">×</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeQuoteLineItem(id) {
            document.getElementById(`lineItem-${id}`).remove();
            calculateQuoteTotals();
        }

        function calculateQuoteTotals() {
            const items = document.querySelectorAll('#quoteLineItems > div');
            let subtotal = 0;
            items.forEach(item => {
                const qty = parseFloat(item.querySelector('.line-qty')?.value) || 0;
                const rate = parseFloat(item.querySelector('.line-rate')?.value) || 0;
                const total = qty * rate;
                const totalEl = item.querySelector('.line-total');
                if (totalEl) totalEl.textContent = '₪' + total.toLocaleString();
                subtotal += total;
            });

            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const discountedSubtotal = subtotal * (1 - discount / 100);
            const includeVAT = document.getElementById('quoteIncludeVAT').checked;
            const vat = includeVAT ? discountedSubtotal * 0.17 : 0;
            const total = discountedSubtotal + vat;

            document.getElementById('quoteSubtotal').textContent = '₪' + discountedSubtotal.toLocaleString();
            document.getElementById('quoteVAT').textContent = '₪' + vat.toLocaleString();
            document.getElementById('quoteTotal').textContent = '₪' + total.toLocaleString();
        }

        function renderQuotes() {
            const filter = document.getElementById('quoteFilterStatus').value;
            let filtered = quotes;
            if (filter) filtered = quotes.filter(q => q.status === filter);

            // Check for expired quotes
            const today = new Date().toISOString().split('T')[0];
            quotes.forEach(q => {
                if (q.validUntil < today && q.status === 'sent') q.status = 'expired';
            });

            const tbody = document.getElementById('quotesTable');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--gray);">No quotes yet</td></tr>';
            } else {
                tbody.innerHTML = filtered.sort((a, b) => new Date(b.created) - new Date(a.created)).map(q => {
                    const statusColors = { draft: 'var(--gray)', sent: 'var(--secondary)', accepted: 'var(--success)', rejected: 'var(--danger)', expired: 'var(--warning)' };
                    return `
                        <tr>
                            <td>${q.number}</td>
                            <td>${q.clientName}</td>
                            <td>${q.title}</td>
                            <td>₪${q.total.toLocaleString()}</td>
                            <td>${new Date(q.validUntil).toLocaleDateString('he-IL')}</td>
                            <td><span style="color: ${statusColors[q.status]}; text-transform: capitalize;">${q.status}</span></td>
                            <td>
                                ${q.status === 'sent' || q.status === 'accepted' ? `<button class="btn btn-success" onclick="convertQuoteToProposal(${q.id})" style="padding: 4px 8px; font-size: 10px;">→ Proposal</button>` : ''}
                                <button class="btn btn-secondary" onclick="editQuote(${q.id})" style="padding: 4px 8px;">Edit</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateQuoteStats();
        }

        function updateQuoteStats() {
            document.getElementById('quotesDraft').textContent = quotes.filter(q => q.status === 'draft').length;
            document.getElementById('quotesSent').textContent = quotes.filter(q => q.status === 'sent').length;
            document.getElementById('quotesAccepted').textContent = quotes.filter(q => q.status === 'accepted').length;
            const totalValue = quotes.filter(q => q.status === 'accepted').reduce((s, q) => s + q.total, 0);
            document.getElementById('quotesTotal').textContent = '₪' + totalValue.toLocaleString();
        }

        function populateQuoteDropdowns() {
            document.getElementById('quoteClient').innerHTML = '<option value="">Select client...</option>' +
                clients.map(c => `<option value="${c.id}">${c.company || (c.firstName + ' ' + c.lastName)}</option>`).join('');
            // Set default validity (30 days)
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            document.getElementById('quoteValidUntil').value = defaultDate.toISOString().split('T')[0];
        }

        function editQuote(id) {
            const quote = quotes.find(q => q.id === id);
            if (!quote) return;
            document.getElementById('editingQuoteId').value = id;
            document.getElementById('quoteModalTitle').textContent = 'Edit Quote';
            populateQuoteDropdowns();
            document.getElementById('quoteClient').value = quote.clientId;
            document.getElementById('quoteTitle').value = quote.title;
            document.getElementById('quoteValidUntil').value = quote.validUntil;
            document.getElementById('quoteDiscount').value = quote.discount || 0;
            document.getElementById('quoteNotes').value = quote.notes || '';
            // Rebuild line items
            document.getElementById('quoteLineItems').innerHTML = '';
            quoteLineItemCount = 0;
            quote.lineItems.forEach(item => {
                addQuoteLineItem();
                const lastItem = document.getElementById('quoteLineItems').lastElementChild;
                lastItem.querySelector('.line-desc').value = item.description;
                lastItem.querySelector('.line-qty').value = item.quantity;
                lastItem.querySelector('.line-rate').value = item.rate;
            });
            calculateQuoteTotals();
            openModal('newQuote');
        }

        function convertQuoteToProposal(id) {
            const quote = quotes.find(q => q.id === id);
            if (!quote) return;
            // This would open the proposal modal pre-filled with quote data
            showToast('Feature coming soon: Convert to proposal');
        }

        document.getElementById('newQuoteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const editId = document.getElementById('editingQuoteId').value;
            const clientId = parseInt(document.getElementById('quoteClient').value);
            const client = clients.find(c => c.id === clientId);

            // Gather line items
            const lineItems = [];
            document.querySelectorAll('#quoteLineItems > div').forEach(item => {
                lineItems.push({
                    description: item.querySelector('.line-desc').value,
                    quantity: parseFloat(item.querySelector('.line-qty').value) || 1,
                    rate: parseFloat(item.querySelector('.line-rate').value) || 0
                });
            });

            const subtotal = lineItems.reduce((s, i) => s + (i.quantity * i.rate), 0);
            const discount = parseFloat(document.getElementById('quoteDiscount').value) || 0;
            const discountedSubtotal = subtotal * (1 - discount / 100);
            const includeVAT = document.getElementById('quoteIncludeVAT').checked;
            const vat = includeVAT ? discountedSubtotal * 0.17 : 0;
            const total = discountedSubtotal + vat;

            const quote = {
                id: editId ? parseInt(editId) : Date.now(),
                number: editId ? quotes.find(q => q.id === parseInt(editId))?.number : `QT-${new Date().getFullYear()}-${String(quotes.length + 1).padStart(3, '0')}`,
                clientId: clientId,
                clientName: client ? (client.company || client.firstName + ' ' + client.lastName) : 'Unknown',
                title: document.getElementById('quoteTitle').value,
                validUntil: document.getElementById('quoteValidUntil').value,
                lineItems: lineItems,
                subtotal: discountedSubtotal,
                vat: vat,
                total: total,
                discount: discount,
                notes: document.getElementById('quoteNotes').value,
                status: editId ? quotes.find(q => q.id === parseInt(editId))?.status || 'draft' : 'draft',
                created: new Date().toISOString()
            };

            if (editId) {
                const idx = quotes.findIndex(q => q.id === parseInt(editId));
                if (idx !== -1) quotes[idx] = quote;
            } else {
                quotes.push(quote);
            }

            saveData();
            renderQuotes();
            closeModal('newQuote');
            document.getElementById('newQuoteForm').reset();
            document.getElementById('quoteLineItems').innerHTML = '';
            document.getElementById('editingQuoteId').value = '';
            document.getElementById('quoteModalTitle').textContent = 'Create Quote';
            showToast(editId ? 'Quote updated' : 'Quote created');
        });

        // ========== DOCUMENTS MODULE ==========

        function toggleContractFields() {
            const type = document.getElementById('documentType').value;
            document.getElementById('contractFields').style.display = type === 'contract' ? 'block' : 'none';
        }

        function previewDocument(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('documentPreview').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            }
        }

        function renderDocuments() {
            const filter = document.getElementById('docFilterType').value;
            let filtered = documents;
            if (filter) filtered = documents.filter(d => d.type === filter);

            const tbody = document.getElementById('documentsTable');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--gray);">No documents yet</td></tr>';
            } else {
                tbody.innerHTML = filtered.sort((a, b) => new Date(b.created) - new Date(a.created)).map(d => {
                    const typeColors = { contract: 'var(--primary)', proposal: 'var(--secondary)', invoice: 'var(--success)', receipt: 'var(--warning)', other: 'var(--gray)' };
                    return `
                        <tr>
                            <td>${d.name}</td>
                            <td><span style="color: ${typeColors[d.type]}; text-transform: capitalize;">${d.type}</span></td>
                            <td>${d.clientName || '-'}</td>
                            <td>${new Date(d.created).toLocaleDateString('he-IL')}</td>
                            <td>${d.endDate ? new Date(d.endDate).toLocaleDateString('he-IL') : '-'}</td>
                            <td>
                                ${d.fileData ? `<button class="btn btn-secondary" onclick="viewDocument(${d.id})" style="padding: 4px 8px;">View</button>` : ''}
                                <button class="btn btn-danger" onclick="deleteDocument(${d.id})" style="padding: 4px 8px;">Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateDocumentStats();
            renderContractRenewals();
            renderRecentDocuments();
        }

        function updateDocumentStats() {
            document.getElementById('docsTotal').textContent = documents.length;
            const activeContracts = documents.filter(d => d.type === 'contract' && (!d.endDate || new Date(d.endDate) > new Date())).length;
            document.getElementById('docsContracts').textContent = activeContracts;
            const thirtyDays = new Date();
            thirtyDays.setDate(thirtyDays.getDate() + 30);
            const expiring = documents.filter(d => d.type === 'contract' && d.endDate && new Date(d.endDate) <= thirtyDays && new Date(d.endDate) > new Date()).length;
            document.getElementById('docsExpiring').textContent = expiring;
            // Estimate storage (rough calculation based on file data length)
            const storageBytes = documents.reduce((s, d) => s + (d.fileData?.length || 0), 0);
            document.getElementById('docsStorage').textContent = (storageBytes / 1024 / 1024).toFixed(1) + ' MB';
        }

        function renderContractRenewals() {
            const container = document.getElementById('contractRenewals');
            const today = new Date();
            const sixtyDays = new Date();
            sixtyDays.setDate(today.getDate() + 60);
            const expiring = documents.filter(d => d.type === 'contract' && d.endDate && new Date(d.endDate) <= sixtyDays && new Date(d.endDate) > today)
                .sort((a, b) => new Date(a.endDate) - new Date(b.endDate));

            if (expiring.length === 0) {
                container.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No contracts expiring soon</div>';
                return;
            }

            container.innerHTML = expiring.map(d => `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div>
                        <div style="font-size: 12px;">${d.name}</div>
                        <div style="font-size: 10px; color: var(--gray);">${d.clientName}</div>
                    </div>
                    <div style="font-size: 11px; color: var(--warning);">Expires: ${new Date(d.endDate).toLocaleDateString('he-IL')}</div>
                </div>
            `).join('');
        }

        function renderRecentDocuments() {
            const container = document.getElementById('recentDocuments');
            const recent = [...documents].sort((a, b) => new Date(b.created) - new Date(a.created)).slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No documents yet</div>';
                return;
            }

            container.innerHTML = recent.map(d => `
                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 12px;">${d.name}</div>
                    <div style="font-size: 10px; color: var(--gray);">${d.type}</div>
                </div>
            `).join('');
        }

        function viewDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (doc && doc.fileData) {
                const win = window.open();
                win.document.write(`<iframe src="${doc.fileData}" style="width:100%;height:100%;border:none;"></iframe>`);
            }
        }

        function deleteDocument(id) {
            if (!confirm('Delete this document?')) return;
            documents = documents.filter(d => d.id !== id);
            saveData();
            renderDocuments();
            showToast('Document deleted');
        }

        function populateDocumentDropdowns() {
            document.getElementById('documentClient').innerHTML = '<option value="">No client</option>' +
                clients.map(c => `<option value="${c.id}">${c.company || (c.firstName + ' ' + c.lastName)}</option>`).join('');
        }

        document.getElementById('newDocumentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('documentFile');
            const file = fileInput.files[0];
            const clientId = document.getElementById('documentClient').value;
            const client = clientId ? clients.find(c => c.id === parseInt(clientId)) : null;

            const processDocument = (fileData) => {
                const doc = {
                    id: Date.now(),
                    name: document.getElementById('documentName').value,
                    type: document.getElementById('documentType').value,
                    clientId: clientId ? parseInt(clientId) : null,
                    clientName: client ? (client.company || client.firstName + ' ' + client.lastName) : null,
                    contractValue: parseFloat(document.getElementById('documentContractValue').value) || null,
                    startDate: document.getElementById('documentStartDate').value || null,
                    endDate: document.getElementById('documentEndDate').value || null,
                    autoRenew: document.getElementById('documentAutoRenew').checked,
                    notes: document.getElementById('documentNotes').value,
                    fileData: fileData,
                    fileName: file ? file.name : null,
                    created: new Date().toISOString()
                };

                documents.push(doc);
                saveData();
                renderDocuments();
                closeModal('newDocument');
                document.getElementById('newDocumentForm').reset();
                showToast('Document uploaded');
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => processDocument(e.target.result);
                reader.readAsDataURL(file);
            } else {
                processDocument(null);
            }
        });

        // ========== VENDORS MODULE ==========

        document.getElementById('newVendorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const vendor = {
                id: Date.now(),
                name: document.getElementById('vendorName').value,
                email: document.getElementById('vendorEmail').value,
                phone: document.getElementById('vendorPhone').value,
                vatNumber: document.getElementById('vendorVAT').value,
                category: document.getElementById('vendorCategory').value,
                created: new Date().toISOString()
            };
            vendors.push(vendor);
            saveData();
            populateExpenseDropdowns();
            closeModal('newVendor');
            document.getElementById('newVendorForm').reset();
            showToast('Vendor added');
        });

        // ========== BUDGET MODULE ==========

        document.getElementById('setBudgetForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const category = document.getElementById('budgetCategory').value;
            budgets[category] = {
                monthly: parseFloat(document.getElementById('budgetMonthly').value) || 0,
                yearly: parseFloat(document.getElementById('budgetYearly').value) || 0,
                alert: document.getElementById('budgetAlert').checked
            };
            saveData();
            closeModal('setBudget');
            showToast('Budget set');
        });

        // ========== DASHBOARD MODULE ==========

        function updateDashboard() {
            const period = document.getElementById('dashboardPeriod').value;
            const now = new Date();
            let startDate;

            switch (period) {
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'quarter':
                    const quarter = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), quarter * 3, 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                default:
                    startDate = new Date(0);
            }

            // Calculate revenues
            const periodInvoices = invoices.filter(i => new Date(i.date) >= startDate);
            const totalRevenue = periodInvoices.reduce((s, i) => s + i.amount, 0);
            const collected = periodInvoices.filter(i => i.status === 'paid').reduce((s, i) => s + i.amount, 0);
            const outstanding = periodInvoices.filter(i => i.status !== 'paid').reduce((s, i) => s + i.amount, 0);

            // Calculate expenses
            const periodExpenses = expenses.filter(e => new Date(e.date) >= startDate);
            const totalExpenses = periodExpenses.reduce((s, e) => s + e.amount, 0);

            // Update revenue KPIs
            document.getElementById('dashRevenue').textContent = '₪' + totalRevenue.toLocaleString();
            document.getElementById('dashCollected').textContent = '₪' + collected.toLocaleString();
            document.getElementById('dashOutstanding').textContent = '₪' + outstanding.toLocaleString();
            document.getElementById('dashExpenses').textContent = '₪' + totalExpenses.toLocaleString();

            // Profit & Loss
            const grossProfit = collected - totalExpenses;
            const profitMargin = collected > 0 ? (grossProfit / collected * 100).toFixed(1) : 0;
            document.getElementById('dashGrossProfit').textContent = '₪' + grossProfit.toLocaleString();
            document.getElementById('dashProfitMargin').textContent = profitMargin + '%';
            document.getElementById('dashPLRevenue').textContent = '₪' + collected.toLocaleString();
            document.getElementById('dashPLExpenses').textContent = '₪' + totalExpenses.toLocaleString();
            document.getElementById('dashNetProfit').textContent = '₪' + grossProfit.toLocaleString();

            // Pipeline
            const leads = clients.filter(c => c.pipelineStage === 'lead').length;
            const proposalsSent = proposals.filter(p => p.status === 'sent').length;
            const won = proposals.filter(p => p.status === 'accepted').length;
            const totalPipeline = leads + proposalsSent + won || 1;

            document.getElementById('pipelineLeads').textContent = leads;
            document.getElementById('pipelineProposals').textContent = proposalsSent;
            document.getElementById('pipelineWon').textContent = won;
            document.getElementById('pipelineLeadsBar').style.width = (leads / totalPipeline * 100) + '%';
            document.getElementById('pipelineProposalsBar').style.width = (proposalsSent / totalPipeline * 100) + '%';
            document.getElementById('pipelineWonBar').style.width = (won / totalPipeline * 100) + '%';

            const winRate = (proposalsSent + won) > 0 ? (won / (proposalsSent + won) * 100).toFixed(0) : 0;
            const avgDeal = won > 0 ? proposals.filter(p => p.status === 'accepted').reduce((s, p) => s + p.amount, 0) / won : 0;
            document.getElementById('dashWinRate').textContent = winRate + '%';
            document.getElementById('dashAvgDeal').textContent = '₪' + avgDeal.toLocaleString();

            // Project status
            const projectStatus = document.getElementById('projectStatusBreakdown');
            const active = projects.filter(p => p.status === 'active').length;
            const onHold = projects.filter(p => p.status === 'on_hold').length;
            const completed = projects.filter(p => p.status === 'completed').length;
            projectStatus.innerHTML = `
                <div style="margin-bottom: 8px; display: flex; justify-content: space-between;"><span>Active</span><span style="color: var(--success);">${active}</span></div>
                <div style="margin-bottom: 8px; display: flex; justify-content: space-between;"><span>On Hold</span><span style="color: var(--warning);">${onHold}</span></div>
                <div style="display: flex; justify-content: space-between;"><span>Completed</span><span style="color: var(--gray);">${completed}</span></div>
            `;

            // Top clients
            const topClients = document.getElementById('topClients');
            const clientRevenue = {};
            invoices.filter(i => i.status === 'paid').forEach(i => {
                if (!clientRevenue[i.clientName]) clientRevenue[i.clientName] = 0;
                clientRevenue[i.clientName] += i.amount;
            });
            const sortedClients = Object.entries(clientRevenue).sort((a, b) => b[1] - a[1]).slice(0, 5);
            if (sortedClients.length === 0) {
                topClients.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No revenue data yet</div>';
            } else {
                topClients.innerHTML = sortedClients.map(([name, revenue]) => `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="font-size: 12px;">${name}</span>
                        <span style="font-size: 12px; color: var(--success);">₪${revenue.toLocaleString()}</span>
                    </div>
                `).join('');
            }

            // Time utilization
            const timeUtil = document.getElementById('timeUtilization');
            const periodTime = timeEntries.filter(e => new Date(e.date) >= startDate);
            const totalTime = periodTime.reduce((s, e) => s + e.hours, 0);
            const billableTime = periodTime.filter(e => e.billable).reduce((s, e) => s + e.hours, 0);
            const utilization = totalTime > 0 ? (billableTime / totalTime * 100).toFixed(0) : 0;
            timeUtil.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${utilization}%</div>
                    <div style="font-size: 11px; color: var(--gray);">Billable Utilization</div>
                </div>
                <div style="margin-top: 16px; display: flex; justify-content: space-around;">
                    <div style="text-align: center;">
                        <div style="font-size: 16px; font-weight: 600;">${totalTime}h</div>
                        <div style="font-size: 10px; color: var(--gray);">Total</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 16px; font-weight: 600; color: var(--success);">${billableTime}h</div>
                        <div style="font-size: 10px; color: var(--gray);">Billable</div>
                    </div>
                </div>
            `;

            // Alerts
            updateDashboardAlerts();
            updateUpcomingDeadlines();
        }

        function updateDashboardAlerts() {
            const container = document.getElementById('dashboardAlerts');
            const alerts = [];

            // Overdue invoices
            const overdueInvoices = invoices.filter(i => i.status === 'pending' && new Date(i.dueDate) < new Date()).length;
            if (overdueInvoices > 0) alerts.push(`${overdueInvoices} overdue invoice(s)`);

            // Overdue tasks
            const overdueTasks = tasks.filter(t => t.dueDate && new Date(t.dueDate) < new Date() && t.status !== 'done').length;
            if (overdueTasks > 0) alerts.push(`${overdueTasks} overdue task(s)`);

            // Expiring contracts
            const thirtyDays = new Date();
            thirtyDays.setDate(thirtyDays.getDate() + 30);
            const expiringContracts = documents.filter(d => d.type === 'contract' && d.endDate && new Date(d.endDate) <= thirtyDays && new Date(d.endDate) > new Date()).length;
            if (expiringContracts > 0) alerts.push(`${expiringContracts} contract(s) expiring soon`);

            // Budget alerts
            Object.entries(budgets).forEach(([category, budget]) => {
                if (budget.alert) {
                    const spent = expenses.filter(e => e.category === category).reduce((s, e) => s + e.amount, 0);
                    if (budget.monthly && spent >= budget.monthly * 0.8) {
                        alerts.push(`${category} budget at ${Math.round(spent / budget.monthly * 100)}%`);
                    }
                }
            });

            if (alerts.length === 0) {
                container.innerHTML = '<div style="color: var(--success); font-size: 13px;">All good!</div>';
            } else {
                container.innerHTML = alerts.map(a => `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <span style="color: var(--warning);">⚠️</span>
                        <span style="font-size: 12px;">${a}</span>
                    </div>
                `).join('');
            }
        }

        function updateUpcomingDeadlines() {
            const container = document.getElementById('upcomingDeadlines');
            const deadlines = [];

            // Project deadlines
            projects.filter(p => p.status === 'active' && p.expectedEndDate).forEach(p => {
                deadlines.push({ type: 'Project', name: p.name, date: p.expectedEndDate });
            });

            // Task deadlines
            tasks.filter(t => t.status !== 'done' && t.dueDate).forEach(t => {
                deadlines.push({ type: 'Task', name: t.title, date: t.dueDate });
            });

            // Invoice due dates
            invoices.filter(i => i.status === 'pending' && i.dueDate).forEach(i => {
                deadlines.push({ type: 'Invoice', name: i.clientName, date: i.dueDate });
            });

            // Sort by date and take next 5
            const upcoming = deadlines.sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5);

            if (upcoming.length === 0) {
                container.innerHTML = '<div style="color: var(--gray); font-size: 13px;">No upcoming deadlines</div>';
            } else {
                container.innerHTML = upcoming.map(d => {
                    const isOverdue = new Date(d.date) < new Date();
                    return `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <div>
                                <div style="font-size: 12px;">${d.name}</div>
                                <div style="font-size: 10px; color: var(--gray);">${d.type}</div>
                            </div>
                            <div style="font-size: 11px; color: ${isOverdue ? 'var(--danger)' : 'var(--gray)'};">${new Date(d.date).toLocaleDateString('he-IL')}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        function exportDashboardReport() {
            showToast('Export feature coming soon');
        }

        // ========== INITIALIZE NEW MODULES ==========

        function initNewModules() {
            // Initialize time tracking
            renderTimeEntries();
            updateTimeStats();

            // Initialize tasks
            renderTasks();

            // Initialize quotes
            renderQuotes();

            // Initialize documents
            renderDocuments();

            // Initialize dashboard
            updateDashboard();

            // Populate dropdowns
            populateExpenseDropdowns();
        }

        // Initialize
        updateStats();
        initPayslips();
        initNewModules();

        // Initialize timer if one was running
        if (activeTimer) {
            startTimerDisplay();
        }

        // Update data counts on settings page
        updateDataCounts();
    </script>
</body>
</html>
